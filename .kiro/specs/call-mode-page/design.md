# 設計書

## 概要

営業担当者が売主に電話をかける際に使用する専用ページを作成します。画面を左右2分割し、左側に物件情報・売主情報・査定情報を表示、右側に通話メモ入力欄を配置します。既存の売主詳細ページから遷移し、通話終了後は元のページに戻ります。

## アーキテクチャ

### ページ構成

```
売主詳細ページ (/sellers/:id)
    ↓ 「通話メモ」ボタンクリック
通話専用ページ (/sellers/:id/call)
    ↓ 「保存して終了」または「戻る」ボタンクリック
売主詳細ページ (/sellers/:id)
```

### レイアウト構造

```
┌────────────────────────────────────────────────────────────┐
│  ヘッダー（最小限）                                        │
│  [← 戻る] 通話モード - {売主名}                           │
├──────────────────────────┬─────────────────────────────────┤
│  左側（50%）             │  右側（50%）                    │
│  ━━━━━━━━━━━━━━━━━━━━  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  📍 物件情報             │  📝 通話メモ入力                │
│  - 物件住所              │                                 │
│  - 物件種別              │  よく使うフレーズ：             │
│  - 土地面積              │  [興味あり] [検討中] [不在]    │
│  - 建物面積              │  [訪問希望] [資料送付] [急ぎ]  │
│  - 築年                  │                                 │
│                          │  ┌───────────────────────────┐ │
│  👤 売主情報             │  │                           │ │
│  - 氏名                  │  │  通話内容を入力...        │ │
│  - 住所                  │  │                           │ │
│  - 電話番号              │  │                           │ │
│  - メールアドレス        │  │                           │ │
│                          │  └───────────────────────────┘ │
│  💰 最新査定情報         │                                 │
│  - 査定額                │  [保存して終了]                 │
│  - 価格範囲              │                                 │
│  - 査定日時              │  ─────────────────────────────  │
│                          │  📋 過去の通話履歴              │
│  📞 過去の追客履歴       │                                 │
│  - 最終通話日            │  K 2025/12/1 14:30              │
│  - AI要約                │  売却に興味を持っている。       │
│                          │  訪問査定を希望している。       │
│  （スクロール可能）      │                                 │
│                          │  K 2025/11/28 10:15             │
│                          │  不在のため、後日再度連絡予定。 │
│                          │                                 │
│                          │  （スクロール可能）             │
└──────────────────────────┴─────────────────────────────────┘
```

## コンポーネントとインターフェース

### 1. フロントエンド - CallModePage コンポーネント

新しいページコンポーネント `frontend/src/pages/CallModePage.tsx` を作成します。

#### 主要な機能

1. **データ取得**
   - 売主情報
   - 物件情報
   - 最新査定情報
   - 活動履歴（通話メモ）
   - AI要約

2. **レイアウト**
   - Grid システムを使用して左右50%ずつに分割
   - 左側：情報表示エリア（物件情報と売主情報は編集可能）
   - 右側：通話メモ入力エリア

3. **通話メモ入力**
   - よく使うフレーズボタン
   - 複数行テキストエリア
   - 保存ボタン

4. **売主情報編集**
   - 編集ボタンで編集モードに切り替え
   - 氏名、住所、電話番号、メールアドレスの編集
   - 保存ボタンとキャンセルボタン
   - バリデーションとエラーハンドリング

5. **ナビゲーション**
   - 戻るボタン（未保存の確認ダイアログ付き）
   - 保存して終了ボタン

### 2. ルーティング

`frontend/src/App.tsx` に新しいルートを追加：

```typescript
<Route path="/sellers/:id/call" element={<CallModePage />} />
```

### 3. 売主詳細ページの修正

`frontend/src/pages/SellerDetailPage.tsx` の「通話メモ」ボタンを修正：

```typescript
// 現在：ダイアログを開く
onClick={handlePhoneClick}

// 変更後：通話専用ページに遷移
onClick={() => navigate(`/sellers/${id}/call`)}
```

## データモデル

### 既存のデータモデルを使用

- `Seller`: 売主情報
- `PropertyInfo`: 物件情報
- `ValuationResult`: 査定情報
- `Activity`: 活動履歴（通話メモを含む）

新しいデータモデルは不要です。

## 正確性プロパティ

*プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。*

### Property 1: ページ遷移の一貫性

*任意の* 売主IDに対して、通話専用ページから戻るボタンをクリックすると、元の売主詳細ページに戻るべきである

**検証: 要件 1.1, 1.5**

### Property 2: レイアウトの固定性

*任意の* 画面サイズに対して、左側と右側の幅は常に50%ずつであるべきである

**検証: 要件 4.1, 4.2**

### Property 3: 情報表示の順序

*任意の* 売主に対して、左側の情報表示エリアは常に「物件情報 → 売主情報 → 査定情報 → 過去の追客履歴」の順序で表示されるべきである

**検証: 要件 2.1, 2.3, 2.4, 2.5**

### Property 4: 通話履歴の表示件数

*任意の* 売主に対して、右側の過去の通話履歴は最新5件のみを表示するべきである

**検証: 要件 6.2**

### Property 5: 読み取り専用の保証

*任意の* 通話専用ページにおいて、左側の情報表示エリアには編集機能が存在しないべきである

**検証: 要件 5.2, 5.3**

### Property 6: 未保存データの保護

*任意の* 通話メモ入力中に戻るボタンをクリックすると、確認ダイアログが表示されるべきである

**検証: 要件 5.5**

### Property 7: 売主情報編集の一貫性

*任意の* 売主に対して、編集モードで情報を変更して保存すると、表示モードで更新された情報が表示されるべきである

**検証: 要件 7.5**

### Property 8: 売主情報編集のキャンセル

*任意の* 売主に対して、編集モードで情報を変更してキャンセルすると、元の情報が保持されるべきである

**検証: 要件 7.6**

## エラーハンドリング

### 1. データ取得エラー

**シナリオ:** 売主情報、物件情報、査定情報の取得に失敗

**対応:**
- エラーメッセージを表示
- 「売主詳細ページに戻る」ボタンを提供
- 通話メモの入力は可能にする（データがなくても記録できるように）

### 2. 通話メモ保存エラー

**シナリオ:** 通話メモの保存に失敗

**対応:**
- エラーメッセージを表示
- 入力内容を保持
- 再試行ボタンを提供
- ローカルストレージに一時保存（オプション）

### 3. 無効な売主ID

**シナリオ:** URLパラメータの売主IDが無効または存在しない

**対応:**
- エラーメッセージを表示
- 売主一覧ページにリダイレクト

## テスト戦略

### ユニットテスト

1. **CallModePage コンポーネント**
   - データ取得が正しく行われることを確認
   - レイアウトが50%ずつに分割されることを確認
   - よく使うフレーズボタンが正しく動作することを確認
   - 通話メモの保存が正しく行われることを確認

2. **ナビゲーション**
   - 戻るボタンが正しく動作することを確認
   - 未保存データがある場合に確認ダイアログが表示されることを確認

### 統合テスト

1. **エンドツーエンドフロー**
   - 売主詳細ページから通話専用ページに遷移
   - 通話メモを入力して保存
   - 売主詳細ページに戻る
   - 保存した通話メモが表示されることを確認

2. **UI 表示テスト**
   - 物件情報が最上部に表示されることを確認
   - 過去の通話履歴が最新5件のみ表示されることを確認
   - 担当者イニシャルと日時が正しく表示されることを確認

## 実装の注意事項

### パフォーマンス

- 既存のAPIエンドポイントを再利用
- 新しいAPIエンドポイントは不要
- データ取得は並列で実行（Promise.all）

### UI/UX

- レスポンシブデザインは不要（デスクトップ専用）
- 最小画面幅: 1280px
- 左右のスクロールは独立

### アクセシビリティ

- キーボードショートカット: Ctrl+S で保存
- Esc キーで戻る（確認ダイアログ付き）
- フォーカス管理: ページ読み込み時に通話メモ入力欄にフォーカス

### セキュリティ

- 既存の認証ミドルウェアを使用
- 売主情報の暗号化は既存の仕組みを継承
