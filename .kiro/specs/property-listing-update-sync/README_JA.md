# 物件リスト更新同期機能 - 概要

## 📋 このSpecについて

このSpecは、AA9313のATBB状態が更新されない問題の**恒久的な解決策**を定義しています。

## 🎯 目的

現在、`PropertyListingSyncService`は新規物件の追加（INSERT）のみをサポートしており、既存物件の更新（UPDATE）には対応していません。この機能を追加することで、スプレッドシートで物件情報が更新された際に、自動的にデータベースにも反映されるようにします。

## 🐛 解決する問題

### 現在の問題
- AA9313の`atbb成約済み/非公開`がスプレッドシートで更新されても、データベースに反映されない
- 手動修正スクリプトを毎回実行する必要がある
- 約50件の物件で同様の問題が発生している可能性

### 根本原因
`PropertyListingSyncService.ts`にUPDATE機能が実装されていない

## ✅ 実装する機能

### 1. 更新検出機能
- スプレッドシートとデータベースのデータを比較
- 変更された物件を自動検出
- どのフィールドが変更されたかを記録

### 2. 更新実行機能
- 検出された変更をデータベースに反映
- バッチ処理で複数物件を効率的に更新
- エラーハンドリングとリトライ

### 3. 自動同期統合
- `EnhancedAutoSyncService`のPhase 4として統合
- 定期的に自動実行
- 監視とログ記録

## 📁 Specファイル構成

```
.kiro/specs/property-listing-update-sync/
├── requirements.md  ← 要件定義（ユーザーストーリー、技術要件）
├── tasks.md         ← タスク一覧（14タスク、推定5時間）
├── design.md        ← 設計書（アーキテクチャ、データフロー）
└── README_JA.md     ← このファイル（日本語概要）
```

## 🚀 実装計画

### Phase 1: コア更新ロジック（2時間）
1. `detectUpdatedPropertyListings()` - 更新検出
2. `updatePropertyListing()` - 単一物件更新
3. `syncUpdatedPropertyListings()` - バッチ更新
4. ユニットテスト

### Phase 2: 統合（1時間）
1. `EnhancedAutoSyncService`への統合
2. 同期ログの追加

### Phase 3: 手動スクリプト（1時間）
1. 手動同期スクリプトの作成
2. 既存修正スクリプトの更新
3. ドキュメント作成

### Phase 4: テストと検証（1時間）
1. AA9313でのテスト
2. 複数物件でのテスト
3. 自動同期統合テスト
4. 負荷テスト

**合計推定時間**: 5時間

## 📊 アーキテクチャ概要

```
EnhancedAutoSyncService
  ├─ Phase 1: 売主同期
  ├─ Phase 2: 物件作成
  ├─ Phase 3: 売主更新
  ├─ Phase 4: 物件リスト更新 ← 新規追加
  └─ Phase 5: その他の同期

Phase 4の処理フロー:
1. スプレッドシートから全物件データを取得
2. データベースから全物件データを取得
3. フィールドごとに比較して変更を検出
4. 変更された物件をバッチ更新（10件ずつ）
5. 結果をsync_logsテーブルに記録
```

## 🎯 成功基準

- ✅ AA9313のATBB状態が自動的に更新される
- ✅ すべての物件フィールドが正しく同期される
- ✅ 自動同期の一部として実行される
- ✅ 同期ログに更新履歴が記録される
- ✅ 手動修正スクリプトが不要になる
- ✅ 100件の物件を2分以内に同期できる

## 📝 関連ドキュメント

### 現在の問題に関するドキュメント
- `backend/AA9313_修正完了_最終確認.md` - AA9313修正スクリプトのバグ修正
- `backend/fix-aa9313-atbb-status.ts` - 一時的な修正スクリプト
- `CONTEXT_TRANSFER_AA9313_FIX_COMPLETE.md` - 問題の詳細

### 実装計画
- `backend/PROPERTY_LISTING_UPDATE_IMPLEMENTATION_PLAN.md` - 実装計画書

### このSpec
- `requirements.md` - 詳細な要件定義
- `tasks.md` - 実装タスク一覧
- `design.md` - 技術設計書

## 🔄 現在の状態

### 一時的な解決策（完了）
✅ `backend/fix-aa9313-atbb-status.ts`のバグを修正
✅ AA9313を手動で修正できる状態

### 恒久的な解決策（このSpec）
⏳ 要件定義完了
⏳ タスク定義完了
⏳ 設計完了
🔄 実装待ち

## 🚀 次のステップ

### 即座に実行可能（一時的な解決策）
```bash
cd backend
npx ts-node fix-aa9313-atbb-status.ts
```

### 今後の実装（恒久的な解決策）
1. このSpecをレビュー
2. Phase 1から実装開始
3. 各Phaseごとにテスト
4. 本番環境にデプロイ

## 💡 重要なポイント

### スプレッドシート構成
- **物件リストスプレッドシート**
  - ID: `1tI_iXaiLuWBggs5y0RH7qzkbHs9wnLLdRekAmjkhcLY`
  - シート名: `物件`
  - 同期先: `property_listings`テーブル
  - 現在: INSERT のみ
  - 今後: INSERT + UPDATE

### 影響範囲
- AA9313（即座の問題）
- 約50件の物件（storage_location問題）
- 将来的にすべての物件更新

### 利点
- 手動修正スクリプト不要
- データの鮮度向上
- 運用負荷軽減
- エラー削減

## 📞 質問・相談

このSpecについて質問や提案がある場合は、以下を確認してください:

1. **要件について**: `requirements.md`を参照
2. **実装について**: `design.md`を参照
3. **タスクについて**: `tasks.md`を参照

---

**作成日**: 2026-01-07  
**ステータス**: 要件定義完了 - 実装待ち  
**推定工数**: 5時間  
**優先度**: 高（AA9313問題の恒久的解決策）
