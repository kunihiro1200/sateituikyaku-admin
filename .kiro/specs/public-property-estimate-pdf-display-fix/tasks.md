# Implementation Plan: 概算書PDF表示修正（本番環境対応）

## Overview

公開物件サイトの概算書PDF生成機能が本番環境（Vercel）で動作しない問題を解決します。Vercel用のエントリーポイント（`backend/api/index.ts`）に概算書PDF生成エンドポイントを追加し、404エラーを解消します。

## Tasks

- [x] 1. backend/api/index.tsに概算書エンドポイントを追加
  - `POST /api/public/properties/:propertyNumber/estimate-pdf` エンドポイントを実装
  - PropertyServiceを動的インポート
  - エラーハンドリングを追加
  - ログ出力を追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2_

- [x] 2. PropertyServiceの環境変数対応を確認
  - `GOOGLE_SERVICE_ACCOUNT_JSON`環境変数からの読み込みをサポート
  - ファイルシステムアクセスとの互換性を維持
  - Vercel環境とローカル環境の両方で動作することを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3. エラーハンドリングの実装
  - 認証エラーの処理
  - スプレッドシートアクセスエラーの処理
  - 計算タイムアウトエラーの処理
  - 適切なHTTPステータスコードとエラーメッセージを返す
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 4. ログ出力の追加
  - PDF生成開始ログ
  - PDF URL生成ログ
  - エラー詳細ログ
  - 環境変数確認ログ
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5. Checkpoint - ローカル環境での動作確認
  - バックエンドのビルドが成功することを確認
  - TypeScriptのコンパイルエラーがないことを確認
  - ユーザーに確認を求める

- [x] 6. Vercel環境変数の設定
  - Vercelダッシュボードで環境変数を設定
  - `GOOGLE_SERVICE_ACCOUNT_JSON`を設定
  - `GOOGLE_SERVICE_ACCOUNT_KEY_PATH`を設定
  - 既存の環境変数（SUPABASE_URL、SUPABASE_SERVICE_KEY）を確認
  - _Requirements: 2.3, 4.1, 4.2_

- [x] 7. Vercelへのデプロイ
  - 変更をGitにコミット
  - Vercelに自動デプロイ
  - デプロイログを確認
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 8. 本番環境での動作確認
  - 公開物件サイトで概算書ボタンをクリック
  - PDFが新しいタブで開くことを確認
  - 正しい金額が表示されることを確認
  - 404エラーが発生しないことを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2_

- [ ] 9. エラーケースのテスト
  - 存在しない物件番号でテスト
  - エラーメッセージが適切に表示されることを確認
  - ブラウザコンソールのエラーログを確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 7.4_

- [ ] 10. ログ出力の確認
  - Vercelのログダッシュボードを確認
  - PDF生成のログが適切に出力されることを確認
  - エラー時のログが詳細に記録されることを確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 11. Final checkpoint - 本番環境での最終確認
  - すべての機能が正常に動作していることを確認
  - エラーハンドリングが適切に機能していることを確認
  - ユーザーに最終確認を求める

## Notes

- タスク1が最も重要です。これにより404エラーが解消されます。
- タスク2はオプションですが、Vercel環境での安定性向上のため推奨されます。
- タスク6の環境変数設定は、デプロイ前に完了する必要があります。
- 各タスクは要件（Requirements）を参照しており、トレーサビリティを確保しています。
- Checkpointタスクでユーザーに確認を求め、問題があれば修正します。

