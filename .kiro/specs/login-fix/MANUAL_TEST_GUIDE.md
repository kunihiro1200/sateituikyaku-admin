# ログイン機能 手動テストガイド

## 概要
このガイドでは、ログイン機能の手動テスト手順を説明します。

## 前提条件
- フロントエンドとバックエンドが起動していること
- Supabase Dashboardでの設定が完了していること
- 環境変数が正しく設定されていること

## テスト環境の起動

### 1. バックエンドの起動
```bash
cd backend
npm run dev
```

### 2. フロントエンドの起動
```bash
cd frontend
npm run dev
```

## 正常系テスト

### テスト 9.1.1: ログインボタンクリック → Google OAuth画面表示

**手順:**
1. ブラウザで `http://localhost:5173` にアクセス
2. ログインページが表示されることを確認
3. 「Googleでログイン」ボタンをクリック
4. Google OAuth画面にリダイレクトされることを確認

**期待結果:**
- ✅ ログインページが正しく表示される
- ✅ ボタンクリック後、Google OAuth画面が表示される
- ✅ URLが `accounts.google.com` に変わる

**確認項目:**
- [ ] ログインページのUIが正しく表示される
- [ ] ボタンが正しく動作する
- [ ] Google OAuth画面が表示される

---

### テスト 9.1.2: Google アカウント選択 → 承認

**手順:**
1. Google OAuth画面でアカウントを選択
2. 必要に応じて権限の承認を行う
3. 承認後、アプリケーションにリダイレクトされることを確認

**期待結果:**
- ✅ アカウント選択画面が表示される
- ✅ 承認後、`http://localhost:5173/auth/callback` にリダイレクトされる
- ✅ コールバック処理が実行される

**確認項目:**
- [ ] アカウント選択が正しく動作する
- [ ] 承認画面が表示される（初回のみ）
- [ ] リダイレクトが正しく行われる

---

### テスト 9.1.3: 認証後にホームページへリダイレクト

**手順:**
1. コールバック処理が完了するまで待機
2. ホームページ（`/`）にリダイレクトされることを確認
3. ローディング表示が適切に表示されることを確認

**期待結果:**
- ✅ コールバックページでローディングが表示される
- ✅ 処理完了後、ホームページにリダイレクトされる
- ✅ URLが `http://localhost:5173/` に変わる

**確認項目:**
- [ ] ローディング表示が適切に表示される
- [ ] リダイレクトが自動的に行われる
- [ ] エラーが発生しない

---

### テスト 9.1.4: ユーザー情報の表示確認

**手順:**
1. ホームページでユーザー情報が表示されることを確認
2. ヘッダーにユーザー名またはメールアドレスが表示されることを確認
3. ログアウトボタンが表示されることを確認

**期待結果:**
- ✅ ユーザー情報が正しく表示される
- ✅ ログイン状態が維持される
- ✅ ログアウトボタンが表示される

**確認項目:**
- [ ] ユーザー名が表示される
- [ ] メールアドレスが表示される
- [ ] ログアウトボタンが表示される

---

## 異常系テスト

### テスト 9.2.1: OAuth承認キャンセル時のエラー表示

**手順:**
1. ログインボタンをクリック
2. Google OAuth画面で「キャンセル」をクリック
3. エラーメッセージが表示されることを確認

**期待結果:**
- ✅ ログインページに戻る
- ✅ エラーメッセージが表示される
- ✅ 再度ログインを試行できる

**確認項目:**
- [ ] エラーメッセージが表示される
- [ ] ログインページに戻る
- [ ] 再試行が可能

---

### テスト 9.2.2: ネットワークエラー時のエラー表示

**手順:**
1. バックエンドを停止
2. ログインボタンをクリック
3. エラーメッセージが表示されることを確認

**期待結果:**
- ✅ ネットワークエラーのメッセージが表示される
- ✅ リトライボタンが表示される
- ✅ ユーザーに適切なフィードバックが提供される

**確認項目:**
- [ ] エラーメッセージが表示される
- [ ] リトライボタンが表示される
- [ ] エラーが適切に処理される

---

### テスト 9.2.3: 無効なトークンでのエラー処理

**手順:**
1. ブラウザの開発者ツールを開く
2. LocalStorageに無効なトークンを設定
3. ページをリロード
4. エラーが適切に処理されることを確認

**期待結果:**
- ✅ 無効なトークンが検出される
- ✅ ログインページにリダイレクトされる
- ✅ エラーメッセージが表示される

**確認項目:**
- [ ] 無効なトークンが検出される
- [ ] ログインページにリダイレクトされる
- [ ] エラーが適切に処理される

---

## セッション管理テスト

### テスト 9.3.1: ログイン後のページリロード

**手順:**
1. ログイン後、ページをリロード（F5）
2. ログイン状態が維持されることを確認
3. ユーザー情報が再度表示されることを確認

**期待結果:**
- ✅ ログイン状態が維持される
- ✅ 再度ログインする必要がない
- ✅ ユーザー情報が正しく表示される

**確認項目:**
- [ ] ログイン状態が維持される
- [ ] ユーザー情報が表示される
- [ ] 再認証が不要

---

### テスト 9.3.2: ログアウト後のリダイレクト

**手順:**
1. ログアウトボタンをクリック
2. ログインページにリダイレクトされることを確認
3. ユーザー情報がクリアされることを確認

**期待結果:**
- ✅ ログインページにリダイレクトされる
- ✅ ユーザー情報がクリアされる
- ✅ 保護されたページにアクセスできない

**確認項目:**
- [ ] ログインページにリダイレクトされる
- [ ] ユーザー情報がクリアされる
- [ ] セッションが終了する

---

### テスト 9.3.3: トークン期限切れ後の再ログイン

**手順:**
1. ログイン後、長時間（24時間以上）待機
2. ページをリロードまたは操作を行う
3. トークン期限切れが検出されることを確認
4. ログインページにリダイレクトされることを確認

**期待結果:**
- ✅ トークン期限切れが検出される
- ✅ ログインページにリダイレクトされる
- ✅ エラーメッセージが表示される

**確認項目:**
- [ ] トークン期限切れが検出される
- [ ] ログインページにリダイレクトされる
- [ ] 再ログインが可能

---

## ブラウザ互換性テスト

### 対応ブラウザ
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

### テスト項目
各ブラウザで以下を確認：
- [ ] ログイン機能が正常に動作する
- [ ] OAuth画面が正しく表示される
- [ ] リダイレクトが正しく行われる
- [ ] セッション管理が正常に動作する

---

## デバッグ情報の確認

### ブラウザコンソール
以下のログが出力されることを確認：
- `🔐 Initializing auth check...`
- `✅ Session restored`
- `🔐 Handling auth callback...`
- `✅ Auth callback successful`

### ネットワークタブ
以下のリクエストが成功することを確認：
- `POST /api/auth/callback` → 200 OK
- `POST /api/auth/validate` → 200 OK
- `POST /api/auth/logout` → 200 OK

### LocalStorage
以下のキーが保存されることを確認：
- `sb-<project-id>-auth-token`

---

## トラブルシューティング

### ログインできない場合
1. Supabase DashboardでRedirect URLsを確認
2. 環境変数が正しく設定されているか確認
3. ブラウザのコンソールでエラーを確認
4. ネットワークタブでリクエストを確認

### リダイレクトが失敗する場合
1. `FRONTEND_URL`環境変数を確認
2. Supabase DashboardのRedirect URLsを確認
3. ブラウザのポップアップブロックを確認

### セッションが維持されない場合
1. LocalStorageが有効か確認
2. ブラウザのCookieが有効か確認
3. トークンの有効期限を確認

---

## テスト完了チェックリスト

### 正常系
- [ ] ログインボタンクリック → Google OAuth画面表示
- [ ] Google アカウント選択 → 承認
- [ ] 認証後にホームページへリダイレクト
- [ ] ユーザー情報の表示確認

### 異常系
- [ ] OAuth承認キャンセル時のエラー表示
- [ ] ネットワークエラー時のエラー表示
- [ ] 無効なトークンでのエラー処理

### セッション管理
- [ ] ログイン後のページリロード
- [ ] ログアウト後のリダイレクト
- [ ] トークン期限切れ後の再ログイン

### ブラウザ互換性
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

---

## 次のステップ
すべてのテストが完了したら、以下を実施：
1. テスト結果を記録
2. 発見された問題を報告
3. 必要に応じて修正を実施
4. 本番環境へのデプロイを準備
