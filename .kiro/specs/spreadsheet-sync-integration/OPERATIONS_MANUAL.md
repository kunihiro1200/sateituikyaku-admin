# 運用マニュアル

スプレッドシート同期機能の日常的な運用手順を説明します。

## 目次

1. [日常的な監視](#日常的な監視)
2. [手動同期の実行](#手動同期の実行)
3. [エラー対応](#エラー対応)
4. [スナップショット管理](#スナップショット管理)
5. [パフォーマンス監視](#パフォーマンス監視)
6. [メンテナンス作業](#メンテナンス作業)

---

## 日常的な監視

### 同期ステータスの確認

**頻度**: 1日1回（朝）

1. フロントエンドの「スプレッドシート同期管理」ページにアクセス
2. 「ステータス」タブで以下を確認:
   - 過去7日間の同期統計
   - 成功率（95%以上が正常）
   - 平均処理時間（2秒以内が正常）
   - レート制限の使用状況（80%未満が正常）

### エラーログの確認

**頻度**: 1日1回（朝）

1. 「エラーログ」タブを開く
2. 過去24時間のエラーを確認
3. エラータイプ別に分類:
   - **network**: ネットワークエラー → 一時的なものは無視、継続する場合は調査
   - **validation**: データ検証エラー → スプレッドシートのデータを修正
   - **rate_limit**: レート制限超過 → バッチサイズを調整
   - **auth**: 認証エラー → 緊急対応が必要
   - **conflict**: 競合エラー → データの重複を確認

### アラート対応

以下の場合は即座に対応が必要:

1. **認証エラーが発生**
   - サービスアカウントキーを確認
   - スプレッドシートのアクセス権限を確認

2. **同期失敗率が20%を超える**
   - エラーログを詳細に確認
   - 必要に応じてシステムを一時停止

3. **レート制限が90%を超える**
   - 手動同期を一時停止
   - バッチサイズを調整

---

## 手動同期の実行

### 差分同期（推奨）

未同期のデータのみを同期します。通常はこちらを使用してください。

1. 「スプレッドシート同期管理」ページにアクセス
2. 「ステータス」タブの右側にある「手動同期」パネルを確認
3. 「差分同期（未同期データのみ）」を選択
4. 「同期を開始」ボタンをクリック
5. 進行状況を監視
6. 完了後、結果を確認

**実行タイミング**:
- 大量のデータを一括で編集した後
- システムメンテナンス後
- エラーが多発した後の復旧時

### 全データ同期

すべてのデータを再同期します。データの整合性に問題がある場合のみ使用してください。

**注意**: 全データ同期は時間がかかり、レート制限に達する可能性があります。

1. 「手動同期」パネルで「全データ同期」を選択
2. 「同期を開始」ボタンをクリック
3. 進行状況を監視（10,000件で約5分）
4. 完了後、データ検証を実行

**実行タイミング**:
- 初回移行後の確認
- データの整合性に問題がある場合
- スプレッドシートを大幅に変更した後

### 同期の中断

同期は自動的に完了まで実行されます。緊急時のみ、以下の手順で中断できます:

1. バックエンドサーバーを再起動
2. 進行中の同期は中断されます
3. 次回の同期で未完了分が処理されます

---

## エラー対応

### ネットワークエラー

**症状**: `error_type: network`

**原因**:
- Google Sheets API への接続失敗
- タイムアウト
- 一時的なネットワーク障害

**対応**:
1. エラーが一時的なものか確認（数分後に再発しなければOK）
2. 継続する場合:
   - ネットワーク接続を確認
   - Google Sheets API のステータスを確認
   - ファイアウォール設定を確認

### バリデーションエラー

**症状**: `error_type: validation`

**原因**:
- スプレッドシートのデータ形式が不正
- 必須フィールドが空
- 電話番号やメールアドレスの形式が不正

**対応**:
1. エラーログから該当レコードを特定
2. スプレッドシートで該当行を確認
3. データを修正
4. 差分同期を実行して再試行

### レート制限エラー

**症状**: `error_type: rate_limit`

**原因**:
- Google Sheets API のレート制限（100リクエスト/100秒）を超過

**対応**:
1. 手動同期を一時停止
2. レート制限がリセットされるまで待機（最大100秒）
3. バッチサイズを小さくする（デフォルト: 100 → 50に変更）
4. 再度同期を実行

### 認証エラー

**症状**: `error_type: auth`

**緊急度**: 高

**原因**:
- サービスアカウントキーが無効
- スプレッドシートのアクセス権限が削除された
- Google Sheets API が無効化された

**対応**:
1. 即座にシステム管理者に連絡
2. サービスアカウントキーを確認
3. スプレッドシートの共有設定を確認
4. Google Cloud Console で API が有効か確認
5. 必要に応じてサービスアカウントを再作成

### 競合エラー

**症状**: `error_type: conflict`

**原因**:
- 売主番号の重複
- 同時編集による競合

**対応**:
1. エラーログから重複している売主番号を特定
2. Supabase とスプレッドシートの両方を確認
3. 重複を解消（片方を削除または売主番号を変更）
4. 差分同期を実行

---

## スナップショット管理

### スナップショットの作成

**推奨タイミング**:
- 大規模なデータ変更の前
- 全データ同期の前
- 週次バックアップ（毎週月曜日）

**手順**:
1. 「スナップショット」タブを開く
2. 「新しいスナップショットを作成」ボタンをクリック
3. 説明を入力（例: "週次バックアップ 2024-01-01"）
4. 作成完了を確認

### スナップショットからのロールバック

**注意**: ロールバックは現在のデータを完全に置き換えます。慎重に実行してください。

**手順**:
1. 「スナップショット」タブを開く
2. ロールバックしたいスナップショットを選択
3. 「ロールバック」ボタンをクリック
4. 確認ダイアログで「OK」をクリック
5. 完了後、データ検証を実行

### スナップショットの削除

古いスナップショットは自動的に削除されます（保持期間: 30日）。

手動で削除する場合:
1. 「スナップショット」タブを開く
2. 削除したいスナップショットの「削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック

---

## パフォーマンス監視

### レート制限の監視

**目標**: 使用率を80%未満に保つ

**確認方法**:
1. 「ステータス」タブの「API レート制限」セクションを確認
2. 使用率が80%を超えている場合:
   - 手動同期の頻度を減らす
   - バッチサイズを小さくする
   - 同期対象を絞り込む

### 処理時間の監視

**目標**:
- 単一レコード同期: 2秒以内
- バッチ同期（100件）: 10秒以内
- 全データ同期（10,000件）: 5分以内

**確認方法**:
1. 「同期履歴」タブで処理時間を確認
2. 目標を大幅に超えている場合:
   - ネットワーク接続を確認
   - データベースのパフォーマンスを確認
   - バッチサイズを調整

### エラー率の監視

**目標**: 5%未満

**確認方法**:
1. 「ステータス」タブの統計情報を確認
2. エラー率が5%を超えている場合:
   - エラーログを詳細に確認
   - 原因を特定して対応

---

## メンテナンス作業

### 週次メンテナンス（毎週月曜日）

1. スナップショットを作成
2. エラーログを確認
3. パフォーマンス統計を確認
4. 必要に応じて差分同期を実行

### 月次メンテナンス（毎月1日）

1. 古いスナップショットを削除（自動）
2. 古いログを削除（手動）
3. パフォーマンスレポートを作成
4. 必要に応じて設定を調整

### データ検証（四半期ごと）

1. 検証スクリプトを実行:
   ```bash
   cd backend
   npx ts-node src/scripts/verify-migration.ts
   ```
2. 結果を確認
3. 問題があれば対応

### バックアップ（毎日）

1. Supabase の自動バックアップを確認
2. スナップショットが定期的に作成されていることを確認

---

## トラブルシューティング

### 同期が遅い

**チェックリスト**:
- [ ] レート制限に達していないか
- [ ] ネットワーク接続は正常か
- [ ] データベースのパフォーマンスは正常か
- [ ] バッチサイズは適切か

### 同期が失敗し続ける

**チェックリスト**:
- [ ] 認証は正常か
- [ ] スプレッドシートのアクセス権限は正常か
- [ ] データ形式は正しいか
- [ ] エラーログを確認したか

### データの不整合

**対応**:
1. 検証スクリプトを実行
2. 問題のあるレコードを特定
3. 手動で修正
4. 全データ同期を実行

---

## 連絡先

問題が解決しない場合:
- システム管理者: [連絡先]
- 開発チーム: [連絡先]
- Google Cloud サポート: https://cloud.google.com/support
