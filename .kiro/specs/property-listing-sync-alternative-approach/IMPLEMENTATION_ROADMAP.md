# 実装ロードマップ - 物件リスト同期 REST API版

## 📅 実装スケジュール

**総所要時間**: 8-12日  
**優先度**: 高  
**開始日**: 2025-01-09

---

## Week 1: コアサービス実装

### Day 1: ユーティリティ作成 ⏱️ 1日

**目標**: リトライとサーキットブレーカーの実装

#### 午前 (4時間)
- [ ] `backend/src/utils/retryWithBackoff.ts` 作成
  - 指数バックオフアルゴリズム実装
  - 設定可能なリトライオプション
  - ユニットテスト作成
  
**チェックポイント**: リトライが正しく動作することを確認

#### 午後 (4時間)
- [ ] `backend/src/utils/CircuitBreaker.ts` 作成
  - 状態機械実装 (closed/open/half-open)
  - 失敗カウント追跡
  - タイムアウトベースのリセット
  - ユニットテスト作成

**チェックポイント**: サーキットブレーカーが閾値で開くことを確認

**成果物**:
- ✅ RetryWithBackoff実装完了
- ✅ CircuitBreaker実装完了
- ✅ ユニットテスト全てパス

---

### Day 2: Supabaseクライアント ⏱️ 1日

**目標**: Supabaseクライアントファクトリーの実装

#### 午前 (4時間)
- [ ] `backend/src/services/SupabaseClientFactory.ts` 作成
  - クライアント初期化ロジック
  - 接続ヘルスチェック
  - リトライロジック統合
  - 設定管理

#### 午後 (4時間)
- [ ] ユニットテスト作成
- [ ] 統合テスト作成（実際のSupabaseに接続）
- [ ] エラーハンドリング追加

**チェックポイント**: Supabaseクライアントが安定して接続できることを確認

**成果物**:
- ✅ SupabaseClientFactory実装完了
- ✅ 接続テスト成功
- ✅ エラーハンドリング完備

---

### Day 3: メインサービス (Part 1) ⏱️ 1日

**目標**: PropertyListingRestSyncServiceの基本実装

#### 午前 (4時間)
- [ ] `backend/src/services/PropertyListingRestSyncService.ts` 作成
  - クラス構造定義
  - コンストラクタ実装
  - 基本メソッドのスケルトン作成
  - Google Sheets統合

#### 午後 (4時間)
- [ ] `syncAll()` メソッド実装
- [ ] `syncByNumbers()` メソッド実装
- [ ] データ変換ロジック
- [ ] バリデーション追加

**チェックポイント**: Google Sheetsからデータを取得できることを確認

**成果物**:
- ✅ PropertyListingRestSyncService基本実装
- ✅ Google Sheets統合完了
- ✅ データ取得テスト成功

---

### Day 4-5: キュー処理実装 ⏱️ 2日

**目標**: バッチ処理とレート制限の実装

#### Day 4 午前 (4時間)
- [ ] `backend/src/services/PropertyListingSyncProcessor.ts` 作成
  - PQueue初期化
  - バッチ作成ロジック
  - `processBatch()` メソッド実装

#### Day 4 午後 (4時間)
- [ ] `processSingleBatch()` メソッド実装
- [ ] `processSingleListing()` メソッド実装
- [ ] エラーハンドリング追加

#### Day 5 午前 (4時間)
- [ ] RateLimiter強化
- [ ] レート制限統合
- [ ] リトライロジック追加

#### Day 5 午後 (4時間)
- [ ] ユニットテスト作成
- [ ] 統合テスト作成
- [ ] パフォーマンステスト

**チェックポイント**: 100件のデータを5分以内に同期できることを確認

**成果物**:
- ✅ PropertyListingSyncProcessor実装完了
- ✅ レート制限動作確認
- ✅ バッチ処理テスト成功

---

## Week 2: 状態管理とテスト

### Day 6-7: 状態管理実装 ⏱️ 2日

**目標**: 同期状態の追跡とAPI実装

#### Day 6 午前 (4時間)
- [ ] `backend/migrations/082_add_sync_state_table.sql` 作成
  - テーブルスキーマ定義
  - インデックス追加
  - RLSポリシー設定
  - マイグレーション実行

#### Day 6 午後 (4時間)
- [ ] `backend/src/services/SyncStateService.ts` 作成
  - `createSync()` 実装
  - `updateSync()` 実装
  - `getSync()` 実装
  - `getLastSync()` 実装
  - `getStatistics()` 実装

#### Day 7 午前 (4時間)
- [ ] `backend/src/routes/syncStatus.ts` 作成
  - POST /manual エンドポイント
  - GET /status/:syncId エンドポイント
  - GET /health エンドポイント
  - 認証ミドルウェア追加

#### Day 7 午後 (4時間)
- [ ] APIテスト作成
- [ ] エンドツーエンドテスト
- [ ] ドキュメント更新

**チェックポイント**: APIで同期状態を確認できることを確認

**成果物**:
- ✅ sync_stateテーブル作成完了
- ✅ SyncStateService実装完了
- ✅ API routes実装完了
- ✅ APIテスト全てパス

---

### Day 8: フロントエンド実装 ⏱️ 1日

**目標**: 同期状態ダッシュボードの作成

#### 午前 (4時間)
- [ ] `frontend/src/pages/SyncStatusPage.tsx` 作成
  - 同期履歴テーブル
  - ヘルス状態表示
  - 手動同期トリガーボタン

#### 午後 (4時間)
- [ ] リアルタイム更新実装
- [ ] エラー表示
- [ ] スタイリング
- [ ] コンポーネントテスト

**チェックポイント**: ダッシュボードで同期状態を確認できることを確認

**成果物**:
- ✅ SyncStatusPage実装完了
- ✅ リアルタイム更新動作確認
- ✅ UIテスト成功

---

### Day 9-10: 統合テストと負荷テスト ⏱️ 2日

**目標**: 包括的なテストと性能検証

#### Day 9 午前 (4時間)
- [ ] 統合テスト作成
  - フル同期フロー
  - 選択的同期
  - エラーリカバリー
  - 並行同期

#### Day 9 午後 (4時間)
- [ ] サーキットブレーカーテスト
- [ ] レート制限テスト
- [ ] テストデータクリーンアップ

#### Day 10 午前 (4時間)
- [ ] 負荷テスト作成
  - 1,000件のデータ
  - 10,000件のデータ
  - 並行手動同期
  - ネットワーク不安定時

#### Day 10 午後 (4時間)
- [ ] パフォーマンスメトリクス測定
- [ ] 結果ドキュメント作成
- [ ] 最適化実施

**チェックポイント**: 
- 1,000件を5分以内に同期
- 成功率 >99%
- エラーリカバリー動作確認

**成果物**:
- ✅ 統合テスト全てパス
- ✅ 負荷テスト成功
- ✅ パフォーマンス要件達成

---

## Week 3: デプロイと移行

### Day 11: マイグレーション準備 ⏱️ 1日

**目標**: 本番環境への移行準備

#### 午前 (4時間)
- [ ] `backend/migrations/migrate-to-rest-sync.ts` 作成
- [ ] データ整合性チェック追加
- [ ] ロールバック機能実装
- [ ] ドライランモード実装

#### 午後 (4時間)
- [ ] デプロイガイド作成
- [ ] 運用マニュアル作成
- [ ] トラブルシューティングガイド作成
- [ ] モニタリング設定

**チェックポイント**: マイグレーションスクリプトがドライランで成功することを確認

**成果物**:
- ✅ マイグレーションスクリプト完成
- ✅ ドキュメント完備
- ✅ モニタリング設定完了

---

### Day 12: デプロイと検証 ⏱️ 1日

**目標**: 本番環境へのデプロイと検証

#### 午前 (4時間)
- [ ] 本番環境にデプロイ
- [ ] 並行実行開始（10%トラフィック）
- [ ] モニタリング確認
- [ ] エラーチェック

#### 午後 (4時間)
- [ ] 結果比較（新旧サービス）
- [ ] データ整合性検証
- [ ] パフォーマンス確認
- [ ] 段階的切り替え計画確認

**チェックポイント**: 
- エラーなし
- データ整合性OK
- パフォーマンス要件達成

**成果物**:
- ✅ 本番環境デプロイ完了
- ✅ 並行実行成功
- ✅ 検証完了

---

## 📊 進捗追跡

### Phase 1: コアサービス (Day 1-3)
- [ ] Day 1: ユーティリティ
- [ ] Day 2: Supabaseクライアント
- [ ] Day 3: メインサービス

### Phase 2: キュー処理 (Day 4-5)
- [ ] Day 4: バッチ処理
- [ ] Day 5: レート制限

### Phase 3: 状態管理 (Day 6-8)
- [ ] Day 6: データベース
- [ ] Day 7: API
- [ ] Day 8: フロントエンド

### Phase 4: テスト (Day 9-10)
- [ ] Day 9: 統合テスト
- [ ] Day 10: 負荷テスト

### Phase 5: デプロイ (Day 11-12)
- [ ] Day 11: 準備
- [ ] Day 12: デプロイ

---

## 🎯 マイルストーン

| マイルストーン | 期限 | 状態 |
|--------------|------|------|
| Phase 1完了 | Day 3終了 | ⏳ 未開始 |
| Phase 2完了 | Day 5終了 | ⏳ 未開始 |
| Phase 3完了 | Day 8終了 | ⏳ 未開始 |
| Phase 4完了 | Day 10終了 | ⏳ 未開始 |
| Phase 5完了 | Day 12終了 | ⏳ 未開始 |

---

## 🚨 リスクと対策

### リスク 1: 実装遅延
**対策**: 
- 毎日の進捗確認
- 問題の早期発見
- 必要に応じてスコープ調整

### リスク 2: テスト失敗
**対策**:
- TDD（テスト駆動開発）
- 小さな単位でテスト
- CI/CD統合

### リスク 3: パフォーマンス問題
**対策**:
- 早期の負荷テスト
- プロファイリング
- 最適化の余地を確保

---

## 📞 サポート

問題が発生した場合:

1. **技術的な問題**: [design.md](./design.md)を確認
2. **実装の詳細**: [tasks.md](./tasks.md)を確認
3. **トラブルシューティング**: [START_HERE.md](./START_HERE.md)を確認

---

**作成日**: 2025-01-09  
**最終更新**: 2025-01-09  
**ステータス**: 実装準備完了
