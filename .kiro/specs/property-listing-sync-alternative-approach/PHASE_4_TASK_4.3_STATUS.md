# Phase 4 Task 4.3: マイグレーションスクリプト - ステータス

**日付:** 2025-01-09  
**ステータス:** 🔄 進行中  
**優先度:** High  
**進捗率:** 20%

## 📊 現在の状況

### ✅ 完了した作業

1. **マイグレーション実装ガイドの作成**
   - ファイル: `PHASE_4_TASK_4.3_MIGRATION_SCRIPTS.md`
   - 内容:
     - データ整合性チェックスクリプトの仕様
     - マイグレーション実行スクリプトの仕様
     - ロールバックスクリプトの仕様
     - 実行手順の詳細
     - トラブルシューティングガイド

### 🔄 進行中の作業

現在、実装ガイドに基づいて実際のマイグレーションスクリプトを作成する準備が整いました。

### ⏳ 未着手の作業

1. **データ整合性チェックスクリプトの実装**
   - ファイル: `backend/migrations/verify-property-listing-sync-migration.ts`
   - 推定時間: 2時間

2. **マイグレーション実行スクリプトの実装**
   - ファイル: `backend/migrations/migrate-to-rest-sync.ts`
   - 推定時間: 4時間

3. **ロールバックスクリプトの実装**
   - ファイル: `backend/migrations/rollback-rest-sync.ts`
   - 推定時間: 2時間

## 🎯 次のステップ

### 優先度1: データ整合性チェックスクリプトの実装

**目的:** マイグレーション前にデータベースの状態を検証

**実装内容:**
```typescript
// backend/migrations/verify-property-listing-sync-migration.ts

interface MigrationCheckResult {
  passed: boolean;
  issues: string[];
  warnings: string[];
  stats: {
    totalRecords: number;
    syncedRecords: number;
    pendingRecords: number;
    errorRecords: number;
  };
}

async function checkDataIntegrity(): Promise<MigrationCheckResult> {
  // 1. 物件リストの総数を確認
  // 2. 同期状態テーブルの存在確認
  // 3. 同期状態の統計
  // 4. 重複レコードのチェック
  // 5. 必須フィールドのチェック
  // 6. 最終同期時刻のチェック
}
```

**実装手順:**
1. Supabaseクライアントの初期化
2. 各チェック項目の実装
3. 結果の集計とレポート
4. エラーハンドリング
5. テスト実行

### 優先度2: マイグレーション実行スクリプトの実装

**目的:** 既存システムから新システムへの移行を実行

**実装内容:**
```typescript
// backend/migrations/migrate-to-rest-sync.ts

interface MigrationOptions {
  dryRun: boolean;
  batchSize: number;
  skipBackup: boolean;
}

class MigrationExecutor {
  async execute(): Promise<void> {
    // Step 1: バックアップ作成
    // Step 2: 既存の同期状態をクリーンアップ
    // Step 3: 新しい同期状態を初期化
    // Step 4: 初回同期を実行
    // Step 5: 検証
  }
}
```

**実装手順:**
1. MigrationExecutorクラスの作成
2. バックアップ機能の実装
3. クリーンアップ機能の実装
4. 初期化機能の実装
5. 同期実行機能の実装
6. 検証機能の実装
7. コマンドライン引数の処理
8. テスト実行

### 優先度3: ロールバックスクリプトの実装

**目的:** 問題が発生した場合にマイグレーションをロールバック

**実装内容:**
```typescript
// backend/migrations/rollback-rest-sync.ts

interface RollbackOptions {
  backupTable?: string;
  dryRun: boolean;
}

class RollbackExecutor {
  async execute(): Promise<void> {
    // Step 1: バックアップテーブルを確認
    // Step 2: 現在のデータを削除
    // Step 3: バックアップからデータを復元
    // Step 4: 同期状態をクリーンアップ
  }
}
```

**実装手順:**
1. RollbackExecutorクラスの作成
2. バックアップ検索機能の実装
3. データクリア機能の実装
4. データ復元機能の実装
5. クリーンアップ機能の実装
6. コマンドライン引数の処理
7. テスト実行

## 📝 実装時の注意点

### データ整合性チェック

- すべてのチェックを実行し、結果を詳細にレポート
- 警告とエラーを明確に区別
- 統計情報を分かりやすく表示
- エラーが発生してもすべてのチェックを実行

### マイグレーション実行

- ドライランモードを必ず実装
- バックアップは必須（スキップオプションは非推奨）
- 進捗状況をリアルタイムで表示
- エラーが発生しても可能な限り続行
- 詳細なログを記録

### ロールバック

- バックアップテーブルの存在を必ず確認
- ドライランモードを実装
- データ復元前に現在のデータをクリア
- 復元後にデータ整合性を確認
- 詳細なログを記録

## 🔍 テスト計画

### ユニットテスト

各スクリプトの主要な関数をテスト:
- データ整合性チェック関数
- バックアップ作成関数
- データ復元関数
- クリーンアップ関数

### 統合テスト

実際のデータベースを使用してテスト:
1. テスト用Supabaseプロジェクトの準備
2. テストデータの投入
3. マイグレーションの実行
4. 結果の検証
5. ロールバックの実行
6. 結果の検証

### 本番環境テスト

本番環境でのテスト:
1. ドライランモードでの実行
2. 小規模データセットでの実行
3. 結果の検証
4. 問題がなければ本番実行

## 📊 成功基準

### データ整合性チェック

- ✅ すべてのチェック項目が実装されている
- ✅ 結果が分かりやすく表示される
- ✅ エラーと警告が明確に区別される
- ✅ 統計情報が正確に計算される

### マイグレーション実行

- ✅ ドライランモードが動作する
- ✅ バックアップが正しく作成される
- ✅ データが正しく移行される
- ✅ 進捗状況が表示される
- ✅ エラーハンドリングが適切

### ロールバック

- ✅ バックアップから正しく復元される
- ✅ データ整合性が保たれる
- ✅ ドライランモードが動作する
- ✅ エラーハンドリングが適切

## 📚 参考資料

- **実装ガイド:** `PHASE_4_TASK_4.3_MIGRATION_SCRIPTS.md`
- **Phase 4要件:** `PHASE_4_REQUIREMENTS.md`
- **統合テスト:** `PHASE_4_TASK_4.1_INTEGRATION_TESTS.md`
- **負荷テスト:** `PHASE_4_TASK_4.2_LOAD_TESTS.md`

## 🎯 タイムライン

| 作業項目 | 推定時間 | 開始予定 | 完了予定 |
|---------|---------|---------|---------|
| データ整合性チェック | 2時間 | 次回 | 次回 |
| マイグレーション実行 | 4時間 | 次回 | 次回 |
| ロールバック | 2時間 | 次回 | 次回 |

**合計推定時間:** 8時間（1日）

## 💡 推奨される作業順序

1. **データ整合性チェックスクリプトの実装** (2時間)
   - 最も基本的で重要なスクリプト
   - 他のスクリプトの基盤となる
   - テストが容易

2. **マイグレーション実行スクリプトの実装** (4時間)
   - 最も複雑なスクリプト
   - データ整合性チェックを使用
   - 十分なテストが必要

3. **ロールバックスクリプトの実装** (2時間)
   - マイグレーションの逆操作
   - バックアップ機能を使用
   - 安全性の確認が重要

---

**作成日:** 2025-01-09  
**最終更新:** 2025-01-09  
**次回更新予定:** スクリプト実装開始時  
**担当者:** 開発チーム
