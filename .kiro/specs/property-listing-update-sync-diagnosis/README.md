# 物件リスト更新同期診断 Spec

## 📋 概要

このspecは、既存物件データの更新がスプレッドシートからデータベースに同期されない問題を診断するためのものです。

**対象**: 既に登録済みの物件の情報更新（新規追加ではない）

## 🎯 目的

1. 自動同期が正常に動作しているか確認する
2. スプレッドシートとデータベースの差分を特定する
3. 同期されない根本原因を明らかにする
4. 適切な解決策を提示する

## 📁 ファイル構成

```
.kiro/specs/property-listing-update-sync-diagnosis/
├── README.md                    # このファイル
├── requirements.md              # 詳細な要件定義
├── tasks.md                     # タスク一覧
├── QUICK_START.md              # クイックスタートガイド
└── DIAGNOSIS_RESULTS.md        # 診断結果（診断後に作成）
```

## 🚀 クイックスタート

### 1. 全体診断の実行

```bash
cd backend
npx ts-node diagnose-property-listing-update-sync.ts
```

### 2. 特定物件の詳細診断

```bash
cd backend
npx ts-node diagnose-specific-property-sync.ts <物件番号>
```

**例**:
```bash
npx ts-node diagnose-specific-property-sync.ts AA4885
```

### 3. 診断結果に基づいた対応

診断結果に応じて、以下のいずれかの対応を実行:

- **自動同期が動作していない** → バックエンドサーバーを再起動
- **データに差分がある** → 手動同期を実行
- **同期エラーが発生している** → エラー内容を確認して修正

詳細は [QUICK_START.md](./QUICK_START.md) を参照してください。

## 📊 診断の流れ

```
┌─────────────────────────────────────┐
│  1. 全体診断スクリプトの実行        │
│     - 環境変数の確認                │
│     - 同期ログの確認                │
│     - データ差分の確認              │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  2. 問題の特定                      │
│     - 自動同期の動作状態            │
│     - データの不一致箇所            │
│     - エラーの有無                  │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  3. 根本原因の分析                  │
│     - サーバー未起動？              │
│     - 同期ロジックの問題？          │
│     - カラムマッピングの問題？      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  4. 解決策の実行                    │
│     - サーバー再起動                │
│     - 手動同期実行                  │
│     - コード修正（必要な場合）      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  5. 検証                            │
│     - 診断スクリプトの再実行        │
│     - データ一致の確認              │
│     - 自動同期の動作確認            │
└─────────────────────────────────────┘
```

## 🔍 診断スクリプト

### 全体診断スクリプト

**ファイル**: `backend/diagnose-property-listing-update-sync.ts`

**機能**:
- 環境変数の設定確認
- sync_logsテーブルの確認
- 最新10件のデータ差分確認
- 診断結果のサマリー表示

**実行時間**: 約30秒

---

### 特定物件診断スクリプト

**ファイル**: `backend/diagnose-specific-property-sync.ts`

**機能**:
- 指定された物件のスプレッドシートデータ取得
- 指定された物件のデータベースデータ取得
- フィールドごとの差分表示
- 推奨される対応の表示

**実行時間**: 約10秒

## 📈 診断結果の例

### 正常な状態

```
=== 物件リスト更新同期 診断 ===

1. 環境変数の確認
AUTO_SYNC_ENABLED: true
SUPABASE_URL: 設定済み
GOOGLE_SHEETS_SPREADSHEET_ID: 設定済み

2. 同期ログの確認
✅ 同期ログ: 5件
   最終実行: 2026-01-10T10:30:00Z
   ステータス: completed
   更新件数: 3

3. データ差分の確認（最新10件）
✅ 最新10件は全て一致しています

=== 診断結果サマリー ===
✅ 自動同期は正常に動作しています
```

---

### 問題がある状態

```
=== 物件リスト更新同期 診断 ===

1. 環境変数の確認
AUTO_SYNC_ENABLED: true
SUPABASE_URL: 設定済み
GOOGLE_SHEETS_SPREADSHEET_ID: 設定済み

2. 同期ログの確認
❌ 同期ログが見つかりません
   → 自動同期が一度も実行されていない可能性があります

3. データ差分の確認（最新10件）
⚠️  AA4885: ATBB状況が不一致
   スプレッドシート: "非公開（一般）"
   データベース: "一般・公開中"
   最終更新: 2025-12-17

❌ 3件の不一致が見つかりました

=== 診断結果サマリー ===
❌ 自動同期が実行されていません

推奨される対応:
1. バックエンドサーバーを再起動してください
   cd backend && npm run dev
```

## 🛠️ よくある問題と解決策

### 問題1: 自動同期が実行されていない

**症状**:
- sync_logsテーブルにレコードがない
- データが長期間更新されていない

**原因**:
- バックエンドサーバーが再起動されていない
- AUTO_SYNC_ENABLED環境変数がfalse

**解決策**:
```bash
cd backend
npm run dev
```

---

### 問題2: 一部の物件のみ更新されない

**症状**:
- 一部の物件だけデータが古い
- 特定のフィールドのみ差分がある

**原因**:
- カラムマッピングの問題
- データ型の不一致

**解決策**:
1. カラムマッピングを確認
2. 該当物件の詳細診断を実行
3. 必要に応じてマッピングを修正

---

### 問題3: 同期エラーが発生している

**症状**:
- sync_logsのstatusが「error」
- properties_updatedが0

**原因**:
- スプレッドシート接続エラー
- データベース接続エラー
- 同期ロジックのバグ

**解決策**:
1. sync_logsのerror_detailsを確認
2. エラー内容に基づいて対応
3. 必要に応じて開発チームに報告

## 📚 関連ドキュメント

### このSpec内
- [requirements.md](./requirements.md) - 詳細な要件定義
- [tasks.md](./tasks.md) - タスク一覧とスケジュール
- [QUICK_START.md](./QUICK_START.md) - クイックスタートガイド

### 関連Spec
- [property-listing-auto-sync](../property-listing-auto-sync/) - 自動同期の実装spec
- [property-listing-sync-diagnosis](../property-listing-sync-diagnosis/) - 同期全般の診断spec
- [property-listing-auto-sync-diagnosis](../property-listing-auto-sync-diagnosis/) - 自動同期の診断spec

### 実装ファイル
- `backend/src/services/EnhancedAutoSyncService.ts` - 自動同期サービス
- `backend/src/services/PropertyListingSyncService.ts` - 物件リスト同期サービス
- `backend/src/services/GoogleSheetsClient.ts` - Google Sheets クライアント

## 🎯 成功基準

### 診断フェーズ
- [ ] 自動同期の動作状態を正確に把握できる
- [ ] スプレッドシートとデータベースの差分を確認できる
- [ ] 同期ログの履歴を確認できる
- [ ] 問題の根本原因を特定できる

### 解決フェーズ
- [ ] 自動同期が正常に動作する
- [ ] スプレッドシートの更新が5分以内にデータベースに反映される
- [ ] sync_logsテーブルに定期的にログが記録される
- [ ] データの不一致が解消される

## ⏱️ 推定時間

- **診断スクリプトの実装**: 45分
- **診断の実行と分析**: 25分
- **解決策の文書化**: 25分

**合計**: 約1時間35分

## 📝 ステータス

**現在のステータス**: ✅ Phase 1 完了 → 🚀 Phase 2 実行準備完了

**Phase 1 完了**:
- ✅ Task 1.1: 全体診断スクリプトの作成
- ✅ Task 1.2: 特定物件診断スクリプトの作成
- ✅ Task 1.3: クイックスタートガイドの作成

**次のステップ (Phase 2)**:
1. Task 2.1: 全体診断の実行
2. Task 2.2: 問題のある物件の特定
3. Task 2.3: 根本原因の特定

**実行ガイド**: `今すぐ実行_物件リスト更新同期診断_Phase2.md` を参照

## 🤝 貢献

このspecに関する質問や提案がある場合は、開発チームに連絡してください。

---

**作成日**: 2026-01-10  
**最終更新**: 2026-01-10  
**バージョン**: 1.0.0
