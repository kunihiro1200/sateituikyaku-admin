# 物件リスト更新同期診断 - 要件定義

## 概要

既存物件（AA4885など）のATBB状況やその他のフィールドがスプレッドシートから正しく同期更新されない問題を診断し、修正する。

## 背景

### 現在の状況
- 新規物件追加時の同期は正常に動作している（`.kiro/specs/property-listing-atbb-status-auto-sync`で実装済み）
- しかし、既存物件のフィールド更新（特にATBB状況）が同期されない問題が発生
- 具体例：AA4885のATBB状況がスプレッドシートで更新されてもDBに反映されない

### 問題の範囲
- **影響を受けるフィールド**: ATBB状況、その他の更新可能なフィールド全般
- **影響を受ける物件**: 既存の全物件（新規追加物件は問題なし）
- **ユーザー影響**: 物件情報が最新でないため、業務判断に支障

## 目標

1. **診断**: 既存物件の更新同期が失敗する根本原因を特定
2. **修正**: 更新同期を正常に動作させる
3. **検証**: AA4885を含む複数の既存物件で更新同期が正常に動作することを確認
4. **予防**: 今後同様の問題が発生しないようにする

## ユーザーストーリー

### US-1: 既存物件の更新同期診断
**As a** システム管理者  
**I want to** 既存物件の更新同期が失敗する原因を診断できる  
**So that** 問題の根本原因を理解し、適切な修正を行える

**受入基準:**
- [ ] 診断スクリプトが既存物件の同期状態を確認できる
- [ ] AA4885の現在の状態（DB vs スプレッドシート）を比較できる
- [ ] 同期処理のログを確認できる
- [ ] 失敗の原因（コード、設定、データ）を特定できる

### US-2: 更新同期の修正
**As a** システム管理者  
**I want to** 既存物件の更新同期を修正できる  
**So that** スプレッドシートの変更が自動的にDBに反映される

**受入基準:**
- [ ] 既存物件のフィールド更新が検出される
- [ ] 検出された更新がDBに正しく反映される
- [ ] ATBB状況の更新が正常に動作する
- [ ] その他のフィールドの更新も正常に動作する

### US-3: 修正の検証
**As a** システム管理者  
**I want to** 修正が正常に動作することを検証できる  
**So that** 本番環境で安心して使用できる

**受入基準:**
- [ ] AA4885のATBB状況を手動で更新し、同期を確認できる
- [ ] 複数の既存物件で更新同期をテストできる
- [ ] 新規物件の追加同期が引き続き正常に動作する
- [ ] エラーが発生した場合、適切なログが記録される

### US-4: 予防措置
**As a** 開発者  
**I want to** 同様の問題が再発しないようにする  
**So that** システムの信頼性を向上できる

**受入基準:**
- [ ] 更新同期のテストケースが追加される
- [ ] 同期処理のモニタリングが強化される
- [ ] ドキュメントが更新される
- [ ] 今後の開発で同様の問題を防ぐガイドラインが作成される

## 技術要件

### 診断要件

1. **現状確認**
   - AA4885の現在のDB状態を取得
   - AA4885のスプレッドシート状態を取得
   - 差分を明確に表示

2. **同期処理の確認**
   - 自動同期サービスの動作状態を確認
   - 同期ログの確認
   - エラーログの確認

3. **コード分析**
   - 既存の同期処理コードのレビュー
   - 新規追加と更新の処理の違いを特定
   - 潜在的なバグの特定

### 修正要件

1. **更新検出の改善**
   - スプレッドシートの変更を正確に検出
   - 変更されたフィールドのみを更新（効率化）
   - タイムスタンプベースの変更検出

2. **更新処理の実装**
   - 既存レコードの更新処理
   - トランザクション管理
   - エラーハンドリング

3. **ATBB状況の特別処理**
   - ATBB状況フィールドの正確なマッピング
   - 値の検証
   - 変換処理（必要な場合）

### 検証要件

1. **単体テスト**
   - 更新検出ロジックのテスト
   - 更新処理のテスト
   - エラーハンドリングのテスト

2. **統合テスト**
   - AA4885での実際の更新テスト
   - 複数物件での更新テスト
   - 新規追加との共存テスト

3. **パフォーマンステスト**
   - 大量更新時の処理時間
   - メモリ使用量
   - データベース負荷

## 非機能要件

### パフォーマンス
- 1物件の更新処理は1秒以内
- 100物件の一括更新は30秒以内
- 同期処理がシステム全体のパフォーマンスに影響しない

### 信頼性
- 同期失敗時は適切なエラーログを記録
- 部分的な失敗でも他の物件の同期は継続
- リトライ機能の実装

### 保守性
- コードは既存の同期処理と一貫性を保つ
- 十分なコメントとドキュメント
- デバッグしやすいログ出力

## 制約条件

1. **既存機能への影響**
   - 新規物件追加の同期機能は変更しない
   - 他のテーブルの同期処理に影響しない
   - 既存のAPIエンドポイントは維持

2. **データ整合性**
   - 更新処理中のデータ不整合を防ぐ
   - ロールバック機能の実装
   - 監査ログの記録

3. **スケジュール**
   - 診断フェーズ: 即座に開始
   - 修正フェーズ: 診断完了後
   - 検証フェーズ: 修正完了後

## 成功基準

### 必須（Must Have）
- [ ] AA4885のATBB状況更新が正常に同期される
- [ ] 診断スクリプトが正常に動作する
- [ ] 修正後の検証テストが全て成功する
- [ ] 既存の新規追加同期が引き続き動作する

### 推奨（Should Have）
- [ ] 他のフィールドの更新も正常に同期される
- [ ] 同期処理のパフォーマンスが向上する
- [ ] エラーハンドリングが強化される
- [ ] モニタリング機能が追加される

### 任意（Nice to Have）
- [ ] リアルタイム同期の実装
- [ ] 同期状態のダッシュボード
- [ ] 手動同期トリガーのUI
- [ ] 同期履歴の可視化

## 関連仕様

- `.kiro/specs/property-listing-atbb-status-auto-sync`: 新規物件追加時の同期（正常動作中）
- `backend/src/services/PropertyListingSyncService.ts`: 既存の同期サービス
- `backend/src/services/PropertyListingColumnMapper.ts`: カラムマッピング

## 次のステップ

1. **Phase 1: 診断**（優先度: 最高）
   - 診断スクリプトの作成
   - AA4885の状態確認
   - 根本原因の特定

2. **Phase 2: 修正**（優先度: 高）
   - 更新検出ロジックの実装
   - 更新処理の実装
   - エラーハンドリングの追加

3. **Phase 3: 検証**（優先度: 高）
   - テストケースの作成
   - AA4885での検証
   - 複数物件での検証

4. **Phase 4: 予防**（優先度: 中）
   - ドキュメントの更新
   - モニタリングの強化
   - ガイドラインの作成

## 備考

- この問題は既存の自動同期機能の拡張であり、新規機能の追加ではない
- 診断結果によっては、要件が変更される可能性がある
- AA4885は代表的な例であり、全ての既存物件が対象
