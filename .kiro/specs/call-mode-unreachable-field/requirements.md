# 通話モード「不通」フィールド機能 - 要件定義

## 1. 概要

通話モードページに「不通」フィールドを追加し、売主との通話状況を記録できるようにします。このフィールドは反響日付が2026年1月1日以降の売主に対して必須項目となります。未選択の場合は「当日TEL分_未着手」ステータスが表示されます。

## 2. ユーザーストーリー

### US-1: 不通フィールドの表示と入力
**As a** 営業担当者  
**I want to** 通話モードで売主の通話状況（不通/通電OK）を記録したい  
**So that** 売主との連絡状況を正確に管理できる

**受入基準:**
- 通話モードページの「通話メモ入力」セクションに「不通」フィールドが表示される
- 反響日付が2026年1月1日以降の売主の場合のみ表示される
- ラジオボタンで「不通」または「通電OK」を選択できる
- 必須項目として赤いアスタリスク（*）が表示される
- 選択しない場合は保存ボタンが無効化される

### US-2: スプレッドシートとの同期
**As a** システム管理者  
**I want to** 不通フィールドがスプレッドシートのJ列と同期される  
**So that** データの一貫性が保たれる

**受入基準:**
- 不通フィールドの値がスプレッドシートのJ列（カラム名：不通）と同期される
- 「不通」を選択した場合、スプレッドシートに「不通」と記録される
- 「通電OK」を選択した場合、スプレッドシートに「通電OK」と記録される

### US-3: ステータス計算への影響
**As a** 営業担当者  
**I want to** 不通フィールドの状態に応じて適切なステータスが表示される  
**So that** 対応が必要な売主を一目で識別できる

**受入基準:**
- 不通フィールドが「不通」の場合、売主リストのステータスに「不通」が表示される
- 不通フィールドが「通電OK」の場合、「不通」ステータスは表示されない
- 不通フィールドが未選択（NULL）で、以下の条件を満たす場合、「当日TEL分_未着手」ステータスが表示される：
  - 次電日が今日以前
  - ステータスに「追客中」が含まれる
  - 反響日付が2026年1月1日以降
  - 不通でない
- 不通フィールドが選択済み（「不通」または「通電OK」）の場合、「当日TEL」ステータスが表示される（電話担当が割り当てられている場合）

## 3. 機能要件

### FR-1: UIコンポーネント
- 通話モードページの「通話メモ入力」セクションに「不通」フィールドを追加
- ラジオボタンで以下の選択肢を提供:
  - 不通
  - 通電OK
- 反響日付が2026年1月1日以降の売主の場合のみ表示
- 必須項目として赤いアスタリスク（*）を表示
- 選択しない場合は保存ボタンを無効化

### FR-2: データベーススキーマ
- `sellers`テーブルに`unreachable_status`カラムを追加
- データ型: `VARCHAR(20) NULL`
- 有効な値: `'不通'`, `'通電OK'`, `NULL`
- CHECK制約で有効な値のみを許可

### FR-3: スプレッドシート同期
- スプレッドシートのJ列（カラム名：不通）と同期
- 双方向同期（スプレッドシート→DB、DB→スプレッドシート）

### FR-4: ステータス計算ロジック
- `unreachableStatus`フィールドが`'不通'`の場合、「不通」ステータスを表示
- `unreachableStatus`フィールドが`'通電OK'`の場合、「不通」ステータスを表示しない
- `unreachableStatus`フィールドが`NULL`で、以下の条件を満たす場合、「当日TEL分_未着手」ステータスを表示：
  - 次電日が今日以前
  - ステータスに「追客中」が含まれる
  - 反響日付が2026年1月1日以降
  - 不通でない
- `unreachableStatus`フィールドが選択済み（`'不通'`または`'通電OK'`）の場合、「当日TEL」ステータスを表示（電話担当が割り当てられている場合）
- 既存の`is_unreachable`および`not_reachable`フィールドとの互換性を維持

## 4. 非機能要件

### NFR-1: パフォーマンス
- 不通フィールドの保存は1秒以内に完了する
- ステータス計算は既存のパフォーマンスに影響を与えない

### NFR-2: データ整合性
- スプレッドシートとデータベース間のデータ整合性を保つ
- トランザクション処理でデータの一貫性を保証

### NFR-3: 後方互換性
- 既存の`is_unreachable`および`not_reachable`フィールドとの互換性を維持
- 既存の売主データ（`unreachable_status`がNULL）は「当日TEL分_未着手」ステータスが表示される

## 5. 制約事項

### C-1: 表示条件
- 反響日付が2026年1月1日以降の売主のみに表示
- 反響日付が2026年1月1日より前の売主には表示されない

### C-2: 必須項目
- 反響日付が2026年1月1日以降の売主の場合、不通フィールドは必須
- 選択しない場合は保存できない

### C-3: 有効な値
- 「不通」または「通電OK」のみ選択可能
- NULL（未選択）は既存データのみ許可

## 6. 依存関係

- スプレッドシート同期機能
- 売主ステータス計算ロジック
- 通話モードページUI

## 7. 受入テスト

### AT-1: 不通フィールドの表示
1. 反響日付が2026年1月1日以降の売主の通話モードページを開く
2. 「不通」フィールドが表示されることを確認
3. ラジオボタンで「不通」と「通電OK」が選択できることを確認
4. 必須項目のアスタリスク（*）が表示されることを確認

### AT-2: 必須項目のバリデーション
1. 反響日付が2026年1月1日以降の売主の通話モードページを開く
2. 通話メモを入力
3. 不通フィールドを選択せずに保存ボタンをクリック
4. 保存ボタンが無効化されていることを確認

### AT-3: スプレッドシート同期
1. 通話モードで「不通」を選択して保存
2. スプレッドシートのJ列に「不通」が記録されることを確認
3. 通話モードで「通電OK」を選択して保存
4. スプレッドシートのJ列に「通電OK」が記録されることを確認

### AT-4: ステータス計算（当日TEL分_未着手）
1. 以下の条件を満たす既存の売主（`unreachable_status`がNULL）を確認：
   - 次電日: 今日以前
   - ステータス: 「追客中」を含む
   - 反響日付: 2026年1月1日以降
2. 売主リストで「当日TEL分_未着手」ステータスが表示されることを確認
3. 不通フィールドを「不通」に変更して保存
4. 売主リストで「当日TEL分_未着手」ステータスが表示されなくなることを確認
5. 売主リストで「不通」ステータスが表示されることを確認

### AT-5: ステータス計算（当日TEL）
1. 以下の条件を満たす売主を作成：
   - 不通フィールド: 通電OK
   - 次電日: 今日以前
   - ステータス: 「追客中」を含む
   - 反響日付: 2026年1月1日以降
   - 電話担当: 割り当てあり
2. 売主リストで「当日TEL（担当名）」ステータスが表示されることを確認
3. 「当日TEL分_未着手」ステータスは表示されないことを確認

### AT-6: 反響日付による表示制御
1. 反響日付が2026年1月1日より前の売主の通話モードページを開く
2. 「不通」フィールドが表示されないことを確認
3. 反響日付が2026年1月1日以降の売主の通話モードページを開く
4. 「不通」フィールドが表示されることを確認

## 8. ステータスの優先順位と条件

以下の順序でステータスが判定されます：

1. **不通**: `unreachableStatus`が「不通」の場合
2. **訪問日前日**: 訪問日が明日（または木曜訪問の場合は火曜日）
3. **当日TEL分_未着手**: 
   - `unreachableStatus`がNULL（未選択）
   - 次電日が今日以前
   - ステータスに「追客中」が含まれる
   - 反響日付が2026年1月1日以降
   - 不通でない
4. **当日TEL（担当名）**: 
   - `unreachableStatus`が選択済み（「不通」または「通電OK」）
   - 電話担当が割り当てられている
   - 次電日が今日以前
   - ステータスに「追客中」が含まれる
   - 反響日付が2026年1月1日以降
5. **当日TEL**: 
   - `unreachableStatus`が選択済み（「不通」または「通電OK」）
   - 電話担当が未割り当て
   - 次電日が今日以前
   - ステータスに「追客中」が含まれる
   - 反響日付が2026年1月1日以降
6. **Pinrich空欄**: Pinrichフィールドが空欄
