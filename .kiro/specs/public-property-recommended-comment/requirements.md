# おすすめコメント表示機能 - 要件定義書

## 概要

公開物件詳細ページの画像ギャラリーの下に、業務リストスプレッドシートから取得した「おすすめコメント」を表示する機能を追加します。

## 用語集

- **おすすめコメント**: 業務リストスプレッドシートの「athome」シートに記載された物件の推薦コメント
- **業務リスト**: 物件情報を管理するGoogle スプレッドシート
- **athomeシート**: 業務リスト内の特定のシート名
- **物件番号**: 物件を一意に識別する番号（例: AA12345）
- **物件タイプ**: 土地、戸建て、マンションの3種類

## データソース仕様

### スプレッドシート情報
- **スプレッドシート**: 業務リスト（既存のGoogleSheetsClient経由でアクセス）
- **シート名**: `athome`
- **キー**: 物件番号で物件を特定

### セル位置（物件タイプ別）

| 物件タイプ | セル位置 |
|-----------|---------|
| 土地 | B53 |
| 戸建て | B142 |
| マンション | B150 |

## 要件

### 要件1: おすすめコメントの取得

**ユーザーストーリー**: システム管理者として、物件のおすすめコメントをスプレッドシートから自動取得したい

#### 受入基準

1. バックエンドAPIが物件番号を受け取り、業務リストの「athome」シートからデータを取得すること
2. 物件タイプに応じて正しいセル（B53/B142/B150）からコメントを読み取ること
3. コメントが空の場合、nullまたは空文字列を返すこと
4. スプレッドシートへのアクセスエラー時、適切なエラーハンドリングを行うこと
5. 既存のGoogleSheetsClientサービスを再利用すること


### 要件2: フロントエンドでの表示

**ユーザーストーリー**: 潜在的な購入者として、物件の画像の下におすすめコメントを見たい

#### 受入基準

1. 公開物件詳細ページ（PublicPropertyDetailPage）の画像ギャラリーの直下にコメントセクションを配置すること
2. コメントが存在する場合のみ、セクションを表示すること
3. コメントが空またはnullの場合、セクション全体を非表示にすること
4. コメントは読みやすいスタイルで表示すること（適切なフォントサイズ、行間、余白）
5. レスポンシブデザインに対応し、モバイル・タブレット・デスクトップで適切に表示されること

### 要件3: APIエンドポイント

**ユーザーストーリー**: 開発者として、おすすめコメントを取得するための明確なAPIエンドポイントが欲しい

#### 受入基準

1. 新しいエンドポイント `GET /api/public/properties/:id/recommended-comment` を作成すること
2. 物件IDをパラメータとして受け取ること
3. レスポンス形式:
   ```json
   {
     "comment": "string | null",
     "propertyType": "土地 | 戸建て | マンション"
   }
   ```
4. 物件が見つからない場合、404エラーを返すこと
5. スプレッドシートアクセスエラー時、500エラーと適切なエラーメッセージを返すこと

### 要件4: エラーハンドリング

**ユーザーストーリー**: ユーザーとして、エラーが発生してもページが正常に表示されることを期待する

#### 受入基準

1. スプレッドシートへのアクセスが失敗した場合、コメントセクションを非表示にすること
2. エラーをコンソールにログ出力すること（デバッグ用）
3. ユーザーにはエラーメッセージを表示せず、コメントなしの状態で物件情報を表示すること
4. 物件タイプが不明な場合、コメント取得をスキップすること

### 要件5: パフォーマンス

**ユーザーストーリー**: ユーザーとして、ページの読み込みが遅くならないことを期待する

#### 受入基準

1. おすすめコメントの取得は非同期で行い、ページの初期表示をブロックしないこと
2. コメント取得中はローディングインジケーターを表示すること
3. コメント取得に失敗しても、他の物件情報は正常に表示されること
4. スプレッドシートへのアクセスは適切にキャッシュすること（既存のRateLimiterを使用）

## 技術仕様

### バックエンド実装

**新規サービス**: `RecommendedCommentService`
- 物件番号と物件タイプから適切なセル位置を決定
- GoogleSheetsClientを使用してathomeシートからコメントを取得
- エラーハンドリングとログ出力

**新規ルート**: `/api/public/properties/:id/recommended-comment`
- PropertyListingServiceから物件情報を取得
- RecommendedCommentServiceを呼び出してコメントを取得
- JSON形式でレスポンスを返す

### フロントエンド実装

**新規コンポーネント**: `RecommendedCommentSection`
- おすすめコメントを表示する独立したコンポーネント
- ローディング状態とエラー状態を管理
- Material-UIのPaperコンポーネントを使用してスタイリング

**既存ページの更新**: `PublicPropertyDetailPage`
- PropertyImageGalleryの直下にRecommendedCommentSectionを配置
- useQueryフックを使用してコメントを非同期取得

## 非機能要件

1. **セキュリティ**: スプレッドシートの認証情報は環境変数で管理
2. **可用性**: スプレッドシートアクセスエラーがページ全体に影響しないこと
3. **保守性**: コードは既存のアーキテクチャパターンに従うこと
4. **テスト可能性**: ユニットテストとインテグレーションテストを作成すること

## 制約事項

1. 既存のGoogleSheetsClient実装を変更しないこと
2. 公開物件詳細ページのレイアウトを大きく変更しないこと
3. スプレッドシートの「athome」シート構造は変更しないこと
4. セル位置（B53, B142, B150）は固定値として扱うこと

## 今後の拡張可能性

1. おすすめコメントの管理画面（社内用）
2. コメントの履歴管理
3. 複数言語対応
4. コメントのリッチテキスト対応（画像、リンクなど）
