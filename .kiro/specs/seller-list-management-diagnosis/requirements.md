# 売主リスト管理システム診断ツール - 要件定義書

## 概要

本診断ツールは、売主リスト管理システムの動作状況を包括的に診断し、問題の早期発見と解決を支援するためのツールです。システムの各機能が正常に動作しているか、データの整合性が保たれているか、パフォーマンスが要件を満たしているかを自動的にチェックします。

## 目的

1. **問題の早期発見**: システムの異常や不具合を早期に検出する
2. **データ整合性の検証**: データベースとスプレッドシートのデータが整合しているか確認する
3. **パフォーマンス監視**: システムのパフォーマンスが要件を満たしているか検証する
4. **運用支援**: 管理者が問題を迅速に特定し、解決できるようにする

## 診断項目

### 1. データベース接続診断

**目的**: データベースへの接続が正常に確立できるか確認する

#### 診断内容

1. **接続テスト**
   - PostgreSQL/Supabaseへの接続が確立できるか
   - 接続プールが正常に動作しているか
   - 接続タイムアウトが適切に設定されているか

2. **認証情報の検証**
   - データベース認証情報が正しいか
   - 環境変数が正しく設定されているか
   - 接続文字列の形式が正しいか

3. **権限の確認**
   - 必要なテーブルへのアクセス権限があるか
   - CRUD操作が実行できるか

#### 期待される結果

- ✅ データベース接続が1秒以内に確立される
- ✅ 全ての必要なテーブルにアクセスできる
- ✅ 認証情報が正しく設定されている

#### エラー時の対応

- ❌ 接続失敗: 環境変数とネットワーク設定を確認
- ❌ 認証エラー: データベース認証情報を確認
- ❌ 権限エラー: データベースユーザーの権限を確認

### 2. テーブル構造診断

**目的**: データベーステーブルが正しく作成されているか確認する

#### 診断内容

1. **必須テーブルの存在確認**
   - `sellers` テーブル
   - `properties` テーブル
   - `valuations` テーブル
   - `activity_logs` テーブル
   - `follow_ups` テーブル
   - `appointments` テーブル
   - `employees` テーブル
   - `sync_logs` テーブル

2. **カラム構造の検証**
   - 各テーブルに必要なカラムが存在するか
   - カラムのデータ型が正しいか
   - NOT NULL制約が適切に設定されているか
   - デフォルト値が設定されているか

3. **インデックスの確認**
   - パフォーマンス要件を満たすインデックスが作成されているか
   - 検索に使用されるカラムにインデックスがあるか
   - 外部キーにインデックスがあるか

#### 期待される結果

- ✅ 全ての必須テーブルが存在する
- ✅ 全てのカラムが正しいデータ型で作成されている
- ✅ 必要なインデックスが全て作成されている

#### エラー時の対応

- ❌ テーブル不足: マイグレーションスクリプトを実行
- ❌ カラム不足: ALTER TABLE文で追加
- ❌ インデックス不足: CREATE INDEX文で作成

### 3. データ整合性診断

**目的**: データベース内のデータが整合性を保っているか確認する

#### 診断内容

1. **売主データの整合性**
   - 売主番号が一意であるか
   - 売主番号の形式が正しいか（AA + 5桁）
   - 必須フィールドが全て入力されているか
   - 暗号化されたフィールドが正しく暗号化されているか

2. **物件データの整合性**
   - 全ての売主に物件データが紐付いているか
   - 物件種別が正しい値であるか
   - 面積や築年数が妥当な範囲内か

3. **査定データの整合性**
   - 査定額が妥当な範囲内か（100万円〜10億円）
   - 査定額1 < 査定額2 < 査定額3の関係が成立しているか
   - 査定日が妥当な日付か

4. **外部キー制約の検証**
   - 孤立したレコードが存在しないか
   - 参照整合性が保たれているか

#### 期待される結果

- ✅ 全ての売主番号が一意である
- ✅ 全ての必須フィールドが入力されている
- ✅ 査定額が妥当な範囲内である
- ✅ 外部キー制約が全て満たされている

#### エラー時の対応

- ❌ 重複売主番号: 重複レコードを特定し、マージまたは削除
- ❌ 必須フィールド未入力: データを補完
- ❌ 不正な査定額: 再計算または手動修正
- ❌ 孤立レコード: 親レコードを作成または子レコードを削除

### 4. スプレッドシート同期診断

**目的**: スプレッドシートとデータベースの同期が正常に動作しているか確認する

#### 診断内容

1. **Google Sheets API接続**
   - Google Sheets APIへの接続が確立できるか
   - 認証情報が正しいか
   - スプレッドシートへのアクセス権限があるか

2. **データ同期状態の確認**
   - 最終同期日時が記録されているか
   - 同期エラーが発生していないか
   - 同期ログが正しく記録されているか

3. **データ差分の検出**
   - スプレッドシートとデータベースでデータに差分があるか
   - 差分がある場合、どちらが最新か
   - 同期が必要なレコード数

4. **同期パフォーマンスの測定**
   - 同期処理にかかる時間
   - 1レコードあたりの処理時間
   - エラー率

#### 期待される結果

- ✅ Google Sheets APIに接続できる
- ✅ 最終同期が5分以内に実行されている
- ✅ 同期エラー率が1%未満である
- ✅ 1000件の同期が30秒以内に完了する

#### エラー時の対応

- ❌ API接続失敗: 認証情報とネットワーク設定を確認
- ❌ 同期遅延: 同期頻度を調整または手動同期を実行
- ❌ 同期エラー多発: エラーログを確認し、原因を特定
- ❌ パフォーマンス低下: バッチサイズを調整

### 5. 暗号化機能診断

**目的**: 個人情報の暗号化が正しく動作しているか確認する

#### 診断内容

1. **暗号化設定の確認**
   - 暗号化キーが正しく設定されているか
   - 暗号化アルゴリズムがAES-256-GCMであるか
   - 暗号化キーが環境変数から読み込まれているか

2. **暗号化・復号化テスト**
   - テストデータを暗号化できるか
   - 暗号化されたデータを復号化できるか
   - 復号化後のデータが元のデータと一致するか

3. **暗号化対象フィールドの確認**
   - 氏名が暗号化されているか
   - 電話番号が暗号化されているか
   - メールアドレスが暗号化されているか

4. **パフォーマンステスト**
   - 暗号化処理が500ms以内に完了するか
   - 復号化処理が500ms以内に完了するか

#### 期待される結果

- ✅ 暗号化キーが正しく設定されている
- ✅ 暗号化・復号化が正常に動作する
- ✅ 全ての個人情報が暗号化されている
- ✅ 暗号化処理が500ms以内に完了する

#### エラー時の対応

- ❌ 暗号化キー未設定: 環境変数を設定
- ❌ 暗号化失敗: 暗号化ライブラリを確認
- ❌ 復号化失敗: 暗号化キーが変更されていないか確認
- ❌ パフォーマンス低下: 暗号化アルゴリズムを見直し

### 6. 認証・認可診断

**目的**: 認証・認可機能が正しく動作しているか確認する

#### 診断内容

1. **Supabase認証の確認**
   - Supabase認証が有効になっているか
   - JWTトークンが正しく発行されるか
   - トークンの有効期限が適切か（24時間）

2. **セッション管理の確認**
   - セッションが正しく作成されるか
   - セッションタイムアウトが30分に設定されているか
   - セッションが正しく破棄されるか

3. **権限チェックの確認**
   - ユーザーロールが正しく判定されるか
   - 権限のないユーザーがアクセスできないか
   - アクセスログが記録されるか

4. **ログイン失敗制限の確認**
   - 連続ログイン失敗が5回で制限されるか
   - 15分後にロックが解除されるか

#### 期待される結果

- ✅ Supabase認証が正常に動作する
- ✅ JWTトークンが正しく発行される
- ✅ セッション管理が正常に動作する
- ✅ 権限チェックが正しく機能する
- ✅ ログイン失敗制限が機能する

#### エラー時の対応

- ❌ 認証失敗: Supabase設定を確認
- ❌ トークン発行失敗: JWT設定を確認
- ❌ セッション管理エラー: セッションストアを確認
- ❌ 権限チェック失敗: ロール定義を確認

### 7. パフォーマンス診断

**目的**: システムのパフォーマンスが要件を満たしているか確認する

#### 診断内容

1. **API応答時間の測定**
   - 売主一覧取得API: P95 < 500ms
   - 売主詳細取得API: P95 < 500ms
   - 売主登録API: < 2秒
   - 検索API: < 1秒

2. **データベースクエリの測定**
   - 平均クエリ実行時間 < 100ms
   - スロークエリの検出
   - インデックスの使用状況

3. **メモリ使用量の測定**
   - サーバーメモリ使用量 < 2GB
   - メモリリークの検出

4. **同時接続数のテスト**
   - 100ユーザーの同時接続に耐えられるか
   - レスポンスタイムの劣化がないか

#### 期待される結果

- ✅ 全てのAPI応答時間が要件を満たす
- ✅ データベースクエリが100ms以内に完了する
- ✅ メモリ使用量が2GB以下である
- ✅ 100ユーザーの同時接続に耐えられる

#### エラー時の対応

- ❌ API応答遅延: クエリの最適化、キャッシュの導入
- ❌ スロークエリ: インデックスの追加、クエリの書き換え
- ❌ メモリ不足: メモリリークの修正、サーバースペックの増強
- ❌ 同時接続制限: 接続プールの調整、スケールアウト

### 8. 自動査定機能診断

**目的**: 自動査定機能が正しく動作しているか確認する

#### 診断内容

1. **査定計算ロジックの検証**
   - 戸建ての査定額が正しく計算されるか
   - 土地評価額の計算が正しいか
   - 建物評価額の計算が正しいか
   - 減価率の計算が正しいか

2. **異常値チェックの確認**
   - 査定額が100万円未満の場合に警告が表示されるか
   - 査定額が10億円を超える場合に警告が表示されるか

3. **査定履歴の保存確認**
   - 査定履歴が正しく保存されるか
   - 過去の査定額が保持されるか

4. **パフォーマンステスト**
   - 査定計算が1秒以内に完了するか

#### 期待される結果

- ✅ 査定額が正しく計算される
- ✅ 異常値チェックが機能する
- ✅ 査定履歴が保存される
- ✅ 査定計算が1秒以内に完了する

#### エラー時の対応

- ❌ 計算エラー: 計算式を確認
- ❌ 異常値チェック失敗: 閾値を確認
- ❌ 履歴保存失敗: データベース接続を確認
- ❌ パフォーマンス低下: 計算ロジックを最適化

### 9. 重複検出機能診断

**目的**: 重複検出機能が正しく動作しているか確認する

#### 診断内容

1. **重複検出ロジックの検証**
   - 電話番号での重複検出が機能するか
   - メールアドレスでの重複検出が機能するか
   - 複数の条件での重複検出が機能するか

2. **重複表示の確認**
   - 重複が検出された場合に警告が表示されるか
   - 過去の売主情報が表示されるか

3. **パフォーマンステスト**
   - 重複検出が1秒以内に完了するか

#### 期待される結果

- ✅ 重複検出が正しく機能する
- ✅ 重複時に警告が表示される
- ✅ 重複検出が1秒以内に完了する

#### エラー時の対応

- ❌ 重複検出失敗: 検出ロジックを確認
- ❌ 警告表示失敗: フロントエンドコードを確認
- ❌ パフォーマンス低下: インデックスを追加

### 10. 外部API連携診断

**目的**: 外部API（Google Calendar、Gmail、Google Chat）との連携が正常に動作しているか確認する

#### 診断内容

1. **Google Calendar API**
   - カレンダーイベントの作成ができるか
   - カレンダーイベントの更新ができるか
   - カレンダーイベントの削除ができるか
   - タイムアウトが10秒に設定されているか

2. **Gmail API**
   - メール送信ができるか
   - メールテンプレートが正しく適用されるか
   - 送信履歴が記録されるか

3. **Google Chat API**
   - チャット通知が送信できるか
   - 通知内容が正しいか

4. **エラーハンドリングの確認**
   - API呼び出し失敗時に適切なエラーメッセージが表示されるか
   - リトライ処理が機能するか

#### 期待される結果

- ✅ 全ての外部APIに接続できる
- ✅ API呼び出しが正常に完了する
- ✅ タイムアウトが適切に設定されている
- ✅ エラーハンドリングが機能する

#### エラー時の対応

- ❌ API接続失敗: 認証情報とネットワーク設定を確認
- ❌ タイムアウト: タイムアウト時間を調整
- ❌ エラーハンドリング失敗: エラー処理コードを確認

## 診断実行方法

### 1. 手動診断

管理者が診断スクリプトを手動で実行する方法

```bash
# 全診断項目を実行
npm run diagnose:all

# 特定の診断項目のみ実行
npm run diagnose:database
npm run diagnose:sync
npm run diagnose:performance
```

### 2. 自動診断

システムが定期的に自動で診断を実行する方法

- 毎日午前3時に全診断を実行
- 診断結果をログに記録
- 異常が検出された場合は管理者に通知

### 3. オンデマンド診断

ユーザーが管理画面から診断を実行する方法

- 管理画面に「診断実行」ボタンを配置
- ボタンクリックで診断を実行
- 診断結果を画面に表示

## 診断結果の出力形式

### コンソール出力

```
=== 売主リスト管理システム診断結果 ===

[データベース接続診断]
✅ データベース接続: 正常
✅ 認証情報: 正常
✅ 権限: 正常

[テーブル構造診断]
✅ 必須テーブル: 全て存在
✅ カラム構造: 正常
⚠️  インデックス: 一部不足（sellers.phone_numberにインデックスがありません）

[データ整合性診断]
✅ 売主データ: 正常
❌ 物件データ: 異常（売主AA00123に物件データが紐付いていません）
✅ 査定データ: 正常

...

=== 診断完了 ===
正常: 25項目
警告: 3項目
エラー: 2項目
```

### JSON出力

```json
{
  "timestamp": "2025-01-10T10:00:00Z",
  "summary": {
    "total": 30,
    "passed": 25,
    "warning": 3,
    "failed": 2
  },
  "results": [
    {
      "category": "database",
      "item": "connection",
      "status": "passed",
      "message": "データベース接続が正常に確立されました"
    },
    {
      "category": "data_integrity",
      "item": "property_linkage",
      "status": "failed",
      "message": "売主AA00123に物件データが紐付いていません",
      "details": {
        "seller_number": "AA00123",
        "seller_name": "[暗号化]"
      }
    }
  ]
}
```

## 診断結果の活用

### 1. 問題の優先順位付け

- **Critical（緊急）**: システムが動作しない、データ損失の可能性
- **High（高）**: 主要機能が使用できない
- **Medium（中）**: 一部機能に制限がある
- **Low（低）**: パフォーマンスの軽微な低下

### 2. 修正アクションの提案

診断結果に基づいて、具体的な修正アクションを提案

- インデックスの追加
- マイグレーションの実行
- 設定の変更
- データの修正

### 3. 定期的な監視

- 診断結果を時系列で記録
- トレンドを分析
- 問題の予兆を検出

## 非機能要件

### パフォーマンス

- 全診断の実行時間: 5分以内
- 個別診断の実行時間: 30秒以内
- 診断実行中もシステムは通常通り動作すること

### 信頼性

- 診断スクリプトがシステムに悪影響を与えないこと
- 診断失敗時もシステムは継続して動作すること
- 診断結果が正確であること

### 保守性

- 診断項目の追加が容易であること
- 診断ロジックが理解しやすいこと
- 診断結果が分かりやすいこと

## 今後の拡張

### Phase 2で追加予定の診断項目

- フロントエンドパフォーマンス診断
- セキュリティ診断（脆弱性スキャン）
- バックアップ・リストア診断
- ログ分析診断
- ユーザー行動分析

### Phase 3で追加予定の機能

- 自動修復機能
- 予測分析（問題の予兆検出）
- ダッシュボード（診断結果の可視化）
- アラート機能（Slack、メール通知）
