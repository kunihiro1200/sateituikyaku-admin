# 別府市エリアマッピング完全データ更新ガイド

## 概要

このガイドでは、提供された別府市の詳細な住所データ（⑨-⑮、㊷、㊸）を
データベースに投入し、既存物件の配信エリアを更新する手順を説明します。

## 前提条件

- データベースに `beppu_area_mapping` テーブルが作成済み
- Supabase接続情報が `.env` ファイルに設定済み
- Node.js と TypeScript がインストール済み

## 実装手順

### ステップ1: データ解析

提供された生データを解析し、データベース投入用のJSON形式に変換します。

```bash
cd backend
npx ts-node parse-beppu-area-data.ts
```

**実行結果:**
- `beppu-area-mappings.json` ファイルが生成される
- データ統計が表示される
- サンプルデータが表示される

**確認ポイント:**
- 合計地域数が妥当か
- 複数エリアに所属する地域が正しく処理されているか
- 地域名の正規化が適切か

### ステップ2: データ投入（Dry Run）

実際にデータベースを更新する前に、Dry Runで確認します。

```bash
npx ts-node insert-complete-beppu-data.ts --dry-run
```

**確認ポイント:**
- 投入予定のレコード数
- エラーが発生しないか

### ステップ3: データ投入（本番）

Dry Runで問題がなければ、実際にデータを投入します。

```bash
npx ts-node insert-complete-beppu-data.ts --force
```

**実行内容:**
1. 既存の `beppu_area_mapping` テーブルのデータをクリア
2. 新しいマッピングデータを投入
3. データベース内のデータを検証
4. 統計情報を表示

**注意:** このコマンドは既存データを削除します。必要に応じてバックアップを取ってください。


### ステップ4: マッピング検証

投入したデータが正しく機能するか、実際の住所でテストします。

```bash
npx ts-node verify-beppu-area-mapping.ts
```

**テストケース例:**
- `別府市南立石一区1-2-3` → `⑨` を含む
- `別府市荘園北町3-15` → `⑩㊸`
- `別府市中央町5-20` → `⑮㊷`
- `別府市亀川四の湯町１区2-5` → `⑪㊸`
- `別府市東荘園4丁目10-5` → `⑩㊸`

**確認ポイント:**
- 各住所から正しいエリア番号が取得できるか
- 複数エリアに所属する地域が正しく処理されているか
- 丁目の表記揺れ（全角/半角）が正しく処理されているか

### ステップ5: 既存物件の配信エリア更新（Dry Run）

別府市の既存物件の配信エリアを新しいマッピングで再計算します。
まずはDry Runで影響範囲を確認します。

```bash
npx ts-node backfill-beppu-distribution-areas.ts --dry-run
```

**確認ポイント:**
- 更新対象の物件数
- 変更される配信エリアの内容
- エラーが発生する物件がないか

### ステップ6: 既存物件の配信エリア更新（本番）

Dry Runで問題がなければ、実際に更新します。

```bash
npx ts-node backfill-beppu-distribution-areas.ts --force
```

**実行内容:**
1. 別府市の全物件を取得
2. 各物件の住所から配信エリアを再計算
3. 変更があった物件のみデータベースを更新
4. 更新統計を表示

**注意:** この処理には時間がかかる場合があります。

## データ構造

### 提供されたデータの特徴

1. **複数エリアへの所属**
   - 多くの地域が複数のエリア番号に属している
   - 例: 荘園北町 → ⑩（中部中学校区）+ ㊸（鉄輪線より下）

2. **特殊な条件付き地域**
   - 荘園（白菊寮を除く） → ⑨
   - 荘園（白菊寮のみ） → ⑩
   - 鶴見（7組・9組・ルミエールの丘を除く） → ⑨
   - 鶴見（7組・9組・ルミエールの丘） → ⑩

3. **表記揺れ**
   - 丁目の数字: 全角（１丁目）と半角（1丁目）が混在
   - 解析スクリプトで自動的に正規化

### データベーススキーマ

```sql
CREATE TABLE beppu_area_mapping (
  id SERIAL PRIMARY KEY,
  school_district TEXT NOT NULL,
  region_name TEXT NOT NULL,
  distribution_areas TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### マッピングロジック

`BeppuAreaMappingService` は以下のロジックで配信エリアを決定します:

1. 住所から地域名を抽出（優先順位: 丁目付き > 区付き > 町付き > その他）
2. 地域名でデータベースを検索
3. 複数のマッピングがある場合は全てのエリアを統合
4. エリア番号をソートして返す

## トラブルシューティング

### データ投入時のエラー

**エラー:** `Missing SUPABASE_URL or SUPABASE_SERVICE_KEY`
- **原因:** 環境変数が設定されていない
- **解決:** `backend/.env` ファイルを確認

**エラー:** `Table does not exist`
- **原因:** `beppu_area_mapping` テーブルが作成されていない
- **解決:** `migrations/048_add_beppu_area_mapping.sql` を実行

### マッピングが見つからない

**問題:** 特定の住所でエリア番号が取得できない
- **原因1:** 地域名の抽出ロジックが不適切
- **解決1:** `BeppuAreaMappingService.extractRegionName()` を確認
- **原因2:** データベースに該当地域が登録されていない
- **解決2:** データベースの内容を確認し、必要に応じて追加

### 配信エリアが期待と異なる

**問題:** 物件の配信エリアが期待と異なる
- **原因1:** 複数エリアへの所属が正しく処理されていない
- **解決1:** `lookupDistributionAreas()` のロジックを確認
- **原因2:** Google Map URLの座標ベースの計算が影響している
- **解決2:** `PropertyDistributionAreaCalculator` の統合ロジックを確認

## 検証チェックリスト

データ更新後、以下を確認してください:

- [ ] データベースに全ての地域が登録されている
- [ ] 複数エリアに所属する地域が正しく処理されている
- [ ] テストケースが全て成功する
- [ ] 既存物件の配信エリアが更新されている
- [ ] エラーログに問題がない
- [ ] 実際の物件で配信エリアが正しく表示される

## 次のステップ

データ更新が完了したら:

1. フロントエンドで物件詳細ページを確認
2. Gmail配信機能で正しい買主が抽出されるか確認
3. 必要に応じてマッピングデータを微調整
4. ドキュメントを更新

## 参考資料

- [DATA_UPDATE_TASK.md](./DATA_UPDATE_TASK.md) - タスクの詳細
- [requirements.md](./requirements.md) - 要件定義
- [design.md](./design.md) - 設計ドキュメント
- [IMPLEMENTATION_COMPLETE.md](./IMPLEMENTATION_COMPLETE.md) - 実装完了レポート
