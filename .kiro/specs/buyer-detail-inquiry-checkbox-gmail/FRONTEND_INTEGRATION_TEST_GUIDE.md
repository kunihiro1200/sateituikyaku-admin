# フロントエンド統合テストガイド

## 概要

買主詳細ページの問合せ履歴チェックボックスGmail送信機能のフロントエンド統合テストガイドです。

## テスト環境の準備

### 1. 開発サーバーの起動

```bash
# バックエンド
cd backend
npm run dev

# フロントエンド（別ターミナル）
cd frontend
npm run dev
```

### 2. テストデータの確認

- 問合せ履歴が複数ある買主を選択
- 各問合せ履歴に物件が紐付いていることを確認

## テストケース

### テストケース1: チェックボックス選択の基本動作

**目的**: チェックボックスで物件を選択できることを確認

**手順**:
1. 買主詳細ページを開く
2. 問合せ履歴テーブルを確認
3. 1つの問合せ履歴のチェックボックスをクリック

**期待結果**:
- ✅ チェックボックスがチェック状態になる
- ✅ 「1件選択中」と表示される
- ✅ BuyerGmailSendButtonが有効化される（青色）
- ✅ ボタンに「Gmail送信 (1件)」と表示される

**検証項目**:
- [ ] チェックボックスの視覚的フィードバック
- [ ] 選択数の表示
- [ ] ボタンの有効/無効状態
- [ ] ボタンのラベル

---

### テストケース2: 複数物件の選択

**目的**: 複数の物件を選択できることを確認

**手順**:
1. 買主詳細ページを開く
2. 3つの問合せ履歴のチェックボックスをクリック

**期待結果**:
- ✅ 3つのチェックボックスがチェック状態になる
- ✅ 「3件選択中」と表示される
- ✅ BuyerGmailSendButtonに「Gmail送信 (3件)」と表示される

**検証項目**:
- [ ] 複数選択の状態管理
- [ ] 選択数のカウント
- [ ] UIの更新

---

### テストケース3: 選択解除

**目的**: チェックボックスの選択を解除できることを確認

**手順**:
1. 2つの問合せ履歴を選択
2. 1つのチェックボックスをクリックして選択解除

**期待結果**:
- ✅ チェックボックスが未選択状態になる
- ✅ 「1件選択中」と表示される
- ✅ ボタンのラベルが「Gmail送信 (1件)」に更新される

**検証項目**:
- [ ] 選択解除の動作
- [ ] 選択数の更新
- [ ] UIの同期

---

### テストケース4: 全選択解除

**目的**: すべての選択を解除した場合の動作を確認

**手順**:
1. 2つの問合せ履歴を選択
2. 両方のチェックボックスをクリックして選択解除

**期待結果**:
- ✅ すべてのチェックボックスが未選択状態になる
- ✅ 選択数の表示が消える
- ✅ BuyerGmailSendButtonが無効化される（グレー）
- ✅ ボタンに「Gmail送信 (0件)」と表示される

**検証項目**:
- [ ] 完全な選択解除
- [ ] ボタンの無効化
- [ ] UIのクリーンアップ

---

### テストケース5: Gmail送信ボタンのクリック（選択なし）

**目的**: 物件未選択時のエラーハンドリングを確認

**手順**:
1. 買主詳細ページを開く
2. 何も選択せずにBuyerGmailSendButtonをクリック

**期待結果**:
- ✅ ボタンがクリックできない（無効状態）
- ✅ エラーメッセージは表示されない（ボタンが無効なため）

**検証項目**:
- [ ] ボタンの無効化
- [ ] クリックイベントの防止

---

### テストケース6: Gmail送信ボタンのクリック（1件選択）

**目的**: 1件選択時のGmail送信フローを確認

**手順**:
1. 買主詳細ページを開く
2. 1つの問合せ履歴を選択
3. BuyerGmailSendButtonをクリック

**期待結果**:
- ✅ PropertySelectionModalが表示されない
- ✅ TemplateSelectionModalが表示される
- ✅ モーダルに利用可能なテンプレートが表示される

**検証項目**:
- [ ] PropertySelectionModalのスキップ
- [ ] TemplateSelectionModalの表示
- [ ] テンプレート一覧の表示

---

### テストケース7: Gmail送信ボタンのクリック（複数件選択）

**目的**: 複数件選択時のGmail送信フローを確認

**手順**:
1. 買主詳細ページを開く
2. 3つの問合せ履歴を選択
3. BuyerGmailSendButtonをクリック

**期待結果**:
- ✅ PropertySelectionModalが表示されない
- ✅ TemplateSelectionModalが表示される
- ✅ モーダルに利用可能なテンプレートが表示される

**検証項目**:
- [ ] 複数物件選択時のフロー
- [ ] PropertySelectionModalのスキップ
- [ ] TemplateSelectionModalの表示

---

### テストケース8: テンプレート選択

**目的**: テンプレート選択後のメール作成画面を確認

**手順**:
1. 2つの問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. TemplateSelectionModalでテンプレートを選択

**期待結果**:
- ✅ BuyerEmailCompositionModalが表示される
- ✅ 選択した2つの物件情報が表示される
- ✅ メール本文に両方の物件情報が含まれる
- ✅ 物件番号、住所、価格などが正しく表示される

**検証項目**:
- [ ] BuyerEmailCompositionModalの表示
- [ ] 複数物件情報の表示
- [ ] メール本文のマージ
- [ ] データの正確性

---

### テストケース9: メール本文の確認（1件）

**目的**: 1件選択時のメール本文を確認

**手順**:
1. 1つの問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. テンプレートを選択
4. メール本文を確認

**期待結果**:
- ✅ 物件情報が正しくフォーマットされている
- ✅ 物件番号、住所、価格が含まれる
- ✅ テンプレートの変数が正しく置換されている

**検証項目**:
- [ ] 物件情報のフォーマット
- [ ] データの正確性
- [ ] テンプレート変数の置換

---

### テストケース10: メール本文の確認（複数件）

**目的**: 複数件選択時のメール本文を確認

**手順**:
1. 3つの問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. テンプレートを選択
4. メール本文を確認

**期待結果**:
- ✅ 3つの物件情報がすべて含まれる
- ✅ 各物件が区切られて表示される
- ✅ 物件の順序が一貫している
- ✅ すべての物件データが正確

**検証項目**:
- [ ] 複数物件の表示
- [ ] 物件の区切り
- [ ] データの順序
- [ ] データの正確性

---

### テストケース11: メール送信のキャンセル

**目的**: メール作成をキャンセルできることを確認

**手順**:
1. 2つの問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. テンプレートを選択
4. BuyerEmailCompositionModalで「キャンセル」をクリック

**期待結果**:
- ✅ モーダルが閉じる
- ✅ 選択状態が保持される（2件選択中のまま）
- ✅ ページの状態が変わらない

**検証項目**:
- [ ] モーダルのクローズ
- [ ] 選択状態の保持
- [ ] ページ状態の維持

---

### テストケース12: メール送信の成功

**目的**: メール送信が成功することを確認

**手順**:
1. 2つの問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. テンプレートを選択
4. メール内容を確認
5. 「送信」をクリック

**期待結果**:
- ✅ メールが送信される
- ✅ 成功メッセージが表示される
- ✅ モーダルが閉じる
- ✅ 選択状態がクリアされる（0件選択中）
- ✅ チェックボックスがすべて未選択になる

**検証項目**:
- [ ] メール送信の成功
- [ ] 成功メッセージ
- [ ] モーダルのクローズ
- [ ] 選択状態のクリア
- [ ] UIのリセット

---

### テストケース13: エラーハンドリング（物件データ取得失敗）

**目的**: 物件データ取得失敗時のエラーハンドリングを確認

**手順**:
1. 存在しない物件IDを持つ問合せ履歴を選択（テストデータ準備が必要）
2. BuyerGmailSendButtonをクリック

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ 「物件データの取得に失敗しました」というメッセージ
- ✅ モーダルが開かない
- ✅ 選択状態が保持される

**検証項目**:
- [ ] エラーメッセージの表示
- [ ] エラー内容の明確性
- [ ] 選択状態の保持

---

### テストケース14: エラーハンドリング（API通信エラー）

**目的**: API通信エラー時のエラーハンドリングを確認

**手順**:
1. ネットワークをオフラインにする（開発者ツールで設定）
2. 問合せ履歴を選択
3. BuyerGmailSendButtonをクリック

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ 「通信エラーが発生しました」というメッセージ
- ✅ モーダルが開かない

**検証項目**:
- [ ] ネットワークエラーの検出
- [ ] エラーメッセージの表示
- [ ] ユーザーへの適切なフィードバック

---

### テストケース15: 既存機能との互換性（テンプレート選択）

**目的**: テンプレート選択機能が正常に動作することを確認

**手順**:
1. 問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. TemplateSelectionModalで異なるテンプレートを選択

**期待結果**:
- ✅ すべてのテンプレートが表示される
- ✅ テンプレートの説明が表示される
- ✅ 選択したテンプレートに応じてメール本文が変わる

**検証項目**:
- [ ] テンプレート一覧の表示
- [ ] テンプレート選択の動作
- [ ] メール本文の変更

---

### テストケース16: 既存機能との互換性（送信者選択）

**目的**: 送信者選択機能が正常に動作することを確認

**手順**:
1. 問合せ履歴を選択
2. BuyerGmailSendButtonをクリック
3. テンプレートを選択
4. BuyerEmailCompositionModalで送信者を変更

**期待結果**:
- ✅ 送信者選択ドロップダウンが表示される
- ✅ 利用可能な送信者が表示される
- ✅ 送信者を変更できる

**検証項目**:
- [ ] 送信者選択UIの表示
- [ ] 送信者一覧の取得
- [ ] 送信者変更の動作

---

### テストケース17: レスポンシブデザイン

**目的**: 異なる画面サイズでの動作を確認

**手順**:
1. ブラウザのウィンドウサイズを変更
2. モバイルサイズ（375px）で確認
3. タブレットサイズ（768px）で確認
4. デスクトップサイズ（1920px）で確認

**期待結果**:
- ✅ すべての画面サイズでUIが適切に表示される
- ✅ チェックボックスがクリックしやすい
- ✅ ボタンが適切なサイズで表示される
- ✅ モーダルが画面に収まる

**検証項目**:
- [ ] モバイルでの表示
- [ ] タブレットでの表示
- [ ] デスクトップでの表示
- [ ] タッチ操作の容易さ

---

### テストケース18: パフォーマンス

**目的**: 大量の問合せ履歴がある場合のパフォーマンスを確認

**手順**:
1. 問合せ履歴が20件以上ある買主を選択
2. 複数の問合せ履歴を選択
3. BuyerGmailSendButtonをクリック

**期待結果**:
- ✅ チェックボックスの選択が即座に反映される
- ✅ 選択数の更新が遅延なく行われる
- ✅ ボタンのクリックが即座に反応する
- ✅ モーダルの表示が遅延なく行われる

**検証項目**:
- [ ] UI更新の速度
- [ ] 選択状態の管理
- [ ] レンダリングパフォーマンス

---

### テストケース19: ブラウザ互換性

**目的**: 異なるブラウザでの動作を確認

**手順**:
1. Chrome、Firefox、Safari、Edgeで同じ操作を実行
2. 各ブラウザで基本的なフローをテスト

**期待結果**:
- ✅ すべてのブラウザで同じように動作する
- ✅ UIが一貫して表示される
- ✅ 機能が正常に動作する

**検証項目**:
- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

---

### テストケース20: アクセシビリティ

**目的**: キーボード操作とスクリーンリーダーでの動作を確認

**手順**:
1. Tabキーでチェックボックスにフォーカス
2. Spaceキーで選択/解除
3. Tabキーでボタンにフォーカス
4. Enterキーでボタンをクリック

**期待結果**:
- ✅ キーボードですべての操作が可能
- ✅ フォーカスが視覚的に分かる
- ✅ スクリーンリーダーで内容が読み上げられる
- ✅ ARIA属性が適切に設定されている

**検証項目**:
- [ ] キーボードナビゲーション
- [ ] フォーカスインジケーター
- [ ] スクリーンリーダー対応
- [ ] ARIA属性

---

## テスト結果の記録

### テスト実施日時
- 日時: _______________
- 実施者: _______________
- 環境: _______________

### テスト結果サマリー

| テストケース | 結果 | 備考 |
|------------|------|------|
| TC1: チェックボックス選択 | ⬜ Pass / ⬜ Fail | |
| TC2: 複数物件選択 | ⬜ Pass / ⬜ Fail | |
| TC3: 選択解除 | ⬜ Pass / ⬜ Fail | |
| TC4: 全選択解除 | ⬜ Pass / ⬜ Fail | |
| TC5: 選択なしクリック | ⬜ Pass / ⬜ Fail | |
| TC6: 1件選択送信 | ⬜ Pass / ⬜ Fail | |
| TC7: 複数件選択送信 | ⬜ Pass / ⬜ Fail | |
| TC8: テンプレート選択 | ⬜ Pass / ⬜ Fail | |
| TC9: メール本文（1件） | ⬜ Pass / ⬜ Fail | |
| TC10: メール本文（複数） | ⬜ Pass / ⬜ Fail | |
| TC11: キャンセル | ⬜ Pass / ⬜ Fail | |
| TC12: 送信成功 | ⬜ Pass / ⬜ Fail | |
| TC13: データ取得失敗 | ⬜ Pass / ⬜ Fail | |
| TC14: 通信エラー | ⬜ Pass / ⬜ Fail | |
| TC15: テンプレート互換性 | ⬜ Pass / ⬜ Fail | |
| TC16: 送信者選択互換性 | ⬜ Pass / ⬜ Fail | |
| TC17: レスポンシブ | ⬜ Pass / ⬜ Fail | |
| TC18: パフォーマンス | ⬜ Pass / ⬜ Fail | |
| TC19: ブラウザ互換性 | ⬜ Pass / ⬜ Fail | |
| TC20: アクセシビリティ | ⬜ Pass / ⬜ Fail | |

### 発見された問題

1. **問題タイトル**: _______________
   - 重要度: ⬜ Critical / ⬜ High / ⬜ Medium / ⬜ Low
   - 説明: _______________
   - 再現手順: _______________
   - 期待結果: _______________
   - 実際の結果: _______________

2. **問題タイトル**: _______________
   - 重要度: ⬜ Critical / ⬜ High / ⬜ Medium / ⬜ Low
   - 説明: _______________
   - 再現手順: _______________
   - 期待結果: _______________
   - 実際の結果: _______________

### 総合評価

- ⬜ すべてのテストケースがPass
- ⬜ 一部のテストケースがFail（詳細は上記参照）
- ⬜ 追加のテストが必要

### 次のステップ

- [ ] 発見された問題の修正
- [ ] 追加テストの実施
- [ ] ドキュメントの更新
- [ ] 本番環境へのデプロイ準備

---

## トラブルシューティング

### 問題: チェックボックスが表示されない

**原因**: InquiryHistoryTableコンポーネントのpropsが正しく渡されていない

**解決策**:
1. BuyerDetailPageでselectedPropertyIdsとonSelectionChangeが正しく渡されているか確認
2. InquiryHistoryTableコンポーネントのprops定義を確認

### 問題: 選択数が更新されない

**原因**: State管理の問題

**解決策**:
1. setSelectedPropertyIdsが正しく呼ばれているか確認
2. Setオブジェクトの不変性が保たれているか確認（新しいSetを作成）

### 問題: ボタンが有効化されない

**原因**: selectedPropertyIds.sizeの判定が正しくない

**解決策**:
1. BuyerGmailSendButtonのdisabled propsを確認
2. selectedPropertyIds.size === 0の条件を確認

### 問題: モーダルが表示されない

**原因**: モーダルの表示条件が満たされていない

**解決策**:
1. TemplateSelectionModalのopen propsを確認
2. State管理を確認

### 問題: メール本文に物件情報が含まれない

**原因**: APIレスポンスの問題またはテンプレートマージの問題

**解決策**:
1. `/api/email-templates/:id/merge-multiple`エンドポイントのレスポンスを確認
2. BuyerEmailCompositionModalでのデータ処理を確認

---

## 参考情報

### 関連ドキュメント
- [要件定義](.kiro/specs/buyer-detail-inquiry-checkbox-gmail/requirements.md)
- [設計書](.kiro/specs/buyer-detail-inquiry-checkbox-gmail/design.md)
- [タスクリスト](.kiro/specs/buyer-detail-inquiry-checkbox-gmail/tasks.md)

### 関連コンポーネント
- `frontend/src/pages/BuyerDetailPage.tsx`
- `frontend/src/components/InquiryHistoryTable.tsx`
- `frontend/src/components/BuyerGmailSendButton.tsx`
- `frontend/src/components/BuyerEmailCompositionModal.tsx`
- `frontend/src/components/TemplateSelectionModal.tsx`

### APIエンドポイント
- `GET /api/buyers/:buyer_number`
- `GET /api/buyers/:buyer_number/inquiry-histories`
- `GET /api/property-listings/:id`
- `POST /api/email-templates/:id/merge-multiple`
- `POST /api/gmail/send`
