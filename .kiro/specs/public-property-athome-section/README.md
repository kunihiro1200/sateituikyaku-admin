# 物件公開サイト Athomeセクション機能

## 概要

物件公開サイトの詳細ページに、業務リストスプレッドシートの「athome」シートから取得したデータを表示する機能です。物件タイプに応じて異なるセル範囲のデータを取得し、基本情報セクションの下に表示します。

## 機能の特徴

- **物件タイプ別データ取得**: 土地、戸建て、マンションごとに異なるセル範囲からデータを取得
- **5分間キャッシュ**: API呼び出しを削減し、パフォーマンスを向上
- **記号置換**: ★記号を●に自動変換（お気に入り文言機能との競合回避）
- **グレースフルデグラデーション**: エラー時も画面表示を継続
- **3秒タイムアウト**: 長時間の待機を防止

## アーキテクチャ

```
┌─────────────────────────────────────────┐
│   PublicPropertyDetailPage              │
│   (フロントエンド)                       │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│   AthomeSection Component               │
│   - データ取得                           │
│   - ローディング表示                     │
│   - リスト表示                           │
└───────────────┬─────────────────────────┘
                │ API Request
                ▼
┌─────────────────────────────────────────┐
│   GET /api/public-properties/:id/athome │
│   (バックエンドAPI)                      │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│   AthomeDataService                     │
│   - セル範囲マッピング                   │
│   - キャッシュ管理                       │
│   - 記号置換                             │
│   - エラーハンドリング                   │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│   GoogleSheetsClient                    │
│   - スプレッドシート認証                 │
│   - データ取得                           │
└─────────────────────────────────────────┘
```

## セル範囲マッピング

| 物件タイプ | セル範囲 |
|-----------|---------|
| 土地 | B63:B79 |
| 戸建て / 戸建 | B152:B166 |
| マンション | B149:B163 |

## API仕様

### エンドポイント

```
GET /api/public-properties/:id/athome
```

### レスポンス

```json
{
  "data": [
    "●駅から徒歩5分",
    "●南向きで日当たり良好",
    "閑静な住宅街"
  ],
  "propertyType": "土地",
  "cached": true
}
```

### エラーレスポンス

エラー時もステータス200で空配列を返します（グレースフルデグラデーション）:

```json
{
  "data": [],
  "propertyType": "土地",
  "cached": false,
  "error": "Error message"
}
```

## 環境変数

以下の環境変数が必要です:

```env
# Google Sheets認証
GOOGLE_SERVICE_ACCOUNT_KEY_PATH=path/to/service-account-key.json

# 業務リストスプレッドシートID（RecommendedCommentServiceと共通）
GYOMU_LIST_SPREADSHEET_ID=your-spreadsheet-id
```

## キャッシュ戦略

- **キャッシュ場所**: メモリ内（Map）
- **キャッシュキー**: `athome:${propertyNumber}`
- **TTL**: 5分（300,000ミリ秒）
- **キャッシュヒット**: APIコールなしで即座にレスポンス
- **キャッシュミス**: Google Sheets APIから取得後、キャッシュに保存

## エラーハンドリング

1. **スプレッドシートURLなし**: 空配列を返す
2. **未知の物件タイプ**: 空配列を返す
3. **シートが見つからない**: 1秒後にリトライ、失敗時は空配列
4. **API エラー**: 1秒後にリトライ、失敗時は空配列
5. **タイムアウト（3秒）**: 空配列を返す

すべてのエラーケースで、ユーザーにはエラーメッセージを表示せず、セクションを非表示にします。

## テスト

### ユニットテスト実行

```bash
cd backend
npm test -- AthomeDataService.test.ts
```

### 手動テスト

1. 物件詳細ページを開く
2. 基本情報セクションの下にathome情報が表示されることを確認
3. ★記号が●に置換されていることを確認
4. 5分以内に再読み込みして、キャッシュから取得されることを確認
5. ネットワークを切断して、エラー時にセクションが非表示になることを確認

## トラブルシューティング

### athome情報が表示されない

1. **スプレッドシートURLの確認**
   - `property_listings`テーブルの`storage_location`カラムにURLが設定されているか確認

2. **物件タイプの確認**
   - サポートされている物件タイプ（土地、戸建て、マンション）か確認

3. **シート名の確認**
   - スプレッドシート内に物件番号と同じ名前のシートが存在するか確認

4. **認証の確認**
   - サービスアカウントキーファイルが正しく配置されているか確認
   - スプレッドシートへのアクセス権限があるか確認

### キャッシュが効かない

1. **サーバー再起動**
   - メモリキャッシュはサーバー再起動でクリアされます

2. **TTL確認**
   - 5分経過後は自動的にキャッシュが無効化されます

### パフォーマンスが遅い

1. **キャッシュヒット率の確認**
   - ログで`Cache hit`メッセージを確認

2. **Google Sheets APIクォータ**
   - APIクォータを超過していないか確認

## 今後の拡張

1. **Redisキャッシュ**: スケーラビリティ向上のため、メモリキャッシュをRedisに移行
2. **バッチ取得**: 一覧ページで複数物件のathomeデータを一括取得
3. **リッチテキスト対応**: リンクや太字などの書式をサポート
4. **管理画面**: スプレッドシートを経由せずにathomeデータを編集

## 関連ドキュメント

- [Requirements Document](./requirements.md)
- [Design Document](./design.md)
- [Tasks Document](./tasks.md)
- [User Guide](./USER_GUIDE.md)
