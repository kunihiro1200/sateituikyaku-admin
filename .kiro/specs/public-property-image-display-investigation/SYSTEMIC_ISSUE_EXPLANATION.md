# 格納先URLが入力されているのに画像が表示されない理由

## 質問

> 物件リストに格納先URLが入力されてるのに、実際の公開物件のサイトに画像が入ってないのはなぜ？

## 回答サマリー

**3つの根本原因**があります：

1. **`image_urls` フィールドが空** - 公開サイトは `image_urls` 配列を読み取るが、多くの物件でこのフィールドが空
2. **同期処理が未完了** - 格納先URLから画像URLへの変換処理が全物件に対して実行されていない
3. **`hidden_images` カラムの問題** - 一部の物件で画像取得処理がエラーになる

## 詳細説明

### 1. データ構造の理解

物件リストテーブル（`property_listings`）には2つの重要なフィールドがあります：

```
┌─────────────────────┬──────────────────────────────────────┐
│ フィールド名        │ 説明                                 │
├─────────────────────┼──────────────────────────────────────┤
│ storage_location    │ Google Driveフォルダの格納先URL      │
│                     │ 例: https://drive.google.com/...     │
├─────────────────────┼──────────────────────────────────────┤
│ image_urls          │ 実際の画像URLの配列（JSON）          │
│                     │ 例: ["/api/public/images/xxx/..."]  │
└─────────────────────┴──────────────────────────────────────┘
```

**重要なポイント**:
- `storage_location` = Google Driveフォルダへのリンク（人間が見るため）
- `image_urls` = 実際に画像を表示するためのURL（システムが使用）

### 2. 現在の状況（データベース調査結果）

#### 全物件（1,261件）
```
✅ image_urls 設定済み: 145件 (11.5%)
❌ image_urls 未設定:   1,116件 (88.5%)
```

#### 公開物件（152件）
```
✅ image_urls 設定済み: 79件 (52.0%)
❌ image_urls 未設定:   73件 (48.0%)
```

**つまり**:
- 格納先URL（`storage_location`）は入力されている
- しかし、画像URL（`image_urls`）は空のまま
- 公開サイトは `image_urls` を読み取るため、画像が表示されない

### 3. なぜこのような状況になったのか？

#### 原因1: 個別修正のみ実施

これまで、特定の物件（AA13129、AA13154、AA18など）のみを個別に修正してきました：

```
AA13129 → 修正完了 ✅
AA13154 → 修正完了 ✅
AA18    → 修正完了 ✅
その他  → 未修正 ❌
```

#### 原因2: 一括処理スクリプトの未実行

画像URLを一括で取得・設定するスクリプト（`populate-property-image-urls.ts`）が存在しますが、全物件に対して実行されていません。

#### 原因3: 同期プロセスの不完全

新しい物件が追加された際に、自動的に `image_urls` を設定する仕組みが実装されていません。

### 4. 技術的な詳細

#### 公開サイトの画像表示フロー

```
1. ユーザーが公開物件サイトにアクセス
   ↓
2. フロントエンドが GET /api/public/properties を呼び出し
   ↓
3. バックエンドが property_listings テーブルからデータ取得
   ↓
4. フロントエンドが property.image_urls[0] を表示
   ↓
5. image_urls が空の場合 → 「画像なし」プレースホルダー表示
```

**問題点**:
- ステップ4で `image_urls` が空
- `storage_location` は存在するが、使用されていない

#### なぜ storage_location を直接使わないのか？

`storage_location` は Google Drive フォルダのURLです。このURLから画像を取得するには：

1. Google Drive API を呼び出す
2. フォルダ内の画像ファイル一覧を取得
3. 各画像のダウンロードURLを生成
4. 画像データを取得

この処理は**非常に遅い**（1物件あたり数秒）ため、一覧表示では使用できません。

そのため、事前に画像URLを取得して `image_urls` フィールドに保存しておく必要があります。

## 解決策

### ステップ1: 一括画像URL取得スクリプトの実行

既存のスクリプトを実行して、全物件の `image_urls` を設定します：

```bash
cd backend
npx tsx populate-property-image-urls.ts
```

**このスクリプトの動作**:
1. `storage_location` が設定されている全物件を取得
2. 各物件について Google Drive から画像URLを取得
3. `image_urls` フィールドに保存

**実行結果（前回実行時）**:
```
成功:     138件
スキップ: 1件（既に設定済み）
エラー:   102件
合計:     241件
```

### ステップ2: エラー物件の対応

#### エラーの種類

1. **無効なストレージURL形式**（約60件）
   - 問題: `storage_location` がパス形式で保存されている
   - 例: `共有アイテム＞IFOO2017＞1売買関係＞...`
   - 対応: `work_tasks` テーブルから正しいURLを取得

2. **画像が見つからない**（約40件）
   - 問題: Google Drive フォルダは存在するが画像なし
   - 対応: フォルダに画像をアップロード

3. **ファイルURLが設定されている**（2件）
   - 問題: フォルダURLではなくファイルURLが設定
   - 対応: 正しいフォルダURLに修正

### ステップ3: 定期的な同期の実装（今後の課題）

新しい物件が追加された際に自動的に `image_urls` を設定する仕組みを実装：

1. **定期実行スクリプト**
   - cron job で毎日実行
   - 新規物件のみを対象

2. **物件追加時のトリガー**
   - Supabase Database Webhook を使用
   - 物件追加時に自動実行

## 期待される結果

### 修正前
```
公開物件152件中:
✅ 画像表示: 79件 (52%)
❌ 画像なし: 73件 (48%)
```

### 修正後（ステップ1実行後）
```
公開物件152件中:
✅ 画像表示: 約120件 (79%)
❌ 画像なし: 約32件 (21%)
```

### 最終目標（ステップ2完了後）
```
公開物件152件中:
✅ 画像表示: 約140件 (92%)
❌ 画像なし: 約12件 (8%)
```

## 実行手順

### 今すぐ実行できる対応

```bash
# 1. バックエンドディレクトリに移動
cd backend

# 2. 一括画像URL取得スクリプトを実行
npx tsx populate-property-image-urls.ts

# 3. 結果を確認
# 成功件数、エラー件数が表示されます

# 4. フロントエンドで確認
cd ../frontend
npm run dev

# 5. ブラウザで確認
# http://localhost:5173/public/properties
```

### 実行時間

- **処理時間**: 約5〜10分（物件数による）
- **API呼び出し**: 各物件につき1回（Google Drive API）
- **待機時間**: 100ms/件（API制限対策）

## よくある質問

### Q1: なぜ個別修正ではなく一括処理が必要なのか？

**A**: 個別修正は時間がかかり、スケールしません。

```
個別修正: 1物件 × 5分 × 1,000物件 = 83時間
一括処理: 1,000物件 × 0.1秒 = 100秒（約2分）
```

### Q2: スクリプト実行中にエラーが出たらどうなるのか？

**A**: エラーが出ても他の物件の処理は続行されます。

- 成功した物件: `image_urls` が設定される
- エラーの物件: スキップされる（後で再実行可能）

### Q3: 既に image_urls が設定されている物件はどうなるのか？

**A**: スキップされます。

スクリプトは `image_urls` が空の物件のみを処理します。

### Q4: 画像が更新された場合はどうするのか？

**A**: スクリプトを再実行します。

または、特定の物件のみを更新する場合は、個別修正スクリプトを使用します。

## 関連ファイル

### スクリプト
- `backend/populate-property-image-urls.ts` - 一括画像URL取得
- `backend/sync-storage-locations.ts` - storage_location 同期

### サービス
- `backend/src/services/PropertyImageService.ts` - 画像取得サービス
- `backend/src/services/PropertyListingService.ts` - 物件一覧サービス

### ドキュメント
- `ROOT_CAUSE_ANALYSIS.md` - 根本原因分析（技術詳細）
- `BATCH_POPULATION_COMPLETE.md` - 前回実行結果
- `requirements.md` - 要件定義

## まとめ

### 問題の本質

```
格納先URL（storage_location）は入力されている
        ↓
しかし、画像URL（image_urls）は空
        ↓
公開サイトは image_urls を読み取る
        ↓
結果: 画像が表示されない
```

### 解決策

```
一括画像URL取得スクリプトを実行
        ↓
storage_location から image_urls を生成
        ↓
データベースに保存
        ↓
結果: 画像が表示される
```

### 次のアクション

1. ✅ **今すぐ実行**: `npx tsx populate-property-image-urls.ts`
2. ⏳ **エラー対応**: 無効なURLを修正
3. 🔄 **定期実行**: 自動同期の実装（今後）

## 作成日

2026年1月6日

## ステータス

📝 **説明完了** - 一括処理スクリプトの実行待ち
