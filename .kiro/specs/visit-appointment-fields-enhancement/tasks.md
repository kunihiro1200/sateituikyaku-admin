# 実装計画

- [x] 1. データベーススキーマを拡張


  - マイグレーションファイルを作成（030_add_visit_appointment_fields.sql）
  - sellers テーブルに visit_department 列を追加（TEXT型、NULL許可）
  - sellers テーブルに visit_valuation_acquirer 列を追加（TEXT型、NULL許可）
  - マイグレーション実行スクリプトを作成
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_



- [x] 2. 型定義を更新


  - backend/src/types/index.ts の Seller インターフェースに新しいフィールドを追加


  - frontend/src/types/index.ts の Seller インターフェースに新しいフィールドを追加
  - _要件: 1.1, 1.2, 1.3_

- [x] 3. スプレッドシート同期の設定を更新


  - backend/src/config/column-mapping.json に新しいフィールドのマッピングを追加
  - spreadsheetToDatabase に「訪問部」「訪問査定取得者」を追加
  - databaseToSpreadsheet に対応するマッピングを追加
  - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_





- [x] 4. ColumnMapper を更新
  - backend/src/config/column-mapping.json に新しいフィールドのマッピングを追加済み
  - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [x] 5. バックエンドAPI を更新
  - backend/src/services/SellerService.supabase.ts の updateSeller メソッドを更新済み
  - visitDepartment と visitValuationAcquirer フィールドの処理を追加済み
  - _要件: 1.5, 3.1, 3.2, 3.3_



- [x] 6. フロントエンド - 状態変数を追加


  - frontend/src/pages/CallModePage.tsx に新しい状態変数を追加
  - editedVisitDepartment 状態を追加
  - editedVisitValuationAcquirer 状態を追加


  - _要件: 1.4_



- [x] 7. フロントエンド - データ初期化処理を更新
  - loadAllData 関数で新しいフィールドを初期化済み
  - seller.visitDepartment を editedVisitDepartment に設定済み
  - seller.visitValuationAcquirer を editedVisitValuationAcquirer に設定済み
  - _要件: 5.1, 5.2, 5.3_

- [x] 8. フロントエンド - 表示モードUIを実装
  - 訪問予約セクションの表示モードに3つのフィールドを追加済み
  - 未設定の場合は「未設定」と表示
  - 設定されている場合はスタッフ名を表示（イニシャルから名前を検索）
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 9. フロントエンド - 編集モードUIを実装
  - 訪問予約セクションの編集モードに3つのドロップダウンを追加済み
  - ドロップダウンにスタッフ一覧を表示
  - 空の選択肢（「未設定」）を含める
  - _要件: 1.1, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 10. フロントエンド - 訪問査定取得者の自動設定機能を実装
  - 訪問査定日時フィールドの onChange イベントに自動設定ロジックを追加済み（行 2755-2766）
  - 現在のログインユーザーのメールアドレスを取得
  - メールアドレスからスタッフ情報を検索
  - スタッフが見つかれば訪問査定取得者に自動設定（既存値を上書き）
  - スタッフが見つからなければ空のまま
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 11. フロントエンド - 保存処理を更新
  - handleSaveAppointment 関数を更新済み
  - API呼び出しに visitDepartment を追加済み
  - API呼び出しに visitValuationAcquirer を追加済み
  - 保存成功後にデータを再読み込み
  - _要件: 1.5, 3.1, 3.2, 3.3_

- [x] 12. エラーハンドリングを実装
  - データベース更新エラー時の処理
  - スプレッドシート同期エラー時の警告表示
  - スタッフ一覧取得エラー時の処理
  - 無効なスタッフ参照時の警告表示
  - ログインユーザー情報取得エラー時の処理（自動設定をスキップ）
  - スタッフ検索失敗時の処理（空のまま）
  - _要件: 3.4_

- [ ] 13. チェックポイント - 基本機能の動作確認
  - **重要**: まず `backend/migrations/run-034-migration.ts` を実行して visit_department 列を追加する
    ```bash
    cd backend
    npx ts-node migrations/run-034-migration.ts
    ```
  - マイグレーションが正常に実行されることを確認
  - 通話モードページで3つのフィールドが表示されることを確認
  - ドロップダウンからスタッフを選択できることを確認
  - 訪問査定日時を入力すると訪問査定取得者が自動設定されることを確認
  - 保存ボタンをクリックしてデータが保存されることを確認
  - ページをリロードして値が保持されることを確認
  - 問題があればユーザーに質問する

- [ ] 14. スプレッドシート同期のテスト
  - システムで訪問予約情報を保存
  - スプレッドシートに正しく書き込まれることを確認
  - スプレッドシートで訪問予約情報を編集
  - 同期処理を実行してシステムに反映されることを確認
  - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 15. 最終チェックポイント - すべての機能が動作することを確認
  - 訪問部、営担、訪問査定取得者の3つのフィールドが正しく表示されることを確認
  - ドロップダウンからスタッフを選択して保存できることを確認
  - 訪問査定日時を入力すると訪問査定取得者が自動設定されることを確認
  - 自動設定が既存値を上書きすることを確認
  - ログインユーザーがスタッフ一覧に存在しない場合、空のままであることを確認
  - スプレッドシートとの双方向同期が正しく動作することを確認
  - 未設定の場合に「未設定」と表示されることを確認
  - エラーハンドリングが正しく動作することを確認
  - 問題があればユーザーに質問する

- [ ]* 16. ユニットテストを作成
  - フロントエンド - CallModePage コンポーネントのテスト
  - 訪問査定日時入力時の自動設定機能のテスト
  - ログインユーザーがスタッフ一覧に存在しない場合のテスト
  - 既存値の上書きのテスト
  - バックエンド - API エンドポイントのテスト
  - ColumnMapper のテスト
  - _要件: すべて_

- [ ]* 17. 統合テストを作成
  - エンドツーエンドフローのテスト
  - 訪問査定取得者の自動設定を含むフローのテスト
  - スプレッドシート同期のテスト
  - _要件: すべて_
