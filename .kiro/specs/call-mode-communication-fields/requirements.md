# 通話モード - コミュニケーションフィールド追加

## 概要

売主管理システムの通話モードページに、売主とのコミュニケーションを円滑にするための3つのフィールドを追加します。これらのフィールドはスプレッドシートと同期され、「コミュニケーション履歴」と「実績」セクションの間に配置されます。

---

## ユーザーストーリー

### US-1: 電話担当者の選択
**As a** 営業担当者  
**I want to** 売主への電話担当者を選択できる  
**So that** 誰が連絡を取るべきか明確になる

**受け入れ基準**:
1.1. 「電話担当（任意）」フィールドがプルダウン形式で表示される  
1.2. プルダウンの選択肢は、スタッフ管理スプレッドシート（ID: `19yAuVYQRm-_zhjYX7M7zjiGbnBibkG77Mpz93sN1xx`、シート名: `スタッフ`）の「通常=TRUE」のスタッフの「イニシャル」カラムから取得される  
1.3. 選択した電話担当者（イニシャル）は保存ボタンをクリックした時にスプレッドシートに同期される  
1.4. 電話担当者が未選択の場合でも保存できる（任意フィールド）

### US-2: 連絡取りやすい日時の記録
**As a** 営業担当者  
**I want to** 売主が連絡を取りやすい日時を記録できる  
**So that** 効率的に連絡を取ることができる

**受け入れ基準**:
2.1. 「連絡取りやすい日、時間帯」フィールドがテキストボックス形式で表示される  
2.2. 入力した内容は保存ボタンをクリックした時にスプレッドシートに同期される  
2.3. 複数行の入力が可能である  
2.4. 空欄でも保存できる（任意フィールド）

### US-3: 連絡方法の記録
**As a** 営業担当者  
**I want to** 売主への連絡方法（電話、メール、SMSなど）を記録できる  
**So that** 適切な連絡手段を選択できる

**受け入れ基準**:
3.1. 「連絡方法」フィールドがテキストボックス形式で表示される  
3.2. 入力した内容は保存ボタンをクリックした時にスプレッドシートに同期される  
3.3. 複数行の入力が可能である  
3.4. 空欄でも保存できる（任意フィールド）

### US-4: フィールドの配置
**As a** 営業担当者  
**I want to** コミュニケーション関連のフィールドが適切な位置に配置される  
**So that** 情報を見つけやすく、入力しやすい

**受け入れ基準**:
4.1. 3つのフィールドは「コミュニケーション履歴」セクションと「実績」セクションの間に配置される  
4.2. フィールドの順序は以下の通り:
   - 電話担当（任意）
   - 連絡取りやすい日、時間帯
   - 連絡方法
4.3. 各フィールドは視覚的に区別しやすいレイアウトになっている

---

## 技術要件

### データソース

#### スタッフ管理スプレッドシート
- **スプレッドシートID**: `19yAuVYQRm-_zhjYX7M7zjiGbnBibkG77Mpz93sN1xx`
- **シート名**: `スタッフ`
- **取得条件**: `通常 = TRUE` のスタッフのみ
- **取得フィールド**: `イニシャル` カラムの値

#### 売主スプレッドシート
- 既存の売主スプレッドシートに以下のカラムを追加:
  - `電話担当（任意）` - スタッフのイニシャルを保存
  - `連絡取りやすい日、時間帯` - テキストを保存
  - `連絡方法` - テキストを保存

### データベーススキーマ

#### `sellers` テーブルに追加するカラム

```sql
ALTER TABLE sellers
ADD COLUMN phone_contact_person TEXT,           -- 電話担当者名
ADD COLUMN preferred_contact_time TEXT,         -- 連絡取りやすい日、時間帯
ADD COLUMN contact_method TEXT;                 -- 連絡方法
```

### API エンドポイント

#### スタッフ一覧取得
- **エンドポイント**: `GET /api/employees/active`
- **説明**: 通常=TRUEのスタッフのイニシャル一覧を取得
- **レスポンス**:
```json
{
  "employees": [
    {
      "id": "employee-uuid",
      "initials": "YT",
      "isActive": true
    }
  ]
}
```

#### 売主情報更新
- **エンドポイント**: `PATCH /api/sellers/:id`
- **説明**: 売主情報を更新（既存エンドポイントを拡張）
- **リクエストボディ**:
```json
{
  "phoneContactPerson": "YT",
  "preferredContactTime": "平日 10:00-12:00\n土曜日 14:00-16:00",
  "contactMethod": "電話優先\nメール可"
}
```

---

## スプレッドシート同期仕様

### 同期タイミング
1. **読み込み**: 通話モードページを開いた時
2. **書き込み**: 保存ボタンをクリックした時（他のフィールドと一緒にまとめて保存）

### 同期方向
- **双方向同期**: データベース ⇔ スプレッドシート

### カラムマッピング

| データベースカラム | スプレッドシートカラム | データ型 |
|------------------|---------------------|---------|
| `phone_contact_person` | `電話担当（任意）` | TEXT |
| `preferred_contact_time` | `連絡取りやすい日、時間帯` | TEXT |
| `contact_method` | `連絡方法` | TEXT |

---

## UI/UX 要件

### レイアウト

```
┌─────────────────────────────────────┐
│ コミュニケーション履歴セクション      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 【新規追加】                         │
│                                     │
│ 電話担当（任意）                     │
│ [プルダウン: 選択してください ▼]     │
│                                     │
│ 連絡取りやすい日、時間帯              │
│ ┌─────────────────────────────┐    │
│ │                             │    │
│ │                             │    │
│ └─────────────────────────────┘    │
│                                     │
│ 連絡方法                             │
│ ┌─────────────────────────────┐    │
│ │                             │    │
│ │                             │    │
│ └─────────────────────────────┘    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 実績セクション                       │
└─────────────────────────────────────┘
```

### スタイリング
- **電話担当プルダウン**: 既存のプルダウンと同じスタイル
- **テキストボックス**: 
  - 高さ: 3行分（約80px）
  - 幅: 親要素の100%
  - リサイズ可能
- **ラベル**: 既存のフィールドラベルと同じスタイル

---

## 非機能要件

### パフォーマンス
- スタッフ一覧の取得は1秒以内に完了する
- フィールドの保存は2秒以内に完了する

### セキュリティ
- スタッフ一覧は認証済みユーザーのみ取得可能
- 売主情報の更新は認証済みユーザーのみ実行可能

### 互換性
- 既存の通話モードページの機能に影響を与えない
- 既存のスプレッドシート同期機能と統合される

---

## 制約事項

1. スタッフ管理スプレッドシートの構造は変更しない
2. 既存の売主スプレッドシートのカラム順序は変更しない（末尾に追加）
3. 既存の通話モードページのレイアウトは最小限の変更に留める

---

## 成功基準

1. ✅ 3つのフィールドが通話モードページに表示される
2. ✅ 電話担当プルダウンにスタッフ一覧が表示される
3. ✅ フィールドの入力内容がスプレッドシートに同期される
4. ✅ スプレッドシートの内容がページ読み込み時に表示される
5. ✅ 既存の通話モード機能が正常に動作する

---

## 参考情報

### 関連ファイル
- **バックエンド**: `backend/src/` (売主管理システム用)
- **フロントエンド**: `frontend/src/pages/CallModePage.tsx`
- **サービス**: `backend/src/services/SellerService.supabase.ts`
- **スプレッドシート同期**: `backend/src/services/SpreadsheetSyncService.ts`

### 関連仕様
- `call-mode-page` - 通話モードページの基本仕様
- `call-mode-unreachable-field` - 不通フィールドの実装例

---

**作成日**: 2026年1月30日  
**作成者**: システム  
**ステータス**: レビュー待ち
