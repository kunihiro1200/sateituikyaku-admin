# 通話モード - コミュニケーションフィールド追加 タスクリスト

## タスク概要

売主管理システムの通話モードページに、コミュニケーション関連の3つのフィールドを追加します。

---

## タスク一覧

### 1. データベース準備

- [ ] 1.1 マイグレーションファイルを作成
  - ファイル名: `backend/supabase/migrations/XXX_add_communication_fields_to_sellers.sql`
  - `phone_contact_person`, `preferred_contact_time`, `contact_method` カラムを追加

- [ ] 1.2 マイグレーションを実行
  - `npx supabase db push` を実行
  - カラムが正しく追加されたことを確認

### 2. バックエンド実装

- [ ] 2.1 型定義を更新
  - `backend/src/types/index.ts` の `Seller` インターフェースに新しいフィールドを追加
  - `UpdateSellerRequest` インターフェースに新しいフィールドを追加

- [ ] 2.2 SellerServiceを更新
  - `backend/src/services/SellerService.supabase.ts` の `updateSeller` メソッドを拡張
  - 新しいフィールドの更新処理を追加

- [ ] 2.3 スタッフ一覧取得APIを実装
  - `backend/src/routes/employees.ts` に `GET /api/employees/active` エンドポイントを追加
  - 通常=TRUEのスタッフのイニシャル一覧を返す

- [ ] 2.4 カラムマッピング設定を更新
  - `backend/src/config/column-mapping.json` に新しいフィールドのマッピングを追加
  - `spreadsheetToDatabase` と `databaseToSpreadsheet` の両方を更新

### 3. フロントエンド実装

- [ ] 3.1 型定義を更新
  - `frontend/src/types/index.ts` の `Seller` インターフェースに新しいフィールドを追加

- [ ] 3.2 CallModePageに状態を追加
  - `editedPhoneContactPerson`, `editedPreferredContactTime`, `editedContactMethod` の状態を追加
  - `activeEmployees` の状態を追加

- [ ] 3.3 スタッフ一覧を取得
  - `useEffect` で `/api/employees/active` を呼び出し
  - `activeEmployees` 状態を更新

- [ ] 3.4 UIコンポーネントを追加
  - 「コミュニケーション履歴」と「実績」セクションの間に新しいセクションを追加
  - 電話担当プルダウンを実装
  - 連絡取りやすい日、時間帯テキストボックスを実装
  - 連絡方法テキストボックスを実装

- [ ] 3.5 保存処理を更新
  - `handleSave` 関数に新しいフィールドを追加
  - APIリクエストに新しいフィールドを含める

### 4. テスト

- [ ] 4.1 バックエンドAPIテスト
  - スタッフ一覧取得APIが正しく動作するか確認
  - 売主情報更新APIが新しいフィールドを正しく保存するか確認

- [ ] 4.2 フロントエンドテスト
  - 通話モードページで新しいフィールドが表示されるか確認
  - スタッフプルダウンにスタッフ一覧が表示されるか確認
  - フィールドに値を入力して保存できるか確認

- [ ] 4.3 スプレッドシート同期テスト
  - データベース → スプレッドシートの同期が正しく動作するか確認
  - スプレッドシート → データベースの同期が正しく動作するか確認

- [ ] 4.4 エンドツーエンドテスト
  - 通話モードページで新しいフィールドを入力して保存
  - ページをリロードして値が保持されているか確認
  - スプレッドシートに正しく同期されているか確認

### 5. デプロイ

- [ ] 5.1 バックエンドをデプロイ
  - 変更をコミット
  - `git push origin main`

- [ ] 5.2 フロントエンドをデプロイ
  - 変更をコミット
  - `git push origin main`

- [ ] 5.3 本番環境で動作確認
  - 通話モードページを開く
  - 新しいフィールドが表示されることを確認
  - スタッフプルダウンにスタッフ一覧が表示されることを確認
  - フィールドに値を入力して保存
  - ページをリロードして値が保持されていることを確認
  - スプレッドシートに同期されていることを確認

---

## 優先順位

1. **高**: タスク1（データベース準備）、タスク2（バックエンド実装）
2. **中**: タスク3（フロントエンド実装）
3. **低**: タスク4（テスト）、タスク5（デプロイ）

---

## 見積もり時間

- タスク1: 30分
- タスク2: 2時間
- タスク3: 3時間
- タスク4: 2時間
- タスク5: 1時間

**合計**: 約8.5時間

---

## 依存関係

- タスク2はタスク1に依存
- タスク3はタスク2に依存
- タスク4はタスク3に依存
- タスク5はタスク4に依存

---

## 注意事項

1. **スタッフ管理スプレッドシート**
   - スプレッドシートID: `19yAuVYQRm-_zhjYX7M7zjiGbnBibkG77Mpz93sN1xx`
   - シート名: `スタッフ`
   - 取得条件: `通常 = TRUE`
   - 取得フィールド: `イニシャル` カラム

2. **売主スプレッドシート**
   - カラム名: `電話担当（任意）`, `連絡取りやすい日、時間帯`, `連絡方法`
   - これらのカラムが存在しない場合は、スプレッドシートに手動で追加する必要がある

3. **保存タイミング**
   - 保存ボタンをクリックした時にまとめて保存
   - 既存のフィールドと一緒に保存される

4. **バックエンドの編集対象**
   - **`backend/src/`** を編集（売主管理システム用）
   - **`backend/api/`** は編集しない（公開物件サイト用）

---

**作成日**: 2026年1月30日  
**作成者**: システム  
**ステータス**: レビュー待ち
