# Implementation Plan: 売主同期時の物件情報作成修正

## Overview

売主リストをスプレッドシートから同期する際、物件情報が作成されない問題を修正します。`EnhancedAutoSyncService`と`PropertySyncHandler`を修正して、売主同期時に物件情報を確実に作成します。

## Tasks

- [x] 1. PropertySyncHandlerの修正
  - `syncProperty()`メソッドを修正して、物件番号がない場合でも物件レコードを作成
  - 既存物件の検索ロジックを改善（物件番号とseller_idの両方で検索）
  - エラーハンドリングを追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3_

- [ ]* 1.1 PropertySyncHandlerのユニットテストを作成
  - 物件番号がある場合の作成・更新をテスト
  - 物件番号がない場合の作成をテスト
  - seller_idでの検索をテスト
  - エラーハンドリングをテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 2. EnhancedAutoSyncServiceの修正
  - `syncSingleSeller()`メソッドを修正して、物件作成を確実に実行
  - `ensurePropertyCreated()`メソッドを実装
  - 物件作成エラー時のログ記録を追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 2.1 EnhancedAutoSyncServiceのユニットテストを作成
  - `syncSingleSeller()`が物件を作成することをテスト
  - `ensurePropertyCreated()`が正しく動作することをテスト
  - エラーハンドリングをテスト
  - ログ記録をテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 3. ログ記録機能の実装
  - `logPropertyCreationError()`メソッドを実装
  - sync_logsテーブルにエラーログを記録
  - タイムスタンプと売主番号を含める
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 4. 既存データへの一括物件作成スクリプトの実装
  - 物件番号を持つ全ての売主に対して物件レコードを作成
  - 既存物件はスキップ
  - 進捗状況をログに出力
  - 作成件数とスキップ件数を報告
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 4.1 一括物件作成スクリプトのテストを作成
  - 物件レコードが正しく作成されることをテスト
  - 既存物件がスキップされることをテスト
  - 進捗状況が表示されることをテスト
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 5. Checkpoint - 基本機能のテスト
  - 全てのユニットテストが通ることを確認
  - 売主同期時に物件が作成されることを確認
  - エラーハンドリングが正しく動作することを確認
  - ユーザーに質問があれば確認

- [ ] 6. 統合テストの実装
  - スプレッドシートからデータベースへの同期をテスト
  - 売主と物件の作成をテスト
  - 通話モードページでの表示をテスト
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ]* 6.1 統合テストのプロパティテストを作成
  - **Property 1: 売主作成時の物件作成**
  - **Validates: Requirements 1.1, 1.2, 1.3, 1.4**
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ]* 6.2 統合テストのプロパティテストを作成
  - **Property 2: フィールドマッピングの完全性**
  - **Validates: Requirements 2.1, 2.2, 2.3, 2.4, 2.5**
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ]* 6.3 統合テストのプロパティテストを作成
  - **Property 3: 売主と物件の関連付け**
  - **Validates: Requirements 3.1, 3.2, 3.3**
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 7. 手動テストの実施
  - 売主リストを同期して物件情報が作成されることを確認
  - 通話モードページで物件情報が表示されることを確認
  - 物件情報が存在しない場合のメッセージを確認
  - 一括物件作成スクリプトを実行して既存データに物件を作成
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 8. ドキュメントの更新
  - README.mdに一括物件作成スクリプトの使用方法を追加
  - エラーログの確認方法を追加
  - トラブルシューティングガイドを追加

- [x] 9. Final Checkpoint - 全体テスト
  - 全てのテストが通ることを確認
  - 手動テストが完了していることを確認
  - ドキュメントが更新されていることを確認
  - ユーザーに最終確認

## Notes

- タスクに`*`が付いているものはオプショナルで、コア機能の実装を優先する場合はスキップ可能
- 各タスクは要件にトレーサビリティを持つ
- Checkpointタスクで段階的に検証を行う
- プロパティテストは普遍的な正確性を検証
- ユニットテストは具体的な例とエッジケースを検証

