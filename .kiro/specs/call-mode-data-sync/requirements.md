# Requirements Document

## Introduction

通話モードページにおいて、スプレッドシートから取得したデータが正しく表示されない問題を解決します。現在、売主情報、物件情報、訪問予約情報、査定情報などの各セクションが空欄になっており、ユーザーが通話時に必要な情報を確認できない状態です。この機能では、スプレッドシートから同期されたデータを通話モードページで正しく表示できるようにします。

## Glossary

- **System**: 売主管理システム
- **User**: システムを使用する営業担当者
- **Seller**: 売主（不動産売却を検討している顧客）
- **Call Mode Page**: 通話モードページ（売主との電話対応時に使用する専用画面）
- **Spreadsheet**: Google スプレッドシート（売主データの同期元）
- **Database**: PostgreSQL データベース（売主データの保存先）

## Requirements

### Requirement 1

**User Story:** ユーザーとして、通話モードページで売主の基本情報を確認したい。そうすることで、電話対応時に正確な情報を基に会話ができる。

#### Acceptance Criteria

1. WHEN ユーザーが通話モードページを開く THEN システムは売主の氏名、住所、電話番号、メールアドレスを表示する
2. WHEN スプレッドシートから同期されたデータが存在する THEN システムはそのデータを復号化して表示する
3. WHEN 売主情報が更新される THEN システムは最新の情報を即座に反映する
4. WHEN 売主番号が存在する THEN システムは売主番号をチップ形式で表示する
5. WHEN 反響日付とサイト情報が存在する THEN システムはそれらの情報を表示する

### Requirement 2

**User Story:** ユーザーとして、通話モードページで物件情報を確認したい。そうすることで、物件の詳細について顧客と正確に話し合える。

#### Acceptance Criteria

1. WHEN ユーザーが通話モードページを開く THEN システムは物件住所、物件種別、土地面積、建物面積を表示する
2. WHEN 築年、構造、間取り、状況（売主）の情報が存在する THEN システムはそれらの情報を表示する
3. WHEN 物件情報がデータベースに存在しない THEN システムは「物件情報なし」と表示する
4. WHEN 物件種別が日本語ラベルに変換可能な場合 THEN システムは日本語ラベルで表示する
5. WHEN 状況（売主）が略語の場合 THEN システムは完全な日本語ラベルで表示する

### Requirement 3

**User Story:** ユーザーとして、通話モードページで訪問予約情報を確認したい。そうすることで、訪問スケジュールについて顧客と調整できる。

#### Acceptance Criteria

1. WHEN 訪問予約が設定されている THEN システムは訪問日時、担当者、訪問査定取得者を表示する
2. WHEN 訪問予約が設定されていない THEN システムは「訪問予約なし」と表示する
3. WHEN 訪問メモが存在する THEN システムは訪問メモを表示する
4. WHEN 訪問統計データが利用可能な場合 THEN システムは月間訪問統計を表示する
5. WHEN 担当者情報が従業員マスタに存在する THEN システムは担当者の表示名を表示する

### Requirement 4

**User Story:** ユーザーとして、通話モードページで査定情報を確認したい。そうすることで、査定額について顧客と具体的に話し合える。

#### Acceptance Criteria

1. WHEN 査定額が計算されている THEN システムは査定額1、査定額2、査定額3を万円単位で表示する
2. WHEN 固定資産税路線価が入力されている THEN システムは「自動計算」のチップを表示する
3. WHEN 手入力査定額が設定されている THEN システムは「手入力」のチップを表示する
4. WHEN 査定担当者が設定されている THEN システムは査定担当者名を表示する
5. WHEN 査定額が未設定の場合 THEN システムは「査定額未設定」と表示し、査定計算セクションへのリンクを提供する

### Requirement 5

**User Story:** ユーザーとして、通話モードページでステータスと確度情報を確認したい。そうすることで、顧客の現在の状況を把握できる。

#### Acceptance Criteria

1. WHEN ユーザーが通話モードページを開く THEN システムは現在のステータスと確度を表示する
2. WHEN 次回電話日が設定されている THEN システムは次回電話日を表示する
3. WHEN 除外日と除外アクションが設定されている THEN システムはそれらの情報を表示する
4. WHEN 専任（他決）決定日が設定されている THEN システムは決定日を表示する
5. WHEN 競合情報と専任・他決要因が設定されている THEN システムはそれらの情報を表示する

### Requirement 6

**User Story:** ユーザーとして、通話モードページでスプレッドシートコメントを確認したい。そうすることで、過去の対応履歴や重要なメモを参照できる。

#### Acceptance Criteria

1. WHEN スプレッドシートコメントが存在する THEN システムはコメントを表示する
2. WHEN コメントにURLが含まれる THEN システムはURLをクリック可能なリンクとして表示する
3. WHEN コメントが長文の場合 THEN システムはスクロール可能な領域で表示する
4. WHEN コメントが存在しない THEN システムは「コメントなし」と表示する
5. WHEN コメントが更新される THEN システムは最新のコメントを即座に反映する

### Requirement 7

**User Story:** ユーザーとして、通話モードページでAI要約を確認したい。そうすることで、過去の通話履歴を素早く把握できる。

#### Acceptance Criteria

1. WHEN 通話履歴が存在する THEN システムはAI要約を生成して表示する
2. WHEN スプレッドシートコメントが存在する THEN システムはコメントも要約に含める
3. WHEN AI要約の生成中 THEN システムはローディングインジケーターを表示する
4. WHEN AI要約の生成に失敗した場合 THEN システムはエラーメッセージを表示せず、要約なしで続行する
5. WHEN 要約が生成された後 THEN システムは要約をバックグラウンドで表示に反映する

### Requirement 8

**User Story:** ユーザーとして、データ取得時にキャッシュをクリアしたい。そうすることで、常に最新のデータを確認できる。

#### Acceptance Criteria

1. WHEN 通話モードページを開く THEN システムは売主データのキャッシュをクリアする
2. WHEN キャッシュクリアに失敗した場合 THEN システムはエラーを無視して続行する
3. WHEN データ取得が完了する THEN システムは最新のデータを表示する
4. WHEN ページをリロードする THEN システムは再度キャッシュをクリアして最新データを取得する
5. WHEN データ更新後にリロードする THEN システムは更新されたデータを正しく表示する
