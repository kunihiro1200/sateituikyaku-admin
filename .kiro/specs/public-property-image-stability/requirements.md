# 公開物件サイト画像表示安定化

## 概要

公開物件サイトにおいて、以下の画像表示の不安定性が発生しています：
1. ヘッダーの「いふう」ロゴが度々消える、または変な表示になる
2. 物件一覧の画像が度々表示されなくなる

これらの問題を解決し、画像表示を常に安定させます。

## 問題の詳細

### 1. ロゴ表示の不安定性

**現在の実装**:
- ロゴ画像: `/comfortable-tenant-search-logo.png`
- コンポーネント: `PublicPropertyLogo.tsx`
- 表示場所: ヘッダー右側

**問題**:
- ロゴが度々消える
- 変な表示になる（レイアウト崩れ、画像が読み込まれない等）

**考えられる原因**:
- 画像パスの問題（相対パス vs 絶対パス）
- 画像ファイルの存在確認不足
- CORSエラー
- キャッシュの問題
- ネットワークエラー時のフォールバック不足

### 2. 物件一覧画像の不安定性

**現在の実装**:
- コンポーネント: `PublicPropertyCard.tsx`
- 画像ソース: `property.images[0]` または `property.image_url`
- フォールバック: `/placeholder-property.jpg`

**問題**:
- 物件一覧の画像が度々表示されなくなる

**考えられる原因**:
- Google Drive画像URLの有効期限切れ
- CORS設定の問題
- 画像読み込みエラー時のリトライ不足
- プレースホルダー画像の読み込み失敗
- `loading="lazy"`による遅延読み込みの問題

## ユーザーストーリー

### US-1: ロゴの安定表示
**As a** サイト訪問者  
**I want** ヘッダーのロゴが常に正しく表示される  
**So that** サイトのブランディングが維持され、信頼性が向上する

**受け入れ基準**:
1. ロゴ画像が常に表示される
2. ロゴが消えたり、レイアウトが崩れたりしない
3. 画像読み込みエラー時にフォールバック表示がある
4. ページ遷移時もロゴが安定して表示される
5. スマホ・タブレット・PCで正しく表示される

### US-2: 物件一覧画像の安定表示
**As a** サイト訪問者  
**I want** 物件一覧の画像が常に表示される  
**So that** 物件の外観を確認でき、興味のある物件を見つけやすい

**受け入れ基準**:
1. 物件画像が常に表示される（実際の画像またはプレースホルダー）
2. 画像読み込みエラー時に自動的にプレースホルダーが表示される
3. 画像読み込み中はローディングインジケーターが表示される
4. スクロール時も画像が安定して読み込まれる
5. ページ遷移から戻った時も画像が正しく表示される

### US-3: 画像読み込みエラーハンドリング
**As a** 開発者  
**I want** 画像読み込みエラーを適切にハンドリングする  
**So that** ユーザーに常に何らかの画像が表示され、エラーが記録される

**受け入れ基準**:
1. 画像読み込みエラー時に`onError`ハンドラーが実行される
2. エラー時にプレースホルダー画像に自動的に切り替わる
3. エラーがコンソールに記録される（デバッグ用）
4. 複数回のリトライ機能がある（オプション）
5. エラー状態が無限ループにならない

## 技術的要件

### 1. ロゴ画像の安定化

#### 1.1 画像パスの確認と修正
- [ ] ロゴ画像ファイルが`public/`ディレクトリに存在することを確認
- [ ] 画像パスが正しいことを確認（`/comfortable-tenant-search-logo.png`）
- [ ] Vercelデプロイ時のパスが正しいことを確認

#### 1.2 エラーハンドリングの追加
- [ ] `onError`ハンドラーを追加
- [ ] エラー時のフォールバック表示を実装
- [ ] エラーログを記録

#### 1.3 画像の事前読み込み
- [ ] `<link rel="preload">`でロゴ画像を事前読み込み
- [ ] または、Base64エンコードしてインライン化（小さい画像の場合）

### 2. 物件一覧画像の安定化

#### 2.1 エラーハンドリングの強化
- [ ] `onError`ハンドラーを追加
- [ ] エラー時にプレースホルダー画像に自動切り替え
- [ ] プレースホルダー画像自体のエラーハンドリング

#### 2.2 画像読み込み状態の管理
- [ ] 画像読み込み中の状態を管理
- [ ] ローディングインジケーターを表示
- [ ] 読み込み完了後にフェードイン効果

#### 2.3 CORS設定の確認
- [ ] Google Drive画像のCORS設定を確認
- [ ] 必要に応じてプロキシ経由で画像を取得

#### 2.4 プレースホルダー画像の準備
- [ ] プレースホルダー画像が存在することを確認
- [ ] プレースホルダー画像のパスが正しいことを確認
- [ ] プレースホルダー画像をBase64エンコードしてインライン化（オプション）

### 3. 共通の改善

#### 3.1 画像最適化
- [ ] 画像サイズの最適化（必要に応じてリサイズ）
- [ ] WebP形式のサポート（フォールバックあり）
- [ ] 画像の遅延読み込み（`loading="lazy"`）の適切な使用

#### 3.2 キャッシュ戦略
- [ ] ブラウザキャッシュの活用
- [ ] Service Workerによるキャッシュ（オプション）

#### 3.3 モニタリング
- [ ] 画像読み込みエラーの記録
- [ ] エラー率のモニタリング

## 非機能要件

### パフォーマンス
- ロゴ画像の読み込み時間: 500ms以内
- 物件画像の読み込み時間: 1秒以内（初回）
- プレースホルダー画像の表示: 即座

### 信頼性
- 画像表示成功率: 99%以上
- エラー時のフォールバック成功率: 100%

### ユーザビリティ
- 画像が表示されない場合でも、レイアウトが崩れない
- ローディング状態が明確に表示される

## 制約事項

- 既存のデザインを維持する
- 既存のコンポーネント構造を大きく変更しない
- パフォーマンスを低下させない

## 成功基準

1. ロゴが常に表示される（エラー時はフォールバック）
2. 物件一覧の画像が常に表示される（エラー時はプレースホルダー）
3. 画像読み込みエラーが適切にハンドリングされる
4. ユーザーからの「画像が表示されない」という報告がなくなる

## 参考情報

### 現在のファイル構造
```
frontend/
├── public/
│   ├── comfortable-tenant-search-logo.png  ← ロゴ画像
│   └── placeholder-property.jpg            ← プレースホルダー画像
├── src/
│   ├── components/
│   │   ├── PublicPropertyLogo.tsx          ← ロゴコンポーネント
│   │   ├── PublicPropertyLogo.css
│   │   ├── PublicPropertyHeader.tsx        ← ヘッダーコンポーネント
│   │   └── PublicPropertyCard.tsx          ← 物件カードコンポーネント
│   └── pages/
│       └── PublicPropertiesPage.tsx        ← 物件一覧ページ
```

### 関連する環境変数
- `VITE_API_URL`: APIのベースURL
- Google Drive画像URL: 動的に生成される

## 優先順位

1. **高**: ロゴのエラーハンドリング追加
2. **高**: 物件画像のエラーハンドリング追加
3. **中**: 画像読み込み状態の管理
4. **中**: プレースホルダー画像の最適化
5. **低**: Service Workerによるキャッシュ
