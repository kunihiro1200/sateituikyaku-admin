# 買主配信フィルタリング - クイックリファレンス

## 📋 プロジェクト概要

**ステータス**: ✅ 完了  
**完了日**: 2025年12月18日  
**主な成果**: メールアドレスベース買主統合、配信精度向上、誤配信防止

---

## 🎯 主要な改善点

### 1. メールアドレスベース統合
- 同じメールアドレスの複数レコードを自動統合
- 希望エリアをマージ（重複なし）
- 最も許容的なステータスを使用（C > D）
- ユニークメールごとに1通のみ配信

### 2. 物件タイプマッチング強化
- 複数タイプ対応（"戸建、マンション"）
- 同等タイプの認識（マンション ≈ アパート、戸建 ≈ 戸建て）
- 価格帯チェック前に物件タイプを検証

### 3. 配信フラグ拡張
- "要"、"mail"、"LINE→mail"を受付
- 配信対象買主が89名から574名に増加（+545%）

### 4. 価格帯パース改善
- "~1900万円"、"1000万円~2999万円"、"3000万円以上"に対応
- 全ての一般的な形式を正しくパース

---

## 📊 主要な指標

| 指標 | 修正前 | 修正後 | 改善 |
|------|--------|--------|------|
| AA13129配信対象 | 0名 | 35名 | +∞% |
| AA13149配信対象 | 0名 | 93名 | +∞% |
| 有効配信フラグ買主 | 89名 | 574名 | +545% |
| AA4160誤配信 | 1件 | 0件 | -100% |
| ユニークメール | 1,000件 | 972件 | 2.8%統合 |

---

## 🔧 テストスクリプト

### 重複メール分析
```bash
cd backend
npx ts-node analyze-duplicate-buyer-emails.ts
```

### メール統合テスト
```bash
# 同じエリアのテスト
npx ts-node test-email-consolidation-same-areas.ts

# 異なるエリアのテスト
npx ts-node test-email-consolidation-different-areas.ts

# ステータス優先順位のテスト
npx ts-node test-email-consolidation-status-priority.ts
```

### バグ修正検証
```bash
# AA4160の誤配信修正を検証
npx ts-node test-aa4160-buyer-2064-fixed.ts
```

### スキーマ検証
```bash
# カラム名の正しさを検証
npx ts-node check-buyers-schema.ts
```

---

## 📚 ドキュメント

### 主要ドキュメント
- [要件定義書](./requirements.md) - 全要件と受入基準
- [設計書](./design.md) - アーキテクチャと実装詳細
- [タスク一覧](./tasks.md) - 全12タスクの詳細
- [プロジェクト完了報告](./PROJECT_COMPLETE.md) - 包括的な完了レポート

### 実装ガイド
- [メール統合ガイド](./EMAIL_CONSOLIDATION_GUIDE.md) - 実装方法の詳細
- [カラム命名ガイド](./COLUMN_NAMING_GUIDE.md) - カラム名の使い分け

### 調査レポート
- [調査サマリー](./INVESTIGATION_SUMMARY.md) - 問題の調査結果
- [Task 9完了レポート](./TASK_9_COMPLETE.md) - メール統合実装
- [Task 10完了レポート](./TASK_10_COMPLETE.md) - カラム参照検証

---

## 🔑 重要な設定値

### ステータス優先順位
```typescript
C: 3  // アクティブ（最優先）
B: 2  // 中優先
A: 2  // 中優先
D: 1  // 非アクティブ（最低優先）
```

### 配信タイプ優先順位
```typescript
'要': 3        // 最優先
'mail': 2      // 中優先
'LINE→mail': 1 // 低優先
```

### 有効な配信フラグ
```typescript
['要', 'mail', 'LINE→mail']
```

### 物件タイプの同等性
```typescript
マンション ≈ アパート
戸建 ≈ 戸建て
```

---

## 🗂️ カラム命名規則

### Buyersテーブル
- **カラム**: `desired_area`
- **用途**: 買主の希望エリア
- **例**: "㊵㊶⑫", "①②③④⑥⑦"

### Property Listingsテーブル
- **カラム**: `distribution_areas`
- **用途**: 物件の配信エリア
- **例**: "㊵㊶", "⑩㊶㊸"

### ✅ 正しい使用例
```typescript
// Buyers
const buyerAreas = buyer.desired_area;

// Property Listings
const propertyAreas = property.distribution_areas;
```

### ❌ 誤った使用例
```typescript
// ❌ buyersテーブルにdistribution_areasカラムは存在しない
const buyerAreas = buyer.distribution_areas;

// ❌ property_listingsテーブルにdesired_areaカラムは存在しない
const propertyAreas = property.desired_area;
```

---

## 🐛 トラブルシューティング

### 問題: 買主が期待される物件を受信しない

**確認事項**:
1. メールアドレスに複数のレコードがあるか？
   ```bash
   npx ts-node analyze-duplicate-buyer-emails.ts
   ```
2. 希望エリアが正しく統合されているか？（ログを確認）
3. 最も許容的なステータスが使用されているか？
4. 物件タイプが一致しているか？

### 問題: 重複メールが送信される

**確認事項**:
1. 統合処理がメール抽出前に実行されているか？
2. メールアドレスが正規化されているか？（小文字、トリム）
3. `consolidateBuyersByEmail()`が呼ばれているか？

### 問題: パフォーマンスの低下

**確認事項**:
1. 統合処理がリクエストごとに1回だけ実行されているか？
2. マップが効率的に使用されているか？
3. キャッシングを検討

---

## 📈 次のステップ

### 短期（1-2週間）
- [ ] 本番環境でテスト実行
- [ ] 配信ログの監視
- [ ] ユーザーフィードバックの収集

### 中期（1-3ヶ月）
- [ ] パフォーマンス最適化
- [ ] UI改善（フィルター結果表示）
- [ ] 自動テストの追加

### 長期（3-6ヶ月）
- [ ] 機械学習の導入
- [ ] A/Bテスト
- [ ] スケーラビリティ向上

---

## 👥 チーム連絡先

### 質問・問題報告
- **技術的な質問**: 開発チームに連絡
- **バグ報告**: GitHubのIssueを作成
- **機能要望**: プロダクトマネージャーに連絡

### 関連リソース
- [GitHub Repository](リポジトリURL)
- [Slack Channel](SlackチャンネルURL)
- [Wiki](WikiURL)

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-18 | 1.0 | 初版作成 - プロジェクト完了 |

---

**最終更新**: 2025年12月18日  
**ステータス**: ✅ 完了  
**次回レビュー**: 2025年1月18日
