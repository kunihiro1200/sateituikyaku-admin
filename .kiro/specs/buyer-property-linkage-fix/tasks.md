# 実装計画

- [x] 1. 診断モジュールの実装



  - 買主と物件の紐づけ状況を分析する診断スクリプトを作成
  - `BuyerLinkageDiagnostic`クラスを実装し、総買主数、property_number有無の統計を取得
  - サンプルデータを含む診断レポートを出力
  - _要件: 1.1, 1.2, 1.3_



- [x] 1.1 診断モジュールのプロパティベーステストを作成
  - **Property 1: Buyer count accuracy**
  - **検証: 要件 1.2**

- [x] 2. カラムマッピング検証ツールの実装
  - `ColumnMappingValidator`クラスを作成
  - buyer-column-mapping.jsonから「物件番号」→「property_number」のマッピングを検証
  - スプレッドシートからサンプルデータを読み取り、物件番号フォーマットを検証
  - マッピングエラーを検出し、修正提案を出力
  - _要件: 2.1, 2.2, 2.4_

- [x] 2.1 カラムマッピング検証のプロパティベーステストを作成
  - **Property 2: Column mapping extraction**
  - **検証: 要件 2.2, 3.2**

- [x] 2.2 物件番号フォーマット検証のプロパティベーステストを作成
  - **Property 3: Property number format validation**
  - **検証: 要件 2.4**

- [x] 3. 拡張買主同期サービスの実装
  - `EnhancedBuyerSyncService`クラスを作成（`BuyerSyncService`を継承）
  - property_numberの明示的な抽出ロジックを追加
  - property_listingsテーブルとの参照整合性検証を実装
  - 詳細なログ出力（抽出成功/失敗、検証結果）を追加
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 3.1 同期更新の一貫性プロパティベーステストを作成
  - **Property 4: Sync update consistency**
  - **検証: 要件 3.3**

- [x] 3.2 参照整合性検証のプロパティベーステストを作成
  - **Property 5: Referential integrity validation**
  - **検証: 要件 3.4**

- [x] 4. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 5. 買主紐づけキャッシュの実装
  - `BuyerLinkageCache`クラスを作成
  - Redisを使用して物件ごとの買主数をキャッシュ
  - キャッシュの取得、設定、無効化、全無効化メソッドを実装
  - TTL（1時間）とキャッシュ期限切れ時の自動更新を実装
  - _要件: 8.1, 8.2, 8.4, 8.5_

- [x] 5.1 キャッシュ無効化のプロパティベーステストを作成
  - **Property 8: Cache invalidation completeness**
  - **検証: 要件 8.1**

- [x] 5.2 キャッシュ再構築精度のプロパティベーステストを作成
  - **Property 9: Cache rebuild accuracy**
  - **検証: 要件 8.2**

- [x] 5.3 キャッシュエントリ構造のプロパティベーステストを作成
  - **Property 10: Cache entry structure**
  - **検証: 要件 8.4**

- [x] 5.4 キャッシュ期限切れ更新のプロパティベーステストを作成
  - **Property 11: Cache expiration refresh**
  - **検証: 要件 8.5**

- [x] 6. 複数物件番号パーサーの実装


  - カンマ区切りまたは区切り文字で区切られた複数の物件番号を解析
  - 各物件番号を個別に抽出し、検証
  - _要件: 7.1_



- [x] 6.1 複数物件番号パーシングのプロパティベーステストを作成


  - **Property 7: Multiple property number parsing**
  - **検証: 要件 7.1**



- [x] 7. APIエンドポイントの更新

  - GET /api/property-listings/:propertyNumber/buyers エンドポイントを更新
  - キャッシュを使用して買主数を取得


  - キャッシュミス時はデータベースから取得し、キャッシュを更新
  - 買主詳細情報（buyer_number, name, phone_number, status）を返す
  - _要件: 4.1, 4.2, 5.2_

- [x] 7.1 買主数表示フォーマットのプロパティベーステストを作成






  - **Property 6: Buyer count display format**
  - **検証: 要件 4.2**

- [ ] 8. 検証モジュールの実装
  - `BuyerLinkageValidator`クラスを作成
  - 特定の物件番号（例: AA6381）の買主紐づけを検証
  - APIエンドポイントをテストし、レスポンスを検証
  - 複数の物件番号を一括検証する機能を実装
  - _要件: 6.1, 6.2, 6.4_

- [ ] 9. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 10. 再同期スクリプトの作成
  - 既存の買主データのproperty_numberを再同期するスクリプトを作成
  - 拡張買主同期サービスを使用
  - 進捗状況と結果統計をログ出力
  - _要件: 3.1, 3.5_

- [ ] 11. フロントエンド: 物件リストページの買主数表示を更新
  - 物件リストページで「買主 (N)」形式で買主数を表示
  - 買主数が0の場合は「買主 (0)」と表示
  - 買主数をクリックすると買主一覧を表示
  - _要件: 4.2, 4.3, 4.4_

- [ ] 12. フロントエンド: 物件詳細ページの買主タブを実装
  - 物件詳細ページに「買主」タブまたはセクションを追加
  - 紐づけられた買主の一覧を表示（buyer_number, name, phone_number, status）
  - 買主をクリックすると買主詳細ページに遷移
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 13. データベースインデックスの追加
  - buyers.property_numberにインデックスを追加（存在しない場合）
  - パフォーマンスを最適化
  - _要件: なし（パフォーマンス最適化）_

- [ ] 14. エラーハンドリングとログの強化
  - 同期エラー（欠損、無効フォーマット、参照整合性違反）のハンドリングを追加
  - キャッシュエラー（Redis接続失敗、キャッシュ破損）のハンドリングを追加
  - 詳細なログ出力とメトリクス収集を実装
  - _要件: なし（エラーハンドリング）_

- [ ] 15. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 16. デプロイメント準備
  - buyersテーブルのバックアップ手順を文書化
  - デプロイメント手順書を作成
  - ロールバック計画を文書化
  - _要件: なし（デプロイメント）_
