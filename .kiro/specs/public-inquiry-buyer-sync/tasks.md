# 実装計画: 公開物件問い合わせの買主リスト自動転記

## 概要

公開物件サイトの問い合わせフォームから送信された情報を、Googleスプレッドシート「買主リスト」に自動転記する機能を実装します。転記処理は非同期で実行され、失敗時には自動的に再試行されます。

## タスク

- [x] 1. データベーススキーマの拡張
  - `property_inquiries`テーブルに同期ステータス管理用のカラムを追加
  - マイグレーションファイルを作成
  - インデックスを追加して未同期の問い合わせを効率的に検索
  - _要件: 1.1, 1.2, 1.3, 7.3, 7.4_

- [ ]* 1.1 マイグレーションのテスト
  - マイグレーションが正しく実行されることを確認
  - カラムとインデックスが正しく作成されることを確認
  - _要件: 1.1_

- [ ] 2. ヘルパー関数の実装
  - [x] 2.1 電話番号正規化関数を実装
    - ハイフン、空白、括弧を除去
    - 全角数字を半角に変換
    - _要件: 2.3, 5.1, 5.2, 5.3, 5.4_

  - [ ]* 2.2 電話番号正規化のプロパティテストを実装
    - **プロパティ3: 電話番号の正規化**
    - **検証: 要件 2.3, 5.1, 5.2, 5.3, 5.4**

  - [x] 2.3 問合せ元判定関数を実装
    - 物件の公開状態に基づいて問合せ元を判定
    - _要件: 2.5, 4.1, 4.2, 4.3_

  - [ ]* 2.4 問合せ元判定のプロパティテストを実装
    - **プロパティ4: 問合せ元の判定**
    - **検証: 要件 2.5, 4.1, 4.2, 4.3**

  - [x] 2.5 買主番号採番関数を実装
    - E列から数値のみを抽出して最大値を取得
    - 最大値+1を返す（存在しない場合は1）
    - _要件: 3.1, 3.2, 3.3, 3.4_

  - [ ]* 2.6 買主番号採番のプロパティテストを実装
    - **プロパティ5: 買主番号の採番**
    - **検証: 要件 3.1, 3.2, 3.3, 3.4**

- [ ] 3. InquirySyncServiceの実装
  - [x] 3.1 InquirySyncServiceクラスの基本構造を作成
    - コンストラクタとプライベートプロパティを定義
    - GoogleSheetsClientとSupabaseClientを初期化
    - _要件: 1.1_

  - [x] 3.2 syncInquiryメソッドを実装
    - 問い合わせデータをDBから取得
    - 物件データを取得
    - フィールドマッピングを実行
    - スプレッドシートに行を追加
    - ステータスを'synced'に更新
    - _要件: 1.1, 1.2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

  - [ ]* 3.3 syncInquiryのプロパティテストを実装
    - **プロパティ1: 問い合わせの転記**
    - **プロパティ2: フィールドマッピングの正確性**
    - **検証: 要件 1.1, 1.2, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6**

  - [x] 3.4 エラーハンドリングを実装
    - 転記失敗時にステータスを'failed'に更新
    - エラーメッセージをsheet_sync_error_messageに記録
    - _要件: 1.3, 8.1, 8.2_

  - [ ]* 3.5 エラーハンドリングのユニットテストを実装
    - 転記失敗時のステータス更新を確認
    - エラーメッセージの記録を確認
    - _要件: 1.3_

  - [x] 3.6 再試行ロジックを実装
    - 最大3回まで再試行
    - 指数バックオフ（1秒、2秒、4秒）を実装
    - レート制限エラー（429）の特別処理
    - _要件: 6.1, 6.2, 6.3, 6.4_

  - [ ]* 3.7 再試行ロジックのプロパティテストを実装
    - **プロパティ8: 再試行メカニズム**
    - **検証: 要件 6.1, 6.2, 6.3, 6.4**

  - [x] 3.8 重複転記防止ロジックを実装
    - 'synced'ステータスの問い合わせはスキップ
    - 'pending'ステータスの重複処理を防止
    - _要件: 7.1, 7.2_

  - [ ]* 3.9 重複転記防止のプロパティテストを実装
    - **プロパティ9: 重複転記の防止**
    - **検証: 要件 7.1, 7.2**

  - [x] 3.10 syncPendingInquiriesメソッドを実装
    - 未同期の問い合わせを一括処理
    - 各問い合わせに対してsyncInquiryを実行
    - _要件: 1.1_

  - [ ]* 3.11 syncPendingInquiriesのユニットテストを実装
    - 未同期の問い合わせが正しく処理されることを確認
    - _要件: 1.1_

- [x] 4. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 5. APIエンドポイントの拡張
  - [x] 5.1 publicInquiries.tsを拡張
    - InquirySyncServiceをインポート
    - 問い合わせ保存後に非同期転記を開始
    - エラーが発生してもユーザーには影響しないようにする
    - _要件: 1.1, 1.4_

  - [ ]* 5.2 APIエンドポイントのユニットテストを実装
    - 問い合わせ送信が成功することを確認
    - 転記エラーが発生してもAPIレスポンスは成功を返すことを確認
    - _要件: 1.4_

  - [ ]* 5.3 APIエンドポイントのプロパティテストを実装
    - **プロパティ7: 非同期処理の独立性**
    - **検証: 要件 1.4**

- [ ] 6. バックグラウンドジョブの実装
  - [x] 6.1 定期実行ジョブを実装
    - 5分ごとに未同期の問い合わせを処理
    - エラーハンドリングとロギングを実装
    - _要件: 1.1_

  - [ ]* 6.2 バックグラウンドジョブのユニットテストを実装
    - ジョブが正しく実行されることを確認
    - _要件: 1.1_

- [ ] 7. ロギングの実装
  - [x] 7.1 ロギング機能を実装
    - 転記成功時のログ
    - エラー発生時のログ
    - 再試行時のログ
    - _要件: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 7.2 ロギングのプロパティテストを実装
    - **プロパティ10: ロギングの完全性**
    - **検証: 要件 8.1, 8.2, 8.3, 8.4**

- [ ] 8. 統合テストと動作確認
  - [ ] 8.1 エンドツーエンドテストを実装
    - 問い合わせフォームの送信から転記完了までの一連の流れを確認
    - _要件: すべて_

  - [x] 8.2 手動テストを実施
    - 実際のスプレッドシートに対して転記処理を実行
    - 各フィールドが正しくマッピングされていることを確認
    - _要件: すべて_

- [x] 9. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

## 注意事項

- `*`マークが付いているタスクはオプションで、より速いMVPのためにスキップ可能です
- 各タスクは要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、早期にエラーを発見します
- プロパティテストは各プロパティで最低100回の反復を実行します
- ユニットテストとプロパティテストは相補的で、両方が包括的なカバレッジに必要です
