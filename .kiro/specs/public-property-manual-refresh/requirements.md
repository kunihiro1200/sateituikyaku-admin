# 公開物件サイト 手動更新機能 - 要件定義

## 1. 概要

公開物件サイトの詳細ページに、管理者が手動でデータを更新できるボタンを追加します。
現在は60分間のキャッシュがあるため、データを更新しても最大60分待つ必要がありますが、この機能により即座に最新データを表示できるようになります。

## 2. 背景

### 現在の問題
- データ更新後、最大60分待たないと最新データが表示されない
- 画像を差し替えても、キャッシュが切れるまで古い画像が表示される
- 価格や基本情報を変更しても、すぐに反映されない

### 既存の機能
- 「画像を更新」ボタンは既に実装済み（画像キャッシュのみクリア）
- この機能を拡張して、他のデータも更新できるようにする

## 3. ユーザーストーリー

### US-1: 画像と基本情報を素早く更新したい
**As a** 管理者  
**I want to** 画像と基本情報を1-2秒で更新できる  
**So that** 頻繁に更新する情報を素早く確認できる

**受け入れ基準**:
- 1.1 「画像・基本情報を更新」ボタンがページ上部に表示される
- 1.2 ボタンをクリックすると、1-2秒で更新が完了する
- 1.3 更新対象は以下のみ:
  - 基本情報（物件番号、住所、価格、間取り、土地面積、建物面積など）
  - 画像（Google Driveから最新の画像を取得）
- 1.4 おすすめコメントとお気に入り文言は更新しない（高速化のため）
- 1.5 更新中はローディングアイコンが表示される
- 1.6 更新完了後、成功メッセージが表示される
- 1.7 更新失敗時、エラーメッセージが表示される

### US-2: 全てのデータを更新したい
**As a** 管理者  
**I want to** 全てのデータを一括更新できる  
**So that** たまに必要な時に全てのデータを最新にできる

**受け入れ基準**:
- 2.1 「全て更新」ボタンがページ上部に表示される
- 2.2 ボタンをクリックすると、3-5秒で更新が完了する
- 2.3 更新対象は以下の全て:
  - 基本情報（データベース）
  - 画像（Google Drive）
  - おすすめコメント（Google Sheets）
  - お気に入り文言（Google Sheets）
  - パノラマURL（Google Sheets）
- 2.4 更新中はローディングアイコンが表示される
- 2.5 更新完了後、成功メッセージが表示される
- 2.6 更新失敗時、エラーメッセージが表示される

### US-3: 管理者のみがボタンを使用できる
**As a** システム  
**I want to** 管理者のみに更新ボタンを表示する  
**So that** 一般ユーザーが誤って更新ボタンを押すことを防ぐ

**受け入れ基準**:
- 3.1 `canHide=true`（管理者モード）の場合のみボタンが表示される
- 3.2 一般ユーザー（ログインなし）にはボタンが表示されない
- 3.3 ログイン状態は`useAuthStore`で判定する

## 4. 非機能要件

### パフォーマンス
- NFR-1: 「画像・基本情報を更新」ボタンは1-2秒以内に完了すること
- NFR-2: 「全て更新」ボタンは3-5秒以内に完了すること
- NFR-3: 更新中もページは操作可能であること（ボタンのみ無効化）

### ユーザビリティ
- NFR-4: 更新中は視覚的フィードバック（ローディングアイコン）を表示すること
- NFR-5: 成功/失敗メッセージはSnackbarで3秒間表示すること
- NFR-6: ボタンは既存の「画像を更新」ボタンと統一されたデザインであること

### セキュリティ
- NFR-7: 管理者のみがAPIエンドポイントを呼び出せること
- NFR-8: 認証トークンが必要であること（既存の認証機構を使用）

## 5. 制約事項

### 技術的制約
- CONS-1: Google Drive APIのレート制限を考慮すること
- CONS-2: Google Sheets APIのレート制限を考慮すること
- CONS-3: 既存のキャッシュ機構（60分）は維持すること

### ビジネス制約
- CONS-4: 更新頻度は2ヶ月に1度、1日1物件程度を想定
- CONS-5: 主な更新対象は画像と基本情報（価格など）

## 6. 想定される使用シナリオ

### シナリオ1: 画像を差し替えた場合
1. 管理者がGoogle Driveで画像を差し替える
2. 公開物件サイトでその物件を開く
3. 「画像・基本情報を更新」ボタンをクリック
4. 1-2秒後、最新の画像が表示される

### シナリオ2: 価格を変更した場合
1. 管理者がスプレッドシートで価格を変更
2. 自動同期が実行され、データベースが更新される
3. 公開物件サイトでその物件を開く
4. 「画像・基本情報を更新」ボタンをクリック
5. 1-2秒後、最新の価格が表示される

### シナリオ3: おすすめコメントを変更した場合
1. 管理者がGoogle Sheetsでおすすめコメントを変更
2. 公開物件サイトでその物件を開く
3. 「全て更新」ボタンをクリック
4. 3-5秒後、最新のおすすめコメントが表示される

## 7. 成功指標

- KPI-1: 更新ボタンの使用頻度（月間）
- KPI-2: 更新ボタンの成功率（95%以上）
- KPI-3: 平均更新時間（「画像・基本情報を更新」: 2秒以内、「全て更新」: 5秒以内）

## 8. 除外事項

以下は今回の実装範囲外とします：

- OUT-1: 物件一覧ページでの一括更新機能
- OUT-2: 自動更新の頻度変更（60分キャッシュは維持）
- OUT-3: 更新履歴の記録機能
- OUT-4: 更新通知機能（メールやSlackなど）

## 9. 依存関係

### 既存機能
- DEP-1: 既存の「画像を更新」ボタン（`PropertyImageGallery.tsx`）
- DEP-2: 既存の認証機構（`useAuthStore`）
- DEP-3: 既存のキャッシュ機構（`/api/public/properties/:identifier/complete`）

### 外部サービス
- DEP-4: Google Drive API
- DEP-5: Google Sheets API
- DEP-6: Supabase（データベース）

## 10. リスクと対策

### リスク1: APIレート制限
**リスク**: Google APIのレート制限に達する可能性  
**対策**: 
- 更新頻度は低い（2ヶ月に1度、1日1物件）ため、問題ない
- エラーハンドリングを実装し、レート制限エラーを適切に表示

### リスク2: 更新時間が長い
**リスク**: 「全て更新」ボタンが5秒以上かかる可能性  
**対策**:
- 「画像・基本情報を更新」ボタンを優先的に使用
- 並列処理で高速化（可能な範囲で）

### リスク3: キャッシュの不整合
**リスク**: 更新後もキャッシュが残る可能性  
**対策**:
- キャッシュキーに物件IDとタイムスタンプを含める
- 更新時にキャッシュを明示的にクリア

## 11. 今後の拡張可能性

- FUT-1: 物件一覧ページでの一括更新機能
- FUT-2: 更新履歴の記録と表示
- FUT-3: 自動更新の頻度をカスタマイズ可能にする
- FUT-4: 更新通知機能（メールやSlack）
