# Implementation Plan: 公開物件一覧画面の画像表示修正

## Overview

公開物件サイトの一覧画面で画像が表示されない問題を解決する。詳細画面では正常に画像が表示されているため、一覧画面と詳細画面の画像取得ロジックの違いを特定し、一覧画面でも同様に画像が表示されるように修正する。

## Tasks

- [x] 1. 問題の原因を特定する
  - バックエンドとフロントエンドの両方にログを追加
  - 一覧画面のAPIレスポンスに`images`配列が含まれているか確認
  - 画像取得処理が実行されているか確認
  - エラーが発生していないか確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2. バックエンドの画像取得ロジックを修正する
  - [x] 2.1 PropertyListingService.getPublicProperties()にログを追加
    - 各物件の`storage_location`の有無をログ出力
    - `getStorageUrlFromWorkTasks()`の呼び出し結果をログ出力
    - `PropertyImageService.getFirstImage()`の呼び出し結果をログ出力
    - 最終的な`images`配列の内容をログ出力
    - _Requirements: 2.1, 2.2, 2.3_

  - [x] 2.2 画像取得処理のエラーハンドリングを強化
    - try-catchブロックでエラーをキャッチ
    - エラー時は空の画像配列を返す
    - エラー内容を詳細にログ出力
    - _Requirements: 4.1, 4.2_

  - [ ]* 2.3 画像取得処理のユニットテストを作成
    - `storage_location`がある場合のテスト
    - `storage_location`がない場合のテスト
    - `image_url`がある場合のテスト
    - エラー時のテスト
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3. Checkpoint - ログを確認して問題を特定
  - バックエンドのログを確認
  - フロントエンドのコンソールログを確認
  - ネットワークタブで画像URLへのリクエストを確認
  - 問題の原因を特定したら、ユーザーに報告

- [x] 4. 特定された問題に応じた修正を実装
  - [x] 4.1 Promise.all()の並列処理を制限（必要な場合）
    - `p-limit`ライブラリをインストール
    - 並列数を5に制限
    - _Requirements: 3.1_

  - [x] 4.2 キャッシュロジックを修正（必要な場合）
    - `getStorageUrlFromWorkTasks()`のキャッシュを確認
    - キャッシュの有効期限を確認
    - キャッシュのクリア処理を確認
    - _Requirements: 3.2_

  - [x] 4.3 フロントエンドの画像表示ロジックを修正（必要な場合）
    - `PublicPropertiesPage.tsx`の画像表示部分を確認
    - `images`配列が空の場合のプレースホルダー表示を確認
    - 画像URLの形式を確認
    - _Requirements: 2.1, 2.2, 2.4_

- [x] 5. 一覧画面と詳細画面の一貫性を確保
  - [x] 5.1 一覧画面と詳細画面で同じ画像取得ロジックを使用していることを確認
    - `getPublicProperties()`と`getPublicPropertyById()`のコードを比較
    - 両方とも`PropertyImageService.getFirstImage()`を使用していることを確認
    - 両方とも`getStorageUrlFromWorkTasks()`を使用していることを確認
    - _Requirements: 5.1, 5.2, 5.3, 5.4_

  - [ ]* 5.2 一覧画面と詳細画面の一貫性をテスト
    - 同じ物件の一覧画面と詳細画面で同じ画像が表示されることを確認
    - _Requirements: 5.2_

- [x] 6. パフォーマンスの最適化
  - [x] 6.1 画像取得の並列数を制限
    - `p-limit`を使用して並列数を5に制限
    - Google Drive APIのレート制限を回避
    - _Requirements: 3.1_

  - [x] 6.2 画像URLのキャッシュを実装（必要な場合）
    - `PropertyImageService`に画像URLのキャッシュを追加
    - キャッシュの有効期限を5分に設定
    - _Requirements: 3.4_

  - [ ]* 6.3 パフォーマンステスト
    - 一覧画面の初回ロード時間を測定（目標: 2秒以内）
    - ページネーション時のレスポンスタイムを測定（目標: 1秒以内）
    - _Requirements: 1.1, 1.2_

- [x] 7. 統合テストと検証
  - [x] 7.1 一覧画面で画像が表示されることを確認
    - ページ1で画像が表示される
    - ページ2以降でも画像が表示される
    - フィルター適用後も画像が表示される
    - _Requirements: 2.1, 2.2_

  - [x] 7.2 詳細画面で画像が表示されることを確認（既存機能の確認）
    - 一覧画面から詳細画面に遷移
    - 同じ画像が表示される
    - _Requirements: 5.2_

  - [x] 7.3 エラー時の動作を確認
    - `storage_location`がない物件でプレースホルダーが表示される
    - 画像取得エラー時でも物件が表示される
    - _Requirements: 4.1, 4.2, 4.3_

  - [ ]* 7.4 統合テストを作成
    - 一覧画面から詳細画面への遷移テスト
    - ページネーションテスト
    - フィルター適用後のテスト
    - _Requirements: 2.1, 2.2, 5.2_

- [x] 8. Final checkpoint - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認
  - 一覧画面と詳細画面の両方で画像が表示されることを確認
  - パフォーマンスが劣化していないことを確認
  - ユーザーに最終確認を依頼

- [x] 9. スクロール位置復元機能の実装
  - [x] 9.1 NavigationState型定義を作成
    - スクロール位置、ページ番号、フィルター設定を含む型を定義
    - _Requirements: 6.1, 6.3, 6.4_

  - [x] 9.2 一覧画面でナビゲーション状態を保存
    - 物件カードクリック時に現在のスクロール位置を取得
    - 現在のページ番号とフィルター設定を取得
    - React Router の navigate() で state として渡す
    - _Requirements: 6.1, 6.3, 6.4_

  - [x] 9.3 一覧画面でナビゲーション状態を復元
    - useLocation() で保存された state を取得
    - ページ番号とフィルター設定を復元
    - 画像読み込み完了後にスクロール位置を復元
    - _Requirements: 6.2, 6.3, 6.4_

  - [ ]* 9.4 スクロール位置復元のテスト
    - 一覧画面から詳細画面に遷移し、戻った時にスクロール位置が復元されることを確認
    - ページ番号とフィルター設定が復元されることを確認
    - _Requirements: 6.2, 6.3, 6.4_

- [ ] 10. Final checkpoint - スクロール位置復元機能の確認
  - 一覧画面から詳細画面に遷移し、戻った時に元の位置に戻ることを確認
  - ページネーション後に詳細画面に遷移し、戻った時に正しいページに戻ることを確認
  - フィルター適用後に詳細画面に遷移し、戻った時にフィルターが保持されることを確認
  - ユーザーに最終確認を依頼

## Notes

- タスクに`*`が付いているものはオプション（テスト関連）で、コア機能の実装を優先する場合はスキップ可能
- 各タスクは特定の要件を参照しており、トレーサビリティを確保
- Checkpoint（タスク3と8）で進捗を確認し、必要に応じてユーザーに質問
- 問題の原因が特定されるまで、タスク4の具体的な修正内容は確定しない
