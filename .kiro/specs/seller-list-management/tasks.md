# 実装タスク

## フェーズ1: 基盤構築

### タスク1.1: データベーススキーマ作成
- [ ] sellersテーブルを作成
- [ ] employeesテーブルを作成
- [ ] activity_logsテーブルを作成
- [ ] sessionsテーブルを作成
- [ ] valuation_historyテーブルを作成
- [ ] sync_logsテーブルを作成
- [ ] data_freshnessテーブルを作成
- [ ] 必要なインデックスを作成
- [ ] 外部キー制約を設定
- [ ] UNIQUE制約を設定
- *[ ] マイグレーションスクリプトをテスト（P1: 売主番号の一意性と形式）

### タスク1.2: 認証基盤の実装
- [ ] Google OAuth 2.0設定
- [ ] AuthServiceの実装
- [ ] 認証ミドルウェアの実装
- [ ] セッション管理の実装
- [ ] トークンリフレッシュ機能の実装
- *[ ] 認証フローのテスト
- *[ ] セッション期限切れのテスト

### タスク1.3: 暗号化ユーティリティの実装
- [ ] 暗号化関数の実装
- [ ] 復号化関数の実装
- [ ] 暗号化キーの管理
- *[ ] 暗号化・復号化のユニットテスト（P2: 個人情報の暗号化）
- *[ ] プロパティベーステスト（可逆性の検証）

## フェーズ2: コアサービス実装

### タスク2.1: 売主番号サービスの実装
- [ ] SellerNumberServiceの実装
- [ ] 売主番号生成ロジックの実装
- [ ] 売主番号フォーマット検証の実装
- [ ] 重複チェック機能の実装
- *[ ] ユニットテスト（P1: 売主番号の一意性と形式）
- *[ ] プロパティベーステスト（一意性の検証）

### タスク2.2: 売主サービスの実装
- [ ] SellerServiceの実装
- [ ] 売主作成機能の実装
- [ ] 売主取得機能の実装
- [ ] 売主更新機能の実装
- [ ] 売主削除機能（論理削除）の実装
- [ ] 売主リスト取得機能の実装
- [ ] 売主検索機能の実装
- [ ] 個人情報の暗号化・復号化処理の統合
- *[ ] ユニットテスト
- *[ ] 統合テスト

### タスク2.3: 重複検出サービスの実装
- [ ] DuplicateDetectionServiceの実装
- [ ] 電話番号による重複チェックの実装
- [ ] メールアドレスによ重複チェックの実装
- [ ] 重複売主情報取得の実装
- [ ] 売主コピー機能の実装
- *[ ] ユニットテスト（P3: 重複検出の正確性）
- *[ ] プロパティベーステスト（重複検出の網羅性）

### タスク2.4: 査定エンジンの実装
- [ ] ValuationEngineの実装
- [ ] 戸建て・土地の査定計算ロジックの実装
- [ ] マンション手入力機能の実装
- [ ] 査定額妥当性チェックの実装
- [ ] 査定履歴管理の実装
- *[ ] ユニットテスト（P4: 査定額の妥当性）
- *[ ] プロパティベーステスト（査定額の昇順検証）

### タスク2.5: 活動ログサービスの実装
- [ ] ActivityLogServiceの実装
- [ ] 電話活動記録機能の実装
- [ ] メール活動記録機能の実装
- [ ] SMS活動記録機能の実装
- [ ] 活動ログ取得機能の実装
- [ ] 活動統計集計機能の実装
- *[ ] ユニットテスト（P5: 活動ログの完全性）
- *[ ] プロパティベーステスト（時系列順の検証）

## フェーズ3: 外部API連携

### タスク3.1: メールサービスの実装
- [ ] EmailServiceの実装
- [ ] Gmail API連携の実装
- [ ] 査定メール自動生成の実装
- [ ] 追客メール送信の実装
- [ ] メールテンプレート管理の実装
- [ ] リトライ機能の実装
- *[ ] ユニットテスト（モック使用）
- *[ ] 統合テスト（Gmail API）

### タスク3.2: カレンダーサービスの実装
- [ ] CalendarServiceの実装
- [ ] Google Calendar API連携の実装
- [ ] 訪問査定予約登録の実装
- [ ] カレンダーイベント更新の実装
- [ ] カレンダーイベント削除の実装
- [ ] 社員カレンダー取得の実装
- *[ ] ユニットテスト（P6: カレンダー同期の一貫性）
- *[ ] プロパティベーステスト（予約・キャンセルの一貫性）

### タスク3.3: Google Chatサービスの実装
- [ ] ChatNotificationServiceの実装
- [ ] Google Chat API連携の実装
- [ ] 一般媒介通知の実装
- [ ] 専任取得通知の実装
- [ ] 他決共有通知の実装
- [ ] 物件紹介通知の実装
- *[ ] ユニットテスト（モック使用）
- *[ ] 統合テスト（Google Chat API）

### タスク3.4: スプレッドシート同期サービスの実装
- [ ] SpreadsheetSyncServiceの実装
- [ ] Google Sheets API連携の実装
- [ ] 手動同期機能の実装
- [ ] 自動同期機能の実装
- [ ] データ鮮度管理の実装
- [ ] スプレッドシートからのデータ取得の実装
- [ ] データベース更新処理の実装
- [ ] 同期ログ記録の実装
- *[ ] ユニットテスト（P9: データ鮮度管理）
- *[ ] プロパティベーステスト（自動更新の検証）

## フェーズ4: REST API実装

### タスク4.1: 売主API エンドポイント
- [ ] POST /api/sellers（売主作成）
- [ ] GET /api/sellers/:id（売主取得）
- [ ] PUT /api/sellers/:id（売主更新）
- [ ] DELETE /api/sellers/:id（売主削除）
- [ ] GET /api/sellers（売主リスト取得）
- [ ] GET /api/sellers/search（売主検索）
- [ ] エラーハンドリングの実装
- [ ] バリデーションの実装
- *[ ] 統合テスト

### タスク4.2: 認証API エンドポイント
- [ ] GET /api/auth/google（OAuth URL生成）
- [ ] GET /api/auth/callback（OAuth コールバック）
- [ ] POST /api/auth/logout（ログアウト）
- [ ] GET /api/auth/session（セッション確認）
- *[ ] 統合テスト

### タスク4.3: 活動ログAPI エンドポイント
- [ ] POST /api/activity-logs（活動ログ作成）
- [ ] GET /api/activity-logs（活動ログ取得）
- [ ] GET /api/activity-logs/statistics（活動統計取得）
- *[ ] 統合テスト

### タスク4.4: 査定API エンドポイント
- [ ] POST /api/valuations（査定実行）
- [ ] GET /api/valuations/:sellerId（査定履歴取得）
- [ ] PUT /api/valuations/:id（査定更新）
- *[ ] 統合テスト

### タスク4.5: メールAPI エンドポイント
- [ ] POST /api/emails/valuation（査定メール送信）
- [ ] POST /api/emails/follow-up（追客メール送信）
- [ ] GET /api/emails/templates（テンプレート取得）
- *[ ] 統合テスト

### タスク4.6: カレンダーAPI エンドポイント
- [ ] POST /api/calendar/events（イベント作成）
- [ ] PUT /api/calendar/events/:id（イベント更新）
- [ ] DELETE /api/calendar/events/:id（イベント削除）
- [ ] GET /api/calendar/events（イベント取得）
- *[ ] 統合テスト

### タスク4.7: 通知API エンドポイント
- [ ] POST /api/notifications/general-mediation（一般媒介通知）
- [ ] POST /api/notifications/exclusive-contract（専任取得通知）
- [ ] POST /api/notifications/competitor-win（他決共有通知）
- [ ] POST /api/notifications/property-introduction（物件紹介通知）
- *[ ] 統合テスト

### タスク4.8: 同期API エンドポイント
- [ ] POST /api/sync/manual（手動同期実行）
- [ ] GET /api/sync/status（同期ステータス取得）
- [ ] GET /api/sync/logs（同期ログ取得）
- *[ ] 統合テスト

## フェーズ5: フロントエンド実装

### タスク5.1: 認証画面
- [ ] ログイン画面の実装
- [ ] Google OAuth 2.0ボタンの実装
- [ ] 認証コールバック処理の実装
- [ ] セッション管理の実装
- *[ ] E2Eテスト

### タスク5.2: 売主リスト画面
- [ ] 売主リスト表示の実装
- [ ] ページネーション（50件/ページ）の実装
- [ ] 検索機能の実装
- [ ] フィルタリング機能の実装
- [ ] ソート機能の実装
- [ ] 手動更新ボタンの実装
- [ ] ローディング表示の実装
- *[ ] E2Eテスト（P7: 検索パフォーマンス）
- *[ ] E2Eテスト（P8: ページネーションの正確性）

### タスク5.3: 売主詳細画面
- [ ] 売主詳細表示の実装
- [ ] 基本情報セクションの実装
- [ ] 物件情報セクションの実装
- [ ] 査定情報セクションの実装
- [ ] 追客情報セクションの実装
- [ ] 訪問査定情報セクションの実装
- [ ] 競合情報セクションの実装（条件付き表示）
- [ ] 活動ログ表示の実装
- [ ] 編集機能の実装
- [ ] 保存機能の実装
- *[ ] E2Eテスト（P10: 競合情報の必須入力）

### タスク5.4: 新規売主登録画面
- [ ] 新規登録フォームの実装
- [ ] 入力バリデーションの実装
- [ ] 重複チェック表示の実装
- [ ] 売主番号自動生成の実装
- [ ] 保存機能の実装
- *[ ] E2Eテスト

### タスク5.5: 査定メール送信機能
- [ ] 査定メール送信ボタンの実装
- [ ] メールテンプレート選択の実装
- [ ] メールプレビューの実装
- [ ] 送信確認ダイアログの実装
- [ ] 送信結果通知の実装
- *[ ] E2Eテスト

### タスク5.6: 訪問査定予約機能
- [ ] 訪問査定予約フォームの実装
- [ ] 日時選択の実装
- [ ] 担当者選択の実装
- [ ] カレンダー連携の実装
- [ ] 予約確認ダイアログの実装
- *[ ] E2Eテスト

### タスク5.7: Google Chat通知機能
- [ ] 通知ボタンの実装（一般媒介）
- [ ] 通知ボタンの実装（専任取得）
- [ ] 通知ボタンの実装（他決共有）
- [ ] 通知ボタンの実装（物件紹介）
- [ ] 送信確認ダイアログの実装
- [ ] 送信結果通知の実装
- *[ ] E2Eテスト

### タスク5.8: 活動ログ画面
- [ ] 活動ログリスト表示の実装
- [ ] フィルタリング機能の実装
- [ ] 活動統計表示の実装
- [ ] 詳細表示の実装
- *[ ] E2Eテスト

### タスク5.9: 状態管理（Zustand）
- [ ] 認証ストアの実装
- [ ] 売主ストアの実装
- [ ] キャッシュストアの実装
- [ ] 通知ストアの実装
- *[ ] ユニットテスト

### タスク5.10: API クライアント
- [ ] API クライアントの実装
- [ ] エラーハンドリングの実装
- [ ] リトライ機能の実装
- [ ] インターセプターの実装
- *[ ] ユニットテスト

## フェーズ6: パフォーマンス最適化

### タスク6.1: データベース最適化
- [ ] クエリパフォーマンスの分析
- [ ] インデックスの最適化
- [ ] クエリの最適化
- [ ] コネクションプーリングの設定
- *[ ] パフォーマンステスト（P7: 検索パフォーマンス）

### タスク6.2: キャッシング戦略
- [ ] Redis キャッシュの実装
- [ ] キャッシュキー設計
- [ ] キャッシュ無効化戦略の実装
- [ ] キャッシュウォームアップの実装
- *[ ] パフォーマンステスト

### タスク6.3: フロントエンド最適化
- [ ] 遅延読み込みの実装
- [ ] 仮想スクロールの実装
- [ ] コード分割の実装
- [ ] 画像最適化の実装
- *[ ] パフォーマンステスト

## フェーズ7: テストとドキュメント

### タスク7.1: プロパティベーステスト
- [ ] P1: 売主番号の一意性と形式のテスト
- [ ] P2: 個人情報の暗号化のテスト
- [ ] P3: 重複検出の正確性のテスト
- [ ] P4: 査定額の妥当性のテスト
- [ ] P5: 活動ログの完全性のテスト
- [ ] P6: カレンダー同期の一貫性のテスト
- [ ] P7: 検索パフォーマンスのテスト
- [ ] P8: ページネーションの正確性のテスト
- [ ] P9: データ鮮度管理のテスト
- [ ] P10: 競合情報の必須入力のテスト

### タスク7.2: E2Eテスト
- [ ] ログインフローのテスト
- [ ] 売主登録フローのテスト
- [ ] 査定メール送信フローのテスト
- [ ] 訪問査定予約フローのテスト
- [ ] 追客活動記録フローのテスト
- [ ] 検索・フィルタリングのテスト
- [ ] 重複チェックのテスト
- [ ] 競合情報入力のテスト

### タスク7.3: パフォーマンステスト
- [ ] 1万件データでの初期表示速度テスト
- [ ] 検索速度テスト
- [ ] ページネーション速度テスト
- [ ] 同期処理速度テスト
- [ ] 負荷テスト（k6）

### タスク7.4: セキュリティテスト
- [ ] 認証・認可のテスト
- [ ] 個人情報暗号化のテスト
- [ ] SQLインジェクション対策のテスト
- [ ] XSS対策のテスト
- [ ] CSRF対策のテスト

### タスク7.5: ドキュメント作成
- [ ] API ドキュメント（OpenAPI/Swagger）
- [ ] ユーザーマニュアル
- [ ] 開発者ガイド
- [ ] デプロイメントガイド
- [ ] トラブルシューティングガイド

## フェーズ8: デプロイメント

### タスク8.1: 環境構築
- [ ] 開発環境のセットアップ
- [ ] ステージング環境のセットアップ
- [ ] 本番環境のセットアップ
- [ ] CI/CDパイプラインの構築
- [ ] 環境変数の設定

### タスク8.2: データ移行
- [ ] 既存データの分析
- [ ] マイグレーションスクリプトの作成
- [ ] データ移行のテスト
- [ ] 本番データ移行の実行
- [ ] データ整合性の検証

### タスク8.3: 監視とログ
- [ ] アプリケーションログの設定
- [ ] エラー監視の設定
- [ ] パフォーマンス監視の設定
- [ ] アラート設定
- [ ] ダッシュボード作成

### タスク8.4: バックアップとリカバリ
- [ ] データベースバックアップの設定
- [ ] バックアップスケジュールの設定
- [ ] リカバリ手順の作成
- [ ] リカバリテストの実施

## チェックポイント

### チェックポイント1: 基盤構築完了
**タイミング：** フェーズ1完了後

**確認項目：**
- [ ] データベーススキーマが正しく作成されている
- [ ] 認証フローが正常に動作する
- [ ] 暗号化・復号化が正しく機能する
- [ ] 全てのユニットテストが通過する

**成功基準：**
- 認証からログアウトまでの一連の流れが正常に動作すること
- 個人情報が暗号化されてデータベースに保存されること
- プロパティベーステストが全て通過すること

### チェックポイント2: コアサービス完了
**タイミング：** フェーズ2完了後

**確認項目：**
- [ ] 売主の作成・取得・更新・削除が正常に動作する
- [ ] 売主番号が正しく生成される
- [ ] 重複検出が正確に機能する
- [ ] 査定額が正しく計算される
- [ ] 活動ログが正確に記録される
- [ ] 全てのユニットテストが通過する

**成功基準：**
- 売主管理の基本的なCRUD操作が全て正常に動作すること
- 重複検出が100%の精度で機能すること
- 査定額が常に昇順であること
- プロパティベーステストが全て通過すること

### チェックポイント3: 外部API連携完了
**タイミング：** フェーズ3完了後

**確認項目：**
- [ ] Gmail APIでメール送信が正常に動作する
- [ ] Google Calendar APIでイベント作成・削除が正常に動作する
- [ ] Google Chat APIで通知送信が正常に動作する
- [ ] スプレッドシート同期が正常に動作する
- [ ] 手動同期・自動同期が正しく機能する
- [ ] 全ての統合テストが通過する

**成功基準：**
- 全ての外部API連携が正常に動作すること
- エラー時のリトライ機能が正しく動作すること
- データ鮮度管理が正確に機能すること
- 統合テストが全て通過すること

### チェックポイント4: REST API完了
**タイミング：** フェーズ4完了後

**確認項目：**
- [ ] 全てのAPIエンドポイントが正常に動作する
- [ ] エラーハンドリングが適切に実装されている
- [ ] バリデーションが正しく機能する
- [ ] 認証・認可が正しく機能する
- [ ] 全ての統合テストが通過する

**成功基準：**
- 全てのAPIエンドポイントが仕様通りに動作すること
- エラーレスポンスが適切に返されること
- 認証が必要なエンドポイントで認証チェックが機能すること
- 統合テストが全て通過すること

### チェックポイント5: フロントエンド完了
**タイミング：** フェーズ5完了後

**確認項目：**
- [ ] 全ての画面が正常に表示される
- [ ] ユーザー操作が正常に動作する
- [ ] エラー表示が適切に実装されている
- [ ] ローディング表示が適切に実装されている
- [ ] 全てのE2Eテストが通過する

**成功基準：**
- 全ての画面が仕様通りに動作すること
- ユーザーが迷わず操作できること
- エラー時に適切なメッセージが表示されること
- E2Eテストが全て通過すること

### チェックポイント6: パフォーマンス最適化完了
**タイミング：** フェーズ6完了後

**確認項目：**
- [ ] 1万件データで初期表示が3秒以内
- [ ] 検索が1秒以内に完了する
- [ ] ページネーションが高速に動作する
- [ ] キャッシュが正しく機能する
- [ ] 全てのパフォーマンステストが通過する

**成功基準：**
- P7（検索パフォーマンス）の要件を満たすこと
- P8（ページネーションの正確性）の要件を満たすこと
- キャッシュヒット率が80%以上であること
- パフォーマンステストが全て通過すること

### チェックポイント7: テスト完了
**タイミング：** フェーズ7完了後

**確認項目：**
- [ ] 全てのプロパティベーステストが通過する
- [ ] 全てのE2Eテストが通過する
- [ ] 全てのパフォーマンステストが通過する
- [ ] 全てのセキュリティテストが通過する
- [ ] テストカバレッジが80%以上である

**成功基準：**
- P1〜P10の全ての正確性プロパティが検証されていること
- 全てのユーザーシナリオがE2Eテストでカバーされていること
- パフォーマンス要件が全て満たされていること
- セキュリティ脆弱性が存在しないこと

### チェックポイント8: デプロイメント完了
**タイミング：** フェーズ8完了後

**確認項目：**
- [ ] 本番環境が正常に動作する
- [ ] データ移行が正常に完了している
- [ ] 監視とログが正常に機能する
- [ ] バックアップが正常に取得されている
- [ ] ドキュメントが完成している

**成功基準：**
- 本番環境で全ての機能が正常に動作すること
- データ整合性が保たれていること
- 監視アラートが正しく設定されていること
- リカバリ手順が確立されていること

## オプションタスク（*印のタスク）について

*印のタスクはテスト関連のタスクです。これらは以下の理由でオプションとしています：

1. **MVP（最小実行可能製品）を優先する場合：** テストを後回しにして、まず動作する製品を作成できます
2. **段階的な品質向上：** 基本機能を実装してから、テストを追加して品質を向上させることができます
3. **リソース制約：** 時間やリソースが限られている場合、テストを省略して実装を優先できます

ただし、以下のテストは**必須**として実施することを強く推奨します：

- **P1〜P10のプロパティベーステスト：** システムの正確性を保証するため
- **認証・認可のテスト：** セキュリティを保証するため
- **個人情報暗号化のテスト：** データ保護を保証するため
- **パフォーマンステスト：** 要件10を満たすため

## 実装の優先順位

### 高優先度（必須）
1. フェーズ1: 基盤構築
2. フェーズ2: コアサービス実装
3. フェーズ4: REST API実装（基本的なCRUD）
4. フェーズ5: フロントエンド実装（売主リスト、売主詳細、新規登録）

### 中優先度（重要）
1. フェーズ3: 外部API連携（Gmail、Calendar）
2. フェーズ5: フロントエンド実装（査定メール、訪問査定予約）
3. フェーズ6: パフォーマンス最適化
4. フェーズ7: テスト（プロパティベーステスト、E2Eテスト）

### 低優先度（追加機能）
1. フェーズ3: 外部API連携（Google Chat、スプレッドシート同期）
2. フェーズ5: フロントエンド実装（Google Chat通知、活動ログ画面）
3. フェーズ7: テスト（セキュリティテスト）
4. フェーズ8: デプロイメント

## 見積もり

### 開発期間（1人の開発者の場合）
- **フェーズ1:** 1週間
- **フェーズ2:** 2週間
- **フェーズ3:** 2週間
- **フェーズ4:** 2週間
- **フェーズ5:** 3週間
- **フェーズ6:** 1週間
- **フェーズ7:** 2週間
- **フェーズ8:** 1週間

**合計：** 約14週間（3.5ヶ月）

### MVP（最小実行可能製品）の場合
高優先度タスクのみを実装する場合：
- **フェーズ1:** 1週間
- **フェーズ2:** 2週間
- **フェーズ4（基本CRUD）:** 1週間
- **フェーズ5（基本画面）:** 2週間

**合計：** 約6週間（1.5ヶ月）

## 次のステップ

1. **要件の最終確認：** requirements.mdの内容を再確認し、不明点を解消する
2. **設計の最終確認：** design.mdの内容を再確認し、技術スタックを決定する
3. **タスクの優先順位決定：** MVPを目指すか、フル機能を目指すかを決定する
4. **開発環境のセットアップ：** 必要なツールとライブラリをインストールする
5. **実装開始：** フェーズ1から順番に実装を開始する
