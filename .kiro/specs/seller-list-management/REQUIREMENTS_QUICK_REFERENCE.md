# 要件定義書 クイックリファレンス

## 📋 改善された要件一覧

### 🔥 高優先度改善（完了）

#### 要件1: 売主登録と管理
- **パフォーマンス**: 2秒以内、暗号化500ms以内
- **暗号化**: AES-256-GCM
- **エラーハンドリング**: 必須フィールド検証、具体的エラーメッセージ

#### 要件7: 認証とアクセス制御
- **認証方式**: Supabase認証、JWT（24時間有効）
- **セキュリティ**: bcrypt (cost factor 10)、セッション30分
- **ログイン制限**: 5回失敗で15分ロック

#### 要件10: パフォーマンス最適化
- **ページロード**: 3秒以内
- **検索**: 1秒以内
- **API応答**: P95 < 500ms, P99 < 1000ms
- **DBクエリ**: 平均 < 100ms

### 🆕 新規追加要件（完了）

#### 要件31: エラーハンドリングとリカバリー
- **DB接続エラー**: 自動再接続（最大3回、指数バックオフ）
- **暗号化エラー**: エラーキャッチ、管理者通知
- **APIタイムアウト**: 10秒、フォールバック処理
- **エラー分類**: Critical/High/Medium/Low

#### 要件32: データ整合性とバリデーション
- **二重バリデーション**: クライアント側 + サーバー側
- **トランザクション**: ACID特性保証
- **重複検出**: 自動検出、マージ機能
- **バリデーションルール**: 電話番号、メール、郵便番号、日付、売主番号、査定額

## 🔗 要件依存関係（重要な関係のみ）

```
REQ-7 (認証)
  ↓
REQ-1 (売主登録) ← REQ-11 (売主番号)
  ↓
REQ-2 (メール送信)
  ↓
REQ-5 (フォローアップ)

REQ-1 (売主登録)
  ↓
REQ-13 (物件情報)
  ↓
REQ-15 (査定額)
  ↓
REQ-3 (査定メール)

REQ-31 (エラーハンドリング) → 全要件
REQ-32 (データ整合性) → 全要件
```

## 📊 非機能要件サマリー

### パフォーマンス
| 項目 | 目標値 |
|------|--------|
| 売主登録処理 | 2秒以内 |
| 暗号化処理 | 500ms以内 |
| 初回ページロード | 3秒以内 |
| 検索結果表示 | 1秒以内 |
| API応答時間 (P95) | < 500ms |
| API応答時間 (P99) | < 1000ms |
| DBクエリ平均 | < 100ms |

### セキュリティ
| 項目 | 仕様 |
|------|------|
| 個人情報暗号化 | AES-256-GCM |
| パスワードハッシュ化 | bcrypt (cost factor 10) |
| セッションタイムアウト | 30分 |
| ログイン失敗制限 | 5回/15分 |
| 外部APIタイムアウト | 10秒 |

### スケーラビリティ
| 項目 | 目標値 |
|------|--------|
| 同時接続数 | 最大100ユーザー |
| データ件数 | 1万件以上対応 |
| メモリ使用量 | < 2GB/サーバー |
| バッチ処理 | 1000件/バッチ |

## 🎯 バリデーションルール

| フィールド | ルール |
|-----------|--------|
| 電話番号 | 10-11桁の数字、ハイフン許可 |
| メールアドレス | RFC 5322準拠 |
| 郵便番号 | 7桁の数字、ハイフン許可 |
| 日付 | ISO 8601形式、過去100年〜未来10年 |
| 売主番号 | AA + 5桁の数字（例: AA00001） |
| 査定額 | 正の整数、最大999億円 |

## 🚨 エラー分類

| レベル | 定義 | 対応 |
|--------|------|------|
| Critical | データ損失の可能性 | 即座に管理者通知 |
| High | 機能停止 | 5分以内に管理者通知 |
| Medium | 部分的な機能低下 | ログ記録 |
| Low | UI/UX問題 | ログ記録 |

## 📝 実装時のチェックリスト

### 要件1（売主登録）実装時
- [ ] 売主番号の自動生成（AA + 5桁）
- [ ] AES-256-GCMによる個人情報暗号化
- [ ] 必須フィールドのバリデーション
- [ ] エラーメッセージの表示
- [ ] 2秒以内の処理完了
- [ ] activity_logsへの変更履歴記録

### 要件7（認証）実装時
- [ ] Supabase認証の実装
- [ ] JWTトークン発行（24時間有効）
- [ ] 権限検証ロジック
- [ ] 403エラーハンドリング
- [ ] セッションタイムアウト（30分）
- [ ] ログイン失敗制限（5回/15分）

### 要件10（パフォーマンス）実装時
- [ ] ページネーション（50件/ページ）
- [ ] 検索インデックスの作成
- [ ] バッチ処理（1000件/バッチ）
- [ ] プログレスバーの実装
- [ ] エラー時のロールバック
- [ ] パフォーマンス指標の監視

### 要件31（エラーハンドリング）実装時
- [ ] DB接続エラーの自動再接続
- [ ] 暗号化エラーのキャッチ
- [ ] APIタイムアウト設定（10秒）
- [ ] フォールバック処理
- [ ] エラーログの記録
- [ ] 管理者通知の実装

### 要件32（データ整合性）実装時
- [ ] クライアント側バリデーション
- [ ] サーバー側バリデーション
- [ ] トランザクション管理
- [ ] 重複検出アルゴリズム
- [ ] マージ機能
- [ ] バリデーションルールの実装

## 🔍 テスト時の確認ポイント

### パフォーマンステスト
- 売主登録が2秒以内に完了するか
- 1万件のデータで初回ロードが3秒以内か
- 検索結果が1秒以内に表示されるか
- API応答時間がP95 < 500ms, P99 < 1000msか

### セキュリティテスト
- 個人情報が暗号化されているか
- 未認証アクセスがブロックされるか
- セッションタイムアウトが機能するか
- ログイン失敗制限が機能するか

### エラーハンドリングテスト
- DB接続エラー時に自動再接続するか
- 暗号化エラー時に適切なメッセージが表示されるか
- APIタイムアウト時にフォールバック処理が実行されるか
- エラーログが正しく記録されるか

### データ整合性テスト
- 不正なデータが拒否されるか
- 重複データが検出されるか
- トランザクションがロールバックされるか
- バリデーションルールが機能するか

## 📚 関連ドキュメント

- [要件定義書本体](./requirements.md)
- [改善サマリー](./REQUIREMENTS_IMPROVEMENT_SUMMARY.md)
- [設計書](./design.md)
- [タスク一覧](./tasks.md)
- [フィールド仕様書](./field-specifications.md)

## 🎓 用語集（重要な用語のみ）

- **EARS形式**: Event-driven, Autonomous, Requirements Specification（WHEN-THEN-IF構文）
- **AES-256-GCM**: 高度暗号化標準（256ビット鍵、Galois/Counter Mode）
- **bcrypt**: パスワードハッシュ化アルゴリズム
- **JWT**: JSON Web Token（認証トークン）
- **ACID**: Atomicity, Consistency, Isolation, Durability（トランザクション特性）
- **P95/P99**: パーセンタイル（95%/99%のリクエストが満たすべき性能）

## 💡 ベストプラクティス

1. **要件を実装する前に依存関係を確認する**
   - 依存関係マトリクスを参照
   - 前提条件となる要件が実装済みか確認

2. **非機能要件を常に意識する**
   - パフォーマンス目標を念頭に実装
   - セキュリティ要件を最初から組み込む

3. **エラーハンドリングを後回しにしない**
   - 要件31を全機能に適用
   - エラー分類に従って適切に処理

4. **データ整合性を最優先する**
   - 要件32のバリデーションルールを厳守
   - クライアント側・サーバー側の二重チェック

5. **テストを早期に開始する**
   - 受入基準をテストケースに変換
   - 継続的にパフォーマンスを監視
