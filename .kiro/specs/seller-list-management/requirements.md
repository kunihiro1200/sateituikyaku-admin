# 要件定義書

## 変更履歴

### v2.1 (2025-01-11)
- アクセシビリティ要件を追加（WCAG 2.1 レベルAA準拠）
- ユーザビリティ要件を追加
- 要件2（自動査定）の具体的なテストケースを追加
- 要件31（エラーハンドリング）の具体的なテストケースを追加
- 要件32（データ整合性）の具体的なテストケースを追加

### v2.0 (2025-01-09)
- 要件の優先順位付けを追加（MoSCoW法）
- 要件2（自動査定）の受入基準を具体化
- 要件20（競合情報管理）を3つに分割（20A、20B、20C）

### v1.0 (初版)
- 初版作成

## はじめに

本システムは、不動産売買専門の仲介業者向けの売主リスト管理システムです。無料査定依頼を行った売主の情報を一元管理し、自動査定、追客活動、訪問査定予約、社員の活動ログ管理を行います。毎日約10件の新規査定依頼があり、既に1万件以上の売主データを保有しています。

本システムは100以上のフィールドを管理し、査定サイトからの反響受付、重複チェック、追客管理、訪問査定予約、Google Chat連携、除外管理など、不動産仲介業務の全工程をカバーします。

## 用語集

- **システム**: 売主リスト管理システム
- **売主**: 不動産の無料査定を依頼した顧客
- **売主番号**: 売主を一意に識別する番号（AA + 数字5桁、例：AA00001）
- **査定**: 不動産の市場価値を算出すること
- **追客**: 売主に対するフォローアップ活動（電話、メール、SMS）
- **次電日**: 次回電話をかける予定日
- **訪問査定**: 実際に物件を訪問して行う詳細な査定
- **社員**: システムを利用する不動産仲介業者の従業員
- **活動ログ**: 社員が行った追客活動の記録
- **反響**: 査定サイトから届く査定依頼
- **確度**: 売主の売却意欲の高さ（A、B、B'、C、D、E、ダブり）
- **不通**: 電話が繋がらなかった状態
- **他決**: 他社で契約が決まったこと
- **専任媒介**: 当社が専任で売却活動を行う契約
- **一般媒介**: 複数社で売却活動を行う契約
- **専任媒介他決**: 専任媒介契約後に他社で契約が決まったステータス
- **追客他決**: 追客中に他社で契約が決まったステータス
- **追客不要他決**: 追客不要と判断された後に他社で契約が決まったステータス
- **専任他決**: 専任契約後に他社で契約が決まったステータス
- **競合名**: 競合する他社の会社名
- **専任・他決要因**: 専任媒介や他決になった理由（複数選択可能）
- **除外**: 査定サイトから配信を停止すること
- **Pinrich**: ピンリッチという不動産情報配信サービス
- **Google Chat**: 社内コミュニケーションツール（通知・共有に使用）
- **キャッシュ**: システムが一時的に保存するデータ
- **データ鮮度**: データが最後に更新されてからの経過時間

## 要件の優先順位

本システムの要件は、MoSCoW法に基づいて以下のように優先順位付けされています。

### Must Have（必須 - MVP に含める）

これらの要件がなければシステムは成立しません。Phase 1（6週間）で実装します。

- ✅ **要件1**: 売主登録
- ✅ **要件7**: 認証
- ✅ **要件9**: 検索・フィルタリング
- ✅ **要件10**: パフォーマンス
- ✅ **要件11**: 売主番号生成
- ✅ **要件31**: エラーハンドリング
- ✅ **要件32**: データ整合性

**実装期間**: 6週間  
**リソース**: フロントエンド1名、バックエンド1名

### Should Have（重要 - Phase 1で実装）

重要な機能ですが、なくても代替手段があります。Phase 1（6週間）で実装します。

- 🔶 **要件2**: 自動査定
- 🔶 **要件4**: 追客活動記録
- 🔶 **要件5**: フォローアップ管理
- 🔶 **要件12**: 重複検出
- 🔶 **要件13**: 物件情報管理
- 🔶 **要件15**: 査定額管理

**実装期間**: Must Haveと並行して実装  
**リソース**: 同上

### Could Have（あれば良い - Phase 2で実装）

あれば便利ですが、優先度は低い機能です。Phase 2（4週間）で実装します。

- 🔷 **要件3**: 査定メール送信
- 🔷 **要件6**: 訪問査定予約
- 🔷 **要件8**: 活動ログ自動記録
- 🔷 **要件14**: 反響管理
- 🔷 **要件16**: 訪問査定詳細管理
- 🔷 **要件17**: 追客進捗管理
- 🔷 **要件18**: 査定書送付管理
- 🔷 **要件19**: 担当者管理
- 🔷 **要件20A**: 競合情報の表示条件
- 🔷 **要件20B**: 競合情報の必須入力
- 🔷 **要件20C**: 専任・他決要因の選択
- 🔷 **要件21**: Pinrich配信管理
- 🔷 **要件22**: 除外管理
- 🔷 **要件23**: Google Chat連携
- 🔷 **要件24**: キャンセル案内管理
- 🔷 **要件25**: 固定資産税路線価管理
- 🔷 **要件26**: 買主情報連携
- 🔷 **要件27**: イエウールマンション物件管理
- 🔷 **要件28**: 連絡取りやすい時間帯管理

**実装期間**: 4週間  
**リソース**: フロントエンド1名、バックエンド1名

### Won't Have（今回は対象外）

今回のスコープには含めません。

- ⭕ **要件29**: 手動更新（要件30の自動更新で代替）
- ⭕ **要件30**: 自動更新（Phase 3で実装予定）

**理由**: 自動更新機能は複雑性が高く、Phase 1では手動更新で十分対応可能

## 要件

### 要件1

**ユーザーストーリー:** 売主として、無料査定を依頼したいので、自分の情報と物件情報を登録できるようにしたい

#### 受入基準

1. **WHEN** ユーザーが新規売主登録フォームを開く
   **THEN** システムは以下の必須フィールドを表示する:
   - 売主番号（自動生成、読み取り専用）
   - 氏名（暗号化対象）
   - 電話番号（暗号化対象）
   - メールアドレス（暗号化対象）
   - 物件住所
   - 問い合わせ日時

2. **WHEN** ユーザーが必須フィールドを入力して保存する
   **THEN** システムは:
   - 売主番号を自動生成する（形式: AA + 5桁連番）
   - 個人情報をAES-256-GCMで暗号化して保存する
   - 保存成功メッセージを表示する
   - 売主詳細ページにリダイレクトする

3. **WHEN** ユーザーが既存売主情報を編集する
   **THEN** システムは:
   - 変更履歴をactivity_logsに記録する
   - 更新日時を自動更新する
   - 編集者情報を記録する

4. **IF** 必須フィールドが未入力の場合
   **THEN** システムは:
   - 保存を拒否する
   - 具体的なエラーメッセージを表示する
   - 該当フィールドをハイライトする

#### パフォーマンス要件

- 売主登録処理は2秒以内に完了すること
- 暗号化処理による遅延は500ms以内であること

### 要件2

**ユーザーストーリー:** 社員として、売主の物件を自動査定したいので、査定額を自動計算できるようにしたい

#### 受入基準

1. **WHEN** 物件情報が入力された場合
   **THEN** システムは物件の所在地、面積、築年数、構造等の情報に基づいて査定額を自動計算しなければならない

2. **WHEN** 戸建ての査定額を計算する場合
   **THEN** システムは以下の計算式を適用しなければならない:
   
   **土地評価額の計算:**
   - 土地評価額 = 土地面積(㎡) × 固定資産税路線価(円/㎡)
   
   **建物評価額の計算:**
   - 構造別単価:
     * 木造: 150,000円/㎡
     * 軽量鉄骨: 180,000円/㎡
     * 鉄骨: 200,000円/㎡
     * その他: 170,000円/㎡
   - 減価率 = 1 - (築年数 × 0.015)
   - 建物評価額 = 建物面積(㎡) × 構造別単価 × 減価率
   
   **査定額の計算:**
   - 査定額1（最低額）= 土地評価額 × 0.8 + 建物評価額 × 0.7
   - 査定額2（中間額）= 土地評価額 × 1.0 + 建物評価額 × 0.8
   - 査定額3（最高額）= 土地評価額 × 1.2 + 建物評価額 × 0.9
   
   **異常値チェック:**
   - IF 査定額1 < 1,000,000円 OR 査定額3 > 1,000,000,000円
   - THEN 警告メッセージを表示する: 「査定額が通常の範囲外です。入力内容を確認してください。」

3. **WHEN** 査定計算が完了した場合
   **THEN** システムは査定額と計算根拠を売主レコードに保存しなければならない

4. **WHEN** 査定額を再計算する場合
   **THEN** システムは過去の査定履歴を保持しなければならない

### 要件3

**ユーザーストーリー:** 社員として、査定結果を売主に送りたいので、Gmailでボタン一つで査定メールを送信できるようにしたい

#### 受入基準

1. WHEN 社員が送信ボタンをクリックした場合、システムは査定額を含むメールを自動生成しなければならない
2. WHEN メールを送信する場合、システムはGmail APIを使用して送信しなければならない
3. WHEN メール送信が成功した場合、システムは送信日時と内容を活動ログに記録しなければならない
4. WHEN メール送信が失敗した場合、システムはエラーメッセージを表示し、再送信オプションを提供しなければならない
5. WHEN メールテンプレートを使用する場合、システムは売主名、物件情報、査定額を自動挿入しなければならない

### 要件4

**ユーザーストーリー:** 社員として、売主に追客したいので、電話、Gmail、SMSで追客活動を記録できるようにしたい

#### 受入基準

1. WHEN 社員が電話追客を行った場合、システムは通話日時、内容、結果を記録しなければならない
2. WHEN 社員がメール追客を行った場合、システムは送信日時、件名、本文を記録しなければならない
3. WHEN 社員がSMS追客を行った場合、システムは送信日時とメッセージ内容を記録しなければならない
4. WHEN 追客活動を記録する場合、システムは実行した社員のアカウント情報を自動記録しなければならない
5. WHEN 売主の追客履歴を表示する場合、システムは時系列順に全ての追客活動を表示しなければならない

### 要件5

**ユーザーストーリー:** 社員として、売主へのフォローアップを管理したいので、ヒアリング内容を記録し次電日を設定できるようにしたい

#### 受入基準

1. WHEN 社員が売主とヒアリングを行った場合、システムはヒアリング内容をテキストで記録しなければならない
2. WHEN 次電日を設定する場合、システムは指定された日付を売主レコードに保存しなければならない
3. WHEN 次電日が到来した場合、システムは担当社員に通知を送信しなければならない
4. WHEN ヒアリング内容を保存する場合、システムは記録日時と記録者を自動保存しなければならない
5. WHEN 売主の確度を評価する場合、システムはA（売る気あり）、B（売る気あるがまだ先の話）、B'（売る気は全く無い）、C（電話が繋がらない）、D（再建築不可）、E（収益物件）、ダブり（重複している）から選択できなければならない

### 要件6

**ユーザーストーリー:** 社員として、売却意欲の高い売主に訪問査定を提案したいので、訪問査定予約を取得しGoogleカレンダーに登録できるようにしたい

#### 受入基準

1. WHEN 訪問査定の予約を取得した場合、システムは予約日時、場所、担当社員を記録しなければならない
2. WHEN 訪問査定予約が確定した場合、システムはGoogle Calendar APIを使用して担当社員のカレンダーにイベントを作成しなければならない
3. WHEN カレンダーイベントを作成する場合、システムは売主名、物件住所、連絡先を含めなければならない
4. WHEN カレンダー登録が成功した場合、システムは売主レコードのステータスを「訪問査定予定」に更新しなければならない
5. WHEN 訪問査定予約をキャンセルする場合、システムはGoogleカレンダーからイベントを削除しなければならない

### 要件7

**ユーザーストーリー:** 管理者として、複数の社員を管理したいので、社員がGoogleアカウントでログインできるようにしたい

#### 受入基準

1. **WHEN** 未認証ユーザーがシステムにアクセスする
   **THEN** システムはログインページにリダイレクトする

2. **WHEN** ユーザーがSupabase認証でログインする
   **THEN** システムは:
   - JWTトークンを発行する（有効期限: 24時間）
   - ユーザーロールを確認する
   - 適切なダッシュボードにリダイレクトする

3. **WHEN** ユーザーが売主の個人情報にアクセスする
   **THEN** システムは:
   - ユーザーの権限を検証する
   - 復号化された情報を表示する
   - アクセスログを記録する

4. **IF** ユーザーに権限がない場合
   **THEN** システムは:
   - 403 Forbiddenエラーを返す
   - エラーメッセージを表示する
   - アクセス試行をログに記録する

#### セキュリティ要件

- 個人情報はAES-256-GCMで暗号化すること
- パスワードはbcrypt（cost factor 10）でハッシュ化すること
- セッションタイムアウトは30分とすること
- 連続ログイン失敗は5回までとし、その後15分間ロックすること

### 要件8

**ユーザーストーリー:** 管理者として、社員の活動を把握したいので、誰がいつ電話をかけたか自動でログを取得できるようにしたい

#### 受入基準

1. WHEN 社員が追客活動を行った場合、システムは実行社員のGoogleアカウント情報を自動記録しなければならない
2. WHEN 活動ログを記録する場合、システムは活動種別（電話、メール、SMS）、日時、対象売主を記録しなければならない
3. WHEN 管理者が活動ログを閲覧する場合、システムは社員別、日付別、活動種別でフィルタリングできなければならない
4. WHEN 活動ログを表示する場合、システムは最新の活動から時系列順に表示しなければならない
5. WHEN 活動統計を表示する場合、システムは社員ごとの活動件数を集計して表示しなければならない

### 要件9

**ユーザーストーリー:** 社員として、効率的に売主を管理したいので、売主リストを検索・フィルタリングできるようにしたい

#### 受入基準

1. WHEN 社員が売主を検索する場合、システムは名前、住所、電話番号で部分一致検索できなければならない
2. WHEN 売主リストをフィルタリングする場合、システムはステータス（新規、追客中、訪問査定予定、成約等）で絞り込みできなければならない
3. WHEN 売主リストをフィルタリングする場合、システムは次電日の範囲で絞り込みできなければならない
4. WHEN 売主リストをフィルタリングする場合、システムは担当社員で絞り込みできなければならない
5. WHEN 売主リストを表示する場合、システムはページネーションを実装し、1ページあたり50件表示しなければならない

### 要件10

**ユーザーストーリー:** 社員として、大量の売主データを扱いたいので、システムが1万件以上のデータを高速に処理できるようにしたい

#### 受入基準

1. **WHEN** ユーザーが売主一覧ページを開く
   **THEN** システムは:
   - 初回ロード時間が3秒以内であること
   - ページネーション（50件/ページ）を適用すること
   - 検索インデックスを使用すること

2. **WHEN** ユーザーが検索フィルターを適用する
   **THEN** システムは:
   - 検索結果を1秒以内に返すこと
   - 複合インデックスを活用すること
   - 検索条件をキャッシュすること

3. **WHEN** システムが大量データを処理する
   **THEN** システムは:
   - バッチ処理（1000件/バッチ）を使用すること
   - プログレスバーを表示すること
   - エラー時にロールバックすること

#### パフォーマンス指標

- API応答時間: P95 < 500ms, P99 < 1000ms
- データベースクエリ: 平均実行時間 < 100ms
- 同時接続数: 最大100ユーザー
- メモリ使用量: サーバー1台あたり < 2GB

### 要件11

**ユーザーストーリー:** 社員として、売主番号で売主を一意に識別したいので、システムが自動的に売主番号を生成できるようにしたい

#### 受入基準

1. WHEN 新規売主を登録する場合、システムは「AA」で始まる5桁の数字を含む売主番号を自動生成しなければならない
2. WHEN 売主番号を生成する場合、システムは既存の売主番号と重複しない番号を生成しなければならない
3. WHEN 売主番号を表示する場合、システムは常に「AA」+5桁の数字形式で表示しなければならない
4. WHEN 売主を検索する場合、システムは売主番号で完全一致検索できなければならない
5. WHEN 売主番号を使用する場合、システムは売主番号をキーとして全ての関連データを紐付けなければならない

### 要件12

**ユーザーストーリー:** 社員として、重複した売主を管理したいので、電話番号やメールアドレスで重複をチェックできるようにしたい

#### 受入基準

1. WHEN 新規売主を登録する場合、システムは電話番号で既存売主との重複をチェックしなければならない
2. WHEN 電話番号が重複する場合、システムは過去の所有者情報と物件情報を表示しなければならない
3. WHEN メールアドレスが重複する場合、システムは過去の所有者情報と物件情報を表示しなければならない
4. WHEN 重複が検出された場合、システムは「要ダブり確認」フラグを表示しなければならない
5. WHEN 売主コピー機能を使用する場合、システムは指定された売主番号の情報を新規レコードにコピーしなければならない

### 要件13

**ユーザーストーリー:** 社員として、物件の詳細情報を管理したいので、種別、面積、築年、構造などを記録できるようにしたい

#### 受入基準

1. WHEN 物件情報を入力する場合、システムは種別（戸建て、土地、マンション）を選択できなければならない
2. WHEN 物件情報を入力する場合、システムは土地面積と建物面積を平方メートル単位で記録しなければならない
3. WHEN 物件情報を入力する場合、システムは構造（木造、軽量鉄骨、鉄骨、他）をボタン選択で入力できなければならない
4. WHEN 相手が入力した面積が異なる場合、システムは「土地（当社調べ）」「建物（当社調べ）」フィールドに手入力できなければならない
5. WHEN 売主の状況を入力する場合、システムは居住中、空き家、賃貸中、古屋あり、更地から選択できなければならない

### 要件14

**ユーザーストーリー:** 社員として、査定サイトからの反響を管理したいので、サイト名、反響日時、査定理由を記録できるようにしたい

#### 受入基準

1. WHEN 反響を登録する場合、システムは査定サイト名を略称で記録しなければならない
2. WHEN 反響を登録する場合、システムは反響年と反響日付を記録しなければならない
3. WHEN 反響を登録する場合、システムは反響詳細日時をタイムスタンプで記録しなければならない
4. WHEN 査定サイトから情報を取得する場合、システムは査定理由を自動転記しなければならない
5. WHEN 査定サイトのURLを記録する場合、システムはサイトURLフィールドに保存しなければならない

### 要件15

**ユーザーストーリー:** 社員として、複数の査定額を管理したいので、自動計算された査定額と訪問後の査定額を記録できるようにしたい

#### 受入基準

1. WHEN 戸建てまたは土地の査定を行う場合、システムは査定額1、査定額2、査定額3を自動計算しなければならない
2. WHEN マンションの査定を行う場合、システムは査定額1、査定額2、査定額3を手入力できなければならない
3. WHEN 訪問査定後に査定額を入力する場合、システムは「訪問後_査定額1」フィールドに記録しなければならない
4. WHEN 査定額を表示する場合、システムは査定額1が最低額、査定額2が中間額、査定額3が最高額として表示しなければならない
5. WHEN 査定書URLを生成する場合、システムは「つながるオンライン」の査定書URLを記録しなければならない

### 要件16

**ユーザーストーリー:** 社員として、訪問査定の詳細を管理したいので、訪問日時、担当者、注意点を記録できるようにしたい

#### 受入基準

1. WHEN 訪問査定を取得する場合、システムは訪問取得日を自動記録しなければならない
2. WHEN 訪問査定を予約する場合、システムは訪問日、訪問時間、曜日を記録しなければならない
3. WHEN 訪問査定を予約する場合、システムは営業担当者を選択できなければならない
4. WHEN 訪問査定の注意点を入力する場合、システムは訪問時注意点をGoogleカレンダーに連携しなければならない
5. WHEN 訪問査定を取得した場合、システムは訪問査定取得者を自動記録しなければならない

### 要件17

**ユーザーストーリー:** 社員として、追客の進捗を管理したいので、不通状態、次電日、確度を記録できるようにしたい

#### 受入基準

1. WHEN 電話が不通だった場合、システムは不通フラグを設定しなければならない
2. WHEN 1番電話が不通だった場合、システムは「1番電話不通時2度目電話」フラグを記録できなければならない
3. WHEN 次回電話日を設定する場合、システムは次電日フィールドに日付を記録しなければならない
4. WHEN 売主の確度を評価する場合、システムはA（売る気あり）、B（売る気あるがまだ先の話）、B'（売る気は全く無い）、C（電話が繋がらない）、D（再建築不可）、E（収益物件）、ダブり（重複している）から選択できなければならない
5. WHEN 連絡方法を選択する場合、システムはEmail、Smail、電話からラジオボタンで選択できなければならない

### 要件18

**ユーザーストーリー:** 社員として、査定書の送付状況を管理したいので、メール送信日と郵送日を記録できるようにしたい

#### 受入基準

1. WHEN 査定書をメールで送信する場合、システムはE/日付フィールドに送信日を記録しなければならない
2. WHEN 査定書を郵送する場合、システムは郵/日付フィールドに郵送日を記録しなければならない
3. WHEN 郵送状況を管理する場合、システムは「未」「済」のラジオボタンで選択できなければならない
4. WHEN 査定方法を選択する場合、システムは机上査定（メール）、机上査定（郵送）、机上査定（不通）から選択できなければならない
5. WHEN 上記以外の郵送先がある場合、システムは別住所を入力できなければならない

### 要件19

**ユーザーストーリー:** 社員として、担当者を管理したいので、査定担当、電話担当、一番TELを記録できるようにしたい

#### 受入基準

1. WHEN 査定を実行する場合、システムは査定担当者をラジオボタンで選択できなければならない
2. WHEN 電話担当を割り当てる場合、システムは電話担当（任意）をラジオボタンで選択できなければならない
3. WHEN 最初に電話をかけた場合、システムは一番TELフィールドにイニシャルを記録しなければならない
4. WHEN 1番電話をかけた場合、システムは1番電話フィールドに担当者名をラジオボタンで選択できなければならない
5. WHEN 訪問査定割合を表示する場合、システムは担当者別の訪問査定件数を自動計算しなければならない

### 要件20A: 競合情報の表示条件

**ユーザーストーリー:** 社員として、競合情報を適切なタイミングで入力したいので、ステータスに応じて競合情報セクションが表示されるようにしたい

#### 受入基準

1. **WHEN** 売主のステータスが「専任媒介他決」「追客他決」「追客不要他決」「専任他決」「一般」のいずれかである場合
   **THEN** システムは競合情報セクション全体を表示しなければならない

2. **WHEN** ステータスが上記以外に変更された場合
   **THEN** システムは競合情報セクションを非表示にしなければならない

3. **WHEN** 競合情報セクションの表示/非表示が切り替わる場合
   **THEN** システムはスムーズなアニメーション効果を適用しなければならない

### 要件20B: 競合情報の必須入力

**ユーザーストーリー:** 社員として、競合分析を確実に行いたいので、競合情報セクションが表示されている場合は必須項目を入力しなければ保存できないようにしたい

#### 受入基準

1. **WHEN** 競合情報セクションが表示されている場合
   **THEN** システムは以下のフィールドを必須項目として入力を要求しなければならない:
   - 競合名
   - 専任・他決要因
   - 他決対策
   - 契約年月
   - 専任他決打合せ

2. **WHEN** 必須項目が未入力のまま保存しようとした場合
   **THEN** システムは:
   - エラーメッセージを表示する: 「競合情報の必須項目を入力してください」
   - 保存を拒否する
   - 未入力の必須フィールドを赤枠でハイライトする

3. **WHEN** 全ての必須項目が入力された場合
   **THEN** システムは保存を許可し、成功メッセージを表示しなければならない

### 要件20C: 専任・他決要因の選択

**ユーザーストーリー:** 社員として、他決の要因を詳細に分析したいので、27個の選択肢から複数選択できるようにしたい

#### 受入基準

1. **WHEN** 専任・他決要因を選択する場合
   **THEN** システムは以下の27個の選択肢から複数選択できなければならない:
   - 知り合い
   - 価格が高い
   - 決定権者の把握
   - 連絡不足
   - 購入物件の紹介
   - 購入希望者がいる
   - 以前つきあいがあった不動産
   - ヒアリング不足
   - 担当者の対応が良い
   - 査定書郵送
   - １番電話のスピード
   - 対応スピード
   - 買取保証
   - 追客電話の対応
   - 説明が丁寧
   - 詳細な調査
   - 不誠実・やるべきことをしない
   - 定期的な追客電話
   - HPの口コミ
   - 売買に強い
   - 仲介手数料のサービス
   - 仲介手数料以外のサービス
   - 妥当な査定額
   - 定期的なメール配信
   - 提案力
   - 熱意
   - その他

2. **WHEN** 専任他決の打合せ状況を選択する場合
   **THEN** システムは「未」「完了」のラジオボタンで選択できなければならない

3. **WHEN** 「その他」を選択した場合
   **THEN** システムは自由記述フィールドを表示し、詳細を入力できるようにしなければならない

### 要件21

**ユーザーストーリー:** 社員として、Pinrichの配信状況を管理したいので、Pinrichのステータスを記録できるようにしたい

#### 受入基準

1. WHEN Pinrichの配信を開始する場合、システムはPinrichフィールドに「配信中」を記録しなければならない
2. WHEN Pinrichの配信を停止する場合、システムはPinrichフィールドに「クローズ」を記録しなければならない
3. WHEN Pinrichのステータスを変更する場合、システムは変更履歴を保持しなければならない
4. WHEN Pinrichの配信状況を検索する場合、システムはPinrichフィールドでフィルタリングできなければならない
5. WHEN 送信社数を記録する場合、システムは査定サイトに登録している会社数を記録しなければならない

### 要件22

**ユーザーストーリー:** 社員として、除外管理を行いたいので、除外サイト、除外基準、除外日を記録できるようにしたい

#### 受入基準

1. WHEN 除外申請を行う場合、システムは除外サイトのURLを記録しなければならない
2. WHEN 除外基準を確認する場合、システムは各サイトの除外基準を箇条書きで表示しなければならない
3. WHEN 除外日を設定する場合、システムは除外日を自動入力しなければならない
4. WHEN 除外日の対応を選択する場合、システムは「不通であれば除外」「何もせずに除外」からラジオボタンで選択できなければならない
5. WHEN 除外日が到来した場合、システムは担当者に通知を送信しなければならない

### 要件23

**ユーザーストーリー:** 社員として、Google Chatで情報共有したいので、ボタン一つでGoogle Chatに通知を送信できるようにしたい

#### 受入基準

1. WHEN 一般媒介になった場合、システムは「一般媒介のチャット送信」ボタンでGoogle Chatスペースに送信しなければならない
2. WHEN 専任媒介を取得した場合、システムは「専任取得通知チャット」ボタンでGoogle Chatスペースに送信しなければならない
3. WHEN 訪問後に他決になった場合、システムは「他決共有チャット（営業のみ）」ボタンでGoogle Chatスペースに送信しなければならない
4. WHEN 未訪問で他決になった場合、システムは「未訪問他決共有」ボタンでGoogle Chatスペースに送信しなければならない
5. WHEN 物件を紹介する場合、システムは「物件紹介チャット」ボタンで物件紹介コメントをGoogle Chatスペースに送信しなければならない

### 要件24

**ユーザーストーリー:** 社員として、キャンセル案内を管理したいので、キャンセル案内担当者とキャンセル案内内容を記録できるようにしたい

#### 受入基準

1. WHEN キャンセル案内を送信する場合、システムはキャンセル案内担当者を記録しなければならない
2. WHEN キャンセル案内内容を入力する場合、システムはキャンセル案内フィールドに記録しなければならない
3. WHEN 価格負けした場合、システムは「価格負けリストに入力済み」フラグを設定できなければならない
4. WHEN 専任媒介を取得した場合、システムは専任とれた文言フィールドにトークスクリプトを記録しなければならない
5. WHEN 当社の紹介を行う場合、システムは当社の紹介フィールドに内容を記録しなければならない

### 要件25

**ユーザーストーリー:** 社員として、固定資産税路線価を管理したいので、固定資産税路線価を記録できるようにしたい

#### 受入基準

1. WHEN 固定資産税路線価を入力する場合、システムは固定資産税路線価フィールドに価格を記録しなければならない
2. WHEN 固定資産税路線価を使用する場合、システムは査定額計算に反映しなければならない
3. WHEN 固定資産税路線価を表示する場合、システムは適切な桁区切りで表示しなければならない
4. WHEN 固定資産税路線価を更新する場合、システムは更新履歴を保持しなければならない
5. WHEN 固定資産税路線価が未入力の場合、システムは警告を表示しなければならない

### 要件26

**ユーザーストーリー:** 社員として、買主情報と連携したいので、買主コピー機能と購入情報表示機能を使用できるようにしたい

#### 受入基準

1. WHEN 買主コピー機能を使用する場合、システムは指定された買主番号の情報を新規レコードにコピーしなければならない
2. WHEN 買主に登録されている人の場合、システムは購入情報フィールドに買主リストの情報を表示しなければならない
3. WHEN 買主情報を表示する場合、システムは買主番号、名前、連絡先を表示しなければならない
4. WHEN 買主情報を更新する場合、システムは売主リストと買主リストの両方を更新しなければならない
5. WHEN 買主情報が存在しない場合、システムは購入情報フィールドを空白で表示しなければならない

### 要件27

**ユーザーストーリー:** 社員として、イエウールのマンション物件を管理したいので、専用の物件所在地フィールドを使用できるようにしたい

#### 受入基準

1. WHEN 査定サイトがイエウールの場合、システムはサイトフィールドに「ウ」を記録しなければならない
2. WHEN イエウールかつ種別がマンションの場合、システムは「物件所在地（ウのマンションとは別明記分）」フィールドに物件所在地を入力できなければならない
3. WHEN 物件所在地を表示する場合、システムは通常の物件所在地と別明記分を区別して表示しなければならない
4. WHEN イエウール以外のサイトの場合、システムは別明記分フィールドを非表示にしなければならない
5. WHEN マンション以外の種別の場合、システムは別明記分フィールドを非表示にしなければならない

### 要件28

**ユーザーストーリー:** 社員として、連絡取りやすい時間帯を管理したいので、連絡取りやすい日・時間帯を記録できるようにしたい

#### 受入基準

1. WHEN ヒアリングで連絡取りやすい時間帯を確認する場合、システムは連絡取りやすい日・時間帯フィールドに記録しなければならない
2. WHEN 連絡取りやすい時間帯を表示する場合、システムは売主詳細画面で目立つように表示しなければならない
3. WHEN 次電日を設定する場合、システムは連絡取りやすい時間帯を参考情報として表示しなければならない
4. WHEN 連絡取りやすい時間帯が未入力の場合、システムは警告を表示しなければならない
5. WHEN 連絡取りやすい時間帯を検索する場合、システムは時間帯でフィルタリングできなければならない

### 要件29

**ユーザーストーリー:** 社員として、スプレッドシートが更新された可能性があるため、最新データを取得したいので、手動で更新ボタンをクリックしてデータを再取得できるようにしたい

#### 受入基準

1. WHEN 売主リスト画面を表示する場合、システムは更新ボタンを目立つ位置に配置しなければならない
2. WHEN 社員が更新ボタンをクリックした場合、システムはローディング表示を表示しなければならない
3. WHEN 更新ボタンがクリックされた場合、システムはスプレッドシートから最新データを取得しなければならない
4. WHEN データ取得が成功した場合、システムは成功通知を表示し、画面を最新データで更新しなければならない
5. WHEN データ取得が失敗した場合、システムはエラーメッセージを表示し、既存のキャッシュデータを保持しなければならない

### 要件30

**ユーザーストーリー:** 社員として、常に最新のデータで作業したいので、システムが自動的にデータの鮮度をチェックし、古い場合は自動更新できるようにしたい

#### 受入基準

1. WHEN ページをロードする場合、システムはキャッシュデータの最終更新時刻をチェックしなければならない
2. WHEN キャッシュデータが5分以上古い場合、システムはバックグラウンドで自動的にスプレッドシートから最新データを取得しなければならない
3. WHEN 自動更新を実行する場合、システムはユーザーの操作をブロックせずにバックグラウンドで実行しなければならない
4. WHEN 自動更新でデータに変更があった場合、システムは画面を自動的に更新し、変更があったことを通知しなければならない
5. WHEN 自動更新が失敗した場合、システムはエラーをログに記録し、既存のキャッシュデータを継続して表示しなければならない



### 要件31

**ユーザーストーリー:** システム管理者として、エラーが発生した際に適切に処理され、ユーザーに分かりやすいメッセージが表示され、システムが安定して動作し続けることを期待する

#### 受入基準

1. **WHEN** データベース接続エラーが発生する
   **THEN** システムは:
   - 自動的に再接続を試みる（最大3回、指数バックオフ）
   - ユーザーに「一時的な問題が発生しました」と表示する
   - エラーログに詳細を記録する

2. **WHEN** 暗号化/復号化エラーが発生する
   **THEN** システムは:
   - エラーをキャッチする
   - 「データの読み込みに失敗しました」と表示する
   - 管理者に通知する

3. **WHEN** 外部API（Google Calendar等）がタイムアウトする
   **THEN** システムは:
   - タイムアウト時間を10秒に設定する
   - フォールバック処理を実行する
   - ユーザーに代替手段を提示する

4. **WHEN** スプレッドシート同期エラーが発生する
   **THEN** システムは:
   - エラーの種類を特定する（認証、ネットワーク、データ形式）
   - 適切なエラーメッセージを表示する
   - リトライ可能な場合は再試行オプションを提供する

#### エラー分類

- **Critical**: データ損失の可能性 → 即座に管理者通知
- **High**: 機能停止 → 5分以内に管理者通知
- **Medium**: 部分的な機能低下 → ログ記録
- **Low**: UI/UX問題 → ログ記録

### 要件32

**ユーザーストーリー:** システム管理者として、データベースに保存されるデータが常に整合性を保ち、不正なデータが入力されないことを期待する

#### 受入基準

1. **WHEN** ユーザーがフォームに入力する
   **THEN** システムは:
   - クライアント側でリアルタイムバリデーションを実行する
   - サーバー側で再度バリデーションを実行する
   - 不正な値を拒否する

2. **WHEN** データベーストランザクションを実行する
   **THEN** システムは:
   - ACID特性を保証する
   - 外部キー制約を検証する
   - エラー時にロールバックする

3. **WHEN** 重複データが検出される
   **THEN** システムは:
   - 重複検出アルゴリズムを実行する
   - ユーザーに警告を表示する
   - マージ機能を提供する

4. **WHEN** スプレッドシートからデータを同期する
   **THEN** システムは:
   - データ型の整合性を検証する
   - 必須フィールドの存在を確認する
   - 不正なデータをスキップし、エラーログに記録する

#### バリデーションルール

- 電話番号: 10-11桁の数字、ハイフン許可
- メールアドレス: RFC 5322準拠
- 郵便番号: 7桁の数字、ハイフン許可
- 日付: ISO 8601形式、過去100年〜未来10年の範囲
- 売主番号: AA + 5桁の数字（例: AA00001）
- 査定額: 正の整数、最大999億円

## 要件間の依存関係

### 依存関係マトリクス

| 要件 | 依存する要件 | ブロックする要件 |
|------|-------------|-----------------|
| REQ-1 (売主登録) | REQ-7 (認証), REQ-11 (売主番号) | REQ-2 (自動査定), REQ-4 (追客活動), REQ-5 (フォローアップ) |
| REQ-2 (自動査定) | REQ-1 (売主登録), REQ-13 (物件情報), REQ-15 (査定額) | REQ-3 (査定メール) |
| REQ-3 (査定メール) | REQ-2 (自動査定), REQ-7 (認証) | - |
| REQ-4 (追客活動) | REQ-1 (売主登録), REQ-7 (認証) | REQ-5 (フォローアップ) |
| REQ-5 (フォローアップ) | REQ-1 (売主登録), REQ-4 (追客活動) | - |
| REQ-6 (訪問予定) | REQ-1 (売主登録), REQ-7 (認証) | REQ-16 (訪問詳細) |
| REQ-7 (認証) | - | REQ-1, REQ-2, REQ-4, REQ-6, REQ-8 |
| REQ-8 (活動ログ) | REQ-7 (認証) | - |
| REQ-9 (検索・フィルター) | REQ-1 (売主登録), REQ-10 (パフォーマンス) | - |
| REQ-10 (パフォーマンス) | - | REQ-9, REQ-30 |
| REQ-11 (売主番号) | - | REQ-1 (売主登録) |
| REQ-12 (重複検出) | REQ-1 (売主登録) | - |
| REQ-13 (物件情報) | REQ-1 (売主登録) | REQ-2 (自動査定), REQ-15 (査定額) |
| REQ-14 (反響管理) | REQ-1 (売主登録) | - |
| REQ-15 (査定額) | REQ-13 (物件情報) | REQ-2 (自動査定), REQ-3 (査定メール) |
| REQ-16 (訪問詳細) | REQ-6 (訪問予定) | - |
| REQ-20A (競合情報表示) | REQ-1 (売主登録) | REQ-20B, REQ-20C |
| REQ-20B (競合情報必須) | REQ-20A (競合情報表示) | - |
| REQ-20C (他決要因選択) | REQ-20A (競合情報表示) | - |
| REQ-29 (手動更新) | REQ-30 (自動更新) | - |
| REQ-30 (自動更新) | REQ-10 (パフォーマンス) | REQ-29 (手動更新) |
| REQ-31 (エラーハンドリング) | - | 全要件 |
| REQ-32 (データ整合性) | - | 全要件 |

## 非機能要件サマリー

### パフォーマンス要件

- 売主登録処理: 2秒以内
- 暗号化処理: 500ms以内
- 初回ページロード: 3秒以内
- 検索結果表示: 1秒以内
- API応答時間: P95 < 500ms, P99 < 1000ms
- データベースクエリ: 平均 < 100ms

### セキュリティ要件

- 個人情報暗号化: AES-256-GCM
- パスワードハッシュ化: bcrypt (cost factor 10)
- セッションタイムアウト: 30分
- ログイン失敗制限: 5回/15分
- 外部APIタイムアウト: 10秒

### スケーラビリティ要件

- 同時接続数: 最大100ユーザー
- データ件数: 1万件以上対応
- メモリ使用量: サーバー1台あたり < 2GB
- バッチ処理: 1000件/バッチ

### アクセシビリティ要件

- WCAG 2.1 レベルAA準拠
- キーボード操作のみで全機能にアクセス可能
- スクリーンリーダー対応（NVDA、JAWS）
- フォントサイズ: 最小14px、拡大200%まで対応
- カラーコントラスト比: 最小4.5:1（通常テキスト）、3:1（大きなテキスト）
- フォーカスインジケーター: 明確に視認可能（2px以上の境界線）

### ユーザビリティ要件

- 新規ユーザーが30分以内に基本操作を習得できること
- 売主登録から査定メール送信までを5分以内に完了できること
- エラーメッセージは具体的な解決策を含むこと
- 重要な操作（削除等）には確認ダイアログを表示すること
- ローディング状態を明確に表示すること（スピナー、プログレスバー）

## テストケース例

### 要件2（自動査定）のテストケース

#### TC-2.1: 戸建て査定の正常系

**前提条件:**
- 物件種別: 戸建て
- 土地面積: 100㎡
- 建物面積: 80㎡
- 築年数: 10年
- 構造: 木造
- 固定資産税路線価: 100,000円/㎡

**期待される結果:**
- 土地評価額 = 100 × 100,000 = 10,000,000円
- 減価率 = 1 - (10 × 0.015) = 0.85
- 建物評価額 = 80 × 150,000 × 0.85 = 10,200,000円
- 査定額1 = 10,000,000 × 0.8 + 10,200,000 × 0.7 = 15,140,000円
- 査定額2 = 10,000,000 × 1.0 + 10,200,000 × 0.8 = 18,160,000円
- 査定額3 = 10,000,000 × 1.2 + 10,200,000 × 0.9 = 21,180,000円

#### TC-2.2: 異常値検出（最低額が低すぎる）

**前提条件:**
- 物件種別: 戸建て
- 土地面積: 10㎡
- 建物面積: 20㎡
- 築年数: 50年
- 構造: 木造
- 固定資産税路線価: 50,000円/㎡

**期待される結果:**
- 査定額1 < 1,000,000円
- 警告メッセージ表示: 「査定額が通常の範囲外です。入力内容を確認してください。」

#### TC-2.3: 異常値検出（最高額が高すぎる）

**前提条件:**
- 物件種別: 戸建て
- 土地面積: 1000㎡
- 建物面積: 500㎡
- 築年数: 0年
- 構造: 鉄骨
- 固定資産税路線価: 500,000円/㎡

**期待される結果:**
- 査定額3 > 1,000,000,000円
- 警告メッセージ表示: 「査定額が通常の範囲外です。入力内容を確認してください。」

### 要件31（エラーハンドリング）のテストケース

#### TC-31.1: データベース接続エラー

**シナリオ:** データベースサーバーが一時的にダウンしている

**期待される動作:**
1. 自動再接続を3回試行（1秒、2秒、4秒の間隔）
2. ユーザーに「一時的な問題が発生しました。しばらくしてから再度お試しください。」と表示
3. エラーログに以下を記録:
   - タイムスタンプ
   - エラーメッセージ
   - スタックトレース
   - ユーザーID
   - 実行していた操作

#### TC-31.2: 暗号化エラー

**シナリオ:** 暗号化キーが不正または破損している

**期待される動作:**
1. エラーをキャッチし、システムをクラッシュさせない
2. ユーザーに「データの読み込みに失敗しました。システム管理者に連絡してください。」と表示
3. 管理者にメール通知を送信
4. エラーログに詳細を記録

#### TC-31.3: Google Calendar APIタイムアウト

**シナリオ:** Google Calendar APIが10秒以内に応答しない

**期待される動作:**
1. タイムアウトエラーをキャッチ
2. ユーザーに「カレンダーへの登録に失敗しました。手動でカレンダーに登録してください。」と表示
3. 訪問査定情報はデータベースに保存される
4. 後でリトライできるようにキューに追加

### 要件32（データ整合性）のテストケース

#### TC-32.1: 電話番号バリデーション

**テストデータ:**
- 正常: "090-1234-5678", "09012345678", "03-1234-5678"
- 異常: "123", "abc-defg-hijk", "090-1234-567" (桁数不足)

**期待される結果:**
- 正常データ: 保存成功
- 異常データ: エラーメッセージ「正しい電話番号を入力してください（例: 090-1234-5678）」

#### TC-32.2: 売主番号の一意性

**シナリオ:** 既存の売主番号と重複する番号を生成しようとする

**期待される動作:**
1. データベースの一意制約により挿入が拒否される
2. システムが次の番号を自動生成する
3. 最大10回まで再試行する
4. 10回失敗した場合はエラーを返す


