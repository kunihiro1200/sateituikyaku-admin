# Phase 3: 次のステップ

## 現在の状況（2025-01-08）

### ✅ 完了済み

1. **環境変数読み込み修正**
   - `check-deleted-at-column.ts`スクリプトが正常に動作
   - `dotenv.config()`を追加して環境変数を読み込み

2. **削除同期の方向性確認**
   - 削除同期はスプレッドシート→データベースのみ（単方向）
   - 本番環境では`DELETION_SYNC_ENABLED=false`に設定予定
   - Migration 051（`deleted_at`カラム追加）は不要

### 📋 Phase 3の残タスク

Phase 3は「タスク3.4: スプレッドシート同期サービスの実装」に該当します。

#### 要件29: 手動更新機能
**ユーザーストーリー:** 社員として、スプレッドシートが更新された可能性があるため、最新データを取得したいので、手動で更新ボタンをクリックしてデータを再取得できるようにしたい

**実装タスク:**
- [ ] SpreadsheetSyncServiceの実装
- [ ] Google Sheets API連携の実装
- [ ] 手動同期機能の実装
- [ ] スプレッドシートからのデータ取得の実装
- [ ] データベース更新処理の実装
- [ ] 同期ログ記録の実装

#### 要件30: 自動更新機能
**ユーザーストーリー:** 社員として、常に最新のデータで作業したいので、システムが自動的にデータの鮮度をチェックし、古い場合は自動更新できるようにしたい

**実装タスク:**
- [ ] 自動同期機能の実装
- [ ] データ鮮度管理の実装（5分以上古い場合に自動更新）
- [ ] バックグラウンド更新の実装
- [ ] 変更通知の実装

## 次のステップの提案

### オプション1: 削除同期機能を完全に無効化（推奨）

本番環境で削除同期を使用しないため、関連コードを無効化または削除します。

**作業内容:**
1. `.env`ファイルで`DELETION_SYNC_ENABLED=false`を設定
2. Migration 051をスキップ（実行しない）
3. 削除同期関連のコードをコメントアウトまたは削除

**メリット:**
- 不要な機能を削除してコードをシンプルに保つ
- 将来的な混乱を避ける
- パフォーマンスの向上

### オプション2: 手動更新機能の実装に進む

要件29の手動更新機能を実装します。

**作業内容:**
1. `SpreadsheetSyncService`の基本構造を作成
2. Google Sheets APIとの連携を実装
3. 手動同期エンドポイント（POST /api/sync/manual）を実装
4. フロントエンドに更新ボタンを追加

**メリット:**
- ユーザーが必要なときに最新データを取得できる
- 自動更新機能の基盤となる

### オプション3: 自動更新機能の実装に進む

要件30の自動更新機能を実装します（手動更新機能が前提）。

**作業内容:**
1. データ鮮度管理テーブル（`data_freshness`）の作成
2. 自動更新ロジックの実装（5分以上古い場合）
3. バックグラウンド更新の実装
4. 変更通知の実装

**メリット:**
- ユーザーが常に最新データで作業できる
- 手動更新の手間を削減

## 推奨アプローチ

**ステップ1: 削除同期機能を無効化**
- `.env`で`DELETION_SYNC_ENABLED=false`を設定
- Migration 051をスキップ
- ドキュメントに削除同期が無効化されていることを記載

**ステップ2: 手動更新機能の実装**
- 要件29を実装
- ユーザーが必要なときに最新データを取得できるようにする

**ステップ3: 自動更新機能の実装（オプション）**
- 要件30を実装
- データ鮮度管理を追加

## 質問

次のステップを決定するために、以下の質問にお答えください：

1. **削除同期機能について:**
   - 削除同期機能を完全に無効化しますか？
   - それとも、将来的に使用する可能性があるため、コードは残しておきますか？

2. **Phase 3の優先順位について:**
   - 手動更新機能（要件29）を実装しますか？
   - 自動更新機能（要件30）も実装しますか？
   - それとも、Phase 3をスキップして他のフェーズに進みますか？

3. **実装の範囲について:**
   - MVPを目指しますか（基本機能のみ）？
   - それとも、フル機能を実装しますか？

## 参考情報

### 関連ファイル
- `.kiro/specs/seller-list-management/requirements.md` - 要件定義
- `.kiro/specs/seller-list-management/tasks.md` - タスク一覧
- `backend/check-deleted-at-column.ts` - 削除同期確認スクリプト
- `backend/migrations/051_add_soft_delete_support.sql` - 削除同期用マイグレーション

### 環境変数
```env
# 削除同期を無効化（推奨）
DELETION_SYNC_ENABLED=false
```

### 次回のコンテキスト転送用サマリー

**Phase 3の状況:**
- 削除同期の方向性確認完了（スプレッドシート→データベースのみ）
- 本番環境では削除同期を使用しない（`DELETION_SYNC_ENABLED=false`）
- 次のステップ: 削除同期機能の無効化 or 手動更新機能の実装

**完了したタスク:**
1. 環境変数読み込み修正（`check-deleted-at-column.ts`）
2. 削除同期の方向性確認

**未完了のタスク:**
1. 削除同期機能の無効化（オプション）
2. 手動更新機能の実装（要件29）
3. 自動更新機能の実装（要件30）
