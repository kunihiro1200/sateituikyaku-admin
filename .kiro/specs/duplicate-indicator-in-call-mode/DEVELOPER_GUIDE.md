# é‡è¤‡æ¡ˆä»¶ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ©Ÿèƒ½ - é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€é‡è¤‡æ¡ˆä»¶ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ©Ÿèƒ½ã®æŠ€è¡“çš„ãªè©³ç´°ã¨ã€é–‹ç™ºè€…ãŒæ©Ÿèƒ½ã‚’ç†è§£ãƒ»æ‹¡å¼µã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              CallModePage.tsx                         â”‚  â”‚
â”‚  â”‚  - é‡è¤‡æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯                                   â”‚  â”‚
â”‚  â”‚  - çŠ¶æ…‹ç®¡ç†                                           â”‚  â”‚
â”‚  â”‚  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         UI Components                                 â”‚  â”‚
â”‚  â”‚  - DuplicateIndicatorBadge                            â”‚  â”‚
â”‚  â”‚  - DuplicateDetailsModal                              â”‚  â”‚
â”‚  â”‚  - DuplicateCard                                      â”‚  â”‚
â”‚  â”‚  - ActivityItem                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ HTTP/REST API
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend (Express)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              API Routes                               â”‚  â”‚
â”‚  â”‚  GET /sellers/:id/duplicates                          â”‚  â”‚
â”‚  â”‚  GET /sellers/:id/activities                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Services                                      â”‚  â”‚
â”‚  â”‚  - DuplicateDetectionService                          â”‚  â”‚
â”‚  â”‚  - SellerService                                      â”‚  â”‚
â”‚  â”‚  - ActivityLogService                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Database (Supabase)                      â”‚
â”‚  - sellers                                                   â”‚
â”‚  - properties                                                â”‚
â”‚  - activity_logs                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### GET /sellers/:id/duplicates

å£²ä¸»ã®é‡è¤‡æ¡ˆä»¶ã‚’å–å¾—ã—ã¾ã™ã€‚

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```http
GET /api/sellers/:id/duplicates
Authorization: Bearer <token>
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  duplicates: DuplicateMatch[]
}
```

**DuplicateMatchå‹**:
```typescript
interface DuplicateMatch {
  sellerId: string;
  matchType: 'phone' | 'email' | 'both';
  sellerInfo: {
    sellerNumber: string;
    name: string;
    inquiryDate: string;
    phoneNumber: string;
    email: string;
  };
  propertyInfo?: {
    address: string;
    propertyType: string;
  };
}
```

**å®Ÿè£…å ´æ‰€**: `backend/src/routes/sellers.ts`

```typescript
router.get('/:id/duplicates', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    
    // å£²ä¸»æƒ…å ±ã‚’å–å¾—
    const seller = await sellerService.getSeller(id);
    
    if (!seller) {
      return res.status(404).json({
        error: {
          code: 'SELLER_NOT_FOUND',
          message: 'Seller not found',
          retryable: false,
        },
      });
    }
    
    // é‡è¤‡ã‚’æ¤œå‡ºï¼ˆè‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ï¼‰
    const { duplicateDetectionService } = await import('../services/DuplicateDetectionService');
    const duplicates = await duplicateDetectionService.checkDuplicates(
      seller.phoneNumber,
      seller.email,
      id
    );
    
    res.json({ duplicates });
  } catch (error) {
    console.error('Get duplicates error:', error);
    res.status(500).json({
      error: {
        code: 'INTERNAL_ERROR',
        message: 'Failed to get duplicates',
        retryable: true,
      },
    });
  }
});
```

### DuplicateDetectionService

é‡è¤‡æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚

**å®Ÿè£…å ´æ‰€**: `backend/src/services/DuplicateDetectionService.ts`

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

```typescript
class DuplicateDetectionService {
  /**
   * é›»è©±ç•ªå·ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§é‡è¤‡ã‚’æ¤œå‡º
   * @param phoneNumber é›»è©±ç•ªå·
   * @param email ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   * @param excludeId é™¤å¤–ã™ã‚‹å£²ä¸»IDï¼ˆè‡ªåˆ†è‡ªèº«ï¼‰
   * @returns é‡è¤‡æ¡ˆä»¶ã®é…åˆ—
   */
  async checkDuplicates(
    phoneNumber: string,
    email?: string,
    excludeId?: string
  ): Promise<DuplicateMatch[]>;
}
```

**é‡è¤‡æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯**:
1. é›»è©±ç•ªå·ã§æ¤œç´¢ï¼ˆæš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§æ¯”è¼ƒï¼‰
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢ï¼ˆæš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§æ¯”è¼ƒï¼‰
3. çµæœã‚’ãƒãƒ¼ã‚¸ã—ã€é‡è¤‡ã‚’é™¤å»
4. é™¤å¤–IDã‚’é™¤å¤–
5. ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®šï¼ˆphone/email/bothï¼‰

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰**:
- `SELLER_NOT_FOUND` (404): å£²ä¸»ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- `INTERNAL_ERROR` (500): ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

**ãƒªãƒˆãƒ©ã‚¤å¯èƒ½æ€§**:
- `retryable: false`: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚¨ãƒ©ãƒ¼ï¼ˆ404ãªã©ï¼‰
- `retryable: true`: ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¨ãƒ©ãƒ¼ï¼ˆ500ãªã©ï¼‰

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

#### 1. DuplicateIndicatorBadge

é‡è¤‡æ¡ˆä»¶ã®å­˜åœ¨ã‚’ç¤ºã™ãƒãƒƒã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateIndicatorBadge.tsx`

**Props**:
```typescript
interface DuplicateIndicatorBadgeProps {
  duplicateCount: number;  // é‡è¤‡ä»¶æ•°
  onClick: () => void;     // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
}
```

**ç‰¹å¾´**:
- Material-UIã®Chipã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨
- ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2ç§’å‘¨æœŸï¼‰
- è­¦å‘Šè‰²ï¼ˆwarningï¼‰ã§è¡¨ç¤º

**ä½¿ç”¨ä¾‹**:
```tsx
<DuplicateIndicatorBadge
  duplicateCount={duplicates.length}
  onClick={handleOpenDuplicateModal}
/>
```

#### 2. DuplicateDetailsModal

é‡è¤‡æ¡ˆä»¶ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€‚

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateDetailsModal.tsx`

**Props**:
```typescript
interface DuplicateDetailsModalProps {
  open: boolean;                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰çŠ¶æ…‹
  onClose: () => void;                  // é–‰ã˜ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  duplicates: DuplicateWithDetails[];   // é‡è¤‡æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿
  loading: boolean;                     // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
  error?: string | null;                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  onRetry?: () => void;                 // ãƒªãƒˆãƒ©ã‚¤ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
}
```

**ç‰¹å¾´**:
- Material-UIã®Dialogã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³
- Escã‚­ãƒ¼ã§é–‰ã˜ã‚‹æ©Ÿèƒ½

**ä½¿ç”¨ä¾‹**:
```tsx
<DuplicateDetailsModal
  open={duplicateModalOpen}
  onClose={handleCloseDuplicateModal}
  duplicates={duplicatesWithDetails}
  loading={detailsLoading}
  error={detailsError}
  onRetry={handleRetryLoadDetails}
/>
```

#### 3. DuplicateCard

å€‹åˆ¥ã®é‡è¤‡æ¡ˆä»¶æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚«ãƒ¼ãƒ‰ã€‚

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateCard.tsx`

**Props**:
```typescript
interface DuplicateCardProps {
  duplicate: DuplicateWithDetails;  // é‡è¤‡æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿
}

interface DuplicateWithDetails extends DuplicateMatch {
  comments?: string;      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ
  activities?: Activity[]; // ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´
}
```

**ç‰¹å¾´**:
- ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè‰²åˆ†ã‘
  - both: errorï¼ˆèµ¤ï¼‰
  - phone: warningï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
  - email: infoï¼ˆé’ï¼‰
- å£²ä¸»ç•ªå·ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒªãƒ³ã‚¯ã¨ã—ã¦è¡¨ç¤º
- ã‚³ãƒ¡ãƒ³ãƒˆã¨å±¥æ­´ã®è¡¨ç¤º/éè¡¨ç¤º
- å±¥æ­´ã¯æœ€æ–°20ä»¶ã®ã¿è¡¨ç¤º

#### 4. ActivityItem

å€‹åˆ¥ã®æ´»å‹•å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/ActivityItem.tsx`

**Props**:
```typescript
interface ActivityItemProps {
  activity: Activity;  // æ´»å‹•ãƒ‡ãƒ¼ã‚¿
}
```

**ç‰¹å¾´**:
- æ´»å‹•ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
  - phone_call: ğŸ“
  - email: âœ‰ï¸
  - sms: ğŸ’¬
- æ—¥æ™‚ã®æ—¥æœ¬èªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- æ‹…å½“è€…åã®è¡¨ç¤º
- é•·ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ

### çŠ¶æ…‹ç®¡ç†

CallModePageã§ç®¡ç†ã•ã‚Œã‚‹çŠ¶æ…‹:

```typescript
// é‡è¤‡æ¡ˆä»¶é–¢é€£ã®çŠ¶æ…‹
const [duplicates, setDuplicates] = useState<DuplicateMatch[]>([]);
const [duplicatesLoading, setDuplicatesLoading] = useState(false);
const [duplicateModalOpen, setDuplicateModalOpen] = useState(false);
const [duplicatesWithDetails, setDuplicatesWithDetails] = useState<DuplicateWithDetails[]>([]);
const [detailsLoading, setDetailsLoading] = useState(false);
const [detailsError, setDetailsError] = useState<string | null>(null);
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 1. é‡è¤‡æ¤œå‡ºãƒ•ãƒ­ãƒ¼

```typescript
// 1. ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«éåŒæœŸã§é‡è¤‡ã‚’æ¤œå‡º
useEffect(() => {
  if (seller) {
    loadDuplicates();
  }
}, [seller]);

// 2. é‡è¤‡æ¤œå‡ºé–¢æ•°
const loadDuplicates = async () => {
  if (!id) return;
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
  const cacheKey = `duplicates_${id}`;
  const cachedData = sessionStorage.getItem(cacheKey);
  
  if (cachedData) {
    try {
      const parsed = JSON.parse(cachedData);
      setDuplicates(parsed);
      return;
    } catch (e) {
      console.error('Failed to parse cached duplicates:', e);
    }
  }
  
  try {
    setDuplicatesLoading(true);
    const response = await api.get(`/sellers/${id}/duplicates`, {
      timeout: 10000,
    });
    const duplicatesData = response.data.duplicates || [];
    setDuplicates(duplicatesData);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    sessionStorage.setItem(cacheKey, JSON.stringify(duplicatesData));
  } catch (error) {
    console.error('Failed to load duplicates:', error);
    setDuplicates([]);
  } finally {
    setDuplicatesLoading(false);
  }
};
```

#### 2. è©³ç´°æƒ…å ±å–å¾—ãƒ•ãƒ­ãƒ¼

```typescript
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãæ™‚ã«è©³ç´°æƒ…å ±ã‚’å–å¾—
const handleOpenDuplicateModal = async () => {
  setDuplicateModalOpen(true);
  
  if (duplicates.length === 0) return;
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
  const cacheKey = `duplicate_details_${id}`;
  const cachedDetails = sessionStorage.getItem(cacheKey);
  
  if (cachedDetails) {
    try {
      const parsed = JSON.parse(cachedDetails);
      setDuplicatesWithDetails(parsed);
      return;
    } catch (e) {
      console.error('Failed to parse cached details:', e);
    }
  }
  
  try {
    setDetailsLoading(true);
    setDetailsError(null);
    
    // å„é‡è¤‡æ¡ˆä»¶ã®è©³ç´°æƒ…å ±ã‚’ä¸¦åˆ—ã§å–å¾—
    const detailsPromises = duplicates.map(async (duplicate: DuplicateMatch) => {
      try {
        // å£²ä¸»æƒ…å ±ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä¸¦åˆ—ã§å–å¾—
        const [sellerResponse, activitiesResponse] = await Promise.all([
          api.get(`/sellers/${duplicate.sellerId}`, { timeout: 10000 }),
          api.get(`/sellers/${duplicate.sellerId}/activities`, { timeout: 10000 }),
        ]);
        
        return {
          ...duplicate,
          comments: sellerResponse.data.comments,
          activities: activitiesResponse.data.activities || [],
        };
      } catch (error) {
        console.error(`Failed to load details for ${duplicate.sellerId}:`, error);
        return {
          ...duplicate,
          comments: undefined,
          activities: [],
        };
      }
    });
    
    const details = await Promise.all(detailsPromises);
    setDuplicatesWithDetails(details);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    sessionStorage.setItem(cacheKey, JSON.stringify(details));
  } catch (error) {
    console.error('Failed to load duplicate details:', error);
    setDetailsError('è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    setDetailsLoading(false);
  }
};
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥**:

1. **é‡è¤‡æ¤œå‡ºçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
   - ã‚­ãƒ¼: `duplicates_${sellerId}`
   - æœ‰åŠ¹æœŸé™: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¾ã§ï¼‰
   - ç›®çš„: åŒã˜å£²ä¸»ã®é‡è¤‡æ¤œå‡ºã‚’ç¹°ã‚Šè¿”ã•ãªã„

2. **è©³ç´°æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
   - ã‚­ãƒ¼: `duplicate_details_${sellerId}`
   - æœ‰åŠ¹æœŸé™: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¾ã§ï¼‰
   - ç›®çš„: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹é–‰ã™ã‚‹åº¦ã«è©³ç´°æƒ…å ±ã‚’å–å¾—ã—ãªã„

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢**:
- ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•çš„ã«ã‚¯ãƒªã‚¢
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«è‡ªå‹•çš„ã«ã‚¯ãƒªã‚¢

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

1. **éåŒæœŸèª­ã¿è¾¼ã¿**:
   - é‡è¤‡æ¤œå‡ºã¯ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã«éåŒæœŸã§å®Ÿè¡Œ
   - ãƒšãƒ¼ã‚¸ã®åˆæœŸè¡¨ç¤ºã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„

2. **ä¸¦åˆ—å–å¾—**:
   - è¤‡æ•°ã®é‡è¤‡æ¡ˆä»¶ã®è©³ç´°æƒ…å ±ã‚’`Promise.all`ã§ä¸¦åˆ—å–å¾—
   - å–å¾—æ™‚é–“ã‚’çŸ­ç¸®

3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š**:
   - ã™ã¹ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«10ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶æ™‚ã®ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²æ­¢

4. **ãƒ‡ãƒ¼ã‚¿åˆ¶é™**:
   - æ´»å‹•å±¥æ­´ã¯æœ€æ–°20ä»¶ã®ã¿è¡¨ç¤º
   - å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã‚’é˜²æ­¢

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### sellers ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE sellers (
  id UUID PRIMARY KEY,
  seller_number VARCHAR(10),
  name VARCHAR(255),
  phone_number TEXT,  -- æš—å·åŒ–
  email TEXT,         -- æš—å·åŒ–
  comments TEXT,
  inquiry_date DATE,
  -- ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
);

-- é‡è¤‡æ¤œå‡ºç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_sellers_phone ON sellers(phone_number);
CREATE INDEX idx_sellers_email ON sellers(email);
```

### activity_logs ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE activity_logs (
  id UUID PRIMARY KEY,
  seller_id UUID REFERENCES sellers(id),
  type VARCHAR(50),  -- 'phone_call', 'email', 'sms'
  content TEXT,
  employee_id UUID,
  created_at TIMESTAMP,
  -- ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
);

-- æ´»å‹•å±¥æ­´å–å¾—ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_activity_logs_seller_created ON activity_logs(seller_id, created_at DESC);
```

## ãƒ†ã‚¹ãƒˆ

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
```bash
cd backend
npm test -- sellers.test.ts
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:
```bash
cd frontend
npm test -- DuplicateIndicatorBadge.test.tsx
npm test -- DuplicateDetailsModal.test.tsx
npm test -- DuplicateCard.test.tsx
npm test -- ActivityItem.test.tsx
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
cd frontend
npm test -- CallModePage.integration.test.tsx
```

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

è©³ç´°ã¯ `MANUAL_TEST_GUIDE.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤

### ç’°å¢ƒå¤‰æ•°

ç‰¹åˆ¥ãªç’°å¢ƒå¤‰æ•°ã¯ä¸è¦ã§ã™ã€‚æ—¢å­˜ã®èªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
```bash
cd backend
npm run build
npm run start
```

2. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:
```bash
cd frontend
npm run build
# ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ãƒ‡ãƒ—ãƒ­ã‚¤
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿ã®å¤‰æ›´ã®ãŸã‚ã€ç°¡å˜ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½:

1. å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¯æ—¢å­˜æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å¤‰æ›´ä¸è¦

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: é‡è¤‡ãŒæ¤œå‡ºã•ã‚Œãªã„

**åŸå› **:
- é›»è©±ç•ªå·ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒç•°ãªã‚‹
- æš—å·åŒ–ã®å•é¡Œ

**è§£æ±ºç­–**:
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç›´æ¥ç¢ºèª
2. æš—å·åŒ–/å¾©å·åŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª
3. ãƒ­ã‚°ã‚’ç¢ºèª

### å•é¡Œ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé…ã„

**åŸå› **:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä¸è¶³
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶
- å¤§é‡ã®é‡è¤‡æ¡ˆä»¶

**è§£æ±ºç­–**:
1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç¢ºèª
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ç¢ºèª
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèª
4. æ´»å‹•å±¥æ­´ã®è¡¨ç¤ºä»¶æ•°ã‚’èª¿æ•´

### å•é¡Œ: ã‚¨ãƒ©ãƒ¼ãŒé »ç™ºã™ã‚‹

**åŸå› **:
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å•é¡Œ
- èªè¨¼ã®å•é¡Œ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®å•é¡Œ

**è§£æ±ºç­–**:
1. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
4. èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª

## æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

### 1. é‡è¤‡æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã®æ‹¡å¼µ

ç¾åœ¨ã¯é›»è©±ç•ªå·ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§æ¤œå‡ºã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã‚’è¿½åŠ å¯èƒ½:

- åå‰ã®é¡ä¼¼åº¦
- ä½æ‰€ã®é¡ä¼¼åº¦
- ç‰©ä»¶æƒ…å ±ã®é¡ä¼¼åº¦

**å®Ÿè£…å ´æ‰€**: `backend/src/services/DuplicateDetectionService.ts`

### 2. è¡¨ç¤ºæƒ…å ±ã®æ‹¡å¼µ

ç¾åœ¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã¨æ´»å‹•å±¥æ­´ã®ã¿ã§ã™ãŒã€ä»¥ä¸‹ã‚’è¿½åŠ å¯èƒ½:

- æŸ»å®šå±¥æ­´
- å¥‘ç´„å±¥æ­´
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå±¥æ­´

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateCard.tsx`

### 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½

é‡è¤‡æ¡ˆä»¶ãŒå¤šã„å ´åˆã€ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ å¯èƒ½:

- ãƒãƒƒãƒã‚¿ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
- æ—¥ä»˜ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
- æ‹…å½“è€…ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateDetailsModal.tsx`

### 4. ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½

é‡è¤‡æ¡ˆä»¶ã®ã‚½ãƒ¼ãƒˆé †ã‚’å¤‰æ›´å¯èƒ½:

- åéŸ¿æ—¥é †
- ãƒãƒƒãƒã‚¿ã‚¤ãƒ—é †
- æœ€çµ‚æ´»å‹•æ—¥é †

**å®Ÿè£…å ´æ‰€**: `frontend/src/components/DuplicateDetailsModal.tsx`

## API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### GET /sellers/:id/duplicates

**èª¬æ˜**: æŒ‡å®šã•ã‚ŒãŸå£²ä¸»ã®é‡è¤‡æ¡ˆä»¶ã‚’å–å¾—

**èªè¨¼**: å¿…é ˆ

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `id` (path): å£²ä¸»ID (UUID)

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  duplicates: DuplicateMatch[]
}
```

**ã‚¨ãƒ©ãƒ¼**:
- 404: å£²ä¸»ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- 500: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

**ä¾‹**:
```bash
curl -X GET \
  http://localhost:3000/api/sellers/123e4567-e89b-12d3-a456-426614174000/duplicates \
  -H 'Authorization: Bearer <token>'
```

### GET /sellers/:id/activities

**èª¬æ˜**: æŒ‡å®šã•ã‚ŒãŸå£²ä¸»ã®æ´»å‹•å±¥æ­´ã‚’å–å¾—

**èªè¨¼**: å¿…é ˆ

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `id` (path): å£²ä¸»ID (UUID)

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  activities: Activity[]
}
```

**ã‚¨ãƒ©ãƒ¼**:
- 404: å£²ä¸»ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- 500: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼

## å‚è€ƒè³‡æ–™

- [Requirements Document](./requirements.md)
- [Design Document](./design.md)
- [User Guide](./USER_GUIDE.md)
- [Manual Test Guide](./MANUAL_TEST_GUIDE.md)

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2024å¹´12æœˆ9æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
