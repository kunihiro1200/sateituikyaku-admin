# 重複案件インジケーター機能 - ユーザーガイド

## 概要

通話モードページに、重複案件（同じ電話番号やメールアドレスを持つ他の売主案件）を即座に確認できる機能が追加されました。この機能により、過去の対応履歴を素早く把握し、より効果的な顧客対応が可能になります。

## 機能の特徴

- **即座に重複を認識**: 通話モード画面で重複案件の存在を一目で確認
- **詳細情報の表示**: スプレッドシートコメントと過去のコミュニケーション履歴を確認
- **簡単なナビゲーション**: 重複案件の詳細ページに直接アクセス
- **パフォーマンス最適化**: 非同期読み込みとキャッシュにより快適な操作

## 使い方

### 1. 重複案件の確認

通話モードページで売主情報を表示すると、重複案件がある場合、売主番号の右隣に**オレンジ色のバッジ**が表示されます。

```
AA12345  [重複 (2)]
```

- バッジには重複案件の件数が表示されます
- バッジはパルスアニメーションで注意を引きます
- 重複がない場合、バッジは表示されません

### 2. 重複案件の詳細を確認

重複インジケーターバッジをクリックすると、重複案件の詳細情報を表示するモーダルダイアログが開きます。

#### モーダルに表示される情報

各重複案件について、以下の情報が表示されます:

**基本情報**
- 売主番号（クリックで詳細ページに移動）
- 名前
- 反響日
- マッチタイプ（重複の理由）
  - 🔴 **両方**: 電話番号とメールアドレスの両方が一致
  - 🟠 **電話番号**: 電話番号が一致
  - 🔵 **メールアドレス**: メールアドレスが一致

**物件情報**
- 物件の住所
- 物件タイプ

**スプレッドシートコメント**
- 過去に記録されたコメントや注意事項
- コメントがない場合は「コメントはありません」と表示

**コミュニケーション履歴（最新20件）**
- 📞 **電話**: 通話履歴とメモ
- ✉️ **メール**: 送信したメールの件名とテンプレート
- 💬 **SMS**: 送信したSMSのテンプレート
- 各履歴には日時と担当者名が表示されます

### 3. 重複案件の詳細ページに移動

モーダル内の売主番号（青色のリンク）をクリックすると、その売主の詳細ページが新しいタブで開きます。

- 元の通話モードページは開いたまま
- モーダルも開いたまま
- 複数の重複案件を順番に確認できます

### 4. モーダルを閉じる

モーダルは以下の方法で閉じることができます:

- 右上の **×ボタン** をクリック
- モーダルの外側（背景）をクリック
- **Escキー** を押す

## 活用シーン

### シーン1: 初回架電前の確認

新しい売主に初めて電話をかける前に、重複案件を確認することで:

- 過去に同じ顧客から問い合わせがあったかを確認
- 過去の対応内容や注意事項を把握
- 適切な対応方針を決定

**例**: 
「AA12345さんに初めて電話をかけようとしたら、重複インジケーターが表示された。確認すると、3ヶ月前に別の担当者が対応していて、『訪問査定実施済み、再度連絡希望』とコメントがあった。この情報を踏まえて、前回の査定結果を確認してから電話をかけることにした。」

### シーン2: 重複対応の回避

同じ顧客に複数の担当者が同時に連絡してしまうことを防ぐ:

- 他の担当者が既に対応中かを確認
- 最近の連絡履歴を確認
- 重複対応を避けて効率的に業務を進める

**例**:
「AA12890さんに電話をかけようとしたら、重複インジケーターが表示された。確認すると、今朝別の担当者が既に電話をかけていた。重複対応を避けるため、別の案件に取り組むことにした。」

### シーン3: 過去の経緯の把握

長期間フォローしている顧客の場合:

- 過去のやり取りの全体像を把握
- 顧客の状況の変化を確認
- より適切なフォローアップを実施

**例**:
「AA12903さんに久しぶりに電話をかける前に、重複案件を確認した。過去6ヶ月間のメール送信履歴と電話履歴を確認し、前回は『3ヶ月後に再連絡希望』とのことだったので、そのタイミングで連絡することにした。」

## よくある質問

### Q1: 重複インジケーターが表示されないのはなぜですか？

**A**: 以下の理由が考えられます:
- 重複案件が存在しない（最も一般的）
- 重複検出が完了していない（ページ読み込み直後）
- ネットワークエラーで重複検出に失敗した（エラーは表示されません）

### Q2: 重複案件の詳細情報が表示されないのはなぜですか？

**A**: ネットワークエラーやサーバーエラーが発生した可能性があります。モーダル内に「再試行」ボタンが表示されるので、クリックして再度取得してください。

### Q3: 重複案件が多すぎて見づらいのですが？

**A**: モーダル内はスクロール可能です。また、各重複案件のコミュニケーション履歴は最新20件のみ表示されるため、情報量が適切に制限されています。

### Q4: 重複案件の情報が古いのですが？

**A**: 重複案件の情報はセッション中キャッシュされます。最新の情報を取得したい場合は、ページをリロードしてください。

### Q5: 重複インジケーターの表示が遅いのですが？

**A**: 重複検出は非同期で実行されるため、ページ読み込み後2秒程度かかる場合があります。これはページの初期表示を遅延させないための設計です。

### Q6: 重複案件として検出される条件は？

**A**: 以下のいずれかが一致する場合、重複案件として検出されます:
- 電話番号が完全に一致
- メールアドレスが完全に一致
- 両方が一致

### Q7: 自分自身が重複として表示されることはありますか？

**A**: いいえ、現在表示している売主自身は重複案件から除外されます。

## トラブルシューティング

### 問題: 重複インジケーターが表示されない

**解決策**:
1. ページをリロードしてみる
2. ブラウザのコンソールでエラーを確認
3. ネットワーク接続を確認
4. それでも解決しない場合は、システム管理者に連絡

### 問題: モーダルが開かない

**解決策**:
1. ブラウザのコンソールでエラーを確認
2. ページをリロードしてみる
3. 別のブラウザで試してみる
4. それでも解決しない場合は、システム管理者に連絡

### 問題: 詳細情報が表示されない

**解決策**:
1. モーダル内の「再試行」ボタンをクリック
2. ネットワーク接続を確認
3. ページをリロードしてみる
4. それでも解決しない場合は、システム管理者に連絡

### 問題: リンクが動作しない

**解決策**:
1. ブラウザのポップアップブロッカーを確認
2. 別のブラウザで試してみる
3. それでも解決しない場合は、システム管理者に連絡

## 技術的な詳細

### パフォーマンス

- **非同期読み込み**: 重複検出はページの初期表示をブロックしません
- **キャッシュ**: セッション中は重複情報がキャッシュされ、2回目以降は即座に表示されます
- **並列取得**: 複数の重複案件の詳細情報は並列で取得され、効率的に表示されます
- **タイムアウト**: ネットワークリクエストは10秒でタイムアウトし、ページがフリーズすることを防ぎます

### セキュリティ

- すべてのAPIリクエストは認証が必要です
- ユーザーは自分がアクセス権を持つ売主の重複情報のみ閲覧できます
- 電話番号とメールアドレスは暗号化されて保存されています

## フィードバック

この機能に関するフィードバックや改善提案がありましたら、システム管理者までお知らせください。

---

**最終更新日**: 2024年12月9日
**バージョン**: 1.0.0
