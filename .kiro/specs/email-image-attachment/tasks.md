# 実装タスクリスト

## Phase 1: 基本機能（MVP）

- [ ] 1. メール送信ダイアログに画像添付アイコンを追加
  - CallModePageのメール送信ダイアログに画像添付アイコンボタンを追加
  - アイコンをクリックすると画像選択モーダルを開く
  - _要件: 1.1, 1.2_

- [ ] 2. 画像選択モーダルの基本構造を実装
  - ImageSelectorModalコンポーネントを作成
  - タブ切り替えUI（Google Drive / ローカルファイル / URL）
  - 選択確定とキャンセルボタン
  - _要件: 2.1, 2.2, 2.3_

- [ ] 3. Google Driveタブの実装
  - [ ] 3.1 Google Driveフォルダ一覧表示
    - バックエンドAPIエンドポイント: `GET /api/drive/folders/:folderId/contents`
    - フォルダとファイルの一覧を取得
    - _要件: 2.1.1, 2.1.2_
  
  - [ ] 3.2 フォルダ移動機能
    - フォルダをクリックして中に入る
    - パンくずリストで親フォルダに戻る
    - _要件: 2.1.2, 2.1.3_
  
  - [ ] 3.3 画像サムネイル表示
    - Google DriveのサムネイルURLを使用
    - グリッドレイアウトで表示
    - _要件: 2.1.4_

- [ ] 4. ローカルファイルタブの実装
  - [ ] 4.1 ファイル選択機能
    - ファイル選択ボタンを実装
    - 複数ファイル選択を許可
    - _要件: 2.2.1, 2.2.2, 2.2.3_
  
  - [ ] 4.2 ドラッグ&ドロップ機能
    - ドラッグ&ドロップエリアを実装
    - ファイルをドロップして追加
    - _要件: 2.2.5_
  
  - [ ] 4.3 ローカルファイルプレビュー
    - 選択されたファイルのプレビューを表示
    - FileReaderでBase64エンコード
    - _要件: 2.2.4_

- [ ] 5. URLタブの実装
  - [ ] 5.1 URL入力フィールド
    - URL入力フィールドを実装
    - URL形式の検証
    - _要件: 2.3.1, 2.3.2_
  
  - [ ] 5.2 URL画像プレビュー
    - 入力されたURLから画像をプレビュー
    - エラーハンドリング（無効なURL、画像以外）
    - _要件: 2.3.3, 2.3.4_
  
  - [ ] 5.3 複数URL追加機能
    - 追加ボタンで複数URL入力
    - URLリストの管理
    - _要件: 2.3.5_

- [ ] 6. 画像選択機能の実装
  - [ ] 6.1 画像選択UI
    - 画像をクリックして選択/解除
    - 選択状態の視覚的表示（チェックマーク）
    - _要件: 3.1, 3.2, 3.3_
  
  - [ ] 6.2 選択画像の管理
    - 選択された画像を統一された`ImageFile`型で管理
    - 選択数の表示
    - _要件: 3.4, 3.5_

- [ ] 7. 画像プレビュー機能
  - 画像をダブルクリックでプレビューモーダルを開く
  - ファイル名、サイズ、更新日時を表示
  - 選択ボタンを表示
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 8. バックエンドAPIの実装
  - [ ] 8.1 Google Drive API拡張
    - `GET /api/drive/folders/:folderId/contents`: フォルダ内容取得
    - `GET /api/drive/folders/:folderId/path`: フォルダパス取得
    - GoogleDriveServiceに新規メソッド追加
    - _要件: 2.1_
  
  - [ ] 8.2 画像付きメール送信API
    - `POST /api/emails/with-images`: 画像付きメール送信
    - 複数ソース対応（Google Drive / ローカル / URL）
    - _要件: 5.1, 5.2, 5.3_
  
  - [ ] 8.3 画像取得ヘルパー実装
    - `fetchImageFromDrive`: Google Driveから画像取得
    - `fetchImageFromUrl`: URLから画像ダウンロード
    - `decodeBase64Image`: Base64デコード
    - _要件: 5.1, 5.2_

- [ ] 9. 画像サイズ制限の実装
  - 個別ファイルサイズチェック（5MB以下）
  - 合計サイズチェック（10MB以下）
  - 警告ダイアログ表示
  - _要件: 6.1, 6.2, 6.4_

- [ ] 10. 画像埋め込み処理
  - 選択された画像をBase64エンコード
  - HTMLメールとして画像をインライン埋め込み
  - 画像の表示幅を最大600pxに制限
  - _要件: 5.2, 5.3, 5.5_

- [ ] 11. ローディング状態の実装
  - 画像読み込み中のローディングインジケーター
  - 進捗メッセージの表示
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [ ] 12. キャンセル機能の実装
  - キャンセルボタン
  - モーダル外クリックでキャンセル
  - ESCキーでキャンセル
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ] 13. 活動ログへの記録
  - 画像付きメール送信時に活動ログに記録
  - 画像ファイル名、ソース、枚数を記録
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [ ] 14. 統合テストとバグ修正
  - 全機能の動作確認
  - エラーハンドリングの確認
  - ユーザビリティの改善

## Phase 2: UX改善

- [ ] 15. サムネイル表示の最適化
  - 遅延読み込み（Lazy Loading）
  - サムネイルキャッシュ

- [ ] 16. ドラッグ&ドロップのUX改善
  - ドラッグオーバー時の視覚的フィードバック
  - 複数ファイルのバッチ処理

- [ ] 17. エラーハンドリングの強化
  - より詳細なエラーメッセージ
  - リトライ機能

## Phase 3: 最適化

- [ ] 18. パフォーマンス最適化
  - 画像圧縮
  - 並列ダウンロード

- [ ] 19. キャッシュ戦略
  - Google Driveフォルダ内容のキャッシュ
  - URL画像のキャッシュ

- [ ] 20. 活動ログの詳細化
  - 画像ソース別の統計
  - 画像サイズの記録
