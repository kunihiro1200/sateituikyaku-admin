# 要件定義書

## はじめに

本機能は、売主リストのEmail送信機能を拡張し、ユーザーがGoogle Drive上の任意の画像を手動で選択してメールに添付できる機能を提供します。画像選択は常に利用可能で、ユーザーが自由に画像を選択できます。

## 用語集

- **システム**: 売主リスト管理システム
- **売主番号**: 売主を一意に識別する番号（AA + 数字5桁、例：AA00001）
- **Gmail API**: Googleが提供するメール送信サービスのAPI
- **Google Drive API**: Googleが提供するクラウドストレージサービスのAPI
- **画像添付アイコン**: メール送信ダイアログに表示される画像選択用のアイコンボタン
- **画像選択モーダル**: 複数のソースから画像を閲覧・選択するためのダイアログ
- **画像ソース**: Google Drive、ローカルファイル、URLの3つの画像取得元

## 要件

### 要件1

**ユーザーストーリー:** 営業担当者として、メール送信時に画像を添付したいので、簡単に画像を選択できる機能がほしい

#### 受入基準

1. WHEN メール送信ダイアログが表示される場合、システムは画像添付アイコンボタンを常に表示しなければならない
2. WHEN 画像添付アイコンがクリックされた場合、システムは画像選択モーダルを開かなければならない
3. WHEN 画像選択モーダルが開かれる場合、システムはGoogle Drive上の画像ファイルを閲覧できなければならない
4. WHEN ユーザーが画像を選択しない場合、システムは通常のテキストメールとして送信しなければならない

### 要件2

**ユーザーストーリー:** 営業担当者として、複数のソースから画像を選択したいので、Google Drive、ローカルファイル、URLから選べる機能がほしい

#### 受入基準

1. WHEN 画像選択モーダルが開かれる場合、システムは画像ソース選択タブを表示しなければならない
2. WHEN ソース選択タブが表示される場合、システムは「Google Drive」「ローカルファイル」「URL」の3つのタブを提供しなければならない
3. WHEN ユーザーがタブを切り替える場合、システムは対応する画像選択UIを表示しなければならない
4. WHEN 画像ファイル形式を判定する場合、システムはjpg、jpeg、png、gifのみを対象としなければならない

### 要件2.1: Google Driveからの選択

**ユーザーストーリー:** 営業担当者として、Google Drive上のどこからでも画像を選択したいので、フォルダを自由に移動できる機能がほしい

#### 受入基準

1. WHEN Google Driveタブが選択される場合、システムはGoogle Driveのルートフォルダから開始しなければならない
2. WHEN フォルダが表示される場合、システムはフォルダをクリックして中に入れなければならない
3. WHEN サブフォルダ内にいる場合、システムは親フォルダに戻るボタンを表示しなければならない
4. WHEN 画像ファイルが表示される場合、システムはサムネイル付きで一覧表示しなければならない

### 要件2.2: ローカルファイルからの選択

**ユーザーストーリー:** 営業担当者として、自分のPCに保存されている画像を選択したいので、ローカルファイルをアップロードできる機能がほしい

#### 受入基準

1. WHEN ローカルファイルタブが選択される場合、システムはファイル選択ボタンを表示しなければならない
2. WHEN ファイル選択ボタンがクリックされる場合、システムはOSのファイル選択ダイアログを開かなければならない
3. WHEN ファイルが選択される場合、システムは複数ファイルの同時選択を許可しなければならない
4. WHEN ファイルが選択される場合、システムは選択されたファイルのプレビューを表示しなければならない
5. WHEN ドラッグ&ドロップエリアが表示される場合、システムはファイルをドラッグ&ドロップで追加できなければならない

### 要件2.3: URLからの選択

**ユーザーストーリー:** 営業担当者として、Web上の画像を選択したいので、画像URLを入力できる機能がほしい

#### 受入基準

1. WHEN URLタブが選択される場合、システムはURL入力フィールドを表示しなければならない
2. WHEN URLが入力される場合、システムはURLの形式を検証しなければならない
3. WHEN 有効なURLが入力される場合、システムは画像のプレビューを表示しなければならない
4. WHEN 無効なURLが入力される場合、システムはエラーメッセージを表示しなければならない
5. WHEN 複数のURLを追加する場合、システムは追加ボタンで複数URL入力を許可しなければならない

### 要件3

**ユーザーストーリー:** 営業担当者として、複数の画像を選択したいので、必要な枚数だけ選択できる機能がほしい

#### 受入基準

1. WHEN 画像選択モーダルで画像をクリックする場合、システムは画像を選択状態にしなければならない
2. WHEN 画像が選択される場合、システムは選択された画像にチェックマークを表示しなければならない
3. WHEN 選択済みの画像を再度クリックする場合、システムは選択を解除しなければならない
4. WHEN 複数の画像を選択する場合、システムは選択数に制限を設けてはならない
5. WHEN 画像選択を確定する場合、システムは「確定」ボタンをクリックして選択を完了しなければならない

### 要件4

**ユーザーストーリー:** 営業担当者として、選択した画像をプレビューしたいので、画像の詳細を確認できる機能がほしい

#### 受入基準

1. WHEN 画像のサムネイルをダブルクリックする場合、システムは画像のフルサイズプレビューをモーダルで表示しなければならない
2. WHEN プレビューモーダルが表示される場合、システムはファイル名、ファイルサイズ、更新日時を表示しなければならない
3. WHEN プレビューモーダルが表示される場合、システムは「選択」ボタンを表示しなければならない
4. WHEN プレビューモーダルで「選択」ボタンがクリックされる場合、システムは画像を選択状態にしてモーダルを閉じなければならない

### 要件5

**ユーザーストーリー:** 営業担当者として、選択した画像をメールに埋め込んでほしいので、受信者が画像を直接見られるようにしたい

#### 受入基準

1. WHEN ユーザーが画像選択を確定する場合、システムはGoogle Drive APIを使用して画像データを取得しなければならない
2. WHEN 画像データを取得する場合、システムは画像をBase64エンコードしなければならない
3. WHEN メール本文に画像を埋め込む場合、システムはHTML形式のメールとして画像をインライン表示しなければならない
4. WHEN 画像を挿入する場合、システムは画像をメール本文の末尾に配置しなければならない
5. WHEN 画像を挿入する場合、システムは画像の表示幅を最大600pxに制限しなければならない

### 要件6

**ユーザーストーリー:** 営業担当者として、画像のサイズを適切に調整してほしいので、メールが重くなりすぎないようにしたい

#### 受入基準

1. WHEN システムが画像を取得する場合、システムは画像ファイルサイズが5MB以下であることを確認しなければならない
2. WHEN 画像ファイルサイズが5MBを超える場合、システムは警告メッセージを表示し、選択をキャンセルするオプションを提供しなければならない
3. WHEN 画像をメールに埋め込む場合、システムはアスペクト比を維持しなければならない
4. WHEN 複数の画像を選択する場合、システムは合計ファイルサイズが10MB以下であることを確認しなければならない

### 要件7

**ユーザーストーリー:** 営業担当者として、画像選択処理の進捗を確認したいので、処理状況を視覚的に表示してほしい

#### 受入基準

1. WHEN 画像選択モーダルが開かれる場合、システムはローディングインジケーターを表示しなければならない
2. WHEN フォルダ内の画像を読み込む場合、システムは「画像を読み込んでいます...」というメッセージを表示しなければならない
3. WHEN 画像データを取得する場合、システムは「画像を取得しています...」というメッセージを表示しなければならない
4. WHEN 処理が完了した場合、システムはローディングインジケーターを非表示にしなければならない

### 要件8

**ユーザーストーリー:** 営業担当者として、画像選択をキャンセルしたいので、いつでも選択を中止できる機能がほしい

#### 受入基準

1. WHEN 画像選択モーダルが表示される場合、システムは「キャンセル」ボタンを表示しなければならない
2. WHEN 「キャンセル」ボタンがクリックされる場合、システムは選択をキャンセルしてモーダルを閉じなければならない
3. WHEN モーダルの外側をクリックする場合、システムは選択をキャンセルしてモーダルを閉じなければならない
4. WHEN ESCキーが押される場合、システムは選択をキャンセルしてモーダルを閉じなければならない

### 要件9

**ユーザーストーリー:** 営業担当者として、送信されたメールの記録を確認したいので、画像添付の有無を活動ログに記録してほしい

#### 受入基準

1. WHEN 画像付きメールが送信された場合、システムは活動ログに「画像添付あり」というフラグを記録しなければならない
2. WHEN 活動ログを記録する場合、システムは添付された画像のファイル名を記録しなければならない
3. WHEN 活動ログを記録する場合、システムは添付された画像の枚数を記録しなければならない
4. WHEN 活動ログを表示する場合、システムは画像添付の有無を視覚的に区別して表示しなければならない
