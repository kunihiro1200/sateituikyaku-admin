# Property Details同期修正 - タスクリスト

## 1. 調査フェーズ

### 1.1 問題の根本原因調査
- [ ] 1.1.1 `sellers`テーブルのスキーマを確認
- [ ] 1.1.2 `PropertyService.getPropertyAbout()`の実装を確認
- [ ] 1.1.3 コメントアウトされた理由を特定
- [ ] 1.1.4 調査結果をドキュメント化

---

## 2. 実装フェーズ

### 2.1 `PropertyListingSyncService`の修正

#### 2.1.1 コメントアウトの解除
- [ ] 2.1.1.1 `PropertyListingSyncService.ts`の768行目のコメントアウトを解除
- [ ] 2.1.1.2 エラーハンドリングを追加（try-catchブロック）
- [ ] 2.1.1.3 エラーログを詳細に記録

#### 2.1.2 `updatePropertyDetailsFromSheets()`の改善
- [ ] 2.1.2.1 各サービスのエラーを個別にキャッチ
- [ ] 2.1.2.2 一部のデータ取得に失敗しても、他のデータは保存する
- [ ] 2.1.2.3 実行時間をログに記録
- [ ] 2.1.2.4 成功/失敗の統計をログに記録

### 2.2 既存物件の再同期スクリプト

#### 2.2.1 検出スクリプトの作成
- [ ] 2.2.1.1 `backend/backfill-missing-property-about.ts`を作成
- [ ] 2.2.1.2 `property_about`が空の物件を検出する機能を実装
- [ ] 2.2.1.3 検出結果をログに出力

#### 2.2.2 再同期スクリプトの作成
- [ ] 2.2.2.1 検出された物件のコメントデータを再取得
- [ ] 2.2.2.2 `property_details`テーブルに保存
- [ ] 2.2.2.3 バッチ処理で複数物件を効率的に処理
- [ ] 2.2.2.4 進捗状況をログに記録
- [ ] 2.2.2.5 エラーハンドリングを実装

---

## 3. テストフェーズ

### 3.1 単体テスト

#### 3.1.1 `updatePropertyDetailsFromSheets()`のテスト
- [ ] 3.1.1.1 正常系: すべてのデータが正しく取得・保存される
- [ ] 3.1.1.2 異常系: PropertyServiceがエラーを返す → 他のデータは保存される
- [ ] 3.1.1.3 異常系: RecommendedCommentServiceがエラーを返す → 他のデータは保存される
- [ ] 3.1.1.4 異常系: FavoriteCommentServiceがエラーを返す → 他のデータは保存される
- [ ] 3.1.1.5 異常系: すべてのサービスがエラーを返す → エラーログに記録される

#### 3.1.2 各サービスのテスト
- [ ] 3.1.2.1 PropertyService.getPropertyAbout()のテスト
- [ ] 3.1.2.2 RecommendedCommentService.getRecommendedComment()のテスト
- [ ] 3.1.2.3 FavoriteCommentService.getFavoriteComment()のテスト
- [ ] 3.1.2.4 PropertyDetailsService.upsertPropertyDetails()のテスト

### 3.2 統合テスト

#### 3.2.1 同期処理の統合テスト
- [ ] 3.2.1.1 物件リストスプレッドシートを更新 → コメントデータが自動的に同期される
- [ ] 3.2.1.2 新規物件追加 → コメントデータが正しく保存される
- [ ] 3.2.1.3 既存物件更新 → コメントデータが正しく更新される

#### 3.2.2 再同期スクリプトのテスト
- [ ] 3.2.2.1 `property_about`が空の物件を正しく検出できる
- [ ] 3.2.2.2 検出された物件のコメントデータを正しく再取得できる
- [ ] 3.2.2.3 バッチ処理が正常に動作する
- [ ] 3.2.2.4 エラーが発生しても処理が継続する

### 3.3 Property-Based Testing

#### 3.3.1 プロパティ1: データの完全性
- [ ] 3.3.1.1 すべての物件に対して、`property_about`が空でない場合、`property_details`テーブルに保存されている

#### 3.3.2 プロパティ2: 同期の冪等性
- [ ] 3.3.2.1 同じ物件に対して`updatePropertyDetailsFromSheets()`を複数回実行しても、結果は同じである

#### 3.3.3 プロパティ3: エラーハンドリングの堅牢性
- [ ] 3.3.3.1 一部のサービスがエラーを返しても、他のデータは正しく保存される

---

## 4. 検証フェーズ

### 4.1 開発環境での検証

#### 4.1.1 AA12608の検証
- [ ] 4.1.1.1 AA12608の`property_about`が正しく保存される
- [ ] 4.1.1.2 AA12608の`recommended_comments`が正しく保存される
- [ ] 4.1.1.3 AA12608の`favorite_comment`が正しく保存される
- [ ] 4.1.1.4 AA12608の公開物件サイトで「こちらの物件について」が表示される

#### 4.1.2 他の物件の検証
- [ ] 4.1.2.1 複数の物件（最低5件）でコメントデータが正しく表示される
- [ ] 4.1.2.2 物件種別（土地、戸建て、マンション）ごとに検証

### 4.2 ステージング環境での検証

#### 4.2.1 再同期スクリプトの実行
- [ ] 4.2.1.1 `property_about`が空の物件を検出
- [ ] 4.2.1.2 再同期スクリプトを実行
- [ ] 4.2.1.3 すべての物件で`property_about`が保存されたことを確認

#### 4.2.2 パフォーマンステスト
- [ ] 4.2.2.1 100件の物件を同期する時間を測定（目標: 10分以内）
- [ ] 4.2.2.2 Google Sheets APIのレート制限を超えないことを確認
- [ ] 4.2.2.3 メモリ使用量を確認

### 4.3 本番環境での検証

#### 4.3.1 デプロイ前の確認
- [ ] 4.3.1.1 すべてのテストが成功していることを確認
- [ ] 4.3.1.2 ステージング環境での検証が完了していることを確認
- [ ] 4.3.1.3 ロールバック計画を準備

#### 4.3.2 デプロイ後の確認
- [ ] 4.3.2.1 AA12608の公開物件サイトで「こちらの物件について」が表示される
- [ ] 4.3.2.2 他の物件でもコメントデータが正しく表示される
- [ ] 4.3.2.3 エラーログに異常がない
- [ ] 4.3.2.4 同期処理のパフォーマンスが許容範囲内である

---

## 5. ドキュメント化フェーズ

### 5.1 技術ドキュメントの更新
- [ ] 5.1.1 `PropertyListingSyncService`のドキュメントを更新
- [ ] 5.1.2 `updatePropertyDetailsFromSheets()`のドキュメントを更新
- [ ] 5.1.3 エラーハンドリングのドキュメントを追加

### 5.2 運用ドキュメントの作成
- [ ] 5.2.1 再同期スクリプトの使用方法を記載
- [ ] 5.2.2 トラブルシューティングガイドを作成
- [ ] 5.2.3 モニタリング方法を記載

---

## 6. デプロイフェーズ

### 6.1 開発環境へのデプロイ
- [ ] 6.1.1 コードをコミット
- [ ] 6.1.2 開発環境にデプロイ
- [ ] 6.1.3 動作確認

### 6.2 ステージング環境へのデプロイ
- [ ] 6.2.1 コードをマージ
- [ ] 6.2.2 ステージング環境にデプロイ
- [ ] 6.2.3 再同期スクリプトを実行
- [ ] 6.2.4 動作確認

### 6.3 本番環境へのデプロイ
- [ ] 6.3.1 本番環境にデプロイ
- [ ] 6.3.2 再同期スクリプトを実行
- [ ] 6.3.3 動作確認
- [ ] 6.3.4 モニタリング開始

---

## 7. 完了基準

### 7.1 機能要件
- [ ] 7.1.1 すべての物件で`property_about`が正しく保存される
- [ ] 7.1.2 すべての物件で`recommended_comments`が正しく保存される
- [ ] 7.1.3 すべての物件で`favorite_comment`が正しく保存される
- [ ] 7.1.4 公開物件サイトですべてのコメントが正しく表示される

### 7.2 非機能要件
- [ ] 7.2.1 同期処理のエラー率が5%以下
- [ ] 7.2.2 同期処理の完了時間が10分以内（100物件の場合）
- [ ] 7.2.3 エラーログが詳細で、問題の特定が容易

### 7.3 テスト要件
- [ ] 7.3.1 すべての単体テストが成功
- [ ] 7.3.2 すべての統合テストが成功
- [ ] 7.3.3 すべてのProperty-Based Testが成功

### 7.4 ドキュメント要件
- [ ] 7.4.1 技術ドキュメントが更新されている
- [ ] 7.4.2 運用ドキュメントが作成されている
- [ ] 7.4.3 トラブルシューティングガイドが作成されている

---

## 8. 優先順位

### 高優先度（必須）
- タスク 2.1.1: コメントアウトの解除
- タスク 2.1.2: `updatePropertyDetailsFromSheets()`の改善
- タスク 2.2: 既存物件の再同期スクリプト
- タスク 4.1.1: AA12608の検証

### 中優先度（推奨）
- タスク 3.1: 単体テスト
- タスク 3.2: 統合テスト
- タスク 4.2: ステージング環境での検証

### 低優先度（オプション）
- タスク 3.3: Property-Based Testing
- タスク 5: ドキュメント化フェーズ

---

## 9. 見積もり

### 9.1 時間見積もり
- **調査フェーズ**: 1時間
- **実装フェーズ**: 3時間
- **テストフェーズ**: 2時間
- **検証フェーズ**: 2時間
- **ドキュメント化フェーズ**: 1時間
- **デプロイフェーズ**: 1時間

**合計**: 約10時間

### 9.2 リスク見積もり
- **低リスク**: コメントアウトの解除（既存のコードを活用）
- **中リスク**: エラーハンドリングの改善（新しいロジックの追加）
- **低リスク**: 再同期スクリプトの作成（既存のサービスを活用）

---

## 10. 次のステップ

1. **タスク 1.1**: 問題の根本原因調査を開始
2. **タスク 2.1.1**: コメントアウトの解除
3. **タスク 2.2**: 既存物件の再同期スクリプトの作成
4. **タスク 4.1.1**: AA12608の検証

---

**注意**: このタスクリストは、実装の進捗に応じて更新されます。
