# Implementation Plan

- [x] 1. フロントエンドのEmailテンプレート配列を更新
  - ✅ CallModePage.tsxの`emailTemplates`配列を23種類の新しいテンプレートに置き換え
  - ✅ 各テンプレートに`id`, `label`, `subject`, `content`を設定
  - ✅ ユーザーから提供された全23種類のテンプレートを正確に実装
  - ✅ 新しいファイル `frontend/src/utils/emailTemplates.ts` を作成
  - ✅ CallModePage.tsxでインポートして使用
  - _Requirements: 1.1, 5.1, 5.2_

- [x] 2. フロントエンドのプレースホルダー置換ロジックを実装
  - ✅ CallModePage.tsxに`replaceEmailPlaceholders`関数を実装
  - ✅ 全てのプレースホルダータイプ（名前、物件情報、査定額、担当者情報、日時など）に対応
  - ✅ 複雑な条件付きロジック（築年不明、お客様紹介文言）を実装
  - _Requirements: 1.2, 1.3, 3.1-3.9_

- [x] 3. 欠損データのエラーハンドリングを実装
  - ✅ プレースホルダーの値がnullまたはundefinedの場合の処理を追加
  - ✅ 適切なデフォルト値または空文字列を設定
  - ✅ エラーが発生してもシステムがクラッシュしないことを保証
  - _Requirements: 3.10_

- [x] 4. 担当者情報取得機能を実装
  - ✅ 売主に割り当てられた担当者（assignedTo）の情報を取得
  - ✅ 担当者の名前、電話番号、メールアドレスをテンプレートに渡す
  - ✅ 担当者が未設定の場合のフォールバック処理（現在のユーザー情報を使用）
  - _Requirements: 3.6, 3.7, 3.8_

- [x] 5. 日時フォーマット関数を実装
  - ✅ 訪問日を日本語形式でフォーマット（例：12月5日）
  - ✅ 訪問時刻を時刻形式でフォーマット（例：14:00）
  - ✅ タイムゾーンを適切に処理
  - _Requirements: 3.7_

- [x] 6. 築年情報フォーマット関数を実装
  - ✅ 物件種別が戸建てで築年が不明な場合のみメッセージを表示
  - ✅ 条件付きロジックを正確に実装
  - _Requirements: 3.5_

- [x] 7. 査定額フォーマット関数を実装
  - ✅ 査定額を円から万円に変換（÷10000）
  - ✅ 小数点以下を四捨五入
  - ✅ 査定額が未設定の場合は空文字列を表示
  - _Requirements: 3.3_

- [x] 8. Email送信APIエンドポイントを更新
  - ✅ POST /sellers/:id/send-template-emailエンドポイントを使用
  - ✅ プレースホルダー置換後のコンテンツでメール送信
  - ✅ 送信成功後に活動ログを作成
  - _Requirements: 1.4, 1.5_

- [x] 9. 確認ダイアログの動作を検証
  - ✅ テンプレート選択時に確認ダイアログが表示される
  - ✅ ダイアログに件名と本文（プレースホルダー置換済み）が表示される
  - ✅ 確認ボタンでメール送信、キャンセルボタンで送信中止
  - ✅ URLをクリック可能なリンクとして表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 10. UIの表示確認とスタイリング調整
  - ✅ ドロップダウンメニューで3階層の情報（種別、件名、本文プレビュー）が表示される
  - ✅ 長い本文が適切に省略表示される（WebkitLineClamp: 2）
  - ✅ メニュー項目のスタイリングが読みやすい
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 11. サイト別フィルタリング機能を実装
  - ✅ テンプレートに`sites`フィールドを追加
  - ✅ サイト別フィルタリングロジックを実装
  - ✅ サイト名がラベルに含まれるテンプレートは該当サイトのみで表示
  - _Requirements: Custom requirement from user_

- [x] 12. 動的テンプレート順序機能を実装
  - ✅ `getSortedEmailTemplates`関数を実装
  - ✅ 訪問日が1週間以内の場合、訪問査定後御礼メールを最上位に表示
  - ✅ ステータスに「他決」が含まれる場合、他決追客テンプレートを最上位に表示
  - ✅ 訪問予定日の1-2日前の場合、訪問前日通知メールを最上位に表示
  - ✅ それ以外はorder番号順に表示
  - _Requirements: Custom requirement from user_

- [x] 13. URLクリック可能化機能を実装
  - ✅ `renderTextWithLinks`関数を実装
  - ✅ 確認ダイアログ内のURLをクリック可能なリンクとして表示
  - ✅ http://, https://, bit.ly/, chrome-extension:// のURLに対応
  - _Requirements: Custom requirement from user_

- [ ] 14. 統合テストの実施
  - 各テンプレートを選択して送信できることを確認
  - プレースホルダーが正しく置換されることを確認
  - 活動ログに記録されることを確認
  - エラーケース（欠損データ）でもクラッシュしないことを確認
  - サイト別フィルタリングが正しく動作することを確認
  - 動的順序変更が正しく動作することを確認
  - URLがクリック可能であることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 3.10_

- [ ] 15. Checkpoint - すべてのテストが通ることを確認
  - Ensure all tests pass, ask the user if questions arise.
