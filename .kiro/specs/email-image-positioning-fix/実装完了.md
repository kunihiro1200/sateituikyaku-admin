# メール画像位置保持修正 - 実装完了

## 問題の概要
メールエディタで特定のカーソル位置に貼り付けた画像が、受信したメールでは本文の下に表示されてしまい、元の位置が保持されない問題がありました。

## 根本原因

バックエンドで2つの問題がありました：

### 問題1: `sendTemplateEmail`メソッドでの`htmlBody`の無視
フロントエンドから送信された`htmlBody`パラメータ（画像が埋め込まれたHTML）を無視して、常にデフォルトテンプレートを使用していました。

```typescript
// 修正前の問題コード
const finalHtmlBody = htmlBody || `デフォルトテンプレート...`;
// ↑ htmlBodyが提供されていても、finalHtmlBodyは常にデフォルトテンプレートを使用
```

### 問題2: 画像位置の再配置
画像を抽出してから別のロジックで再配置していたため、元の位置が失われていました。

## 実装した解決策

### 修正1: `htmlBody`パラメータの正しい使用

`sendTemplateEmail`メソッドを修正して、`htmlBody`が提供されている場合はそれをそのまま使用するようにしました：

```typescript
// 修正後
if (hasEmbeddedImages) {
  // htmlBodyをそのまま使用（画像が埋め込まれている位置を保持）
  let processedHtml = htmlBody!;
  // 画像をCID参照に置き換え（位置は保持）
  processedHtml = processedHtml.replace(...);
} else {
  // htmlBodyが提供されている場合はそれを使用、なければデフォルトテンプレート
  const finalHtmlBody = htmlBody || `デフォルトテンプレート...`;
}
```

### 修正2: インライン置換による位置保持

`String.replace()`のコールバック関数を使用して、画像を抽出しながら同時にCID参照に置き換えることで、元の位置を保持します：

```typescript
processedHtml = processedHtml.replace(
  /<img([^>]*)src="data:image\/([^;]+);base64,([^"]+)"([^>]*)>/gi,
  (fullMatch, beforeSrc, mimeType, base64Data, afterSrc) => {
    // 画像データを抽出
    const imageBuffer = Buffer.from(base64Data, 'base64');
    const cid = `embedded-image-${imageIndex}`;
    
    // 添付ファイルとして保存
    attachments.push({ filename, mimeType, data: imageBuffer, cid });
    
    // 元の位置でCID参照に置き換え
    return `<img${beforeSrc}src="cid:${cid}"${afterSrc}>`;
  }
);
```

## 処理フロー（修正後）

1. **フロントエンド**: `RichTextEmailEditor`で画像をカーソル位置に貼り付け
2. **フロントエンド**: `<img src="data:image/...">`を含むHTMLを`htmlBody`パラメータとして送信
3. **バックエンド**: `htmlBody`をそのまま使用（無視しない）
4. **バックエンド**: 正規表現で画像を検出し、その場でCID参照に置き換え
5. **バックエンド**: 画像データを添付ファイルとして追加
6. **バックエンド**: マルチパートメールとして送信
7. **受信側**: 画像が元の位置に表示される

## 修正したファイル

### backend/src/services/EmailService.supabase.ts

1. **`sendTemplateEmail`メソッド**:
   - `htmlBody`パラメータを正しく使用するように修正
   - 埋め込み画像がある場合は`htmlBody`をそのまま使用
   - デバッグログを追加

2. **画像処理ロジック**:
   - `processedHtml = htmlBody!`として元のHTMLを保持
   - インライン置換で位置を保持

## デバッグログ

実装には以下のデバッグログが含まれています：

```
📄 htmlBody provided: true
📄 htmlBody length: 1234
📄 htmlBody preview (first 200 chars): <p>テキスト</p><img src="data:image/png;base64,...
🔍 Has embedded images: true
📎 Detected embedded images in HTML body, creating multipart message
✅ Extracted embedded image 0: 245678 bytes
✅ Extracted embedded image 1: 189234 bytes
✅ Processed 2 embedded images
📄 Processed HTML preview (first 500 chars): <p>テキスト</p><img src="cid:embedded-image-0"...
✅ Template email sent successfully: 18f2a3b4c5d6e7f8
```

## テスト手順

1. **バックエンドサーバーを起動**
   ```bash
   cd backend
   npm start
   ```

2. **フロントエンドアプリケーションを開く**
   - 売主詳細ページに移動
   - 「メール送信」ボタンをクリック

3. **画像位置のテスト**
   - メールエディタにテキストを入力
   - 画像を貼り付け（Ctrl+V）- テキストの先頭に配置
   - さらにテキストを入力
   - 別の画像を貼り付け - テキストの途中に配置
   - メールを送信

4. **受信メールで確認**
   - 1枚目の画像がテキストの先頭に表示されることを確認
   - 2枚目の画像がテキストの途中に表示されることを確認
   - 画像が本文の下に移動していないことを確認

## 期待される動作

- ✅ 画像がエディタでの位置を保持
- ✅ 複数の画像を異なる位置に配置可能
- ✅ 画像の前後のテキストが保持される
- ✅ 画像がインライン添付として埋め込まれる（外部リンクではない）
- ✅ メールサイズ制限が適用される（画像1枚5MB、合計10MB）

## ステータス

✅ **完了** - 画像が受信メールでエディタでの位置を保持するようになりました。

## 完了日
2025年12月12日
