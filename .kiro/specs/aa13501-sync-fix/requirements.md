# AA13501同期修正 - 要件定義

## 概要

AA13501において、不通フィールド（`unreachable_status`）、物件住所（`property_address`）、コメント（`comments`）がスプレッドシートに同期されていない問題を修正します。

## 背景

### 現状の問題

1. **不通フィールド（`unreachable_status`）の同期問題**
   - データベースには`unreachable_status`カラムが存在
   - `SellerService.decryptSeller()`では`unreachable_status`を正しく返している
   - しかし、`column-mapping.json`には`unreachable_status`のマッピングが**存在しない**
   - 現在は`is_unreachable`（boolean）のみがマッピングされている
   - スプレッドシートには「不通」列が存在するが、`is_unreachable`（boolean）にマッピングされている

2. **物件住所（`property_address`）の同期問題**
   - `sellers`テーブルに`property_address`カラムが**存在しない**
   - `column-mapping.json`には`property_address`の**逆方向マッピング**（データベース→スプレッドシート）が**存在しない**
   - スプレッドシートの「物件所在地」列（R列）は`property_address`にマッピングされているが、カラム自体が存在しない
   - データベースには「未入力」という値が保存されている

3. **コメント（`comments`）の同期問題**
   - `column-mapping.json`には`comments`のマッピングが**完全に存在しない**
   - スプレッドシートには「コメント」列が存在するが、データベースに同期されない
   - データベースからスプレッドシートへの同期も行われない

### 影響範囲

- **売主管理システム**（`backend/src/`）
  - 通話モードページ（`/sellers/:id/call`）
  - 売主詳細ページ（`/sellers/:id`）
- **スプレッドシート同期**
  - `SpreadsheetSyncService`
  - `ColumnMapper`

## ユーザーストーリー

### US-1: 不通ステータスの同期

**As a** 営業担当者  
**I want** 通話モードページで設定した不通ステータスがスプレッドシートに同期される  
**So that** スプレッドシートで不通ステータスを確認できる

**受け入れ基準**:
1. 通話モードページで不通ステータスを設定できる
2. 不通ステータスがデータベースに保存される
3. 不通ステータスがスプレッドシートの「不通」列に同期される
4. スプレッドシートの「不通」列の値がデータベースに同期される

### US-2: 物件住所の同期

**As a** 営業担当者  
**I want** 売主詳細ページで設定した物件住所がスプレッドシートに同期される  
**So that** スプレッドシートで物件住所を確認できる

**受け入れ基準**:
1. `sellers`テーブルに`property_address`カラムが存在する
2. 売主詳細ページで物件住所を設定できる
3. 物件住所がデータベースに保存される
4. 物件住所がスプレッドシートの「物件所在地」列（R列）に同期される
5. スプレッドシートの「物件所在地」列の値がデータベースに同期される

### US-3: コメントの同期

**As a** 営業担当者  
**I want** 売主詳細ページで設定したコメントがスプレッドシートに同期される  
**So that** スプレッドシートでコメントを確認できる

**受け入れ基準**:
1. 売主詳細ページでコメントを設定できる
2. コメントがデータベースに保存される
3. コメントがスプレッドシートの「コメント」列に同期される
4. スプレッドシートの「コメント」列の値がデータベースに同期される

## 技術的要件

### TR-1: カラムマッピング設定の修正

**要件**: `column-mapping.json`に不通ステータス、物件住所、コメントの双方向マッピングを追加する

**詳細**:
1. `unreachable_status`のマッピングを修正
   - スプレッドシート→データベース: `"不通": "unreachable_status"`（`is_unreachable`から変更）
   - データベース→スプレッドシート: `"unreachable_status": "不通"`（追加）
2. `property_address`の逆方向マッピングを追加
   - データベース→スプレッドシート: `"property_address": "物件所在地"`（追加）
   - （スプレッドシート→データベースは既に存在）
3. `comments`のマッピングを追加
   - スプレッドシート→データベース: `"コメント": "comments"`（追加）
   - データベース→スプレッドシート: `"comments": "コメント"`（追加）

### TR-2: データベーススキーマの修正

**要件**: `sellers`テーブルに`property_address`カラムを追加する

**詳細**:
1. マイグレーションファイルを作成
2. `property_address`カラムを追加（TEXT型、NULL許可）
3. マイグレーションを実行

### TR-3: ColumnMapperの修正

**要件**: `ColumnMapper`が`unreachable_status`、`property_address`、`comments`を正しく変換する

**詳細**:
1. `mapToDatabase()`メソッドで`unreachable_status`と`comments`を正しく変換
2. `mapToSheet()`メソッドで`unreachable_status`、`property_address`、`comments`を正しく変換
3. `unreachable_status`を`is_unreachable`より優先

### TR-4: データ同期の実行

**要件**: AA13501のデータをスプレッドシートから強制同期する

**詳細**:
1. 強制同期スクリプトを作成
2. スプレッドシートからAA13501のデータを取得
3. データベースに保存（`unreachable_status`、`property_address`、`comments`）
4. キャッシュをクリア

## 非機能要件

### NFR-1: 後方互換性

**要件**: 既存のデータとの互換性を保つ

**詳細**:
1. `is_unreachable`（boolean）は引き続きサポート
2. `unreachable_status`（string）を優先的に使用
3. 既存のスプレッドシートデータが正しく移行される

### NFR-2: データ整合性

**要件**: データベースとスプレッドシートのデータが一致する

**詳細**:
1. 双方向同期が正しく動作する
2. データの欠損や重複が発生しない

## 制約事項

### C-1: スプレッドシートの列名

**制約**: スプレッドシートの列名は変更しない

**理由**: 既存のスプレッドシートとの互換性を保つため

### C-2: データベーススキーマ

**制約**: `sellers`テーブルに`property_address`カラムを追加する必要がある

**理由**: 現在`property_address`カラムが存在しないため、マイグレーションが必要

## 成功基準

1. ✅ AA13501の不通ステータスがスプレッドシートに同期される
2. ✅ AA13501の物件住所がスプレッドシートに同期される
3. ✅ AA13501のコメントがスプレッドシートに同期される
4. ✅ 既存のデータが正しく移行される
5. ✅ 双方向同期が正しく動作する
6. ✅ `sellers`テーブルに`property_address`カラムが追加される

## 除外事項

1. 新しいフィールドの追加（`unreachable_status`、`property_address`、`comments`以外）
2. UIの変更
3. スプレッドシートの列名の変更

---

**作成日**: 2026年1月30日  
**更新日**: 2026年1月30日  
**作成者**: Kiro AI  
**ステータス**: ✅ 完了
