# Implementation Plan: 公開物件コメント表示修正

## Overview

公開物件サイトの「お気に入り文言」と「アピールポイント」が表示されなくなった問題を診断・修正します。既存の実装は正しいため、まず診断を行い、問題箇所を特定してから修正を実施します。

## Tasks

- [x] 1. 診断ツールの作成と実行
  - 診断スクリプトとエンドポイントを作成し、問題箇所を特定
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 1.1 バックエンドAPI診断スクリプトの作成
  - 両方のAPIエンドポイントをテストするスクリプトを作成
  - 各物件タイプでの動作確認
  - レスポンスの検証
  - _Requirements: 8.1, 8.2_

- [x] 1.2 診断エンドポイントの作成
  - `/api/public/properties/:id/comments-diagnostic` エンドポイントを実装
  - 両方のコメント機能の状態を一度に確認できるようにする
  - 詳細な診断情報を返す
  - _Requirements: 8.5_

- [x] 1.3 フロントエンド表示診断スクリプトの作成
  - コンポーネントのマウント確認
  - APIリクエストの送信確認
  - レンダリング確認
  - _Requirements: 8.3_

- [x] 1.4 診断の実行と問題特定
  - すべての診断スクリプトを実行
  - 問題箇所を特定
  - 診断レポートを作成
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 2. Checkpoint - 診断結果の確認
  - 診断結果を確認し、修正方針を決定する
  - ユーザーに診断結果を報告し、次のステップを確認

- [x] 3. APIエンドポイントの確認と修正
  - 既存のAPIエンドポイントが正しく動作しているか確認し、必要に応じて修正
  - _Requirements: 1.1, 2.1, 3.1, 3.2, 3.3_

- [x] 3.1 お気に入り文言APIエンドポイントの確認
  - `/api/public/properties/:id/favorite-comment` の存在確認
  - ルーティングの確認
  - レスポンス形式の確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 3.2 アピールポイントAPIエンドポイントの確認
  - `/api/public/properties/:id/recommended-comment` の存在確認
  - ルーティングの確認
  - レスポンス形式の確認
  - セル範囲取得の確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 3.3 APIエンドポイントの修正（必要な場合）
  - 診断結果に基づいてエンドポイントを修正
  - ルーティングの追加または修正
  - _Requirements: 1.1, 2.1_

- [x] 4. フロントエンドコンポーネントの確認と修正
  - コンポーネントが正しく配置され、動作しているか確認し、必要に応じて修正
  - _Requirements: 1.6, 2.7, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 4.1 PropertyImageWithFavoriteCommentコンポーネントの確認
  - コンポーネントの存在確認
  - `showFavoriteComment` propの設定確認
  - APIリクエストの送信確認
  - オーバーレイ表示の確認
  - _Requirements: 1.6, 5.1, 5.3_

- [x] 4.2 RecommendedCommentSectionコンポーネントの確認
  - コンポーネントの存在確認
  - 配置位置の確認（基本情報の下）
  - APIリクエストの送信確認
  - 表示スタイルの確認
  - _Requirements: 2.7, 5.2, 5.4_

- [x] 4.3 PublicPropertyDetailPageの確認と修正
  - 両方のコンポーネントが正しく配置されているか確認
  - propsが正しく渡されているか確認
  - 必要に応じて修正
  - _Requirements: 5.1, 5.2, 5.5, 7.1, 7.2_

- [x] 5. データソースの確認と修正
  - スプレッドシートのデータが正しく設定されているか確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 5.1 スプレッドシートURL設定の確認
  - `property_listings.storage_location` の確認
  - `work_tasks.spreadsheet_url` の確認
  - URLの形式確認
  - _Requirements: 3.1, 3.2_

- [x] 5.2 スプレッドシートシート構造の確認
  - `athome` シートの存在確認
  - セル位置の確認（B53/B142/B150）
  - セル範囲の確認（B63:L79/B152:L166/B149:L163）
  - _Requirements: 3.3, 4.2_

- [x] 5.3 Google Sheets API認証の確認
  - サービスアカウントキーの確認
  - 環境変数の確認
  - 権限の確認
  - _Requirements: 3.7_

- [ ] 6. Checkpoint - 修正完了の確認
  - すべての修正が完了したことを確認
  - 再度診断を実行して問題が解決したことを確認
  - ユーザーに修正結果を報告

- [ ] 7. テストの実装と実行
  - Unit testsとintegration testsを実装・実行
  - _Requirements: すべて_

- [ ] 7.1 FavoriteCommentServiceのユニットテスト
  - 各物件タイプでのセル位置マッピングテスト
  - スプレッドシートからの取得テスト
  - エラーハンドリングテスト
  - キャッシュ動作テスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 4.1, 4.2, 4.3, 6.1, 6.2, 6.3, 6.4_

- [ ] 7.2 RecommendedCommentServiceのユニットテスト
  - 各物件タイプでのセル範囲マッピングテスト
  - セル範囲からの取得テスト
  - 空セルのスキップテスト
  - 行構造の保持テスト
  - エラーハンドリングテスト
  - キャッシュ動作テスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 4.1, 4.2, 4.3, 6.1, 6.2, 6.3, 6.4_

- [ ] 7.3 APIエンドポイントの統合テスト
  - お気に入り文言エンドポイントのテスト
  - アピールポイントエンドポイントのテスト
  - 各物件タイプでのテスト
  - エラーケースのテスト
  - _Requirements: 1.1, 2.1, 6.1, 6.2, 6.3_

- [ ] 7.4 フロントエンドコンポーネントのテスト
  - PropertyImageWithFavoriteCommentのテスト
  - RecommendedCommentSectionのテスト
  - PublicPropertyDetailPageの統合テスト
  - _Requirements: 1.6, 2.7, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 7.5 Property-Based Tests
  - **Property 1: お気に入り文言の取得と表示**
  - **Validates: Requirements 1.1, 1.2, 1.3, 1.4, 1.5**

- [ ]* 7.6 Property-Based Tests
  - **Property 2: アピールポイントのセル範囲取得**
  - **Validates: Requirements 2.2, 2.3, 2.4**

- [ ]* 7.7 Property-Based Tests
  - **Property 3: セル範囲の連結処理**
  - **Validates: Requirements 2.5, 2.6**

- [ ]* 7.8 Property-Based Tests
  - **Property 4: アピールポイントの表示**
  - **Validates: Requirements 2.7, 2.8**

- [ ]* 7.9 Property-Based Tests
  - **Property 5: エラー時のグレースフルデグラデーション**
  - **Validates: Requirements 1.7, 2.9, 6.3, 6.5**

- [ ]* 7.10 Property-Based Tests
  - **Property 6: キャッシュの動作**
  - **Validates: Requirements 6.4**

- [ ]* 7.11 Property-Based Tests
  - **Property 7: 物件タイプのマッピング**
  - **Validates: Requirements 4.2, 4.3**

- [ ] 8. 手動テストと動作確認
  - ブラウザでの視覚的確認
  - 各デバイスでの確認
  - _Requirements: すべて_

- [ ] 8.1 デスクトップでの動作確認
  - お気に入り文言が画像の上に表示されることを確認
  - アピールポイントが基本情報の下に表示されることを確認
  - スタイリングの確認
  - _Requirements: 1.6, 2.7, 5.1, 5.2, 5.3, 5.4_

- [ ] 8.2 タブレットでの動作確認
  - レスポンシブデザインの確認
  - タッチ操作の確認
  - _Requirements: 5.5_

- [ ] 8.3 モバイルでの動作確認
  - レスポンシブデザインの確認
  - 小画面での表示確認
  - _Requirements: 5.5_

- [ ] 8.4 各物件タイプでの動作確認
  - 土地物件での確認
  - 戸建て物件での確認
  - マンション物件での確認
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 8.5 エラーケースの動作確認
  - スプレッドシートURLがない物件での確認
  - セルが空の物件での確認
  - ページが正常に表示されることを確認
  - _Requirements: 1.7, 2.9, 6.1, 6.2, 6.3, 6.5_

- [ ] 9. Checkpoint - テスト完了の確認
  - すべてのテストが成功したことを確認
  - パフォーマンスが許容範囲内であることを確認
  - ユーザーに最終確認を依頼

- [ ] 10. ドキュメントの作成と更新
  - トラブルシューティングガイドと運用マニュアルを作成
  - _Requirements: すべて_

- [ ] 10.1 トラブルシューティングガイドの作成
  - よくある問題と解決方法
  - 診断手順
  - キャッシュクリア方法
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 10.2 運用マニュアルの作成
  - データ設定方法
  - スプレッドシートの構造説明
  - セル位置とセル範囲の説明
  - _Requirements: 3.1, 3.2, 3.3, 4.2_

- [ ] 10.3 実装完了レポートの作成
  - 診断結果のまとめ
  - 修正内容のまとめ
  - テスト結果のまとめ
  - _Requirements: すべて_

## Task Summary

### 総推定時間: 約16時間（2日）

### フェーズ別内訳:
- **Phase 1 (診断):** 4時間
- **Phase 2 (修正):** 4時間
- **Phase 3 (テスト):** 6時間
- **Phase 4 (ドキュメント):** 2時間

### 優先順位:
1. Task 1 - 診断ツールの作成と実行（最優先）
2. Task 2 - Checkpoint（診断結果の確認）
3. Task 3 - APIエンドポイントの確認と修正
4. Task 4 - フロントエンドコンポーネントの確認と修正
5. Task 5 - データソースの確認と修正
6. Task 6 - Checkpoint（修正完了の確認）
7. Task 7 - テストの実装と実行
8. Task 8 - 手動テストと動作確認
9. Task 9 - Checkpoint（テスト完了の確認）
10. Task 10 - ドキュメントの作成と更新

### 依存関係:
- Task 2 は Task 1 に依存
- Task 3, 4, 5 は Task 2 に依存（診断結果に基づく）
- Task 6 は Task 3, 4, 5 に依存
- Task 7 は Task 6 に依存
- Task 8 は Task 7 に依存
- Task 9 は Task 8 に依存
- Task 10 は Task 9 に依存

## 診断シナリオと対応

診断結果に応じて、以下のシナリオのいずれかに該当します：

### シナリオA: APIエンドポイントが存在しない
**症状**: 404エラーが返される
**対応**: Task 3.3でエンドポイントを作成

### シナリオB: コンポーネントが正しく配置されていない
**症状**: コンポーネントがレンダリングされない
**対応**: Task 4.3でPublicPropertyDetailPageを修正

### シナリオC: データソースの問題
**症状**: APIは動作するがデータが取得できない
**対応**: Task 5でスプレッドシートの設定を確認・修正

### シナリオD: 認証・権限の問題
**症状**: Google Sheets APIエラーが発生
**対応**: Task 5.3で認証設定を確認・修正

### シナリオE: キャッシュの問題
**症状**: 古いデータが表示される、または表示されない
**対応**: Redisキャッシュをクリア

## 重要な注意事項

1. **診断優先**: 修正を始める前に、必ず診断を完了させる
2. **Checkpoint**: 各フェーズの後にCheckpointを設け、ユーザーに確認を求める
3. **グレースフルデグラデーション**: エラー時もページが正常に表示されることを確認
4. **既存機能の保護**: 既存の動作を壊さないように注意
5. **テストの徹底**: すべての物件タイプで動作確認を行う

## 成功基準

以下のすべてが満たされた場合、タスク完了とみなします：

1. ✅ お気に入り文言が画像の上に表示される
2. ✅ アピールポイントが基本情報の下に表示される
3. ✅ 各物件タイプで正しいセル位置/範囲からデータを取得
4. ✅ エラー時もページが正常に表示される
5. ✅ パフォーマンスが許容範囲内（キャッシュ使用時 < 500ms）
6. ✅ すべてのテストが成功する
7. ✅ ログにエラーが記録されない
8. ✅ ドキュメントが完成している

