# Implementation Plan: Property Inquiry Response Email

## Overview

物件問い合わせ返信メール機能の実装計画です。既存のEmailServiceを活用し、データベースから物件データを取得してメールテンプレートを生成し、SMTP経由で配信します。

## Tasks

- [x] 1. バックエンド：InquiryResponseServiceの実装
  - 新しいサービスクラスを作成し、データベースからのデータ取得とテンプレート生成のコアロジックを実装
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2_

- [ ]* 1.1 Property 1: データベースからの物件情報取得の正確性
  - **Property 1: データベースからの物件情報取得の正確性**
  - **Validates: Requirements 1.1**

- [ ]* 1.2 Property 2: メールコンテンツ生成の完全性
  - **Property 2: メールコンテンツ生成の完全性**
  - **Validates: Requirements 2.1**

- [x] 2. バックエンド：API Routesの実装
  - [x] 2.1 /api/inquiry-response/property-info/:buyerId エンドポイントを実装
    - 買主IDを受け取り、物件情報を返す
    - _Requirements: 1.1, 1.2_

  - [x] 2.2 /api/inquiry-response/send エンドポイントを実装
    - メール内容と宛先を受け取り、SMTP経由で送信
    - _Requirements: 7.1, 7.4_

- [ ]* 2.3 Property 3: カスタムメッセージの適切な処理
  - **Property 3: カスタムメッセージの適切な処理**
  - **Validates: Requirements 4.1**

- [ ]* 2.4 Property 4: 欠損データの適切な処理
  - **Property 4: 欠損データの適切な処理**
  - **Validates: Requirements 6.1**

- [ ] 3. Checkpoint - バックエンドの動作確認
  - すべてのAPIエンドポイントが正しく動作することを確認
  - エラーハンドリングが適切に機能することを確認

- [x] 4. フロントエンド：Reactコンポーネントの実装
  - [x] 4.1 InquiryResponseButtonコンポーネントを実装
    - 買主一覧ページの各行にボタンを配置
    - クリックでモーダルを開く
    - _Requirements: 10.1, 10.2_

  - [x] 4.2 InquiryResponseEmailModalコンポーネントを実装
    - 物件情報の表示
    - カスタムメッセージ入力フィールド
    - 送信ボタン
    - _Requirements: 5.1, 5.2, 5.3_

- [ ]* 4.3 Property 5: メール送信の成功確認
  - **Property 5: メール送信の成功確認**
  - **Validates: Requirements 7.4**

- [x] 5. 設定管理の実装
  - [x] 5.1 メールテンプレートをサービスコードに実装
    - シンプルなテンプレートを定義
    - _Requirements: 2.1_

  - [x] 5.2 データベースからのデータ取得ロジックを実装
    - buyersテーブルとproperty_listingsテーブルからデータを取得
    - _Requirements: 1.1, 1.2_

- [x] 6. エラーハンドリングとバリデーションの実装
  - [x] 6.1 入力バリデーションを実装
    - 買主IDの検証
    - メールアドレスの形式チェック
    - _Requirements: 6.1_

  - [x] 6.2 エラーメッセージの表示を実装
    - ユーザーフレンドリーなエラーメッセージ
    - ローディング状態の管理
    - _Requirements: 9.1, 9.2, 9.3_

- [ ]* 6.3 ユニットテスト：エラーケースのテスト
  - 欠損データ、無効な買主ID、メール送信失敗などのエッジケースをテスト
  - _Requirements: 6.1, 6.2, 7.5_

- [x] 7. 統合とワイヤリング
  - [x] 7.1 フロントエンドとバックエンドを接続
    - API呼び出しの実装
    - ローディング状態の管理
    - _Requirements: 1.1, 1.2, 7.1_

  - [x] 7.2 既存の買主一覧ページにボタンを統合
    - BuyerTableコンポーネントに新しいカラムを追加
    - 各買主行にボタンを配置
    - _Requirements: 10.1, 10.2_

- [ ]* 7.3 統合テスト：エンドツーエンドフロー
  - ボタンクリックからメール送信までの完全なフローをテスト
  - _Requirements: 10.1, 10.4, 10.5, 10.6_

- [ ] 8. Final checkpoint - すべてのテストが通過することを確認
  - すべてのプロパティテストとユニットテストが成功することを確認
  - ユーザーに質問があれば確認

## Notes

- `*`マークのタスクはオプションで、より速いMVPのためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、早期にエラーを発見します
- プロパティテストは普遍的な正確性プロパティを検証します（各100回実行）
- ユニットテストは特定の例とエッジケースを検証します
