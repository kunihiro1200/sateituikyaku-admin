# 通話履歴サマリー チューニングガイド

このドキュメントは、通話履歴サマリー生成機能の動作をカスタマイズするためのガイドです。
新しい要望や改善点があれば、このファイルに追記してください。

## 📝 更新履歴

### 2024年12月 - 初期設定
- 【連絡可能時間】から不要な情報（「電話切られる」など）を除外
- 【次のアクション】から「査定額」に関する文言を削除
- 「1年後くらいにうる予定」を【状況】に分類するよう変更

---

## 🎯 カテゴリー分類ルール

### 【次のアクション】
**目的**: 次回の営業活動で何をすべきかを明確にする

**現在のルール**:
- 「買いたい」「紹介」「お客様」→「次回電話時に、お客様を紹介したい旨伝え、売却の進捗状況を確認」
- 「２月」「来月」「すぐ」→「早急に訪問査定の日程調整を行う」
- 「何社か」「他社」「競合」→「他社との差別化ポイントを説明し、早めの訪問査定を提案する」
- 「売りたい」「検討中」「前向き」→「売却スケジュールを確認し、訪問査定の日程を提案する」
- 「家族」「相談」「娘」「息子」「嫁」「母様」→「ご家族を含めた面談の機会を設定する」

**除外する文言**:
- ❌ 「査定額を出す」「査定額を提示」（初動で既に提示済みのため）

**今後追加したいルール**:
<!-- ここに新しいルールを追記してください -->
<!-- 例: -->
<!-- - 「〇〇」というキーワードがあれば「△△する」というアクションを提案 -->

---

### 【連絡可能時間】
**目的**: お客様に連絡できる時間帯を明確にする

**含めるべき情報**:
- ✅ 「★希望連絡時間：9時～12時」
- ✅ 「午前中なら電話可能」
- ✅ 「平日の夕方以降」

**除外すべき情報**:
- ❌ 「赤ちゃんが泣きだしたので電話切られる」
- ❌ 「不在だった」「留守だった」
- ❌ 「電話に出られなかった」

**キーワード**:
- 連絡可能、希望連絡時間、お話できる時間、都合の良い時間
- 電話可能、連絡希望、連絡時間、電話時間
- 午前中、午後、夕方以降、夜間、平日の、土日の

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

「連絡希望時間」のあとに、その事に関するコメントがなければ何も入力しなくて良い

### 【状況】
**目的**: 売却の進捗状況や現在の状態を把握する

**含めるべき情報**:
- ✅ 専任媒介の有無
- ✅ 他社との競合状況
- ✅ 売却予定（「1年後くらいにうる予定」など）
- ✅ 検討中の状態

**キーワード**:
- 専任媒介、他社、進捗、決定、相談、買取、査定、募集中
- 契約、媒介、競合、他決、状況、変化、現在
- 年後、予定、検討中、うる予定、売る予定、売却予定

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

ローン残という言葉とそれに続く言葉があればそのとおりここに書く。例えば「ローン残：」で終わっていてその後に金額等がなければそれは、。意味のない情報なのでどこにも入力する必要がない。「ローン３００万」や「ローン残：１５００万」等の情報があればここの記入
「駐車場」や「P」という言葉があってその後に数字があればここに記入
「名義人」という言葉があり、その後に親や娘、息子、本人、等それに該当する言葉があれば記入「名義人」だけで終わっていれば記入は不要
「接道」「太陽光」「リフォーム」等の情報もそれに回答する答えがあればここに書く。答えてなければ書かない
「コメント」という言葉は不要

### 【名義人】
**目的**: 物件の所有者や決定権者を明確にする

**含めるべき情報**:
- ✅ 「自分本人ではない」
- ✅ 「嫁のお母様が所有」
- ✅ 家族構成と決定権

**キーワード**:
- 名義、所有者、本人ではない、家族、娘、息子、母親、父親、兄弟、姉妹
- 決定権、嫁の、妻の、夫の

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

該当の土地建物の所有者のことなので、それに該当することばがあれば、「本人」「父」等入力。なければ不要

### 【売却時期】
**目的**: いつ頃売却したいのかを把握する

**キーワード**:
- 来年、今年、２月、３月、４月、ヶ月後
- 時期、引っ越し、売却可能、急いで

**注意**: 「年後」「予定」「検討中」は【状況】に分類

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

「売却希望時期」のあとに該当する言葉がなければ入力不要、また「売却希望時期」という言葉がなくても、文脈より推測していつ売却をしたいか、をひろって入力してほしい

### 【売却理由】
**目的**: なぜ売却するのかを理解する

**キーワード**:
- 転勤、相続、離婚、住み替え、進学、理由、ため
- 引っ越し、売却理由、事情、必要

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

文脈をみて、売却理由があればそれをここに入力「売却理由」という言葉だけここに入力しても意味ないので不要

### 【物件情報】
**目的**: 物件の詳細情報を把握する

**キーワード**:
- ㎡、平米、コンロ、エアコン、照明、温水器、リフォーム
- 築年数、間取り、新品、洗浄、角部屋、日当たり、禁煙
- 設備、状態、木造、鉄筋、マンション、一戸建て、土地
- 駐車場、庭、階、平屋、注文住宅、ハウスメーカー

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

「リフォーム」等の後に回答コメントがなければなにも入力しなくてよい

### 【確度】
**目的**: 売却の意欲や可能性を評価する

**キーワード**:
- 興味、検討中、前向き、売りたい、考え中、意欲、確度
- 可能性、見込み、希望

**今後追加したいキーワード**:
<!-- ここに新しいキーワードを追記してください -->

売る気の確度なので、１年以内に売る気ある、売る気はあるが１年以上先、ただ査定が気が知りたいだけ、等を文脈より判断して入力してほしい

## 🔧 実装ファイル

カテゴリー分類やキーワードを変更する場合は、以下のファイルを編集してください：

### 1. `backend/src/services/ContentSummarizer.ts`
- **役割**: キーワードベースのカテゴリー分類
- **編集箇所**: `getKeywordsForCategory()` メソッド内の `keywordMap`
- **編集方法**: 各カテゴリーのキーワード配列に追加・削除

### 2. `backend/src/services/SummaryGenerator.ts`
- **役割**: 次のアクション生成ロジック
- **編集箇所**: `generateNextAction()` メソッド
- **編集方法**: 条件分岐を追加・修正

---

## 📋 改善要望テンプレート

新しい要望があれば、以下のテンプレートを使って記録してください：

```markdown
### [日付] - [要望タイトル]

**問題点**:
- 現在の動作: 〇〇
- 期待する動作: △△

**提案する変更**:
- ファイル: `backend/src/services/〇〇.ts`
- 変更内容: 
  - キーワード追加: 「〇〇」「△△」
  - または、ロジック変更: 〇〇の場合は△△する

**影響範囲**:
- 影響するカテゴリー: 【〇〇】
- テストケース: テストケース〇で確認可能

**優先度**: 高 / 中 / 低
```

---

## 🎯 今後の改善要望

<!-- ここに新しい要望を追記してください -->

### 2024年12月14日 - コンテキスト理解の強化（実装完了✅）

**問題点**:
- 現在の動作: キーワードがあるだけで情報を抽出していた
- 期待する動作: キーワードの後に実際の情報があるかを判断して抽出

**実装した変更**:
- ファイル: `backend/src/services/ContentSummarizer.ts`
- 変更内容:
  1. **【連絡可能時間】**: 「連絡希望時間」だけで終わっている場合は除外、実際の時間情報がある場合のみ抽出
  2. **【状況】**: 
     - 「ローン残」: 金額がある場合のみ抽出
     - 「駐車場」「P」: 数字がある場合のみ抽出
     - 「名義人」: 具体的な人物情報がある場合のみ抽出
     - 「接道」「太陽光」「リフォーム」: 回答がある場合のみ抽出
     - 「コメント」という言葉は除外
  3. **【名義人】**: 「名義人」だけで終わっている場合は除外、具体的な所有者情報がある場合のみ抽出
  4. **【売却時期】**: 「売却希望時期」だけで終わっている場合は除外、具体的な時期情報がある場合のみ抽出
  5. **【売却理由】**: 「売却理由」だけで終わっている場合は除外、具体的な理由がある場合のみ抽出
  6. **【物件情報】**: 「リフォーム」などのキーワードだけで終わっている場合は除外
  7. **【確度】**: 文脈から以下を判断
     - 「1年以内に売る気あり」: すぐ、早め、急いでなどのキーワードから推測
     - 「売る気はあるが1年以上先」: 年後、まだ先などのキーワードから推測
     - 「ただ査定額が知りたいだけ」: 査定額を知りたいが売却意思が見られない場合

**影響範囲**:
- 全カテゴリーに影響
- より正確で意味のある情報のみが抽出されるようになる

**優先度**: 高 ✅ 実装完了

---

### 2024年12月14日 - 通話回数カウントの改善（実装完了✅）

**問題点**:
- 現在の動作: スプレッドシートコメントに日付のみ（例: 3/1）が入っている場合、カウントされていなかった
- 期待する動作: 日付のみのパターンも1回の通話としてカウントし、コミュニケーション履歴の通話履歴と合算する

**実装した変更**:
- ファイル: `backend/src/services/TimestampParser.ts`
- 変更内容:
  1. **日付のみパターンの追加**: 「3/1」「12/25」などの日付のみのパターンを認識するように改善
  2. **パターン認識の順序**: 
     - YYYY/M/D HH:mm（完全な日時）
     - YYYY/M/D（年付き日付のみ）
     - M/D HH:mm（短い日時）
     - M/D（短い日付のみ）← 新規追加
  3. **重複カウント防止**: 同じ位置で複数のパターンがマッチしないように制御
  4. **既存のロジック維持**: コミュニケーション履歴の通話履歴とスプレッドシートコメントの日付を合算し、5分以内の重複を除外

**影響範囲**:
- 【通話回数】セクションに影響
- より正確な通話回数がカウントされるようになる

**優先度**: 高 ✅ 実装完了

---

### 2024年12月14日 - 箇条書きフォーマットの追加（実装完了✅）

**問題点**:
- 現在の動作: 【状況】などの長い文章が読みにくい
- 期待する動作: 箇条書きにして改行を入れて読みやすくする

**実装した変更**:
- ファイル: `backend/src/services/SummaryGenerator.ts`
- 変更内容:
  1. **箇条書きフォーマットメソッドの追加**: `formatAsBulletPoints()`メソッドを実装
  2. **文章の分割**: 「。」で文章を分割し、各文を箇条書きに変換
  3. **適用セクション**: 
     - 【状況】: 複数の情報を箇条書きで表示
     - 【物件情報】: 物件の詳細を箇条書きで表示
     - 【その他】: その他の情報を箇条書きで表示
  4. **フォーマット**: 各項目の前に「・」を付け、最後に「。」を付けて改行

**表示例**:
```
【状況】
・専任媒介契約中。
・他社と競合あり。
・1年後くらいに売る予定。
```

**影響範囲**:
- 長い文章が含まれるセクションの可読性が向上
- 情報が整理されて見やすくなる

**優先度**: 中 ✅ 実装完了

---

### 2024年12月14日 - カテゴリー分類の精度向上（実装完了✅）

**問題点**:
- 現在の動作: 
  - 「★希望連絡時間：18時～21時」が【確度】に誤って分類されていた
  - 「★査定方法:」のように、★の後に内容がない情報が表示されていた
  - 意味のない情報（キーワードだけで内容がない）が含まれていた

- 期待する動作: 
  - 「★希望連絡時間」は【連絡可能時間】に分類
  - ★の後に内容がない場合は除外
  - 意味のない情報を自動的に除外

**実装した変更**:
- ファイル: `backend/src/services/ContentSummarizer.ts`
- 変更内容:
  1. **優先的なカテゴリー分類**: 「★希望連絡時間」を含むテキストは必ず【連絡可能時間】に分類
  2. **空の★パターンの除外**: 「★査定方法:」のように、★の後にキーワードがあっても内容がない場合は除外
  3. **【確度】フィルタリング強化**: 「★希望連絡時間」を【確度】から明示的に除外
  4. **カテゴリー優先順位の調整**: 【連絡可能時間】を優先的にチェックするように順序を変更

**影響範囲**:
- 【連絡可能時間】と【確度】の分類精度が向上
- 意味のない情報が自動的に除外される

**優先度**: 高 ✅ 実装完了

---

### 例: 2024年12月XX日 - 〇〇の改善
**問題点**:
- 現在の動作: 〇〇
- 期待する動作: △△

**提案する変更**:
- ファイル: `backend/src/services/ContentSummarizer.ts`
- 変更内容: キーワード追加「〇〇」

**優先度**: 中

---

## 💡 ヒント

### キーワードの追加方法
1. このファイルの該当セクションに新しいキーワードを記録
2. `backend/src/services/ContentSummarizer.ts` を開く
3. `getKeywordsForCategory()` メソッドの該当カテゴリーにキーワードを追加
4. テストページ（http://localhost:5173/test-browser.html）でF5を押して確認

### 次のアクションのロジック変更
1. このファイルに新しいルールを記録
2. `backend/src/services/SummaryGenerator.ts` を開く
3. `generateNextAction()` メソッドに条件分岐を追加
4. テストページで確認

### 除外パターンの追加
1. このファイルに除外すべき情報を記録
2. `backend/src/services/ContentSummarizer.ts` の `categorizeText()` メソッドを編集
3. `excludePatterns` 配列に新しいパターンを追加

---

## 📞 サポート

このドキュメントを更新したら、Kiroに「通話履歴サマリーのチューニングガイドを見て、〇〇を改善して」と伝えてください。
Kiroがこのファイルを参照して、適切な変更を行います。
