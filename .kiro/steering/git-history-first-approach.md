---
tags: [general, troubleshooting, git, best-practices, critical]
priority: high
context: all
inclusion: always
last-verified: 2026-01-25
---

# Git履歴優先アプローチ

## 概要

問題が発生した際、**まず最初に以前の動作していたバージョンのコードを確認**してから作業を進めます。

**重要**: **フロントエンドとバックエンドの両方**を必ず確認すること。

## なぜこのアプローチが重要か

- ✅ **正解は既にコミット履歴の中にある**
- ✅ 推測で修正を試みるよりも、動作していたコードを見る方が確実
- ✅ 時間の無駄を防ぐ
- ✅ 何が変わったのかを理解できる

## 必須作業フロー

### ステップ1: 以前の動作していたコミットを探す

```bash
# 最近のコミット履歴を確認
git log --oneline --all -50

# 特定のキーワードで検索
git log --oneline --all -100 | grep "キーワード"

# 日付で絞り込み
git log --oneline --all --before="2026-01-20" -20
```

### ステップ2: 以前のコードを確認

```bash
# 特定のコミットのファイルを確認
git show <commit>:<file_path>

# 例: backend/api/index.tsの内容を確認
git show 9405333:backend/api/index.ts

# 特定のパターンを検索
git show 9405333:backend/api/index.ts | grep -A 5 -B 5 "complete"
```

### ステップ3: 差分を比較

```bash
# 現在のファイルと以前のコミットを比較
git diff <commit> <file_path>

# 例: 現在のbackend/api/index.tsと以前のバージョンを比較
git diff 9405333 backend/api/index.ts
```

### ステップ4: 修正を適用

- 以前の動作していたバージョンをベースに修正
- 推測で新しいコードを書かない
- 動作していたコードの構造を維持する

## 実例：今回の問題

### 問題
- 画像は表示されるが、パノラマ、おすすめコメント、お気に入り文言が表示されない

### 間違ったアプローチ（今回の失敗）
1. ❌ 推測で「動的インポートが遅いのでは？」と考えた
2. ❌ Supabaseから直接取得する新しいコードを書いた
3. ❌ 以前の動作していたコードを確認しなかった

### 正しいアプローチ（今後）
1. ✅ まず`git log`で以前の動作していたコミット（9405333）を探す
2. ✅ `git show 9405333:backend/api/index.ts`で正解を確認
3. ✅ 以前のコードは動的インポートを使用していたことを確認
4. ✅ 以前の動作していたバージョンに戻す

## チェックリスト

問題が発生したら、以下を必ず実行する：

- [ ] `git log`で以前の動作していたコミットを探す
- [ ] **バックエンド**のコードを確認（`backend/api/index.ts`など）
- [ ] **フロントエンド**のコードを確認（`frontend/src/pages/*.tsx`など）
- [ ] 関連するサービス層を確認（`backend/src/services/*.ts`、`frontend/src/services/*.ts`）
- [ ] カスタムフックを確認（`frontend/src/hooks/*.ts`）
- [ ] 現在のコードとの差分を比較
- [ ] 以前の動作していたバージョンをベースに修正
- [ ] 推測で新しいコードを書かない

## よくある間違い

### ❌ 間違い1: すぐに新しい解決策を試す
- 「動的インポートが遅いから削除しよう」
- 「Supabaseから直接取得しよう」
- → **まず以前のコードを確認する**

### ❌ 間違い2: 「以前は動作していた」という情報を無視する
- ユーザーが「以前は完璧に動作していた」と言っている
- → **その時のコードを必ず確認する**

### ❌ 間違い3: コミット履歴を見ずに推測する
- 「たぶんこうだろう」
- → **git logで確認する**

## まとめ

**正解は既にコミット履歴の中にある。まず確認してから作業する。**

**重要**: **フロントエンドとバックエンドの両方を必ず確認する。**

このアプローチを徹底することで：
- ✅ 時間の無駄を防ぐ
- ✅ 確実に問題を解決できる
- ✅ 何が変わったのかを理解できる
- ✅ 同じ間違いを繰り返さない

---

## 実例：公開物件詳細画面の遅延問題（2026年1月）

### 問題
コメントデータが60秒以上経過しても表示されない

### 原因（2つの問題が重なった）
1. **バックエンド**: 動的インポート（`await import()`）を使用していた → 20秒/回
2. **フロントエンド**: `useEffect`の依存配列に`property?.property_number`が含まれていた → 無限ループ（3-4回呼び出し）

### 結果
20秒 × 3回 = 60秒以上

### 失敗したアプローチ
- ❌ バックエンドの`backend/api/index.ts`だけを確認した
- ❌ フロントエンドの`PublicPropertyDetailPage.tsx`を確認しなかった

### 正しいアプローチ
- ✅ バックエンドの`backend/api/index.ts`を確認
- ✅ **フロントエンドの`PublicPropertyDetailPage.tsx`も確認**
- ✅ 両方の問題を発見して修正

### 教訓
**バックエンドだけでなく、フロントエンドも必ず確認する。**

### ユーザーからの推奨される伝え方
- 「前は完璧に動作していた。その時のフロントエンドとバックエンドのコードを両方確認して、今と何が違うか比較して」
- 「前の完璧だったバージョンと今のコードを全て比較して」
