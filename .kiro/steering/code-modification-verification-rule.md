# コード修正前の確認ルール（絶対に守るべきルール）

## ⚠️ 最重要：意味があってそうなっている

**絶対に守るべき原則**:
- **全てのコードには意味がある**
- **コメントアウトされているコードにも理由がある**
- **変更前に必ず「なぜそうなっているのか」を確認する**
- **確認せずに変更すると、システム全体が壊れる可能性がある**

---

## 🚨 修正前の必須確認プロセス

### ステップ1: Git履歴を確認（必須）

```bash
# コミット履歴を確認
git log --oneline -20

# 特定のファイルの履歴を確認
git log --oneline -- path/to/file

# 特定のコードの変更履歴を確認
git log -S "検索したいコード" --oneline

# コミットの詳細を確認
git show <commit-hash>
```

**確認すること**:
- [ ] なぜその変更が行われたのか
- [ ] コミットメッセージに理由が書いてあるか
- [ ] 関連するコミットがあるか
- [ ] いつ変更されたのか

### ステップ2: コメントを確認（必須）

**確認すること**:
- [ ] コード内のコメントを読む
- [ ] 「一時的に」「TODO」「FIXME」などの記述を確認
- [ ] コメントアウトされている理由を確認
- [ ] 警告コメント（⚠️、❌、🚨など）を確認

**例**:
```typescript
// ⚠️ 重要: publicPropertiesRoutes を先に登録（より具体的なルートを優先）
// app.use('/api/public', publicPropertiesRoutes); // 一時的にコメントアウト（ルートの重複を回避）
```

このコメントを見たら：
- ✅ 「ルートの重複を回避」という理由がある
- ✅ 有効化する前に、重複していないか確認する必要がある
- ❌ 確認せずに有効化してはいけない

### ステップ3: 関連ファイルを確認（必須）

**確認すること**:
- [ ] 同じ機能を実装している他のファイルがないか
- [ ] 重複していないか
- [ ] 依存関係があるか
- [ ] 他のシステムへの影響があるか

**例**:
- `backend/api/index.ts`に直接実装されたエンドポイント
- `backend/src/routes/publicProperties.ts`に実装されたエンドポイント
- → 両方が有効だと、ルートが重複する

### ステップ4: ユーザーに確認（必須）

**確認すること**:
- [ ] 変更の意図を説明
- [ ] 影響範囲を説明
- [ ] なぜそうなっているのかを質問
- [ ] 承認を得てから実行

**例**:
```
「publicPropertiesRoutesがコメントアウトされていますが、
これは他のデプロイの影響を受けないためでしょうか？
確認してから修正します。」
```

### ステップ5: 影響範囲を確認（必須）

**確認すること**:
- [ ] 他のシステムへの影響
- [ ] 既存のURLが壊れないか
- [ ] 後方互換性
- [ ] 公開物件サイトへの影響
- [ ] 管理画面への影響

---

## 📋 過去の問題例

### 問題1: publicPropertiesRoutesを安易に有効化

**日付**: 2026年2月22日

**問題**:
- `publicPropertiesRoutes`がコメントアウトされていた
- コメントに「一時的にコメントアウト（ルートの重複を回避）」と書いてあった
- 確認せずに有効化してしまった

**原因**:
- Git履歴を確認しなかった
- コメントを読まなかった
- ユーザーに確認しなかった

**影響**:
- ルートが重複する可能性があった
- 公開物件サイトが壊れる可能性があった

**教訓**:
- ✅ コメントアウトされているコードには必ず理由がある
- ✅ 「一時的に」というコメントを見たら、必ず理由を確認する
- ✅ ユーザーに確認してから変更する

### 問題2: 概算書PDF生成のINITIAL_WAITを変更

**日付**: 過去の事例

**問題**:
- `INITIAL_WAIT = 4000`（4秒）が正しい設定
- 誰かが`INITIAL_WAIT = 2000`（2秒）に変更してしまった
- 概算書PDF生成が失敗するようになった

**原因**:
- なぜ4秒なのかを確認しなかった
- 復元ガイドを読まなかった

**影響**:
- 概算書PDF生成の成功率が95% → 10-20%に低下

**教訓**:
- ✅ 数値には意味がある
- ✅ 変更前に復元ガイドを確認する
- ✅ なぜその値なのかを理解する

---

## ✅ 正しい修正の手順

### 手順1: 問題を特定

```
「公開物件サイトが404エラーになっている」
```

### 手順2: Git履歴を確認

```bash
git log --oneline -20
git log -S "publicPropertiesRoutes" --oneline
```

### 手順3: コメントを確認

```typescript
// app.use('/api/public', publicPropertiesRoutes); // 一時的にコメントアウト（ルートの重複を回避）
```

### 手順4: ユーザーに確認

```
「publicPropertiesRoutesがコメントアウトされていますが、
これは他のデプロイの影響を受けないためでしょうか？
確認してから修正します。」
```

### 手順5: ユーザーの回答を待つ

```
ユーザー: 「そうです。ルートの重複を避けるためです。」
```

### 手順6: 正しい対応を実行

```
「了解しました。publicPropertiesRoutesは有効化せず、
backend/api/index.tsの直接実装を使用します。」
```

---

## 🚨 絶対にやってはいけないこと

### ❌ 禁止事項1: 確認せずにコメントアウトを解除

```typescript
// ❌ 間違い: 確認せずに有効化
app.use('/api/public', publicPropertiesRoutes);
```

**正しい方法**:
```typescript
// ✅ 正しい: コメントを読み、ユーザーに確認してから判断
// app.use('/api/public', publicPropertiesRoutes); // 一時的にコメントアウト（ルートの重複を回避）
```

### ❌ 禁止事項2: 数値を安易に変更

```typescript
// ❌ 間違い: なぜ4秒なのか確認せずに変更
const INITIAL_WAIT = 2000; // 2秒に変更
```

**正しい方法**:
```typescript
// ✅ 正しい: 復元ガイドを確認し、なぜ4秒なのかを理解してから判断
const INITIAL_WAIT = 4000; // 4秒（Google Sheetsの計算完了を待つため）
```

### ❌ 禁止事項3: Git履歴を確認せずに変更

```bash
# ❌ 間違い: いきなり変更
git add file.ts
git commit -m "fix: something"
```

**正しい方法**:
```bash
# ✅ 正しい: まずGit履歴を確認
git log --oneline -- file.ts
git show <commit-hash>
# 理由を理解してから変更
```

---

## 📝 修正前のチェックリスト

変更前に以下を確認：

### 1. Git履歴の確認
- [ ] コミット履歴を確認した
- [ ] コミットメッセージを読んだ
- [ ] なぜその変更が行われたのか理解した
- [ ] 関連するコミットを確認した

### 2. コメントの確認
- [ ] コード内のコメントを読んだ
- [ ] 「一時的に」「TODO」「FIXME」などの記述を確認した
- [ ] コメントアウトされている理由を理解した
- [ ] 警告コメントを確認した

### 3. 関連ファイルの確認
- [ ] 同じ機能を実装している他のファイルを確認した
- [ ] 重複していないか確認した
- [ ] 依存関係を確認した
- [ ] 他のシステムへの影響を確認した

### 4. ユーザーへの確認
- [ ] 変更の意図を説明した
- [ ] 影響範囲を説明した
- [ ] なぜそうなっているのかを質問した
- [ ] 承認を得た

### 5. 影響範囲の確認
- [ ] 他のシステムへの影響を確認した
- [ ] 既存のURLが壊れないか確認した
- [ ] 後方互換性を確認した
- [ ] 公開物件サイトへの影響を確認した
- [ ] 管理画面への影響を確認した

---

## 🎯 実装例

### 例1: コメントアウトされているコードを見つけた場合

```typescript
// ⚠️ 重要: publicPropertiesRoutes を先に登録（より具体的なルートを優先）
// app.use('/api/public', publicPropertiesRoutes); // 一時的にコメントアウト（ルートの重複を回避）
```

**正しい対応**:
1. コメントを読む → 「ルートの重複を回避」という理由がある
2. Git履歴を確認 → いつ、なぜコメントアウトされたのか
3. 関連ファイルを確認 → `backend/api/index.ts`に同じエンドポイントがあるか
4. ユーザーに確認 → 「これは他のデプロイの影響を受けないためでしょうか？」
5. 承認を得てから判断

### 例2: 数値を変更する場合

```typescript
const INITIAL_WAIT = 4000; // 初回待機時間（4秒）
```

**正しい対応**:
1. 復元ガイドを確認 → `.kiro/restore-guides/estimate-pdf-generation-fix.md`
2. なぜ4秒なのかを理解 → Google Sheetsの計算完了を待つため
3. 変更の影響を確認 → 2秒にすると成功率が10-20%に低下
4. ユーザーに確認 → 「INITIAL_WAITを変更する必要がありますか？」
5. 承認を得てから変更

---

## 📚 関連ドキュメント

- `.kiro/steering/system-isolation-rule.md` - システム隔離ルール
- `.kiro/steering/backward-compatibility-rule.md` - 後方互換性ルール
- `.kiro/restore-guides/estimate-pdf-generation-fix.md` - 概算書PDF生成の復元ガイド

---

## まとめ

**絶対に守るべきルール**:

1. **全てのコードには意味がある**
2. **変更前に必ずGit履歴を確認する**
3. **変更前に必ずコメントを読む**
4. **変更前に必ず関連ファイルを確認する**
5. **変更前に必ずユーザーに確認する**
6. **変更前に必ず影響範囲を確認する**
7. **確認せずに変更してはいけない**

**このルールを徹底することで、システムを壊すことなく、安全に修正できます。**

---

**最終更新日**: 2026年2月22日  
**作成理由**: publicPropertiesRoutesを確認せずに有効化してしまった問題を防ぐため  
**関連する問題**: コメントアウトされているコードを安易に有効化してしまった

