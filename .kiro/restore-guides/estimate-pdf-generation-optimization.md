# 概算書PDF生成の最適化 - 復元ガイド

## 📋 概要

概算書PDF生成の待機時間を最適化し、高速化しました。

## 🎯 実装内容

### 待機時間の最適化
- **初回待機**: 2秒（スプレッドシートの計算は高速）
- **リトライ間隔**: 1秒（ネットワークエラー対応）
- **最大試行回数**: 3回
- **合計最大待機時間**: 5秒（2秒 + 3回 × 1秒）

### 設計思想
1. **スプレッドシートの計算は高速**（通常2-3秒で完了）
2. **初回待機は短く**（2秒で十分）
3. **リトライでネットワークエラーに対応**

### 詳細なログ出力
- 各ステップでの状態を詳細にログ出力
- セルの値、型、検証結果を明確に表示
- 失敗した場合の理由を明確に表示

## 📝 修正ファイル

- `backend/src/services/PropertyService.ts`
  - `waitForCalculationCompletion()` メソッド
  - `INITIAL_WAIT = 2000ms`
  - `MAX_ATTEMPTS = 3`
  - `RETRY_INTERVAL = 1000ms`

## 🔧 復元コミット

```
コミット: 4e1de3b
日付: 2026年1月27日
```

## 🚀 次回の復元依頼の仕方

```
概算書PDF生成が遅い。コミット 4e1de3b に戻して。
```

または

```
概算書PDF生成の待機時間を最適化したバージョンに戻して。
```

## 📊 期待される結果

- **通常の場合**: 2秒で完了（初回待機のみ）
- **ネットワークエラーの場合**: 最大5秒（2秒 + 3回 × 1秒）
- **約40%の高速化**（以前の8.5秒から5秒に短縮）

## ⚠️ 注意事項

- スプレッドシートの計算式が複雑になった場合は、`INITIAL_WAIT`を調整する必要があるかもしれません
- Google Sheets APIのクォータ超過エラーは、待機時間とは無関係です（頻繁なAPIコールが原因）

## 🔍 トラブルシューティング

### 問題: PDF生成が失敗する

**原因1: Google Sheets APIのクォータ超過**
- エラーメッセージ: "Google Sheets APIのクォータを超過しました"
- 解決策: 数分待ってから再度試す

**原因2: スプレッドシートの数式エラー**
- エラーメッセージ: "D11セルに有効な価格が入力されませんでした"
- 解決策: スプレッドシートの数式を確認

**原因3: ネットワークの一時的な問題**
- 解決策: リトライで自動的に対応（最大3回）

## 📚 関連ドキュメント

- スプレッドシートID: `1gBH9bqI7g3Xp6x8ZvWjeHVVcnSadpcB_7OpCt72w_7I`
- シート名: `Sheet1`
- 検証セル: `D11`（価格セル）
- 入力セル: `C2`（物件番号）

---

**最終更新日**: 2026年1月27日
