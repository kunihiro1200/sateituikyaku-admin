# Migration 081 補完スクリプト - 完全診断ガイド

## 📋 現在の状況

補完スクリプトは正しく書かれていますが、検証スクリプトがカラムを認識できていません。
以下の手順で根本原因を特定し、確実に解決します。

---

## ステップ1: PostgreSQL直接確認

まず、PostgreSQL側で実際にカラムが存在するか確認します。

### 1.1 Supabase SQL Editorで確認

Supabaseダッシュボード → SQL Editor → 新しいクエリで以下を実行:

```sql
-- propertiesテーブルのカラム一覧
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'properties' 
ORDER BY ordinal_position;

-- valuationsテーブルのカラム一覧
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'valuations' 
ORDER BY ordinal_position;
```

**期待される結果:**
- `properties`: construction_year, property_address, current_status, updated_at, created_by, updated_by, version などが存在する
- `valuations`: property_id, valuation_type, valuation_amount_1, valuation_date, created_by などが存在する

**もしカラムが存在しない場合** → ステップ2へ
**カラムが存在する場合** → ステップ3へ

---

## ステップ2: 補完スクリプトの実行

カラムが存在しない場合、補完スクリプトを実行します。

### 2.1 Supabaseダッシュボードで実行

1. Supabaseダッシュボード → SQL Editor
2. 新しいクエリを作成
3. `backend/migrations/081_補完_add_missing_columns.sql` の内容をコピー&ペースト
4. **Run** をクリック

### 2.2 実行結果の確認

エラーが出た場合:
- `column already exists` → 問題なし、すでに存在しています
- その他のエラー → エラーメッセージをコピーして報告してください

### 2.3 再度カラム確認

ステップ1.1のSQLを再実行して、カラムが追加されたことを確認します。

---

## ステップ3: PostgreSTキャッシュの強制リロード

カラムは存在するがREST APIで認識されない場合、PostgreSTキャッシュをリロードします。

### 3.1 方法A: Supabaseプロジェクトの一時停止・再開

1. Supabaseダッシュボード → Settings → General
2. **Pause project** をクリック
3. プロジェクトが完全に停止するまで待つ（1-2分）
4. **Resume project** をクリック
5. プロジェクトが完全に起動するまで待つ（2-3分）

### 3.2 方法B: NOTIFY経由でのリロード

Supabase SQL Editorで以下を実行:

```sql
NOTIFY pgrst, 'reload schema';
```

### 3.3 方法C: 直接PostgreSTを再起動

Supabaseダッシュボード → Settings → API → **Restart PostgREST**

---

## ステップ4: 検証

### 4.1 検証スクリプトの実行

```bash
npx ts-node backend/migrations/verify-081-migration.ts
```

### 4.2 期待される結果

```
✅ テーブル properties が存在します
✅ properties に必要なカラムがすべて存在します
✅ テーブル valuations が存在します
✅ valuations に必要なカラムがすべて存在します
```

---

## ステップ5: それでも解決しない場合

### 5.1 環境変数の確認

`.env`ファイルで正しいデータベースに接続しているか確認:

```bash
# backend/.env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
DATABASE_URL=postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres
```

### 5.2 直接PostgreSQL接続での確認

以下のスクリプトを作成して実行:

```typescript
// backend/migrations/verify-081-direct-pg.ts
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

async function verifyDirect() {
  const client = await pool.connect();
  
  try {
    // propertiesのカラム確認
    const propsResult = await client.query(`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'properties'
      ORDER BY ordinal_position
    `);
    
    console.log('Properties columns:', propsResult.rows.map(r => r.column_name));
    
    // valuationsのカラム確認
    const valsResult = await client.query(`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'valuations'
      ORDER BY ordinal_position
    `);
    
    console.log('Valuations columns:', valsResult.rows.map(r => r.column_name));
    
  } finally {
    client.release();
    await pool.end();
  }
}

verifyDirect().catch(console.error);
```

実行:
```bash
npx ts-node backend/migrations/verify-081-direct-pg.ts
```

---

## 🎯 まとめ

1. **ステップ1**: PostgreSQL直接確認でカラムの存在を確認
2. **ステップ2**: カラムがなければ補完スクリプトを実行
3. **ステップ3**: PostgreSTキャッシュを強制リロード
4. **ステップ4**: 検証スクリプトで確認
5. **ステップ5**: それでもダメなら環境変数と直接接続を確認

---

## 📞 次のアクション

**今すぐ実行してください:**

1. Supabaseダッシュボードを開く
2. SQL Editorでステップ1.1のSQLを実行
3. 結果を報告してください

結果に応じて、次の手順をご案内します。
