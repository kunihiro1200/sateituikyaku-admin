# Migration 081 - スキーマキャッシュ更新

## ✅ 診断結果

valuationsテーブルの全カラムがデータベースに存在することを確認しました。

**問題**: PostgRESTのスキーマキャッシュが古いため、アプリケーションから新しいカラムが見えていません。

---

## 🎯 解決方法: スキーマキャッシュの更新

以下の方法を**順番に**試してください。

### 方法1: NOTIFY コマンド（最も簡単）

1. **Supabaseダッシュボード**を開く
2. **SQL Editor**に移動
3. 新しいクエリを作成
4. 以下のSQLを実行:

```sql
NOTIFY pgrst, 'reload schema';
```

5. **数秒待つ**（5-10秒）
6. 検証スクリプトを実行:

```bash
npx ts-node backend/migrations/verify-081-migration.ts
```

**✅ 成功した場合**: すべてのチェックが通ります
**❌ まだエラーが出る場合**: 方法2へ

---

### 方法2: プロジェクトの一時停止・再開（最も確実）

1. **Supabaseダッシュボード** → **Settings** → **General**
2. **Pause project**をクリック
3. プロジェクトが完全に停止するまで待つ（1-2分）
4. **Resume project**をクリック
5. プロジェクトが完全に起動するまで待つ（2-3分）
6. 検証スクリプトを実行:

```bash
npx ts-node backend/migrations/verify-081-migration.ts
```

---

### 方法3: PostgRESTの再起動

1. **Supabaseダッシュボード** → **Settings** → **API**
2. **Restart PostgREST**をクリック
3. 再起動が完了するまで待つ（30秒-1分）
4. 検証スクリプトを実行:

```bash
npx ts-node backend/migrations/verify-081-migration.ts
```

---

## 📊 期待される結果

検証スクリプトが成功すると、以下のように表示されます:

```
✅ テーブル properties が存在します
✅ properties に必要なカラムがすべて存在します
✅ テーブル valuations が存在します
✅ valuations に必要なカラムがすべて存在します

Migration 081 verification completed successfully!
```

---

## 🔍 トラブルシューティング

### それでも解決しない場合

環境変数が正しいデータベースを指しているか確認:

```bash
# backend/.env を確認
SUPABASE_URL=https://your-project.supabase.co
DATABASE_URL=postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres
```

---

## 📞 次のアクション

**今すぐ実行してください:**

1. 方法1のNOTIFYコマンドを実行
2. 5-10秒待つ
3. 検証スクリプトを実行
4. 結果を報告してください

成功すれば、Phase 2の実装に進めます！
