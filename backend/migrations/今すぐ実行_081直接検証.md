# ğŸ¯ Migration 081 - ç›´æ¥PostgreSQLæ¤œè¨¼ï¼ˆæ¨å¥¨ï¼‰

**æœ€çµ‚æ›´æ–°**: 2025-01-08  
**æ‰€è¦æ™‚é–“**: 2åˆ†

---

## ğŸš€ ãªãœã“ã®æ–¹æ³•ãŒæ¨å¥¨ã•ã‚Œã‚‹ã®ã‹ï¼Ÿ

å¾“æ¥ã®æ¤œè¨¼æ–¹æ³•ï¼ˆREST APIçµŒç”±ï¼‰ã§ã¯ã€PostgRESTã®ã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„ã¨ã€å®Ÿéš›ã«ã¯ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¦ã„ã¦ã‚‚ã€Œå­˜åœ¨ã—ãªã„ã€ã¨èª¤ã£ã¦å ±å‘Šã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚

**ã“ã®æ–°ã—ã„æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯**:
- âœ… PostgreSQLã«ç›´æ¥æ¥ç¶š
- âœ… PostgRESTã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ãƒã‚¤ãƒ‘ã‚¹
- âœ… æ­£ç¢ºãªè¨ºæ–­çµæœã‚’å³åº§ã«å–å¾—
- âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ˜ç¢ºã«æç¤º

---

## ğŸ“‹ å‰ææ¡ä»¶

### å¿…é ˆ
- `backend/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã« `DATABASE_URL` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

### DATABASE_URL ã®å–å¾—æ–¹æ³•

1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
2. **Project Settings** â†’ **Database** ã«ç§»å‹•
3. **Connection string** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
4. **URI** ã‚¿ãƒ–ã‚’é¸æŠ
5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šæ–‡å­—åˆ—ã‚’è¡¨ç¤º
6. æ¥ç¶šæ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒ¼

### .env ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½åŠ 

`backend/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã‚’è¿½åŠ :

```env
DATABASE_URL=postgresql://postgres.[your-project-ref]:[your-password]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres
```

---

## ğŸ¯ å®Ÿè¡Œæ‰‹é †ï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•

```bash
cd backend
```

### ã‚¹ãƒ†ãƒƒãƒ—2: æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

```bash
npx ts-node migrations/verify-081-direct-pg.ts
```

### ã‚¹ãƒ†ãƒƒãƒ—3: çµæœã‚’ç¢ºèª

---

## âœ… æˆåŠŸã—ãŸå ´åˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
ğŸ”Œ PostgreSQLã«ç›´æ¥æ¥ç¶šä¸­...

âœ… æ¥ç¶šæˆåŠŸ

ğŸ“‹ properties ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªä¸­...
âœ… properties ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ (18 ã‚«ãƒ©ãƒ )

âœ… properties ã®å…¨ã¦ã®æœŸå¾…ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¾ã™

ã‚«ãƒ©ãƒ ä¸€è¦§:
   id                                  uuid                 NOT NULL
   seller_id                           uuid                 NOT NULL
   property_type                       character varying    NOT NULL
   land_area                           numeric              NULL
   building_area                       numeric              NULL
   ...

ğŸ“‹ valuations ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªä¸­...
âœ… valuations ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ (13 ã‚«ãƒ©ãƒ )

âœ… valuations ã®å…¨ã¦ã®æœŸå¾…ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¾ã™

ã‚«ãƒ©ãƒ ä¸€è¦§:
   id                                  uuid                 NOT NULL
   property_id                         uuid                 NOT NULL
   valuation_type                      character varying    NOT NULL
   ...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… å…¨ã¦ã®æ¤œè¨¼ã«åˆæ ¼ã—ã¾ã—ãŸï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:

1. PostgRESTã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
   æ–¹æ³•: Supabase SQL Editor ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ
   ```sql
   NOTIFY pgrst, 'reload schema';
   ```

2. REST APIçµŒç”±ã§ã®æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   ```bash
   npx ts-node migrations/verify-081-migration.ts
   ```

3. Phase 2ã®å®Ÿè£…ã‚’é–‹å§‹
   - TypeScriptå‹å®šç¾©ã®è¿½åŠ 
   - PropertyService ã®å®Ÿè£…
   - ValuationEngine ã®å®Ÿè£…
```

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **PostgRESTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°**
   - Supabase SQL Editorã§ `NOTIFY pgrst, 'reload schema';` ã‚’å®Ÿè¡Œ
   - 10ç§’å¾…ã¤

2. **Phase 2å®Ÿè£…ã‚’é–‹å§‹**
   - `.kiro/specs/seller-list-management/PHASE_2_REQUIREMENTS.md` ã‚’ç¢ºèª
   - TypeScriptå‹å®šç¾©ã‚’è¿½åŠ 
   - ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ã‚’é–‹å§‹

---

## âŒ ã‚«ãƒ©ãƒ ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
âŒ properties ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸è¶³ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ :
   - land_area_verified
   - building_area_verified
   - property_address_ieul_apartment

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
1. backend/migrations/081_è£œå®Œ_add_missing_columns.sql ã‚’å®Ÿè¡Œ
2. ã¾ãŸã¯ Supabase SQL Editor ã§ç›´æ¥å®Ÿè¡Œ
```

### è§£æ±ºæ–¹æ³•

1. **Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã**
2. **SQL Editor** ã«ç§»å‹•
3. **æ–°ã—ã„ã‚¯ã‚¨ãƒªã‚’ä½œæˆ**
4. `backend/migrations/081_è£œå®Œ_add_missing_columns.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ
5. **Run** ã‚’ã‚¯ãƒªãƒƒã‚¯
6. å†åº¦æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

---

## âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
âŒ properties ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
1. backend/migrations/081_create_properties_and_valuations.sql ã‚’å®Ÿè¡Œ
2. ã¾ãŸã¯ backend/migrations/run-081-migration.ts ã‚’å®Ÿè¡Œ
```

### è§£æ±ºæ–¹æ³•

#### æ–¹æ³•1: SQL Editorã§ç›´æ¥å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

1. **Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã**
2. **SQL Editor** ã«ç§»å‹•
3. **æ–°ã—ã„ã‚¯ã‚¨ãƒªã‚’ä½œæˆ**
4. `backend/migrations/081_create_properties_and_valuations.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ
5. **Run** ã‚’ã‚¯ãƒªãƒƒã‚¯
6. å†åº¦æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

#### æ–¹æ³•2: TypeScriptã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å®Ÿè¡Œ

```bash
cd backend
npx ts-node migrations/run-081-migration.ts
```

---

## âŒ DATABASE_URL ã‚¨ãƒ©ãƒ¼

ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
âŒ ã‚¨ãƒ©ãƒ¼: DATABASE_URL ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“

è§£æ±ºæ–¹æ³•:
1. backend/.env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
2. DATABASE_URL=postgresql://... ã®è¡Œã‚’è¿½åŠ 
3. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Project Settings â†’ Database â†’ Connection string ã‹ã‚‰å–å¾—
```

### è§£æ±ºæ–¹æ³•

1. **Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã**
2. **Project Settings** â†’ **Database** ã«ç§»å‹•
3. **Connection string** ã® **URI** ã‚’ã‚³ãƒ”ãƒ¼
4. `backend/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ :

```env
DATABASE_URL=postgresql://postgres.[your-project-ref]:[your-password]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres
```

5. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’å†èµ·å‹•ï¼ˆç’°å¢ƒå¤‰æ•°ã‚’å†èª­ã¿è¾¼ã¿ï¼‰
6. å†åº¦æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

---

## ğŸ”„ å¾“æ¥ã®æ¤œè¨¼æ–¹æ³•ã¨ã®æ¯”è¼ƒ

| é …ç›® | ç›´æ¥PostgreSQLæ¤œè¨¼ | REST APIæ¤œè¨¼ |
|------|-------------------|--------------|
| **æ­£ç¢ºæ€§** | âœ… å¸¸ã«æ­£ç¢º | âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å½±éŸ¿ã‚’å—ã‘ã‚‹ |
| **é€Ÿåº¦** | âœ… é«˜é€Ÿ | âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°å¾…ã¡ãŒå¿…è¦ |
| **ä¾å­˜é–¢ä¿‚** | DATABASE_URL ã®ã¿ | PostgRESTã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹ |
| **æ¨å¥¨åº¦** | â­â­â­â­â­ | â­â­â­ |

---

## ğŸ“ ã‚ˆãã‚ã‚‹è³ªå•

### Q: DATABASE_URL ã¯ã©ã“ã§å–å¾—ã§ãã¾ã™ã‹ï¼Ÿ
A: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Project Settings â†’ Database â†’ Connection string (URI)

### Q: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚Œã¾ã—ãŸ
A: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Project Settings â†’ Database â†’ Reset database password

### Q: æ¤œè¨¼ã«æˆåŠŸã—ãŸã‚‰æ¬¡ã¯ä½•ã‚’ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ
A: PostgRESTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ã€Phase 2ã®å®Ÿè£…ã‚’é–‹å§‹ã—ã¦ãã ã•ã„

### Q: REST APIæ¤œè¨¼ã‚‚å¿…è¦ã§ã™ã‹ï¼Ÿ
A: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚ç›´æ¥PostgreSQLæ¤œè¨¼ã§æˆåŠŸã™ã‚Œã°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°å¾Œã«REST APIã‚‚å‹•ä½œã—ã¾ã™

---

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `backend/migrations/verify-081-direct-pg.ts`
- **è£œå®Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `backend/migrations/081_è£œå®Œ_add_missing_columns.sql`
- **å…ƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `backend/migrations/081_create_properties_and_valuations.sql`
- **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰**: `backend/migrations/ä»Šã™ãèª­ã‚“ã§ãã ã•ã„_081è£œå®Œ_æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—.md`
- **Spec**: `.kiro/specs/migration-081-completion/requirements.md`

---

**ä»Šã™ãå®Ÿè¡Œ**: `npx ts-node migrations/verify-081-direct-pg.ts`
