# 🚀 Migration 081 補完スクリプト - 今すぐ実行

## 📋 概要

Migration 081の検証結果により、**propertiesテーブルとvaluationsテーブルに不足しているカラム**が見つかりました。この補完スクリプトを実行して、不足しているカラムを追加します。

## ❌ 現在の問題

### Propertiesテーブルに不足しているカラム（9個）
1. `construction_year` - 築年
2. `property_address` - 物件所在地
3. `property_address_ieul_apartment` - イエウール・マンション専用住所
4. `current_status` - 現況
5. `fixed_asset_tax_road_price` - 固定資産税路線価
6. `updated_at` - 更新日時
7. `created_by` - 作成者
8. `updated_by` - 更新者
9. `version` - バージョン（楽観的ロック用）

### Valuationsテーブルに不足しているカラム（12個）
1. `property_id` - 物件ID（外部キー）
2. `valuation_type` - 査定タイプ
3. `valuation_amount_1` - 査定額1
4. `valuation_amount_2` - 査定額2
5. `valuation_amount_3` - 査定額3
6. `calculation_method` - 計算方法
7. `calculation_parameters` - 計算パラメータ
8. `valuation_report_url` - 査定書URL
9. `valuation_date` - 査定日時
10. `created_by` - 作成者
11. `notes` - 備考
12. `created_at` - 作成日時

## ✅ 解決方法

補完スクリプト `081_補完_add_missing_columns.sql` を実行して、不足しているカラムを追加します。

## 🎯 実行手順（3ステップ）

### ステップ1: Supabase Dashboardにログイン

1. ブラウザで Supabase Dashboard を開く
2. プロジェクトを選択
3. 左サイドバーから **SQL Editor** をクリック

### ステップ2: 補完スクリプトを実行

1. **New query** ボタンをクリック
2. 以下のファイルの内容をコピー:
   ```
   backend/migrations/081_補完_add_missing_columns.sql
   ```
3. SQL Editorにペースト
4. **Run** ボタンをクリック

### ステップ3: 実行結果を確認

実行が成功すると、以下のようなメッセージが表示されます:

```
NOTICE: Added construction_year column to properties table
NOTICE: Added property_address column to properties table
NOTICE: Added property_address_ieul_apartment column to properties table
NOTICE: Added current_status column to properties table
NOTICE: Added fixed_asset_tax_road_price column to properties table
NOTICE: Added updated_at column to properties table
NOTICE: Added created_by column to properties table
NOTICE: Added updated_by column to properties table
NOTICE: Added version column to properties table
NOTICE: Added property_id column to valuations table
NOTICE: Added valuation_type column to valuations table
NOTICE: Added valuation_amount_1 column to valuations table
NOTICE: Added valuation_amount_2 column to valuations table
NOTICE: Added valuation_amount_3 column to valuations table
NOTICE: Added calculation_method column to valuations table
NOTICE: Added calculation_parameters column to valuations table
NOTICE: Added valuation_report_url column to valuations table
NOTICE: Added valuation_date column to valuations table
NOTICE: Added created_by column to valuations table
NOTICE: Added notes column to valuations table
NOTICE: Added created_at column to valuations table
NOTICE: Added check_valuation_order constraint to valuations table
NOTICE: ================================================
NOTICE: 補完スクリプト実行完了
NOTICE: ================================================
NOTICE: Properties テーブル: 19 カラム
NOTICE: Valuations テーブル: 13 カラム
NOTICE: 
NOTICE: 次のステップ:
NOTICE: 1. 検証スクリプトを実行: cd backend && npx ts-node migrations/verify-081-migration.ts
NOTICE: 2. 全てのカラムが正しく作成されたことを確認
NOTICE: ================================================
```

## 🔍 検証手順

補完スクリプト実行後、検証スクリプトを実行して全てのカラムが正しく作成されたことを確認します。

```bash
cd backend
npx ts-node migrations/verify-081-migration.ts
```

### 期待される結果

```
🔍 Migration 081の検証: PropertiesとValuationsテーブル
================================================

📋 propertiesテーブルを確認中...
✅ テーブル properties が存在します
✅ properties の全ての期待されるカラムが存在します
✅ properties のインデックス確認をスキップしました（手動確認を推奨）
✅ properties の制約確認をスキップしました（手動確認を推奨）

📋 valuationsテーブルを確認中...
✅ テーブル valuations が存在します
✅ valuations の全ての期待されるカラムが存在します
✅ valuations のインデックス確認をスキップしました（手動確認を推奨）
✅ valuations の制約確認をスキップしました（手動確認を推奨）

================================================
📊 検証結果:

✅ テーブル properties が存在します
✅ properties の全ての期待されるカラムが存在します
✅ properties のインデックス確認をスキップしました（手動確認を推奨）
✅ properties の制約確認をスキップしました（手動確認を推奨）
✅ テーブル valuations が存在します
✅ valuations の全ての期待されるカラムが存在します
✅ valuations のインデックス確認をスキップしました（手動確認を推奨）
✅ valuations の制約確認をスキップしました（手動確認を推奨）

================================================
✅ 全ての検証に合格しました！

🎯 Migration 081は完了し、検証されました。

📋 次のステップ:
   1. TypeScript型定義を更新
   2. PropertyServiceを実装
   3. ValuationEngineを実装
   4. ValuationServiceを実装
```

## ⚠️ トラブルシューティング

### エラー: "column already exists"

**原因**: カラムが既に存在している

**対処法**: 
- これは正常な動作です
- スクリプトは既存のカラムをスキップします
- 検証スクリプトを実行して確認してください

### エラー: "relation does not exist"

**原因**: propertiesまたはvaluationsテーブルが存在しない

**対処法**:
1. Migration 081が実行されているか確認
2. Supabase Dashboard > SQL Editor で以下を実行:
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN ('properties', 'valuations');
   ```
3. テーブルが存在しない場合は、Migration 081を先に実行

### エラー: "foreign key constraint"

**原因**: 外部キー参照先のテーブルが存在しない

**対処法**:
1. employeesテーブルが存在するか確認
2. sellersテーブルが存在するか確認
3. Phase 1のマイグレーションが完了しているか確認

## 📝 補完スクリプトの内容

補完スクリプトは以下の処理を実行します:

1. **Propertiesテーブル**
   - 不足している9個のカラムを追加
   - インデックスを作成
   - トリガーを設定（updated_atの自動更新）

2. **Valuationsテーブル**
   - 不足している12個のカラムを追加
   - インデックスを作成
   - CHECK制約を追加（査定額の昇順検証）

3. **安全性**
   - 既存のカラムは変更しない
   - 既存のデータは保持される
   - 冪等性を保証（何度実行しても安全）

## 🎯 次のステップ

補完スクリプト実行後:

1. ✅ 検証スクリプトを実行
2. ✅ 全てのカラムが正しく作成されたことを確認
3. ✅ Phase 2の実装を開始:
   - TypeScript型定義を更新
   - PropertyServiceを実装
   - ValuationEngineを実装
   - ValuationServiceを実装
   - APIエンドポイントを実装
   - フロントエンドを実装

## 📚 関連ドキュメント

- `.kiro/specs/seller-list-management/PHASE_2_REQUIREMENTS.md` - Phase 2要件定義
- `.kiro/specs/seller-list-management/PHASE_2_DESIGN.md` - Phase 2設計書
- `.kiro/specs/seller-list-management/PHASE_2_TASKS.md` - Phase 2タスクリスト
- `backend/migrations/081_create_properties_and_valuations.sql` - 元のマイグレーション
- `backend/migrations/verify-081-migration.ts` - 検証スクリプト

## ✅ 完了チェックリスト

- [ ] Supabase Dashboardにログイン
- [ ] SQL Editorを開く
- [ ] 補完スクリプトをコピー&ペースト
- [ ] Runボタンをクリック
- [ ] 実行結果を確認（NOTICEメッセージ）
- [ ] 検証スクリプトを実行
- [ ] 全ての検証に合格
- [ ] Phase 2の実装を開始

---

**重要**: このスクリプトは冪等性を保証しているため、何度実行しても安全です。既存のカラムやデータは変更されません。
