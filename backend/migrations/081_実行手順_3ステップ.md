# 📋 Migration 081 実行手順（推奨3ステップ）

## 🎯 目的
Phase 2のpropertiesとvaluationsテーブルを作成します。

## 📋 推奨実行手順

### ステップ1: 現状を診断 🔍

まず、現在のデータベース状態を確認します：

```bash
cd backend
npx ts-node migrations/verify-081-migration.ts
```

**診断内容**:
- ✅ テーブル存在確認（properties, valuations）
- ✅ カラム確認（Supabase REST API使用）
- ℹ️ インデックス確認（スキップ - 手動確認推奨）
- ℹ️ 制約確認（スキップ - 手動確認推奨）

**注意**: インデックスと制約の確認はスキップされます（PostgreSQL直接アクセスが必要なため）。これは正常な動作です。

**診断結果に応じて次のステップを選択：**

#### ✅ 診断が成功した場合
→ マイグレーションは既に完了しています。Phase 2の実装に進めます。

#### ❌ 診断が失敗した場合
→ ステップ2に進んでください。

---

### ステップ2: 修正版マイグレーションを実行 🚀

診断で問題が見つかった場合、修正版SQLを実行します：

```bash
npx ts-node migrations/run-081-migration-fixed.ts
```

⚠️ **注意**: このスクリプトは既存のpropertiesとvaluationsテーブルを削除してから再作成します。

---

### ステップ3: 再度検証 ✅

```bash
npx ts-node migrations/verify-081-migration.ts
```

## ✅ 成功の確認

以下のメッセージが表示されれば成功：

```
✅ All verifications passed!
🎯 Migration 081 is complete and verified.

📋 Next steps:
   1. Update TypeScript types
   2. Implement PropertyService
   3. Implement ValuationEngine
   4. Implement ValuationService
```

## 🔧 代替方法: Supabaseダッシュボードから実行

スクリプトが動作しない場合は、手動で実行できます：

### 手順:

1. https://supabase.com/dashboard を開く
2. SQL Editorを選択
3. `backend/migrations/081_create_properties_and_valuations_fixed.sql` の内容をコピー
4. 貼り付けて「Run」をクリック
5. ステップ3の検証を実行

## ❌ トラブルシューティング

### エラー: "Missing required environment variables"

→ `.env`ファイルに以下が設定されているか確認：
```bash
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### エラー: "construction_year column was not created"

→ これは `CREATE TABLE IF NOT EXISTS` の既知の問題です。
   修正版スクリプト（ステップ2）を実行してください。

### エラー: "exec_sql RPC function does not exist"

→ Supabaseダッシュボードから直接SQLを実行してください（代替方法を参照）。

## 📚 関連ドキュメント

- **詳細ガイド**: `今すぐ実行_081マイグレーション_完全修正版.md`
- **クイックフィックス**: `081_QUICK_FIX.md`
- **診断ガイド**: `今すぐ実行_081診断.md`

## 🎯 次のステップ

マイグレーション成功後：

1. TypeScript型定義の更新
2. PropertyServiceの実装
3. ValuationEngineの実装
4. ValuationServiceの実装

詳細は `.kiro/specs/seller-list-management/PHASE_2_TASKS.md` を参照。

---

**Phase 2 Step 1 の一部です**
