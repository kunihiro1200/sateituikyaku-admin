# 🔧 Migration 081 完全修正版 - 実行ガイド

## ⚠️ 問題の原因

`construction_year`カラムのエラーが繰り返し発生する原因:

1. **既存テーブルとの競合**: `CREATE TABLE IF NOT EXISTS`を使用しているため、既存のpropertiesテーブルがある場合、新しいカラムが追加されない
2. **トランザクションのロールバック**: マイグレーション途中でエラーが発生すると、全体がロールバックされる
3. **スキーマの不整合**: 以前の失敗したマイグレーションの残骸が残っている可能性

## 📋 解決策: 3つのステップ

### ステップ1: 現状診断（推奨）

まず、現在の状態を確認します:

```bash
cd backend/migrations
npx ts-node diagnose-081-issue.ts
```

これにより以下が確認できます:
- ✅ propertiesテーブルの存在
- ✅ construction_yearカラムの存在
- ✅ valuationsテーブルの存在

### ステップ2: Supabaseダッシュボードで修正版を実行

1. **Supabase Dashboard**を開く
   - https://supabase.com/dashboard/project/YOUR_PROJECT_ID

2. **SQL Editor**に移動

3. **修正版SQLを実行**
   - ファイル: `backend/migrations/081_create_properties_and_valuations_fixed.sql`
   - このファイルの内容を全てコピー
   - SQL Editorに貼り付け
   - 「Run」をクリック

### ステップ3: 検証

実行後、以下のメッセージが表示されることを確認:

```
✅ Phase 2 マイグレーション完了
  - properties table: OK (18 columns)
  - construction_year column: OK
  - valuations table: OK
```

## 🔍 修正版の違い

### 元のバージョン:
```sql
CREATE TABLE IF NOT EXISTS properties (
  ...
  construction_year INTEGER,
  ...
);
```

### 修正版:
```sql
-- 既存テーブルを完全に削除
DROP TABLE IF EXISTS valuations CASCADE;
DROP TABLE IF EXISTS properties CASCADE;

-- 新しいテーブルを作成
CREATE TABLE properties (
  ...
  construction_year INTEGER,
  ...
);
```

## ⚠️ 注意事項

### データの削除について
- `DROP TABLE`を使用するため、**既存のpropertiesとvaluationsテーブルのデータは削除されます**
- Phase 2の実装開始段階なので、まだ本番データは存在しないはずです
- もし既存データがある場合は、事前にバックアップを取ってください

### バックアップ方法（必要な場合）
```sql
-- バックアップテーブルを作成
CREATE TABLE properties_backup AS SELECT * FROM properties;
CREATE TABLE valuations_backup AS SELECT * FROM valuations;
```

## 🎯 実行後の確認

### 1. テーブル構造の確認
```sql
-- propertiesテーブルのカラム一覧
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'properties'
ORDER BY ordinal_position;
```

### 2. construction_yearカラムの確認
```sql
-- construction_yearカラムが存在することを確認
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'properties'
AND column_name = 'construction_year';
```

期待される結果:
```
column_name      | data_type
-----------------+-----------
construction_year| integer
```

## 🚀 次のステップ

マイグレーション成功後:

1. ✅ Phase 2 Step 1完了
2. 次は**Phase 2 Step 2**: TypeScript型定義の作成
3. その後**Phase 2 Step 3**: サービス層の実装

## 💡 トラブルシューティング

### エラー: "permission denied"
→ SUPABASE_SERVICE_ROLE_KEYを使用していることを確認

### エラー: "relation does not exist"
→ sellersテーブルが存在することを確認（Phase 1で作成済みのはず）

### エラーが続く場合
1. Supabaseプロジェクトを一時停止して再起動
2. PostgRESTのスキーマキャッシュをリロード
3. サポートに問い合わせ

## 📞 サポート

問題が解決しない場合は、以下の情報を提供してください:
- エラーメッセージの全文
- `diagnose-081-issue.ts`の実行結果
- Supabaseプロジェクトのログ
