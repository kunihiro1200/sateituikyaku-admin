# ğŸš€ ä»Šã™ãå®Ÿè¡Œ: Migration 081ï¼ˆä¿®æ­£ç‰ˆï¼‰

## âš ï¸ é‡è¦ãªä¿®æ­£å†…å®¹

### ä¿®æ­£1: construction_year ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- **å•é¡Œ**: `ERROR: 42703: column "construction_year" does not exist`
- **åŸå› **: `update_updated_at_column()`é–¢æ•°ãŒå­˜åœ¨ã—ãªã„
- **ä¿®æ­£**: é–¢æ•°ã‚’æ˜ç¤ºçš„ã«ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 

### ä¿®æ­£2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é‡è¤‡ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- **å•é¡Œ**: `idx_properties_seller_id` ãŒæ—¢ã«å­˜åœ¨
- **ä¿®æ­£**: ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã« `IF NOT EXISTS` ã‚’è¿½åŠ 

## ğŸ“‹ å®Ÿè¡Œæ‰‹é †ï¼ˆSupabase Dashboardï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰

å‰å›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€”ä¸­ã§å¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã€ã¾ãšæ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ï¼š

```sql
-- Supabase Dashboard ã® SQL Editor ã§å®Ÿè¡Œ
DROP TABLE IF EXISTS valuations CASCADE;
DROP TABLE IF EXISTS properties CASCADE;
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ä¿®æ­£ç‰ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

1. **Supabase Dashboard ã«ãƒ­ã‚°ã‚¤ãƒ³**
   - https://app.supabase.com/
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ

2. **SQL Editor ã‚’é–‹ã**
   - å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒSQL Editorã€ã‚’é¸æŠ
   - ã€ŒNew queryã€ã‚’ã‚¯ãƒªãƒƒã‚¯

3. **SQLãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼**
   - `backend/migrations/081_create_properties_and_valuations.sql` ã‚’é–‹ã
   - å…¨å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼

4. **SQL Editor ã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œ**
   - ã‚³ãƒ”ãƒ¼ã—ãŸå†…å®¹ã‚’è²¼ã‚Šä»˜ã‘
   - ã€ŒRunã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—3: æˆåŠŸç¢ºèª

ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ï¼š

```
NOTICE: Phase 2 tables created successfully
NOTICE:   - properties table: OK
NOTICE:   - construction_year column: OK
NOTICE:   - valuations table: OK
```

### ã‚¹ãƒ†ãƒƒãƒ—4: æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã§ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã§ãã¾ã™ï¼š

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('properties', 'valuations');

-- properties ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ä¸€è¦§
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name = 'properties'
ORDER BY ordinal_position;

-- construction_year ã‚«ãƒ©ãƒ ã®ç¢ºèª
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name = 'properties' 
AND column_name = 'construction_year';

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§
SELECT indexname, indexdef
FROM pg_indexes 
WHERE tablename IN ('properties', 'valuations')
ORDER BY tablename, indexname;
```

## âœ… æœŸå¾…ã•ã‚Œã‚‹çµæœ

### ãƒ†ãƒ¼ãƒ–ãƒ«
- âœ… `properties` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹
- âœ… `valuations` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹

### ã‚«ãƒ©ãƒ ï¼ˆpropertiesï¼‰
- âœ… `id` (UUID)
- âœ… `seller_id` (UUID, å¤–éƒ¨ã‚­ãƒ¼)
- âœ… `property_type` (VARCHAR)
- âœ… `construction_year` (INTEGER) â† **ã“ã‚ŒãŒé‡è¦ï¼**
- âœ… ãã®ä»–ã®ã‚«ãƒ©ãƒ 

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆpropertiesï¼‰
- âœ… `idx_properties_seller_id`
- âœ… `idx_properties_property_type`
- âœ… `idx_properties_created_at`
- âœ… `idx_properties_construction_year` â† **ã“ã‚ŒãŒé‡è¦ï¼**
- âœ… `idx_properties_current_status`

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆvaluationsï¼‰
- âœ… `idx_valuations_property_id`
- âœ… `idx_valuations_valuation_date`
- âœ… `idx_valuations_valuation_type`
- âœ… `idx_valuations_created_by`

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ

1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼**
2. **ã©ã®è¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ç¢ºèª**
3. **ä»¥ä¸‹ã®æƒ…å ±ã‚’ç¢ºèª:**
   - `sellers` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ
   - `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

#### "relation sellers does not exist"
â†’ Phase 1ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„

#### "relation employees does not exist"
â†’ å¾“æ¥­å“¡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„

#### ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œ

## ğŸ“ ä¿®æ­£ã®è©³ç´°

### è¿½åŠ ã•ã‚ŒãŸé–¢æ•°

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

ã“ã®é–¢æ•°ã«ã‚ˆã‚Šã€`updated_at`ã‚«ãƒ©ãƒ ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚

### æ”¹å–„ã•ã‚ŒãŸæ¤œè¨¼ã‚¯ã‚¨ãƒª

```sql
-- construction_year ã‚«ãƒ©ãƒ ã®å­˜åœ¨ç¢ºèªã‚’è¿½åŠ 
SELECT EXISTS (
  SELECT 1 FROM information_schema.columns 
  WHERE table_schema = 'public' 
  AND table_name = 'properties' 
  AND column_name = 'construction_year'
) INTO v_construction_year_exists;
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚«ãƒ©ãƒ ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ãŸã‚‰ï¼š

1. âœ… TypeScriptå‹å®šç¾©ã®ç¢ºèª
2. â³ PropertyServiceã®å®Ÿè£…
3. â³ ValuationEngineã®å®Ÿè£…
4. â³ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

---

**ä½œæˆæ—¥**: 2025-01-08  
**ä¿®æ­£ç†ç”±**: construction_year ã‚¨ãƒ©ãƒ¼ã®è§£æ±º  
**Phase**: 2 - Properties & Valuations
