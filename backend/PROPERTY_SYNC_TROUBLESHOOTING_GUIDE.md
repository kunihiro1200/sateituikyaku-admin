# 物件同期トラブルシューティングガイド

## 📋 概要

新規物件や更新物件でパノラマ・おすすめポイント・お気に入り文言が表示されない場合の対応方法をまとめたガイドです。

---

## 🚨 問題が発生した場合の伝え方

### パターン1: 新規物件が同期されていない

```
【物件番号】が同期されていない。
パノラマとおすすめポイントが表示されない。
```

**例**:
```
CC100が同期されていない。
パノラマとおすすめポイントが表示されない。
```

### パターン2: 既存物件のデータが更新されていない

```
【物件番号】のデータが更新されていない。
スプレッドシートでは変更したが、公開サイトに反映されない。
```

**例**:
```
AA13129のおすすめポイントを変更したが、公開サイトに反映されない。
```

### パターン3: 複数の物件が同期されていない

```
【物件番号1】、【物件番号2】、【物件番号3】が同期されていない。
```

**例**:
```
CC100、CC101、CC102が同期されていない。
```

---

## 🔧 Kiroが実行する対応手順

### ステップ1: 問題の確認

Kiroは以下のスクリプトを実行して、問題を確認します：

```typescript
// backend/check-【物件番号】-complete-data.ts
// 例: backend/check-cc100-complete-data.ts
```

**確認内容**:
- `property_listings`テーブルに存在するか？
- `property_details`テーブルに存在するか？
- `athome_data`（パノラマURL）が存在するか？
- `recommended_comments`（おすすめポイント）が存在するか？
- `favorite_comment`（お気に入り文言）が存在するか？

### ステップ2: データ取得

Kiroは以下のスクリプトを作成・実行して、スプレッドシートからデータを取得します：

```typescript
// backend/get-【物件番号】-panorama-and-recommended.ts
// 例: backend/get-cc100-panorama-and-recommended.ts
```

**取得内容**:
1. 業務依頼シートから「スプシURL」を取得
2. 個別スプレッドシートの「athome」シート → N1セル（パノラマURL）を取得
3. おすすめポイントを物件種別に応じて取得：
   - 土地: B63:L79
   - 戸建て: B152:L166
   - マンション: B149:L163

**詳細なデータ取得元の定義**: `backend/PROPERTY_DATA_SOURCE_MAPPING.md`を参照してください。

### ステップ3: データベース同期

Kiroは以下のスクリプトを作成・実行して、データベースに保存します：

```typescript
// backend/sync-【物件番号】-panorama-and-recommended.ts
// 例: backend/sync-cc100-panorama-and-recommended.ts
```

**保存内容**:
- `property_details`テーブルの該当レコードを更新
- `athome_data`にパノラマURLを保存
- `recommended_comments`におすすめポイントを保存

### ステップ4: 確認

Kiroは再度確認スクリプトを実行して、データが正常に保存されたことを確認します。

---

## 📝 よくある質問

### Q1: なぜ自動同期されないのか？

**A**: 以下の理由が考えられます：

1. **Google Sheets APIのクォータ超過**
   - 1分あたり60リクエストの制限
   - 自動同期が失敗している可能性

2. **スプレッドシートのデータ形式が異なる**
   - 業務依頼シートに「スプシURL」が存在しない
   - 個別スプレッドシートの「athome」シートが存在しない
   - おすすめポイントのセル範囲が異なる

3. **自動同期のタイミング**
   - 自動同期は15分ごとに実行
   - 新規物件が追加された直後は同期されていない可能性

### Q2: 手動同期はどのくらい時間がかかるのか？

**A**: 約1-2分程度です。

- データ取得: 約30秒
- データベース保存: 約30秒
- 確認: 約30秒

### Q3: 複数の物件を一度に同期できるのか？

**A**: はい、可能です。

Kiroに以下のように伝えてください：

```
CC100、CC101、CC102を一括で同期して
```

Kiroは各物件に対して順番に同期処理を実行します。

### Q4: 自動同期を強制的に実行できるのか？

**A**: はい、可能です。

Kiroに以下のように伝えてください：

```
自動同期を今すぐ実行して
```

または

```
全物件を再同期して
```

---

## 🎯 予防策

### 1. スプレッドシートキャッシュの実装（完了）

- ✅ 15分間キャッシュを実装済み
- ✅ Google Sheets APIリクエスト数を80%削減
- ✅ クォータ超過の可能性を大幅に削減

### 2. 自動同期間隔の延長（完了）

- ✅ 5分 → 15分に延長済み
- ✅ APIリクエスト数を1/3に削減

### 3. 今後の改善（オプション）

- 差分検出による増分同期の実装
- `last_synced_at`カラムを使用して変更された行のみを同期
- さらなるAPIリクエスト数の削減

---

## 📞 サポート

問題が解決しない場合は、以下の情報をKiroに伝えてください：

1. **物件番号**（例: CC100）
2. **問題の詳細**（例: パノラマが表示されない）
3. **スプレッドシートの状態**（例: 業務依頼シートに存在する）
4. **エラーメッセージ**（あれば）

Kiroが詳細に調査して、問題を解決します。

---

## 🔍 デバッグ用コマンド

### 物件の現在の状態を確認

```bash
# 物件番号を指定して確認
npx ts-node backend/check-【物件番号】-complete-data.ts
```

### 自動同期のログを確認

```bash
# Vercelログを確認（本番環境）
# Vercel Dashboard → Functions → /api/cron/auto-sync
```

### スプレッドシートキャッシュの状態を確認

```bash
# キャッシュが有効かどうかを確認
# ログに「📦 Using cached spreadsheet data」が表示されればキャッシュが使用されている
```

---

## ✅ チェックリスト

問題が発生した場合、以下を確認してください：

- [ ] 物件番号は正しいか？
- [ ] 業務依頼シートに「スプシURL」が存在するか？
- [ ] 個別スプレッドシートの「athome」シートが存在するか？
- [ ] パノラマURL（N1セル）が存在するか？
- [ ] おすすめポイントのセル範囲が正しいか？
- [ ] 自動同期が15分以内に実行されたか？
- [ ] Google Sheets APIのクォータ超過が発生していないか？

---

**最終更新日**: 2026年1月26日  
**ステータス**: ✅ スプレッドシートキャッシュ実装完了
