<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¬é–‹ç‰©ä»¶ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºè¨ºæ–­</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    h1 {
      color: #333;
      border-bottom: 3px solid #2196F3;
      padding-bottom: 10px;
    }
    
    .input-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    button {
      background-color: #2196F3;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    
    button:hover {
      background-color: #1976D2;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .result-item {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    
    .result-header {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    .status-success {
      color: #4CAF50;
    }
    
    .status-error {
      color: #f44336;
    }
    
    .status-warning {
      color: #FF9800;
    }
    
    .detail-row {
      display: flex;
      margin: 8px 0;
      padding: 8px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    
    .detail-label {
      font-weight: bold;
      min-width: 150px;
      color: #666;
    }
    
    .detail-value {
      flex: 1;
      color: #333;
    }
    
    .comment-content {
      background-color: #FFF9E6;
      padding: 10px;
      border-left: 4px solid #FFC107;
      margin-top: 10px;
      border-radius: 4px;
    }
    
    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-left: 4px solid #f44336;
      margin-top: 10px;
      border-radius: 4px;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .summary {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid #2196F3;
    }
    
    .summary-item {
      margin: 5px 0;
    }
    
    .recommendations {
      background-color: #fff3e0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      border-left: 4px solid #FF9800;
    }
    
    .recommendations h3 {
      margin-top: 0;
      color: #E65100;
    }
    
    .recommendations ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .recommendations li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å…¬é–‹ç‰©ä»¶ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºè¨ºæ–­</h1>
  
  <div class="input-section">
    <div class="input-group">
      <label for="apiBaseUrl">API Base URL:</label>
      <input type="text" id="apiBaseUrl" value="http://localhost:3000/api/public" placeholder="http://localhost:3000/api/public">
    </div>
    
    <div class="input-group">
      <label for="propertyIds">ç‰©ä»¶IDï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯ï¼‰:</label>
      <input type="text" id="propertyIds" placeholder="uuid1, uuid2, uuid3">
    </div>
    
    <button id="diagnoseBtn" onclick="runDiagnosis()">è¨ºæ–­é–‹å§‹</button>
  </div>
  
  <div id="results"></div>
  
  <script>
    async function runDiagnosis() {
      const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
      const propertyIdsInput = document.getElementById('propertyIds').value.trim();
      const resultsDiv = document.getElementById('results');
      const diagnoseBtn = document.getElementById('diagnoseBtn');
      
      if (!propertyIdsInput) {
        alert('ç‰©ä»¶IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const propertyIds = propertyIdsInput.split(',').map(id => id.trim()).filter(id => id);
      
      if (propertyIds.length === 0) {
        alert('æœ‰åŠ¹ãªç‰©ä»¶IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      diagnoseBtn.disabled = true;
      resultsDiv.innerHTML = '<div class="loading">è¨ºæ–­ä¸­...</div>';
      
      try {
        const results = [];
        
        for (const propertyId of propertyIds) {
          const result = await diagnoseProperty(apiBaseUrl, propertyId);
          results.push(result);
        }
        
        displayResults(results);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
      } finally {
        diagnoseBtn.disabled = false;
      }
    }
    
    async function diagnoseProperty(apiBaseUrl, propertyId) {
      const result = {
        propertyId,
        favoriteComment: null,
        recommendedComment: null,
        diagnostic: null,
        errors: []
      };
      
      try {
        // è¨ºæ–­ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
        const diagnosticResponse = await fetch(`${apiBaseUrl}/properties/${propertyId}/comments-diagnostic`);
        if (diagnosticResponse.ok) {
          result.diagnostic = await diagnosticResponse.json();
        } else {
          result.errors.push(`è¨ºæ–­ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: ${diagnosticResponse.status}`);
        }
      } catch (error) {
        result.errors.push(`è¨ºæ–­ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
      
      try {
        // ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€ã‚’å–å¾—
        const favoriteResponse = await fetch(`${apiBaseUrl}/properties/${propertyId}/favorite-comment`);
        if (favoriteResponse.ok) {
          result.favoriteComment = await favoriteResponse.json();
        } else {
          result.errors.push(`ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€APIã‚¨ãƒ©ãƒ¼: ${favoriteResponse.status}`);
        }
      } catch (error) {
        result.errors.push(`ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
      
      try {
        // ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
        const recommendedResponse = await fetch(`${apiBaseUrl}/properties/${propertyId}/recommended-comment`);
        if (recommendedResponse.ok) {
          result.recommendedComment = await recommendedResponse.json();
        } else {
          result.errors.push(`ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆAPIã‚¨ãƒ©ãƒ¼: ${recommendedResponse.status}`);
        }
      } catch (error) {
        result.errors.push(`ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆAPIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
      
      return result;
    }
    
    function displayResults(results) {
      const resultsDiv = document.getElementById('results');
      
      // ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
      const summary = createSummary(results);
      
      // å„ç‰©ä»¶ã®çµæœã‚’è¡¨ç¤º
      let html = '<div class="results">';
      html += summary;
      
      results.forEach(result => {
        html += createResultHTML(result);
      });
      
      // æ¨å¥¨äº‹é …ã‚’è¿½åŠ 
      html += createRecommendations(results);
      
      html += '</div>';
      
      resultsDiv.innerHTML = html;
    }
    
    function createSummary(results) {
      const total = results.length;
      const favoriteSuccess = results.filter(r => r.favoriteComment && r.favoriteComment.comment).length;
      const recommendedSuccess = results.filter(r => r.recommendedComment && r.recommendedComment.comments && r.recommendedComment.comments.length > 0).length;
      const errors = results.filter(r => r.errors.length > 0).length;
      
      return `
        <div class="summary">
          <h3>ğŸ“Š è¨ºæ–­ã‚µãƒãƒªãƒ¼</h3>
          <div class="summary-item">ç·ç‰©ä»¶æ•°: ${total}</div>
          <div class="summary-item">ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š: ${favoriteSuccess}/${total}</div>
          <div class="summary-item">ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚ã‚Š: ${recommendedSuccess}/${total}</div>
          <div class="summary-item ${errors > 0 ? 'status-error' : 'status-success'}">ã‚¨ãƒ©ãƒ¼: ${errors}/${total}</div>
        </div>
      `;
    }
    
    function createResultHTML(result) {
      let html = '<div class="result-item">';
      html += `<div class="result-header">ç‰©ä»¶ID: ${result.propertyId}</div>`;
      
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
      if (result.errors.length > 0) {
        html += '<div class="error-message">';
        html += '<strong>âš ï¸ ã‚¨ãƒ©ãƒ¼:</strong><br>';
        result.errors.forEach(error => {
          html += `â€¢ ${error}<br>`;
        });
        html += '</div>';
      }
      
      // è¨ºæ–­æƒ…å ±
      if (result.diagnostic) {
        html += '<h4>è¨ºæ–­æƒ…å ±</h4>';
        html += `<div class="detail-row"><div class="detail-label">ç‰©ä»¶ç•ªå·:</div><div class="detail-value">${result.diagnostic.propertyNumber}</div></div>`;
        html += `<div class="detail-row"><div class="detail-label">ç‰©ä»¶ã‚¿ã‚¤ãƒ—:</div><div class="detail-value">${result.diagnostic.propertyType}</div></div>`;
        html += `<div class="detail-row"><div class="detail-label">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:</div><div class="detail-value">${result.diagnostic.spreadsheetUrl || 'ãªã—'}</div></div>`;
        html += `<div class="detail-row"><div class="detail-label">ç·ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ :</div><div class="detail-value">${result.diagnostic.totalResponseTime}ms</div></div>`;
      }
      
      // ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€
      html += '<h4>ãŠæ°—ã«å…¥ã‚Šæ–‡è¨€</h4>';
      if (result.favoriteComment) {
        const hasComment = result.favoriteComment.comment;
        html += `<div class="detail-row"><div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div><div class="detail-value ${hasComment ? 'status-success' : 'status-warning'}">${hasComment ? 'âœ… ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—'}</div></div>`;
        
        if (result.diagnostic) {
          html += `<div class="detail-row"><div class="detail-label">ã‚»ãƒ«ä½ç½®:</div><div class="detail-value">${result.diagnostic.favoriteComment.cellPosition || 'ãªã—'}</div></div>`;
          html += `<div class="detail-row"><div class="detail-label">ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ :</div><div class="detail-value">${result.diagnostic.favoriteComment.responseTime}ms</div></div>`;
        }
        
        if (hasComment) {
          html += `<div class="comment-content">"${result.favoriteComment.comment}"</div>`;
        }
      } else {
        html += '<div class="status-error">âŒ å–å¾—å¤±æ•—</div>';
      }
      
      // ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ
      html += '<h4>ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ</h4>';
      if (result.recommendedComment) {
        const hasComments = result.recommendedComment.comments && result.recommendedComment.comments.length > 0;
        html += `<div class="detail-row"><div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div><div class="detail-value ${hasComments ? 'status-success' : 'status-warning'}">${hasComments ? 'âœ… ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—'}</div></div>`;
        
        if (result.diagnostic) {
          html += `<div class="detail-row"><div class="detail-label">ã‚»ãƒ«ç¯„å›²:</div><div class="detail-value">${result.diagnostic.recommendedComment.cellRange || 'ãªã—'}</div></div>`;
          html += `<div class="detail-row"><div class="detail-label">è¡Œæ•°:</div><div class="detail-value">${result.diagnostic.recommendedComment.rowCount}</div></div>`;
          html += `<div class="detail-row"><div class="detail-label">ç·ã‚»ãƒ«æ•°:</div><div class="detail-value">${result.diagnostic.recommendedComment.totalCells}</div></div>`;
          html += `<div class="detail-row"><div class="detail-label">ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ :</div><div class="detail-value">${result.diagnostic.recommendedComment.responseTime}ms</div></div>`;
        }
        
        if (hasComments) {
          html += '<div class="comment-content">';
          result.recommendedComment.comments.forEach((row, index) => {
            html += `${index + 1}. ${row.join(' ')}<br>`;
          });
          html += '</div>';
        }
      } else {
        html += '<div class="status-error">âŒ å–å¾—å¤±æ•—</div>';
      }
      
      html += '</div>';
      return html;
    }
    
    function createRecommendations(results) {
      const recommendations = [];
      
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ
      const hasErrors = results.some(r => r.errors.length > 0);
      if (hasErrors) {
        recommendations.push('ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„');
        recommendations.push('APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      }
      
      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„ç‰©ä»¶ãŒã‚ã‚‹å ´åˆ
      const noFavoriteComment = results.filter(r => r.favoriteComment && !r.favoriteComment.comment).length;
      const noRecommendedComment = results.filter(r => r.recommendedComment && (!r.recommendedComment.comments || r.recommendedComment.comments.length === 0)).length;
      
      if (noFavoriteComment > 0 || noRecommendedComment > 0) {
        recommendations.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è©²å½“ã‚»ãƒ«/ã‚»ãƒ«ç¯„å›²ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        recommendations.push('ç‰©ä»¶ã‚¿ã‚¤ãƒ—ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        recommendations.push('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      }
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãŒé…ã„å ´åˆ
      const slowResponses = results.filter(r => r.diagnostic && r.diagnostic.totalResponseTime > 2000);
      if (slowResponses.length > 0) {
        recommendations.push('âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãŒé…ã„ç‰©ä»¶ãŒã‚ã‚Šã¾ã™ï¼ˆ> 2ç§’ï¼‰');
        recommendations.push('Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„');
        recommendations.push('Google Sheets APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„');
      }
      
      if (recommendations.length === 0) {
        return '<div class="recommendations"><h3>âœ… ã™ã¹ã¦æ­£å¸¸ã§ã™</h3><p>å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p></div>';
      }
      
      let html = '<div class="recommendations">';
      html += '<h3>ğŸ’¡ æ¨å¥¨äº‹é …</h3>';
      html += '<ul>';
      recommendations.forEach(rec => {
        html += `<li>${rec}</li>`;
      });
      html += '</ul>';
      html += '</div>';
      
      return html;
    }
  </script>
</body>
</html>

